<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="pageTitle">Quaderni di Archeologia della Libya - Publications</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: EB Garamond for global text and headings -->
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Global Font and Base Colors - Refined Cooler Greys */
        body {
            font-family: 'EB Garamond', serif; /* Apply Garamond globally */
            background-color: #e8e9eb; /* Very light cool grey */
            color: #3f4245; /* Dark charcoal-blue for body text */
            line-height: 1.6;
        }

        /* Headings Font - Consistent Garamond */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'EB Garamond', serif;
            color: #2c2f33; /* Even darker blue-grey for headings */
            font-weight: 700;
        }

        /* Container for main content */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header Specific Styles */
        .header-bg {
            background-color: #d8dbdf; /* Lighter cool grey for header */
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); /* Subtle shadow */
            border-bottom: 1px solid #c0c4c9; /* A finer line */
        }
        .header-logo {
            max-height: 120px; /* Increased logo size */
            width: auto;
            filter: none; /* No filter needed for lighter background */
        }
        .nav-button {
            background-color: #5f6b7a; /* Muted blue-grey for buttons */
            color: #ffffff; /* White text */
            font-family: 'EB Garamond', serif;
            padding: 0.75rem 1.25rem;
            border-radius: 6px;
            transition: all 0.2s ease-in-out;
            text-decoration: none;
            display: inline-block;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            white-space: nowrap;
            border: 1px solid #505c68; /* Distinct border */
        }
        .nav-button:hover {
            background-color: #72808f; /* Slightly lighter on hover */
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        /* Translation Buttons */
        .lang-button {
            background-color: #8c98a7; /* Even lighter blue-grey for lang buttons */
            color: #ffffff;
            font-family: 'EB Garamond', serif;
            padding: 0.5rem 0.8rem;
            border-radius: 4px;
            transition: all 0.2s ease-in-out;
            font-weight: 600;
            border: 1px solid #7a8694;
        }
        .lang-button:hover {
            background-color: #a0aab8;
            transform: translateY(-1px);
        }
        .lang-button.active {
            background-color: #3b76a7; /* Active blue */
            border-color: #2e5a80;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }

        /* Search Bar Styling */
        .header-search-container {
            background-color: #e0e2e5; /* Lighter cool grey for search area */
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.03);
            border: 1px solid #c0c4c9;
        }
        .search-input, .search-select {
            border: 1px solid #a0a8b3; /* Medium cool grey border */
            border-radius: 4px;
            padding: 0.6rem 1rem;
            font-family: 'EB Garamond', serif;
            color: #3f4245; /* Dark text */
            background-color: #f0f2f5; /* Off-white for inputs */
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }
        .search-input::placeholder, .search-select option {
            color: #7f8a94; /* Placeholder text color */
        }
        .search-input:focus, .search-select:focus {
            border-color: #5f6b7a; /* Muted blue-grey on focus */
            outline: none;
            box-shadow: 0 0 0 2px rgba(95, 107, 122, 0.2); /* Light blue-grey focus ring */
        }
        .search-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292%22%20height%3D%22292%22%20viewBox%3D%220%200%20292%20292%22%3E%3Cpath%20fill%3D%22%237f8a94%22%20d%3D%22M287%2069.4L146.7%20209.6%206.4%2069.4c-4.2-4.1-11-4.1-15.2%200-4.2%204.1-4.2%2010.8%200%2014.9l145%20146.5c4%204%2010.4%204%2014.4%200l145-146.5c4.2-4.1%204.2-10.8%200-14.9-4.2-4.1-11-4.1-15.2%200z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 0.8em;
            padding-right: 2.5rem;
        }

        /* General Section Styling */
        .section-content {
            background-color: #f0f2f5; /* Off-white, slightly darker light grey for main content sections */
            border-radius: 12px;
            padding: 2.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 2.5rem;
            animation: fadeIn 0.8s ease-out;
            border: 1px solid #d0d5dc; /* Subtle cool grey border */
        }

        /* Publication Cards */
        .publication-card {
            background-color: #f8f9fa; /* Even lighter for cards */
            border: 1px solid #e0e5ea; /* Very light cool grey border */
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }
        .publication-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }
        .cover-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-bottom: 1px solid #e0e5ea;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6); /* Standard overlay */
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .modal.flex {
            display: flex;
        }
        .modal-content {
            background-color: #e8e9eb; /* Modal content matches body background for harmony */
            margin: auto;
            padding: 2.5rem;
            border-radius: 10px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            width: 90%;
            max-width: 700px;
            text-align: center;
            position: relative;
            border: 1px solid #a0a8b3;
        }
        .modal-close-button {
            position: absolute;
            top: 15px;
            right: 25px;
            color: #7f8a94;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .modal-close-button:hover {
            color: #2c2f33;
        }
        .modal-buttons button {
            background-color: #5f6b7a;
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 6px;
            transition: background-color 0.2s ease;
            font-family: 'EB Garamond', serif;
            font-weight: 600;
        }
        .modal-buttons button:hover {
            background-color: #72808f;
        }

        /* Admin Specific Styles */
        .admin-bg {
            background-color: #c0c4c9; /* Slightly darker cool grey for admin area */
            color: #2c2f33; /* Dark text for admin */
        }
        .admin-section {
            background-color: #d8dbdf; /* Lighter cool grey for admin sections */
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            color: #3f4245; /* Dark text inside admin sections */
        }
        .admin-section h3 {
            color: #2c2f33; /* Ensure headings are dark */
        }
        .admin-input {
            border: 1px solid #a0a8b3;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            font-family: 'EB Garamond', serif;
            color: #3f4245;
            background-color: #f0f2f5;
        }
        .admin-input::placeholder {
            color: #7f8a94;
        }
        .admin-input:focus {
            border-color: #5f6b7a;
            box-shadow: 0 0 0 2px rgba(95, 107, 122, 0.2);
        }
        .admin-button {
            background-color: #5f6b7a;
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            transition: background-color 0.2s ease;
            font-family: 'EB Garamond', serif;
            font-weight: 600;
        }
        .admin-button:hover {
            background-color: #72808f;
        }
        .admin-button.bg-red-600 { background-color: #dc2626; border-color: #b91c1c;} /* Tailwind red */
        .admin-button.bg-red-600:hover { background-color: #b91c1c; }
        .admin-button.bg-green-600 { background-color: #16a34a; border-color: #15803d; } /* Tailwind green */
        .admin-button.bg-green-600:hover { background-color: #15803d; }
        .admin-button.bg-blue-600 { background-color: #2563eb; border-color: #1d4ed8; } /* Tailwind blue */
        .admin-button.bg-blue-600:hover { background-color: #1d4ed8; }

        /* Footer Styles */
        .footer-bg {
            background-color: #a0a8b3; /* Medium cool grey for footer */
            color: #2c2f33; /* Dark text */
            padding: 2rem;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            border-top: 1px solid #b0b8c3;
        }
        .footer-logo {
            max-height: 80px; /* Increased footer logo size */
            width: auto;
            filter: none; /* No filter needed for lighter background */
        }
        .footer-link {
            color: #3b76a7; /* Professional blue for links */
        }
        .footer-link:hover {
            color: #2e5a80; /* Darker blue on hover */
            text-decoration: underline;
        }

        /* Specific style for abstract/pdf download buttons in modal */
        .modal-download-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }
        .modal-download-group a, .modal-download-group button {
            background-color: #3b76a7; /* A professional blue for downloads */
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 5px;
            font-size: 0.9rem;
            transition: background-color 0.2s ease;
            font-family: 'EB Garamond', serif;
            font-weight: 600;
            text-decoration: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            border: 1px solid #2e5a80;
        }
        .modal-download-group a:hover, .modal-download-group button:hover {
            background-color: #2e5a80;
        }
        .modal-download-group button.disabled {
            background-color: #c0c4c9; /* Light grey for disabled */
            color: #5f6b7a;
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.7;
            border-color: #b0b8c3;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Section separator for content within a view */
        .section-separator {
            border-top: 1px solid #c0c4c9;
            margin: 3rem 0;
        }

        /* Table styling for admin */
        .admin-table-header {
            background-color: #c0c4c9;
        }
        .admin-table-row {
            background-color: #e0e2e5;
            color: #3f4245;
        }
        .admin-table-row:nth-child(even) {
            background-color: #f0f2f5; /* Slightly different for alternating rows */
        }
        .admin-table-row td {
            border-bottom: 1px solid #d0d5dc;
            padding: 0.75rem 1.5rem;
        }
        .admin-table-row:hover {
            background-color: #d0d5dc;
        }
        .file-upload-preview {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }
        .file-upload-preview img {
            max-width: 80px;
            height: auto;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .file-upload-preview p {
            font-size: 0.875rem;
            color: #7f8a94;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[2000] hidden">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-white"></div>
    </div>

    <!-- Modals -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button" id="closeMessageModal">&times;</span>
            <p id="messageText" class="text-lg text-gray-800 mb-4"></p>
            <div id="modalButtons" class="modal-buttons"></div>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button" id="closeConfirmModal">&times;</span>
            <p id="confirmMessage" class="text-lg text-gray-800 mb-6"></p>
            <div class="modal-buttons flex justify-center gap-4">
                <button id="confirmYesBtn" class="bg-red-600 hover:bg-red-700 text-white">Yes</button>
                <button id="confirmNoBtn" class="bg-gray-500 hover:bg-gray-600 text-white">No</button>
            </div>
        </div>
    </div>

    <!-- Publication Details Modal -->
    <div id="publicationDetailsModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button" id="closePublicationDetailsModal">&times;</span>
            <img id="detailCoverImage" src="https://placehold.co/400x600/cccccc/333333?text=No+Image" alt="Publication Cover" class="w-full max-w-[200px] h-auto object-cover mx-auto mb-4 rounded-md shadow-md">
            <h3 id="detailTitle" class="text-2xl font-bold text-gray-800 mb-2"></h3>
            <p id="detailAuthors" class="text-gray-600 text-lg mb-1"></p>
            <p id="detailYear" class="text-gray-500 text-md font-medium mb-3"></p>
            <p id="detailDescription" class="text-gray-700 text-base leading-relaxed text-left mb-6"></p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left text-gray-700 mb-6">
                <div><strong data-lang-key="isbnLabel">ISBN:</strong> <span id="detailISBN">N/A</span></div>
                <div><strong data-lang-key="issnLabel">ISSN:</strong> <span id="detailISSN">N/A</span></div>
            </div>

            <div class="modal-download-group">
                <a id="detailDownloadPdfBtn" href="#" target="_blank" class="admin-button" data-lang-key="downloadFullPdfBtn">Download Full PDF</a>
                <button id="detailDownloadAbstractArBtn" class="admin-button" data-lang-key="downloadArabicAbstractPdfBtn">Download Arabic Abstract (PDF)</button>
                <button id="detailDownloadAbstractEnBtn" class="admin-button" data-lang-key="downloadEnglishAbstractPdfBtn">Download English Abstract (PDF)</button>
                <button id="detailDownloadAbstractItBtn" class="admin-button" data-lang-key="downloadItalianAbstractPdfBtn">Download Italian Abstract (PDF)</button>
            </div>
            <div class="text-gray-700 text-base leading-relaxed text-left mt-6 space-y-3">
                <p><strong class="font-semibold" data-lang-key="arabicAbstractTextLabel">Arabic Abstract (Text):</strong> <span id="detailAbstractArText"></span></p>
                <p><strong class="font-semibold" data-lang-key="englishAbstractTextLabel">English Abstract (Text):</strong> <span id="detailAbstractEnText"></span></p>
                <p><strong class="font-semibold" data-lang-key="italianAbstractTextLabel">Italian Abstract (Text):</strong> <span id="detailAbstractItText"></span></p>
            </div>
        </div>
    </div>

    <!-- Header Section -->
    <header class="header-bg py-4 px-6 shadow-sm">
        <div class="container flex flex-col md:flex-row items-center justify-between w-full gap-4">
            <!-- Top Section: Logo, Search, and Language Buttons -->
            <div class="flex flex-col md:flex-row items-center justify-between w-full gap-4">
                <!-- Logo -->
                <div class="flex-shrink-0">
                    <img id="headerLogo" src="https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/header_logos%2FLogo%20QAL%20arabo%20300%20dpi.jpeg?alt=media&token=c2d438d9-9ba2-49ec-a32a-517ed18775ee" alt="Quaderni di Archeologia della Libya Logo" class="header-logo">
                </div>
                <!-- Search bar and sort options -->
                <div class="header-search-container flex flex-col sm:flex-row items-center gap-4 flex-grow md:max-w-xl lg:max-w-2xl">
                    <input type="text" id="publicationSearch" data-lang-key="searchPlaceholder" placeholder="Search by title, author, year, abstract..." class="search-input flex-grow w-full sm:w-auto">
                    <select id="sortPublications" class="search-select w-full sm:w-auto">
                        <option value="year-desc" data-lang-key="sortYearNewest">Year (Newest First)</option>
                        <option value="year-asc" data-lang-key="sortYearOldest">Year (Oldest First)</option>
                        <option value="title-asc" data-lang-key="sortTitleAZ">Title (A-Z)</option>
                        <option value="title-desc" data-lang-key="sortTitleZA">Title (Z-A)</option>
                        <option value="author-asc" data-lang-key="sortAuthorAZ">Author (A-Z)</option>
                        <option value="author-desc" data-lang-key="sortAuthorZA">Author (Z-A)</option>
                    </select>
                </div>
                <!-- Language Buttons -->
                <div class="flex space-x-2 mt-4 md:mt-0">
                    <button class="lang-button" data-lang="en">ENG</button>
                    <button class="lang-button" data-lang="it">ITA</button>
                </div>
            </div>
           
            <!-- Bottom Section: Navigation buttons -->
            <nav class="flex flex-wrap justify-center items-center space-x-2 md:space-x-4 w-full pt-4 md:pt-0">
                <button class="nav-button view-button" data-view="aboutUs" data-lang-key="navAboutUs">About Us</button>
                <button class="nav-button view-button" data-view="editorialBoard" data-lang-key="navEditorialBoard">Editorial Board</button>
                <button class="nav-button view-button" data-view="currentIssue" data-lang-key="navCurrentIssue">Current Issue</button>
                <button class="nav-button view-button" data-view="archivalVolumes" data-lang-key="navArchivalVolumes">Archival Volumes</button>
                <button class="nav-button view-button" data-view="editorialAndEthics" data-lang-key="navEditorialEthics">Editorial Guidelines & Code of Ethics</button>
                <button class="nav-button view-button" data-view="newsEvents" data-lang-key="navNewsEvents">News & Current Events</button>
            </nav>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow container mt-8">
        <!-- About Us View (Home Page) -->
        <section id="aboutUsView" class="view section-content">
            <h2 class="text-3xl text-center mb-6" data-lang-key="aboutUsHeading">About Quaderni di Archeologia della Libya</h2>
            <div class="prose max-w-none text-gray-700 leading-relaxed space-y-4">
                <p data-lang-key="aboutUsPara1">Welcome to the official website for <strong>Quaderni di Archeologia della Libya</strong>, a prestigious academic journal dedicated to archaeological research in Libya. Initiated in 1950, this esteemed series documents the significant contributions of Italian archaeological missions in the region, fostering a deeper understanding of its rich ancient history.</p>
                <p data-lang-key="aboutUsPara2">After a brief hiatus, the journal proudly resumed publication in 2018 with a new series, re-establishing itself as a leading scientific platform. We provide an essential venue for scholars interested in the archaeology and history of Libya and the broader Maghreb, ensuring high-quality, peer-reviewed content.</p>
                <p data-lang-key="aboutUsPara3">Our volumes embrace a multidisciplinary approach, featuring articles on epigraphy, ancient and colonial history, the history of archaeology, and territorial studies. Contributions are published in major European languages, complemented by comprehensive English and Arabic abstracts, to promote international academic exchange and collaboration.</p>
                <p data-lang-key="aboutUsPara4">This website serves as a dedicated resource for the series, maintained by L'Erma di Bretschneider, a renowned academic publishing house in Rome. We are committed to upholding the highest standards of scholarly excellence and ensuring the continued global dissemination of groundbreaking research presented in the "Quaderni di Archeologia della Libya."</p>
            </div>
            <div class="section-separator"></div>
            <h2 class="text-3xl text-center mb-6" data-lang-key="currentPublicationsHeading">Current Publications</h2>
            <div id="publicationsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <p class="col-span-full text-center text-gray-400" data-lang-key="loadingPublications">Loading publications...</p>
            </div>
        </section>

        <!-- Editorial Board View -->
        <section id="editorialBoardView" class="view hidden section-content">
            <h2 class="text-3xl text-center mb-6" data-lang-key="editorialBoardHeading">Meet the Editorial Board</h2>
            <p class="text-center text-gray-700 mb-8" data-lang-key="editorialBoardIntro">Our journal is guided by a distinguished panel of scholars and experts in Libyan archaeology and related fields. Their expertise ensures the high quality and academic rigor of our publications.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Mock Editorial Board Members - These would ideally come from Firestore as well -->
                <div class="bg-gray-100 p-6 rounded-lg shadow-md border border-gray-200 text-center">
                    <img class="w-32 h-32 rounded-full mx-auto mb-4 object-cover border-2 border-gray-300 shadow-sm" src="https://placehold.co/128x128/e0e2e5/3f4245?text=EB" alt="Eugenio La Rocca">
                    <h3 class="text-xl font-semibold text-gray-800">Prof. Eugenio La Rocca</h3>
                    <p class="text-gray-700 text-sm mb-2" data-lang-key="editorInChief">Editor-in-Chief</p>
                    <p class="text-gray-600 text-sm">University of Rome "La Sapienza"</p>
                </div>
                 <div class="bg-gray-100 p-6 rounded-lg shadow-md border border-gray-200 text-center">
                    <img class="w-32 h-32 rounded-full mx-auto mb-4 object-cover border-2 border-gray-300 shadow-sm" src="https://placehold.co/128x128/e0e2e5/3f4245?text=AH" alt="Ahmed Hussein Y. Abdulkariem">
                    <h3 class="text-xl font-semibold text-gray-800">Dr. Ahmed Hussein Y. Abdulkariem</h3>
                    <p class="text-gray-700 text-sm mb-2" data-lang-key="associateEditor">Associate Editor</p>
                    <p class="text-gray-600 text-sm">Department of Antiquities, Libya</p>
                </div>
                <div class="bg-gray-100 p-6 rounded-lg shadow-md border border-gray-200 text-center">
                    <img class="w-32 h-32 rounded-full mx-auto mb-4 object-cover border-2 border-gray-300 shadow-sm" src="https://placehold.co/128x128/e0e2e5/3f4245?text=BB" alt="Barbara Barich">
                    <h3 class="text-xl font-semibold text-gray-800">Prof. Barbara Barich</h3>
                    <p class="text-gray-700 text-sm mb-2" data-lang-key="editorialBoardMember">Editorial Board Member</p>
                    <p class="text-gray-600 text-sm">University of Rome "La Sapienza"</p>
                </div>
            </div>
            <p class="text-center text-gray-600 mt-8" data-lang-key="editorialBoardComingSoon">Full list of the editorial board and their biographies coming soon.</p>
        </section>

        <!-- Current Issue View -->
        <section id="currentIssueView" class="view hidden section-content flex flex-col items-center">
            <h2 class="text-3xl text-center mb-6" data-lang-key="currentIssueHeading">Current Issue</h2>
            <div id="currentIssueContent" class="text-center w-full max-w-3xl">
                <p class="text-gray-700 text-lg mb-4" data-lang-key="noCurrentIssue">No current issue set yet. Check back soon!</p>
                <div id="currentIssuePublicationCard" class="publication-card p-6 flex flex-col items-center text-center shadow-lg transition duration-500 ease-out hidden">
                    <img id="currentIssueCover" src="" alt="Current Issue Cover" class="cover-image rounded-lg mb-6 shadow-xl" onerror="this.onerror=null;this.src='https://placehold.co/400x600/cccccc/333333?text=No+Image';">
                    <h3 id="currentIssueTitle" class="text-3xl font-bold mb-3 text-gray-800"></h3>
                    <p id="currentIssueAuthors" class="text-gray-700 text-xl mb-2"></p>
                    <p id="currentIssueYear" class="text-gray-500 text-lg font-medium mb-4"></p>
                    <p id="currentIssueDescription" class="text-gray-600 text-md leading-relaxed mb-6"></p>
                    <div class="modal-download-group">
                        <a id="currentIssueDownloadPdfBtn" href="#" target="_blank" class="admin-button" data-lang-key="downloadFullPdfBtn">Download Full PDF</a>
                        <button id="currentIssueDownloadAbstractArBtn" class="admin-button" data-lang-key="downloadArabicAbstractPdfBtn">Download Arabic Abstract (PDF)</button>
                        <button id="currentIssueDownloadAbstractEnBtn" class="admin-button" data-lang-key="downloadEnglishAbstractPdfBtn">Download English Abstract (PDF)</button>
                        <button id="currentIssueDownloadAbstractItBtn" class="admin-button" data-lang-key="downloadItalianAbstractPdfBtn">Download Italian Abstract (PDF)</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Archival Volumes View -->
        <section id="archivalVolumesView" class="view hidden section-content">
            <h2 class="text-3xl text-center mb-6" data-lang-key="archivalVolumesHeading">Archival Volumes</h2>
            <p class="text-center text-gray-700 mb-8" data-lang-key="archivalVolumesIntro">Explore the rich history of archaeological research in Libya through our past publications. Browse by year or special issue below.</p>
            <div id="archivalPublicationsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <p class="col-span-full text-center text-gray-400" data-lang-key="loadingArchivalVolumes">Loading archival volumes...</p>
            </div>
        </section>

        <!-- Editorial Guidelines & Code of Ethics View (Combined) -->
        <section id="editorialAndEthicsView" class="view hidden section-content">
            <h2 class="text-3xl text-center mb-6" data-lang-key="editorialEthicsHeading">Editorial Guidelines & Code of Ethics</h2>
            <div class="prose max-w-none text-gray-700 leading-relaxed space-y-4">
                <h3 class="text-2xl font-bold mt-6 mb-3" data-lang-key="editorialGuidelinesTitle">Editorial Guidelines</h3>
                <p class="text-lg font-semibold" data-lang-key="articlesSubmittedTo">Articles must be submitted to:</p>
                <ul class="list-disc ml-6 space-y-1">
                    <li><a href="mailto:redazione@quadalibya.it" class="text-blue-600 hover:underline">redazione@quadalibya.it</a></li>
                    <li><a href="mailto:laura.buccino@quadalibya.it" class="text-blue-600 hover:underline">laura.buccino@quadalibya.it</a></li>
                </ul>
                <h4 class="text-xl font-bold mt-4 mb-2" data-lang-key="submissionProcedureTitle">Submission Procedure:</h4>
                <ul class="list-disc ml-6 space-y-2">
                    <li data-lang-key="submissionProcedure1">Contributions should be sent in digital format .doc (Microsoft Word) as an e-mail attachment.</li>
                    <li data-lang-key="submissionProcedure2">The contents will be reviewed by at least two anonymous readers and if necessary, will be returned to the author for eventual corrections and changes.</li>
                    <li data-lang-key="submissionProcedure3">Only one set of proofs will be sent to the authors who are expected to correct and return them by the deadline set by the editors.</li>
                    <li data-lang-key="submissionProcedure4">With regard to illustrations, a file including captions and photograph credits should be sent separately. The text should be accompanied by a digital copy of the images to be published (please, use WeTransfer if images are too heavy to be sent as email attachments).</li>
                    <li data-lang-key="submissionProcedure5">The images must be in JPG or TIFF formats and at a minimum resolution of 300 dpi (pixel definition). All images submitted for publication should comply with the copyright rules and there must be an agreement (or a release form) about image reproduction by the copyright owner prior to publication. The author is sole responsible for securing such permits. No image without such accompanying documents will be published.</li>
                </ul>

                <h4 class="text-xl font-bold mt-4 mb-2" data-lang-key="articleRequirementsTitle">Article Requirements:</h4>
                <ul class="list-disc ml-6 space-y-2">
                    <li data-lang-key="articleRequirements1">An abstract of ca. 500 characters / 100 words in the language of the text and in English.</li>
                    <li data-lang-key="articleRequirements2">Title in English.</li>
                    <li data-lang-key="articleRequirements3">5 Keywords in Italian and English.</li>
                    <li data-lang-key="articleRequirements4">Footnotes.</li>
                    <li data-lang-key="articleRequirements5">Address and email address of the author.</li>
                    <li data-lang-key="articleRequirements6">Institutional affiliation of the author.</li>
                </ul>

                <h4 class="text-xl font-bold mt-4 mb-2" data-lang-key="formattingGuidelinesTitle">Formatting Guidelines:</h4>
                <ul class="list-disc ml-6 space-y-2">
                    <li data-lang-key="formattingGuidelines1">Quotes are inserted within double quotation marks "..."</li>
                    <li data-lang-key="formattingGuidelines2">Single quotation marks are used to emphasize specific words or expressions '...'.</li>
                    <li data-lang-key="formattingGuidelines3">Transliterations from other languages (as, for example, from Greek or Arabic) are italicized.</li>
                    <li data-lang-key="formattingGuidelines4">If special characters are used in the text (such as in the case of Greek), the font should be specified.</li>
                    <li data-lang-key="formattingGuidelines5">Latin and Greek sources must be cited using the abbreviations in: Thesaurus Linguae Latinae, The Online Liddell-Scott-Jones Greek-English Lexicon (http://stephanus.tlg.uci.edu/lsj/01-authors_and_works.html) and, if not present, G.W.H. LAMPE, A Patristic Greek Lexicon, Oxford 1961.</li>
                </ul>

                <h4 class="text-xl font-bold mt-4 mb-2" data-lang-key="commonAbbreviationsTitle">Commonly-used Abbreviations:</h4>
                <ul class="list-disc ml-6 space-y-1">
                    <li data-lang-key="abbrCat">cat. = catalogue</li>
                    <li data-lang-key="abbrCf">cf. = confer</li>
                    <li data-lang-key="abbrCm">cm = centimeters</li>
                    <li data-lang-key="abbrCol">col./cols = column/columns</li>
                    <li data-lang-key="abbrEAD">EAD. (small caps) = Eadem</li>
                    <li data-lang-key="abbrEtc">etc. = eccetera</li>
                    <li data-lang-key="abbrF">f./ff. = following / followings</li>
                    <li data-lang-key="abbrFig">fig./figs = figure / figures</li>
                    <li data-lang-key="abbrFol">fol. / fols = folio / folios</li>
                    <li data-lang-key="abbrID">ID. (small caps) = Idem</li>
                    <li data-lang-key="abbrIID">IID. (small caps) = Iidem</li>
                    <li data-lang-key="abbrL">l./ll. = line / lines</li>
                    <li data-lang-key="abbrNoInv">No. inv. = inventory number</li>
                    <li data-lang-key="abbrM">m = meters</li>
                    <li data-lang-key="abbrMs">ms. / mss = manuscript / manuscripts</li>
                    <li data-lang-key="abbrNo">no. / nos = number / numbers</li>
                    <li data-lang-key="abbrNd">n.d. = no date</li>
                    <li data-lang-key="abbrNp">n.p. = no place</li>
                    <li data-lang-key="abbrNote">note = note</li>
                    <li data-lang-key="abbrP">p./pp. = page/pages</li>
                    <li data-lang-key="abbrSee">see = see</li>
                    <li data-lang-key="abbrSv">s.v. (italics) = sub voce</li>
                    <li data-lang-key="abbrPl">pl./pls = plate / plates</li>
                    <li data-lang-key="abbrVol">vol. / vols = volume / volumes</li>
                </ul>
                <p class="text-sm text-gray-600 mt-8" data-lang-key="fullGuidelinesNote">Note: This is a summary of the full editorial guidelines. For complete bibliographic rules, please refer to the comprehensive document.</p>

                <div class="section-separator"></div>

                <h3 class="text-2xl font-bold mt-12 mb-3" data-lang-key="ethicsStatementTitle">Code of Ethics and Malpractice Statement</h3>
                <p data-lang-key="ethicsStatementPara1">This document outlines the ethics principles and good practices applied by the publishing house L'ERMA di Bretschneider (hereafter L'ERMA) to the process of editing and publishing monographs, scientific journals, and other editorial content of scientific, educational, and outreach nature. L'ERMA is inspired by the ethical principles outlined by the Committee on Publication Ethics (hereinafter COPE), an international non-profit organization that aims to support publishers and editors in pursuing high standards of publishing ethics. Although COPE mainly provides guidelines and resources for publishers and editors of scientific journals, these can also be applied to the publication of monographs and other academic content.</p>
                <h4 class="text-xl font-bold mt-4 mb-2" data-lang-key="researchEthicsTitle">I. Research ethics and integrity</h4>
                <p data-lang-key="researchEthicsPara1">L'ERMA publications respect the ethical principles of COPE, which are: Reliability; honesty, respect, and responsibility in all aspects of research; Care, accuracy, and excellence in research practice; Transparency, reproducibility, traceability, and open communication; Attention and respect for all participants and research subjects.</p>
                <p data-lang-key="researchEthicsPara2">Whoever believes that research published by L'ERMA has not been conducted in line with these ethical practices is invited to raise the issue with the publisher at lerma@lerma.it. Where possible, each report will be handled following COPE guidelines, and/or by submitting the matter to the Chairman of the Board of Directors of the publishing house and, if necessary, to the members of the Editorial Board of the publishing house.</p>
                <!-- Further Code of Ethics content here as previously -->
                <p class="text-sm text-gray-600 mt-8" data-lang-key="lastUpdatedDate">Last updated 27 February 2024</p>
            </div>
        </section>

        <!-- News & Current Events View -->
        <section id="newsEventsView" class="view hidden section-content">
            <h2 class="text-3xl text-center mb-6" data-lang-key="newsEventsHeading">News & Current Events</h2>
            <p class="text-center text-gray-700 mb-8" data-lang-key="newsEventsIntro">Stay updated with the latest news, discoveries, and announcements from Quaderni di Archeologia della Libya.</p>
            <div id="newsFeed" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <p class="col-span-full text-center text-gray-400" data-lang-key="noNewsUpdates">No news updates yet. Check back soon!</p>
            </div>
        </section>

        <!-- Admin Login View -->
        <section id="adminLoginView" class="view hidden section-content max-w-md mx-auto">
            <h2 class="text-3xl text-center mb-6" data-lang-key="adminLoginHeading">Admin Login</h2>
            <form id="adminLoginForm" class="space-y-4">
                <div>
                    <label for="adminEmail" class="block text-sm font-semibold mb-1" data-lang-key="emailLabel">Email:</label>
                    <input type="email" id="adminEmail" class="admin-input w-full" required>
                </div>
                <div>
                    <label for="adminPassword" class="block text-sm font-semibold mb-1" data-lang-key="passwordLabel">Password:</label>
                    <input type="password" id="adminPassword" class="admin-input w-full" required>
                </div>
                <button type="submit" class="admin-button w-full bg-green-600 hover:bg-green-700" data-lang-key="loginButton">Login</button>
                <p class="text-red-400 text-sm mt-2 text-center" id="loginErrorMessage"></p>
            </form>
        </section>

        <!-- Admin Dashboard View -->
        <section id="adminDashboardView" class="view hidden admin-bg p-8 rounded-lg shadow-md max-w-4xl mx-auto">
            <h2 class="text-3xl text-center mb-6" data-lang-key="adminDashboardHeading">Admin Dashboard</h2>
            <p class="text-center text-gray-700 mb-4" data-lang-key="welcomeAdmin">Welcome, <span id="loggedInUserEmail" class="font-semibold"></span>!</p>

            <!-- Admin Nav for sub-sections -->
            <nav class="flex justify-center space-x-4 mb-8">
                <button class="admin-button" id="managePublicationsBtn" data-lang-key="managePublicationsBtn">Manage Publications</button>
                <button class="admin-button" id="manageNewsBtn" data-lang-key="manageNewsBtn">Manage News</button>
                <button class="admin-button" id="manageSiteSettingsBtn" data-lang-key="manageSiteSettingsBtn">Site Settings</button>
                <button class="admin-button bg-red-600 hover:bg-red-700" id="adminLogoutBtn" data-lang-key="logoutButton">Logout</button>
            </nav>

            <!-- Manage Publications Section -->
            <div id="adminManagePublications" class="admin-section">
                <h3 id="adminFormTitle" class="text-2xl font-bold mb-4" data-lang-key="addPublicationTitle">Add New Publication</h3>
                <form id="addPublicationForm" class="space-y-4">
                    <div>
                        <label for="bookTitle" class="block text-sm font-semibold mb-1" data-lang-key="titleLabel">Title:</label>
                        <input type="text" id="bookTitle" class="admin-input w-full">
                    </div>
                    <div>
                        <label for="bookAuthors" class="block text-sm font-semibold mb-1" data-lang-key="authorsLabel">Authors (comma-separated):</label>
                        <input type="text" id="bookAuthors" class="admin-input w-full">
                    </div>
                     <div>
                        <label for="bookYear" class="block text-sm font-semibold mb-1" data-lang-key="publicationYearLabel">Publication Year:</label>
                        <input type="number" id="bookYear" class="admin-input w-full" min="1900" max="2100">
                    </div>
                    <div>
                        <label for="bookDescription" class="block text-sm font-semibold mb-1" data-lang-key="descriptionLabel">Description:</label>
                        <textarea id="bookDescription" rows="3" class="admin-input w-full"></textarea>
                    </div>
                    <div>
                        <label for="bookISBN" class="block text-sm font-semibold mb-1" data-lang-key="isbnLabel">ISBN:</label>
                        <input type="text" id="bookISBN" class="admin-input w-full">
                    </div>
                    <div>
                        <label for="bookISSN" class="block text-sm font-semibold mb-1" data-lang-key="issnLabel">ISSN:</label>
                        <input type="text" id="bookISSN" class="admin-input w-full">
                    </div>

                    <!-- Abstract Text Areas -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="abstractArText" class="block text-sm font-semibold mb-1" data-lang-key="arabicAbstractTextLabel">Arabic Abstract (Text):</label>
                            <textarea id="abstractArText" rows="3" class="admin-input w-full"></textarea>
                        </div>
                        <div>
                            <label for="abstractEnText" class="block text-sm font-semibold mb-1" data-lang-key="englishAbstractTextLabel">English Abstract (Text):</label>
                            <textarea id="abstractEnText" rows="3" class="admin-input w-full"></textarea>
                        </div>
                        <div>
                            <label for="abstractItText" class="block text-sm font-semibold mb-1" data-lang-key="italianAbstractTextLabel">Italian Abstract (Text):</label>
                            <textarea id="abstractItText" rows="3" class="admin-input w-full"></textarea>
                        </div>
                    </div>

                    <!-- File Uploads for Cover, PDF, and Abstract PDFs -->
                    <div>
                        <label for="bookCover" class="block text-sm font-semibold mb-1" data-lang-key="coverImageLabel">Cover Image (Optional):</label>
                        <input type="file" id="bookCover" accept="image/*" class="admin-input w-full">
                        <div class="file-upload-preview" id="coverImagePreviewContainer">
                            <img id="uploadedCoverPreviewAdmin" src="" alt="Uploaded Cover Preview" class="max-w-[100px] h-auto rounded-lg shadow-sm" style="display:none;">
                            <p id="coverImageFileNameDisplayAdmin" class="text-xs text-gray-600"></p>
                        </div>
                    </div>
                    <div>
                        <label for="bookPdf" class="block text-sm font-semibold mb-1" data-lang-key="fullBookPdfLabel">Full Book PDF (Optional - First 20 Pages):</label>
                        <input type="file" id="bookPdf" accept="application/pdf" class="admin-input w-full">
                        <p id="pdfFileNameDisplayAdmin" class="text-xs text-gray-600 mt-1"></p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="abstractArPdf" class="block text-sm font-semibold mb-1" data-lang-key="arabicAbstractPdfLabel">Arabic Abstract (PDF - Optional):</label>
                            <input type="file" id="abstractArPdf" accept="application/pdf" class="admin-input w-full">
                            <p id="abstractArPdfFileNameDisplayAdmin" class="text-xs text-gray-600 mt-1"></p>
                        </div>
                        <div>
                            <label for="abstractEnPdf" class="block text-sm font-semibold mb-1" data-lang-key="englishAbstractPdfLabel">English Abstract (PDF - Optional):</label>
                            <input type="file" id="abstractEnPdf" accept="application/pdf" class="admin-input w-full">
                            <p id="abstractEnPdfFileNameDisplayAdmin" class="text-xs text-gray-600 mt-1"></p>
                        </div>
                        <div>
                            <label for="abstractItPdf" class="block text-sm font-semibold mb-1" data-lang-key="italianAbstractPdfLabel">Italian Abstract (PDF - Optional):</label>
                            <input type="file" id="abstractItPdf" accept="application/pdf" class="admin-input w-full">
                            <p id="abstractItPdfFileNameDisplayAdmin" class="text-xs text-gray-600 mt-1"></p>
                        </div>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="bookIsCurrentIssue" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="bookIsCurrentIssue" class="ml-2 block text-sm font-semibold" data-lang-key="setCurrentIssueLabel">Set as Current Issue</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="bookIsArchivalVolume" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="bookIsArchivalVolume" class="ml-2 block text-sm font-semibold" data-lang-key="setArchivalVolumeLabel">Set as Archival Volume</label>
                    </div>

                    <div class="flex justify-between gap-4">
                        <button type="submit" id="submitPublicationBtn" class="admin-button w-full bg-green-600 hover:bg-green-700" data-lang-key="addPublicationButton">Add Publication</button>
                        <button type="button" id="cancelEditPublicationBtn" class="admin-button w-full bg-gray-500 hover:bg-gray-600 hidden" data-lang-key="cancelEditButton">Cancel Edit</button>
                    </div>
                </form>

                <h3 class="text-2xl font-bold mt-8 mb-4" data-lang-key="managePublicationsHeading">Manage Existing Publications</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-300">
                        <thead class="admin-table-header">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-800" data-lang-key="tableHeaderTitle">Title</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-800" data-lang-key="tableHeaderAuthors">Authors</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-800" data-lang-key="tableHeaderYear">Year</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-800" data-lang-key="tableHeaderActions">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminPublicationsList" class="divide-y divide-gray-300">
                            <tr class="admin-table-row"><td colspan="4" class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" data-lang-key="noPublicationsToManage">${translations[currentLanguage].noPublicationsToManage}</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Manage News Section -->
            <div id="adminManageNews" class="admin-section hidden">
                <h3 class="text-2xl font-bold mb-4" data-lang-key="addNewsItemTitle">Add New News Item</h3>
                <form id="addNewsItemForm" class="space-y-4">
                    <div>
                        <label for="newsTitle" class="block text-sm font-semibold mb-1" data-lang-key="newsTitleLabel">News Title:</label>
                        <input type="text" id="newsTitle" class="admin-input w-full" required>
                    </div>
                    <div>
                        <label for="newsDescription" class="block text-sm font-semibold mb-1" data-lang-key="newsDescriptionLabel">News Description:</label>
                        <textarea id="newsDescription" rows="3" class="admin-input w-full" required></textarea>
                    </div>
                    <div>
                        <label for="newsImage" class="block text-sm font-semibold mb-1" data-lang-key="newsImageLabel">News Image (Optional):</label>
                        <input type="file" id="newsImage" accept="image/*" class="admin-input w-full">
                        <div class="file-upload-preview" id="newsImagePreviewContainer">
                            <img id="uploadedNewsImagePreviewAdmin" src="" alt="Uploaded News Image Preview" class="max-w-[100px] h-auto rounded-lg shadow-sm" style="display:none;">
                            <p id="newsImageFileNameDisplayAdmin" class="text-xs text-gray-600"></p>
                        </div>
                    </div>
                    <button type="submit" id="submitNewsBtn" class="admin-button w-full bg-blue-600 hover:bg-blue-700" data-lang-key="addNewsItemButton">Add News Item</button>
                    <button type="button" id="cancelEditNewsBtn" class="admin-button w-full bg-gray-500 hover:bg-gray-600 hidden" data-lang-key="cancelEditButton">Cancel Edit</button>
                </form>

                <h3 class="text-2xl font-bold mt-8 mb-4" data-lang-key="manageNewsHeading">Manage Existing News</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-300">
                        <thead class="admin-table-header">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-800" data-lang-key="tableHeaderTitle">Title</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-800" data-lang-key="tableHeaderDate">Date</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-800" data-lang-key="tableHeaderActions">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminNewsList" class="divide-y divide-gray-300">
                            <tr class="admin-table-row"><td colspan="3" class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" data-lang-key="noNewsToManage">${translations[currentLanguage].noNewsToManage}</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Manage Site Settings Section (New Admin Feature) -->
            <div id="adminManageSiteSettings" class="admin-section hidden">
                <h3 class="text-2xl font-bold mb-4" data-lang-key="manageSiteLogosHeading">Manage Site Logos</h3>
                <form id="logoUploadForm" class="space-y-4">
                    <div>
                        <label for="headerLogoUpload" class="block text-sm font-semibold mb-1" data-lang-key="headerLogoUploadLabel">Upload Header Logo:</label>
                        <input type="file" id="headerLogoUpload" accept="image/*" class="admin-input w-full">
                        <div class="file-upload-preview" id="headerLogoPreviewContainer">
                            <img id="headerLogoPreview" src="" alt="Header Logo Preview" class="max-w-[100px] h-auto rounded-lg shadow-sm" style="display:none;">
                            <p id="headerLogoFileNameDisplayAdmin" class="text-xs text-gray-600"></p>
                        </div>
                    </div>
                    <div>
                        <label for="footerLogoUpload" class="block text-sm font-semibold mb-1" data-lang-key="footerLogoUploadLabel">Upload Footer Logo:</label>
                        <input type="file" id="footerLogoUpload" accept="image/*" class="admin-input w-full">
                        <div class="file-upload-preview" id="footerLogoPreviewContainer">
                            <img id="footerLogoPreview" src="" alt="Footer Logo Preview" class="max-w-[100px] h-auto rounded-lg shadow-sm" style="display:none;">
                            <p id="footerLogoFileNameDisplayAdmin" class="text-xs text-gray-600"></p>
                        </div>
                    </div>
                    <button type="submit" class="admin-button w-full bg-blue-600 hover:bg-blue-700" data-lang-key="updateLogosButton">Update Logos</button>
                </form>

                <div class="section-separator"></div>

                <h3 class="text-2xl font-bold mb-4" data-lang-key="manageContributorLogosHeading">Manage Contributor Logos</h3>
                <form id="contributorLogoUploadForm" class="space-y-4">
                    <div>
                        <label for="contributor1LogoUpload" class="block text-sm font-semibold mb-1" data-lang-key="contributor1LogoLabel">Upload L'ERMA Logo:</label>
                        <input type="file" id="contributor1LogoUpload" accept="image/*" class="admin-input w-full">
                        <div class="file-upload-preview">
                            <img id="contributor1LogoPreview" src="" alt="L'ERMA Logo Preview" class="max-w-[100px] h-auto rounded-lg shadow-sm" style="display:none;">
                            <p id="contributor1FileNameDisplayAdmin" class="text-xs text-gray-600"></p>
                        </div>
                    </div>
                    <div>
                        <label for="contributor2LogoUpload" class="block text-sm font-semibold mb-1" data-lang-key="contributor2LogoLabel">Upload Fondazione MEDA Logo:</label>
                        <input type="file" id="contributor2LogoUpload" accept="image/*" class="admin-input w-full">
                        <div class="file-upload-preview">
                            <img id="contributor2LogoPreview" src="" alt="Fondazione MEDA Logo Preview" class="max-w-[100px] h-auto rounded-lg shadow-sm" style="display:none;">
                            <p id="contributor2FileNameDisplayAdmin" class="text-xs text-gray-600"></p>
                        </div>
                    </div>
                    <button type="submit" class="admin-button w-full bg-blue-600 hover:bg-blue-700" data-lang-key="updateContributorLogosButton">Update Contributor Logos</button>
                </form>
            </div>

        </section>

    </main>

    <!-- Footer Section -->
    <footer class="footer-bg py-6 mt-8 shadow-inner">
        <div class="container flex flex-col md:flex-row items-center justify-between text-sm">
            <!-- Logo on the left -->
            <div class="flex items-center space-x-4 mb-4 md:mb-0">
                <img id="footerLogo" src="https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/header_logos%2FLogo%20QAL%20arabo%20300%20dpi.jpeg?alt=media&token=c2d438d9-9ba2-49ec-a32a-517ed18775ee" alt="Quaderni di Archeologia della Libya Logo" class="footer-logo">
                <p>&copy; <span id="currentYear"></span> <span data-lang-key="copyrightText">Quaderni di Archeologia della Libya. All rights reserved.</span></p>
            </div>
            
            <!-- Contact Info -->
            <div class="text-center md:text-left space-y-1 mb-4 md:mb-0">
                <p class="font-bold" data-lang-key="contactUsLabel">Contact Us:</p>
                <p data-lang-key="emailAddress"><span data-lang-key="emailLabelShort">Email:</span> <a href="mailto:info@archaeologylibya.org" class="footer-link">info@archaeologylibya.org</a></p>
                <p data-lang-key="phoneNumber"><span data-lang-key="phoneLabelShort">Phone:</span> +39 06 6874127</p>
            </div>

            <!-- Contributors & Admin Login -->
            <div class="text-center md:text-right space-y-2">
                <p class="font-bold" data-lang-key="contributorsLabel">Contributors:</p>
                <div class="flex justify-center md:justify-end items-center gap-4">
                    <!-- These will now load instantly from HTML, then be updated by JS if custom ones are set -->
                    <div id="contributor1LogoContainer" class="h-16 flex items-center justify-center">
                        <img id="contributor1Logo" src="https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/contributor_logos%2Flogo%20lerma.png?alt=media&token=f6966fec-902a-4e2a-b39e-a3ddb633e983" alt="L'ERMA di Bretschneider Logo" class="h-16">
                    </div>
                    <div id="contributor2LogoContainer" class="h-16 flex items-center justify-center">
                        <img id="contributor2Logo" src="https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/contributor_logos%2Flogo%20meda%20ets%20max.jpg?alt=media&token=c2071e4e-bf59-4f06-b99b-4b739737f51b" alt="Fondazione MEDA Logo" class="h-16">
                    </div>
                </div>
                <button id="adminLoginBtnFooter" class="nav-button bg-transparent hover:bg-gray-700 border border-white text-white mt-4" data-lang-key="adminLoginButton">Admin Login</button>
            </div>
        </div>
        <p class="text-center text-neutral-300 text-xs mt-4">Logged in User ID: <span id="currentUserId">N/A</span></p>
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase CDN Imports - Corrected syntax to use 'from' keyword
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, onSnapshot, query, orderBy, where, getDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js"; // Corrected this line

        // Firebase Configuration and Auth Token (Provided by Canvas Environment or Fallback)
        const hardcodedFirebaseConfig = {
            apiKey: "AIzaSyDrOjIfbI2ttZF_Dp8JSRNpl_eL8XU4JGk",
            authDomain: "quadernilibyawebsite.firebaseapp.com",
            projectId: "quadernilibyawebsite",
            storageBucket: "quadernilibyawebsite.firebasestorage.app",
            messagingSenderId: "8372415971",
            appId: "1:8372415971:web:76fdcc247797cac05784d6",
            measurementId: "G-G74YV94Y52"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : hardcodedFirebaseConfig.projectId;
        // Ensure firebaseConfig is parsed if it's a string from the environment
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : hardcodedFirebaseConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Default Logo Paths (Placeholders if not set by admin) - Now empty for contributor logos
        const DEFAULT_HEADER_LOGO_URL = 'https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/header_logos%2FLogo%20QAL%20arabo%20300%20dpi.jpeg?alt=media&token=c2d438d9-9ba2-49ec-a32a-517ed18775ee';
        const DEFAULT_FOOTER_LOGO_URL = 'https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/header_logos%2FLogo%20QAL%20arabo%20300%20dpi.jpeg?alt=media&token=c2d438d9-9ba2-49ec-a32a-517ed18775ee';
        // Updated default contributor logo URLs to actual image URLs from your Firebase Storage
        const DEFAULT_CONTRIB1_LOGO_URL = 'https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/contributor_logos%2Flogo%20lerma.png?alt=media&token=f6966fec-902a-4e2a-b39e-a3ddb633e983'; // L'ERMA logo
        const DEFAULT_CONTRIB2_LOGO_URL = 'https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/contributor_logos%2Flogo%20meda%20ets%20max.jpg?alt=media&token=c2071e4e-bf59-4f06-b99b-4b739737f51b'; // Fondazione MEDA logo

        const SITE_SETTINGS_DOC_ID = 'siteSettings';

        // Firebase Service Instances
        let app, db, auth, storage, userId;
        // Expose auth to the window for debugging purposes
        window.auth = auth;

        // Global state for editing and file uploads
        let editingPublicationId = null;
        let editingNewsItemId = null;

        // Current file URLs/names for form management during edits and site settings
        let currentPubFiles = {
            coverUrl: '', coverFileName: '',
            pdfUrl: '', pdfFileName: '',
            abstracts: {
                ar: { text: '', url: '', fileName: '' },
                en: { text: '', url: '', fileName: '' },
                it: { text: '', url: '', fileName: '' }
            }
        };
        let currentNewsImage = { url: '', fileName: '' };
        let currentHeaderLogo = { url: DEFAULT_HEADER_LOGO_URL, fileName: '' };
        let currentFooterLogo = { url: DEFAULT_FOOTER_LOGO_URL, fileName: '', };
        let currentContributor1Logo = { url: DEFAULT_CONTRIB1_LOGO_URL, fileName: '' };
        let currentContributor2Logo = { url: DEFAULT_CONTRIB2_LOGO_URL, fileName: '' };

        // Paths to Firestore collections and Storage
        const PUBLIC_PUB_COLLECTION = `artifacts/${appId}/public/data/publications`;
        const PUBLIC_NEWS_COLLECTION = `artifacts/${appId}/public/data/news`;
        const PUBLIC_SETTINGS_COLLECTION = `artifacts/${appId}/public/data/siteSettings`; // Corrected path to siteSettings
        const STORAGE_PATH_COVERS = `artifacts/${appId}/public/files/covers`;
        const STORAGE_PATH_PDFS = `artifacts/${appId}/public/files/pdfs`;
        const STORAGE_PATH_ABSTRACTS = `artifacts/${appId}/public/files/abstracts`;
        const STORAGE_PATH_NEWS_IMAGES = `artifacts/${appId}/public/files/news`;
        const STORAGE_PATH_LOGOS = `artifacts/${appId}/public/files/logos`;

        // Global variable to hold all fetched publications
        let allPublications = [];

        // --- Translation Setup ---
        let currentLanguage = localStorage.getItem('siteLanguage') || 'en';

        const translations = {
            en: {
                pageTitle: "QAL - Publications", navAboutUs: "About Us", navEditorialBoard: "Editorial Board",
                navCurrentIssue: "Current Issue", navArchivalVolumes: "Archival Volumes", navEditorialEthics: "Editorial Guidelines & Ethics",
                navNewsEvents: "News & Events", adminLoginButton: "Admin Login", logoutButton: "Logout",
                searchPlaceholder: "Search...", sortYearNewest: "Year (Newest)", sortYearOldest: "Year (Oldest)",
                sortTitleAZ: "Title (A-Z)", sortTitleZA: "Title (Z-A)", sortAuthorAZ: "Author (A-Z)",
                sortAuthorZA: "Author (Z-A)", loadingPublications: "Loading publications...", noPubsFound: "No publications found.",
                noSearchResults: "No results match your search/filter criteria.", viewDetailsButton: "View Details",
                confirmDelete: "Confirm Delete", confirmDeleteMsg: "Are you sure you want to delete this item? This action cannot be undone and will remove associated files from storage.",
                successMessage: "Success", errorMessage: "Error", permissionDenied: "Permission Denied",
                loadingMessage: "Loading...", unavailable: "Unavailable", isbnLabel: "ISBN:", issnLabel: "ISSN:",
                downloadFullPdfBtn: "Download Full PDF", downloadArabicAbstractPdfBtn: "Download Arabic Abstract (PDF)",
                downloadEnglishAbstractPdfBtn: "Download English Abstract (PDF)", downloadItalianAbstractPdfBtn: "Download Italian Abstract (PDF)",
                arabicAbstractTextLabel: "Arabic Abstract (Text):", englishAbstractTextLabel: "English Abstract (Text):",
                italianAbstractTextLabel: "Italian Abstract (Text):", noDescription: "No description available.",
                pubDetailsNotFound: "Publication details not found.", fullPdfUnavailable: "Full PDF is not available.",
                arabicAbstractPdfUnavailable: "Arabic abstract PDF is not available.", englishAbstractPdfUnavailable: "English abstract PDF is not available.",
                italianAbstractPdfUnavailable: "Italian abstract PDF is not available.",
                aboutUsHeading: "About Quaderni di Archeologia della Libya",
                aboutUsPara1: "Welcome to the official website for <strong>Quaderni di Archeologia della Libya</strong>, a prestigious academic journal dedicated to archaeological research in Libya. Initiated in 1950, this esteemed series documents the significant contributions of Italian archaeological missions in the region, fostering a deeper understanding of its rich ancient history.",
                aboutUsPara2: "After a brief hiatus, the journal proudly resumed publication in 2018 with a new series, re-establishing itself as a leading scientific platform. We provide an essential venue for scholars interested in the archaeology and history of Libya and the broader Maghreb, ensuring high-quality, peer-reviewed content.",
                aboutUsPara3: "Our volumes embrace a multidisciplinary approach, featuring articles on epigraphy, ancient and colonial history, the history of archaeology, and territorial studies. Contributions are published in major European languages, complemented by comprehensive English and Arabic abstracts, to promote international academic exchange and collaboration.",
                aboutUsPara4: "This website serves as a dedicated resource for the series, maintained by L'Erma di Bretschneider, a renowned academic publishing house in Rome. We are committed to upholding the highest standards of scholarly excellence and ensuring the continued global dissemination of groundbreaking research presented in the \"Quaderni di Archeologia della Libya.\"",
                currentPublicationsHeading: "Current Publications", editorialBoardHeading: "Meet the Editorial Board",
                editorialBoardIntro: "Our journal is guided by a distinguished panel of scholars and experts in Libyan archaeology and related fields. Their expertise ensures the high quality and academic rigor of our publications.",
                editorInChief: "Editor-in-Chief", associateEditor: "Associate Editor", editorialBoardMember: "Editorial Board Member",
                editorialBoardComingSoon: "Full list of the editorial board and their biographies coming soon.",
                currentIssueHeading: "Current Issue", noCurrentIssue: "No current issue set yet. Check back soon!",
                archivalVolumesHeading: "Archival Volumes", archivalVolumesIntro: "Explore the rich history of archaeological research in Libya through our past publications. Browse by year or special issue below.",
                loadingArchivalVolumes: "Loading archival volumes...", editorialEthicsHeading: "Editorial Guidelines & Code of Ethics",
                editorialGuidelinesTitle: "Editorial Guidelines", articlesSubmittedTo: "Articles must be submitted to:",
                submissionProcedureTitle: "Submission Procedure:", submissionProcedure1: "Contributions should be sent in digital format .doc (Microsoft Word) as an e-mail attachment.",
                submissionProcedure2: "The contents will be reviewed by at least two anonymous readers and if necessary, will be returned to the author for eventual corrections and changes.",
                submissionProcedure3: "Only one set of proofs will be sent to the authors who are expected to correct and return them by the deadline set by the editors.",
                submissionProcedure4: "With regard to illustrations, a file including captions and photograph credits should be sent separately. The text should be accompanied by a digital copy of the images to be published (please, use WeTransfer if images are too heavy to be sent as email attachments).",
                submissionProcedure5: "The images must be in JPG or TIFF formats and at a minimum resolution of 300 dpi (pixel definition). All images submitted for publication should comply with the copyright rules and there must be an agreement (or a release form) about image reproduction by the copyright owner prior to publication. The author is sole responsible for securing such permits. No image without such accompanying documents will be published.",
                articleRequirementsTitle: "Article Requirements:", articleRequirements1: "An abstract of ca. 500 characters / 100 words in the language of the text and in English.",
                articleRequirements2: "Title in English.", articleRequirements3: "5 Keywords in Italian and English.",
                articleRequirements4: "Footnotes.", articleRequirements5: "Address and email address of the author.",
                articleRequirements6: "Institutional affiliation of the author.", formattingGuidelinesTitle: "Formatting Guidelines:",
                formattingGuidelines1: "Quotes are inserted within double quotation marks \"...\"", formattingGuidelines2: "Single quotation marks are used to emphasize specific words or expressions '...'.",
                formattingGuidelines3: "Transliterations from other languages (as, for example, from Greek or Arabic) are italicized.",
                formattingGuidelines4: "If special characters are used in the text (such as in the case of Greek), the font should be specified.",
                formattingGuidelines5: "Latin and Greek sources must be cited using the abbreviations in: Thesaurus Linguae Latinae, The Online Liddell-Scott-Jones Greek-English Lexicon (http://stephanus.tlg.uci.edu/lsj/01-authors_and_works.html) and, if not present, G.W.H. LAMPE, A Patristic Greek Lexicon, Oxford 1961.",
                commonAbbreviationsTitle: "Commonly-used Abbreviations:", abbrCat: "cat. = catalogue", abbrCf: "cf. = confer",
                abbrCm: "cm = centimeters", abbrCol: "col./cols = column/columns", abbrEAD: "EAD. (small caps) = Eadem",
                abbrEtc: "etc. = eccetera", abbrF: "f./ff. = following / followings", abbrFig: "fig./figs = figure / figures",
                abbrFol: "fol. / fols = folio / folios", abbrID: "ID. (small caps) = Idem", abbrIID: "IID. (small caps) = Iidem",
                abbrL: "l./ll. = line / lines", abbrNoInv: "No. inv. = inventory number", abbrM: "m = meters",
                abbrMs: "ms. / mss = manuscript / manuscripts", abbrNo: "no. / nos = number / numbers", abbrNd: "n.d. = no date",
                abbrNp: "n.p. = no place", abbrNote: "note = note", abbrP: "p./pp. = page/pages", abbrSee: "see = see",
                abbrSv: "s.v. (italics) = sub voce", abbrPl: "pl./pls = plate / plates", abbrVol: "vol. / vols = volume / volumes",
                fullGuidelinesNote: "Note: This is a summary of the full editorial guidelines. For complete bibliographic rules, please refer to the comprehensive document.",
                ethicsStatementTitle: "Code of Ethics and Malpractice Statement", ethicsStatementPara1: "This document outlines the ethics principles and good practices applied by the publishing house L'ERMA di Bretschneider (hereafter L'ERMA) to the process of editing and publishing monographs, scientific journals, and other editorial content of scientific, educational, and outreach nature. L'ERMA is inspired by the ethical principles outlined by the Committee on Publication Ethics (hereinafter COPE), an international non-profit organization that aims to support publishers and editors in pursuing high standards of publishing ethics. Although COPE mainly provides guidelines and resources for publishers and editors of scientific journals, these can also be applied to the publication of monographs and other academic content.",
                researchEthicsTitle: "I. Research ethics and integrity", researchEthicsPara1: "L'ERMA publications respect the ethical principles of COPE, which are: Reliability; honesty, respect, and responsibility in all aspects of research; Care, accuracy, and excellence in research practice; Transparency, reproducibility, traceability, and open communication; Attention and respect for all participants and research subjects.",
                researchEthicsPara2: "Whoever believes that research published by L'ERMA has not been conducted in line with these ethical practices is invited to raise the issue with the publisher at lerma@lerma.it. Where possible, each report will be handled following COPE guidelines, and/or by submitting the matter to the Chairman of the Board of Directors of the publishing house and, if necessary, to the members of the Editorial Board of the publishing house.",
                lastUpdatedDate: "Last updated 27 February 2024", newsEventsHeading: "News & Current Events",
                newsEventsIntro: "Stay updated with the latest news, discoveries, and announcements from Quaderni di Archeologia della Libya.",
                noNewsUpdates: "No news updates yet. Check back soon!", adminLoginHeading: "Admin Login",
                emailLabel: "Email:", passwordLabel: "Password:", loginButton: "Login",
                adminDashboardHeading: "Admin Dashboard", welcomeAdmin: "Welcome,", managePublicationsBtn: "Manage Publications",
                manageNewsBtn: "Manage News", manageSiteSettingsBtn: "Site Settings", addPublicationTitle: "Add New Publication",
                titleLabel: "Title:", authorsLabel: "Authors (comma-separated):", publicationYearLabel: "Publication Year:",
                descriptionLabel: "Description:", coverImageLabel: "Cover Image (Optional):",
                fullBookPdfLabel: "Full Book PDF (Optional - First 20 Pages):", arabicAbstractPdfLabel: "Arabic Abstract (PDF - Optional):",
                englishAbstractPdfLabel: "English Abstract (PDF - Optional):", italianAbstractPdfLabel: "Italian Abstract (PDF - Optional):",
                setCurrentIssueLabel: "Set as Current Issue", setArchivalVolumeLabel: "Set as Archival Volume", // New
                addPublicationButton: "Add Publication", updatePublicationButton: "Update Publication",
                cancelEditButton: "Cancel Edit", managePublicationsHeading: "Manage Existing Publications", tableHeaderTitle: "Title",
                tableHeaderAuthors: "Authors", tableHeaderYear: "Year", tableHeaderActions: "Actions",
                noPublicationsToManage: "No publications to manage.", addNewsItemTitle: "Add New News Item",
                newsTitleLabel: "News Title:", newsDescriptionLabel: "News Description:", newsImageLabel: "News Image (Optional):",
                addNewsItemButton: "Add News Item", updateNewsItemButton: "Update News Item", manageNewsHeading: "Manage Existing News",
                tableHeaderDate: "Date", noNewsToManage: "No news items to manage.", manageSiteLogosHeading: "Manage Site Logos",
                headerLogoUploadLabel: "Upload Header Logo:", footerLogoUploadLabel: "Upload Footer Logo:", updateLogosButton: "Update Logos",
                manageContributorLogosHeading: "Manage Contributor Logos", contributor1LogoLabel: "Upload L'ERMA Logo:",
                contributor2LogoLabel: "Upload Fondazione MEDA Logo:", updateContributorLogosButton: "Update Contributor Logos",
                copyrightText: "Quaderni di Archeologia della Libya. All rights reserved.", contactUsLabel: "Contact Us:",
                emailLabelShort: "Email:", phoneLabelShort: "Phone:", selectedLabel: "Selected", currentLabel: "Current",
                currentLabelShort: "Corrente", archivalLabelShort: "Archival", // New
                noCustomHeaderLogo: "No custom header logo.", noCustomFooterLogo: "No custom footer logo.",
                noLERMALogo: "No L'ERMA logo.", noMEDALogo: "No MEDA logo.", fileUploadFailed: "File upload failed: ",
                checkStorageRules: "Check Firebase Storage rules.", firebaseInitError: "An error occurred during Firebase initialization. Please check your console for details and ensure your Firebase config is correct.",
                viewNotFound: "View not found.", logoutSuccessful: "Logout successful!", logoutFailed: "Logout failed: ",
                invalidCredentials: "Invalid credentials. Please try again.", tooManyLoginAttempts: "Too many login attempts. Please try again later.",
                adminLoginSuccessful: "Admin login successful!", errorLoadingPublications: "Error loading publications. Check Firebase rules.",
                errorLoadingCurrentIssue: "Error loading current issue.", errorLoadingNews: "Error loading news.",
                errorLoadingAdminPublications: "Error loading admin publications.", noPermissionAddEditPublications: "You do not have permission to add/edit publications.",
                fillAllRequiredFields: "Please fill all required fields.", errorSavingPublication: "Error saving publication: ",
                publicationUpdated: "Publication updated successfully!", publicationAdded: "Publication added successfully!",
                publicationNotFoundForEdit: "Publication not found for editing.", errorLoadingPublicationForEdit: "Error loading publication for editing: ",
                publicationNotFoundForDeletion: "Publication not found for deletion.", errorDeletingPublication: "Error deleting publication: ",
                noPermissionAddNews: "You do not have permission to add news items.", newsItemUpdated: "News item updated successfully!",
                newsItemAdded: "News item added successfully!", errorSavingNewsItem: "Error saving news item: ",
                newsItemNotFoundForEdit: "News item not found for editing.", errorLoadingNewsItemForEdit: "Error loading news item for edit: ",
                newsItemNotFoundForDeletion: "News item not found for deletion.", errorDeletingNewsItem: "Error deleting news item: ",
                errorLoadingAdminNews: "Error loading admin news.", siteLogosNotFound: "Site logos not found in database. Using defaults.",
                couldNotLoadLogos: "Could not load site logos.", siteLogosUpdated: "Site logos updated successfully!",
                errorUpdatingLogos: "Error updating site logos: ", contributorLogosUpdated: "Contributor logos updated successfully!",
                errorUpdatingContributorLogos: "Error updating contributor logos: ", noPermissionUpdateSiteSettings: "You do not have permission to update site settings.",
                yesButton: "Yes", noButton: "No", okButton: "OK", editButton: "Edit", deleteButton: "Delete",
                noArabicAbstract: "No Arabic abstract text available.", noEnglishAbstract: "No English abstract text available.",
                noItalianAbstract: "No Italian abstract text available.", fileNotFoundInStorage: "File not found in storage: ", fileDeletionFailed: "File deletion failed: ",
                noTitle: "No Title", noAuthors: "No Authors", noYear: "No Year", publicationDeleted: "Publication deleted successfully!"
            },
            it: {
                pageTitle: "QAL - Pubblicazioni", navAboutUs: "Chi Siamo", navEditorialBoard: "Comitato Editoriale",
                navCurrentIssue: "Numero Corrente", navArchivalVolumes: "Volumi di Archivio", navEditorialEthics: "Linee Guida & Etica",
                navNewsEvents: "Notizie & Eventi", adminLoginButton: "Accesso Admin", logoutButton: "Esci",
                searchPlaceholder: "Cerca...", sortYearNewest: "Anno (Pi Recente)", sortYearOldest: "Anno (Meno Recente)",
                sortTitleAZ: "Titolo (A-Z)", sortTitleZA: "Titolo (Z-A)", sortAuthorAZ: "Autore (A-Z)",
                sortAuthorZA: "Autore (A-Z)", loadingPublications: "Caricamento pubblicazioni...", noPubsFound: "Nessuna pubblicazione trovata.",
                noSearchResults: "Nessun risultato corrisponde ai criteri di ricerca/filtro.", viewDetailsButton: "Vedi Dettagli",
                confirmDelete: "Conferma Eliminazione", confirmDeleteMsg: "Sei sicuro di voler eliminare questo elemento? Questa azione non pu essere annullata e rimuover i file associati dallo storage.",
                successMessage: "Successo", errorMessage: "Errore", permissionDenied: "Permesso Negato",
                loadingMessage: "Caricamento...", unavailable: "Non Disponibile", isbnLabel: "ISBN:", issnLabel: "ISSN:",
                downloadFullPdfBtn: "Scarica PDF Completo", downloadArabicAbstractPdfBtn: "Scarica Abstract Arabo (PDF)",
                downloadEnglishAbstractPdfBtn: "Scarica Abstract Inglese (PDF)", downloadItalianAbstractPdfBtn: "Scarica Abstract Italiano (PDF)",
                arabicAbstractTextLabel: "Abstract Arabo (Testo):", englishAbstractTextLabel: "Abstract Inglese (Testo):",
                italianAbstractTextLabel: "Abstract Italiano (Testo):", noDescription: "Nessuna descrizione disponibile.",
                pubDetailsNotFound: "Dettagli pubblicazione non trovati.", fullPdfUnavailable: "PDF completo non disponibile.",
                arabicAbstractPdfUnavailable: "Abstract arabo (PDF) non disponibile.", englishAbstractPdfUnavailable: "Abstract inglese (PDF) non disponibile.",
                italianAbstractPdfUnavailable: "Abstract italiano (PDF) non disponibile.",
                aboutUsHeading: "Chi Siamo Quaderni di Archeologia della Libya",
                aboutUsPara1: "Benvenuti nel sito ufficiale di <strong>Quaderni di Archeologia della Libya</strong>, una prestigiosa rivista accademica dedicata alla ricerca archeologica in Libia. Avviata nel 1950, questa stimata serie documenta i significativi contributi delle missioni archeologiche italiane nella regione, promuovendo una comprensione pi approfondita della sua ricca storia antica.",
                aboutUsPara2: "Dopo una breve pausa, la rivista ha ripreso con orgoglio la pubblicazione nel 2018 con una nuova serie, ristabilendosi come piattaforma scientifica di spicco. Forniamo un luogo essenziale per gli studiosi interessati all'archeologia e alla storia della Libia e del Maghreb pi ampio, garantendo contenuti di alta qualit e sottoposti a revisione paritaria.",
                aboutUsPara3: "I nostri volumi adottano un approccio multidisciplinare, presentando articoli su epigrafia, storia antica e coloniale, storia dell'archeologia, e studi territoriali. I contributi sono pubblicati nelle principali lingue europee, accompagnati da riassunti completi in inglese e arabo, per promuovere lo scambio accademico e la collaborazione internazionale.",
                aboutUsPara4: "Questo sito web funge da risorsa dedicata alla serie, gestita da L'Erma di Bretschneider, una rinomata casa editrice accademica di Roma. Ci impegniamo a mantenere i pi alti standard di eccellenza accademica e a garantire la continua diffusione globale della ricerca innovativa presentata nei \"Quaderni di Archeologia della Libya.\"",
                currentPublicationsHeading: "Pubblicazioni Correnti", editorialBoardHeading: "Incontra il Comitato Editoriale",
                editorialBoardIntro: "La nostra rivista  guidata da un illustre gruppo di studiosi ed esperti di archeologia libica e settori correlati. La loro competenza garantisce l'alta qualit e il rigore accademico delle nostre pubblicazioni.",
                editorInChief: "Capo Redattore", associateEditor: "Associato Redattore", editorialBoardMember: "Membro del Comitato Editoriale",
                editorialBoardComingSoon: "Lista completa del comitato editoriale e biografie in arrivo.",
                currentIssueHeading: "Numero Corrente", noCurrentIssue: "Nessun numero corrente impostato. Controlla presto!",
                archivalVolumesHeading: "Volumi di Archivio", archivalVolumesIntro: "Esplora la ricca storia della ricerca archeologica in Libia attraverso le nostre pubblicazioni passate. Sfoglia per anno o numero speciale qui sotto.",
                loadingArchivalVolumes: "Caricamento volumi di archivio...", editorialEthicsHeading: "Linee Guida Editoriali & Codice Etico",
                editorialGuidelinesTitle: "Linee Guida Editoriali", articlesSubmittedTo: "Gli articoli devono essere inviati a:",
                submissionProcedureTitle: "Procedura di Sottomissione:", submissionProcedure1: "I contributi devono essere inviati in formato digitale .doc (Microsoft Word) come allegato e-mail.",
                submissionProcedure2: "I contenuti saranno esaminati da almeno due revisori anonimi e, se necessario, restituiti all'autore per eventuali correzioni e modifiche.",
                submissionProcedure3: "Un solo set di bozze sar inviato agli autori che dovranno correggerle e restituirle entro la scadenza fissata dagli editori.",
                submissionProcedure4: "Con riguardo alle illustrazioni, un file contenente didascalie e crediti fotografici deve essere inviato separatamente. Il testo deve essere accompagnato da una copia digitale delle immagini da pubblicare (si prega di usare WeTransfer se le immagini sono troppo pesanti per essere inviate come allegati e-mail).",
                submissionProcedure5: "Le immagini devono essere in formato JPG o TIFF e con una risoluzione minima di 300 dpi (definizione pixel). Tutte le immagini inviate per la pubblicazione devono essere conformi alle norme sul copyright e deve esserci un accordo (o un modulo di liberatoria) sulla riproduzione dell'immagine da parte del titolare del copyright prima della pubblicazione. L'autore  l'unico responsabile dell'ottenimento di tali permessi. Nessuna immagine senza tali documenti di accompagnamento sar pubblicata.",
                articleRequirementsTitle: "Requisiti dell'Articolo:", articleRequirements1: "Un abstract di ca. 500 caratteri / 100 parole nella lingua del testo e in inglese.",
                articleRequirements2: "Titolo in inglese.", articleRequirements3: "5 Parole Chiave in italiano e inglese.",
                articleRequirements4: "Note a pi di pagina.", articleRequirements5: "Indirizzo e e-mail dell'autore.",
                articleRequirements6: "Affiliazione istituzionale dell'autore.", formattingGuidelinesTitle: "Linee Guida di Formattazione:",
                formattingGuidelines1: "Le citazioni sono inserite tra virgolette doppie \"...\"", formattingGuidelines2: "Le virgolette singole sono usate per enfatizzare parole o espressioni '...'.",
                formattingGuidelines3: "Le traslitterazioni da altre lingue (as, for example, from Greek or Arabic) are italicized.",
                formattingGuidelines4: "Se nel testo vengono usati caratteri speciali (come nel caso del greco), il font deve essere specificato.",
                formattingGuidelines5: "Latin and Greek sources must be cited using the abbreviations in: Thesaurus Linguae Latinae, The Online Liddell-Scott-Jones Greek-English Lexicon (http://stephanus.tlg.uci.edu/lsj/01-authors_and_works.html) and, if not present, G.W.H. LAMPE, A Patristic Greek Lexicon, Oxford 1961.",
                commonAbbreviationsTitle: "Abbreviazioni Comuni:", abbrCat: "cat. = catalogo", abbrCf: "cf. = confronta",
                abbrCm: "cm = centimetri", abbrCol: "col./coll. = colonna/colonne", abbrEAD: "EAD. (maiuscole) = Eadem",
                abbrEtc: "ecc. = eccetera", abbrF: "f./ff. = seguente / seguenti", abbrFig: "fig./figg. = figura / figure",
                abbrFol: "fol. / foll. = foglio / fogli", abbrID: "ID. (maiuscole) = Idem", abbrIID: "IID. (maiuscole) = Iidem",
                abbrL: "l./ll. = linea / linee", abbrNoInv: "N. inv. = numero inventario", abbrM: "m = metri",
                abbrMs: "ms. / mss = manoscritto / manoscritti", abbrNo: "n. / nn. = numero / numeri", abbrNd: "s.d. = senza data",
                abbrNp: "s.l. = senza luogo", abbrNote: "nota = nota", abbrP: "p./pp. = pagina/pagine", abbrSee: "vedi = vedi",
                abbrSv: "s.v. (corsivo) = sub voce", abbrPl: "tav./tavv. = tavola / tavole", abbrVol: "vol. / voll. = volume / volumi",
                fullGuidelinesNote: "Nota: Questo  un riassunto delle linee guida editoriali complete. Per le regole bibliografiche complete, si prega di fare riferimento al documento completo.",
                ethicsStatementTitle: "Codice Etico e Dichiarazione di Malpractice", ethicsStatementPara1: "This document outlines the ethics principles and good practices applied by the publishing house L'ERMA di Bretschneider (hereafter L'ERMA) to the process of editing and publishing monographs, scientific journals, and other editorial content of scientific, educational, and outreach nature. L'ERMA is inspired by the ethical principles outlined by the Committee on Publication Ethics (hereinafter COPE), an international non-profit organization that aims to support publishers and editors in pursuing high standards of publishing ethics. Although COPE mainly provides guidelines and resources for publishers and editors of scientific journals, these can also be applied to the publication of monographs and other academic content.",
                researchEthicsTitle: "I. Research ethics and integrity", researchEthicsPara1: "L'ERMA publications respect the ethical principles of COPE, which are: Reliability; honesty, respect, and responsibility in all aspects of research; Care, accuracy, and excellence in research practice; Transparency, reproducibility, traceability, and open communication; Attention and respect for all participants and research subjects.",
                researchEthicsPara2: "Whoever believes that research published by L'ERMA has not been conducted in line with these ethical practices is invited to raise the issue with the publisher at lerma@lerma.it. Where possible, each report will be handled following COPE guidelines, and/or by submitting the matter to the Chairman of the Board of Directors of the publishing house and, if necessary, to the members of the Editorial Board of the publishing house.",
                lastUpdatedDate: "Ultimo aggiornamento 27 febbraio 2024", newsEventsHeading: "Notizie & Eventi Correnti",
                newsEventsIntro: "Rimani aggiornato con le ultime notizie, scoperte e annunci di Quaderni di Archeologia della Libya.",
                noNewsUpdates: "Nessun aggiornamento di notizie. Controlla presto!", adminLoginHeading: "Accesso Admin",
                emailLabel: "Email:", passwordLabel: "Password:", loginButton: "Accedi",
                adminDashboardHeading: "Pannello di Amministrazione", welcomeAdmin: "Benvenuto,", managePublicationsBtn: "Gestisci Pubblicazioni",
                manageNewsBtn: "Gestisci Notizie", manageSiteSettingsBtn: "Impostazioni Sito", addPublicationTitle: "Aggiungi Nuova Pubblicazione",
                titleLabel: "Titolo:", authorsLabel: "Autori (separati da virgola):", publicationYearLabel: "Anno di Pubblicazione:",
                descriptionLabel: "Descrizione:", coverImageLabel: "Immagine di Copertina (Opzionale):",
                fullBookPdfLabel: "PDF Completo del Libro (Opzionale - Prime 20 Pagine):", arabicAbstractPdfLabel: "Abstract Arabo (PDF - Opzionale):",
                englishAbstractPdfLabel: "Abstract Inglese (PDF - Opzionale):", italianAbstractPdfLabel: "Abstract Italiano (PDF - Opzionale):",
                setCurrentIssueLabel: "Imposta come Numero Corrente", setArchivalVolumeLabel: "Imposta come Volume di Archivio", // New
                addPublicationButton: "Aggiungi Pubblicazione", updatePublicationButton: "Aggiorna Pubblicazione",
                cancelEditButton: "Annulla Modifica", managePublicationsHeading: "Gestisci Pubblicazioni Esistenti", tableHeaderTitle: "Titolo",
                tableHeaderAuthors: "Autori", tableHeaderYear: "Anno", tableHeaderActions: "Azioni",
                noPublicationsToManage: "Nessuna pubblicazione da gestire.", addNewsItemTitle: "Aggiungi Nuova Notizia",
                newsTitleLabel: "Titolo Notizia:", newsDescriptionLabel: "Descrizione Notizia:", newsImageLabel: "Immagine Notizia (Opzionale):",
                addNewsItemButton: "Aggiungi Notizia", updateNewsItemButton: "Aggiorna Notizia", manageNewsHeading: "Gestisci Notizie Esistenti",
                tableHeaderDate: "Data", noNewsToManage: "Nessun elemento di notizia da gestire.", manageSiteLogosHeading: "Gestisci Loghi del Sito",
                headerLogoUploadLabel: "Carica Logo Intestazione:", footerLogoUploadLabel: "Carica Logo Pi di Pagina:", updateLogosButton: "Aggiorna Loghi",
                manageContributorLogosHeading: "Gestisci Loghi Contributori", contributor1LogoLabel: "Carica Logo L'ERMA:",
                contributor2LogoLabel: "Carica Logo Fondazione MEDA:", updateContributorLogosButton: "Aggiorna Loghi Contributori",
                copyrightText: "Quaderni di Archeologia della Libya. Tutti i diritti riservati.", contactUsLabel: "Contattaci:",
                emailLabelShort: "Email:", phoneLabelShort: "Telefono:", selectedLabel: "Selezionato", currentLabel: "Attuale",
                currentLabelShort: "Corrente", archivalLabelShort: "Archivio", // New
                noCustomHeaderLogo: "Nessun logo intestazione personalizzato.", noCustomFooterLogo: "Nessun logo pi di pagina personalizzato.",
                noLERMALogo: "Nessun logo L'ERMA.", noMEDALogo: "Nessun logo MEDA.", fileUploadFailed: "Caricamento file fallito: ",
                checkStorageRules: "Controlla le regole di Firebase Storage.", firebaseInitError: "An error occurred during Firebase initialization. Please check your console for details and ensure your Firebase config is correct.",
                viewNotFound: "Vista non trovata.", logoutSuccessful: "Logout riuscito!", logoutFailed: "Logout fallito: ",
                invalidCredentials: "Credenziali non valide. Riprova.", tooManyLoginAttempts: "Troppi tentativi di accesso. Riprova pi tardi.",
                adminLoginSuccessful: "Accesso admin riuscito!", errorLoadingPublications: "Errore caricamento pubblicazioni. Controlla le regole di Firebase.",
                errorLoadingCurrentIssue: "Errore caricamento numero corrente.", errorLoadingNews: "Errore caricamento notizie.",
                errorLoadingAdminPublications: "Errore caricamento pubblicazioni admin.", noPermissionAddEditPublications: "Non hai il permesso di aggiungere/modificare pubblicazioni.",
                fillAllRequiredFields: "Compila tutti i campi richiesti.", errorSavingPublication: "Errore salvataggio pubblicazione: ",
                publicationUpdated: "Pubblicazione aggiornata con successo!", publicationAdded: "Pubblicazione aggiunta con successo!",
                publicationNotFoundForEdit: "Pubblicazione non trovata per modifica.", errorLoadingPublicationForEdit: "Errore caricamento pubblicazione per modifica: ",
                publicationNotFoundForDeletion: "Pubblicazione non trovata per eliminazione.", errorDeletingPublication: "Errore eliminazione pubblicazione: ",
                noPermissionAddNews: "Non hai il permesso di aggiungere notizie.", newsItemUpdated: "Notizia aggiornata con successo!",
                newsItemAdded: "Notizia aggiunta con successo!", errorSavingNewsItem: "Errore salvataggio notizia: ",
                newsItemNotFoundForEdit: "Notizia non trovata per modifica.", errorLoadingNewsItemForEdit: "Errore caricamento notizia per modifica: ",
                newsItemNotFoundForDeletion: "Notizia non trovata per eliminazione.", errorDeletingNewsItem: "Errore eliminazione notizia: ",
                errorLoadingAdminNews: "Errore caricamento notizie admin.", siteLogosNotFound: "Loghi sito non trovati nel database. Uso predefiniti.",
                couldNotLoadLogos: "Impossibile caricare i loghi del sito.", siteLogosUpdated: "Loghi sito aggiornati con successo!",
                errorUpdatingLogos: "Errore aggiornamento loghi sito: ", contributorLogosUpdated: "Loghi contributori aggiornati con successo!",
                errorUpdatingContributorLogos: "Errore aggiornamento loghi contributori: ", noPermissionUpdateSiteSettings: "Non hai il permesso di aggiornare le impostazioni del sito.",
                yesButton: "Yes", noButton: "No", okButton: "OK", editButton: "Edit", deleteButton: "Delete",
                noArabicAbstract: "Nessun abstract arabo disponibile.", noEnglishAbstract: "Nessun abstract inglese disponibile.",
                noItalianAbstract: "Nessun abstract italiano disponibile.", fileNotFoundInStorage: "File non trovato nello storage: ", fileDeletionFailed: "Eliminazione file fallita: ",
                noTitle: "No Title", noAuthors: "No Authors", noYear: "No Year", publicationDeleted: "Pubblicazione eliminata con successo!"
            }
        };

        // Function to apply translations
        function applyTranslations(lang) {
            console.log(`[Translations] Applying translations for language: ${lang}`);
            const elements = document.querySelectorAll('[data-lang-key]');
            elements.forEach(element => {
                const key = element.dataset.langKey;
                if (translations[lang] && translations[lang][key]) {
                    if (element.tagName === 'INPUT' && element.hasAttribute('placeholder')) {
                        element.placeholder = translations[lang][key];
                    } else if (element.tagName === 'OPTION') {
                        element.textContent = translations[lang][key];
                    } else {
                        element.innerHTML = translations[lang][key]; 
                    }
                }
            });
            document.querySelectorAll('.lang-button').forEach(button => {
                if (button.dataset.lang === lang) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
            currentLanguage = lang;
            localStorage.setItem('siteLanguage', lang);
            console.log(`[Translations] Current language set to: ${currentLanguage}`);
        }

        // Initialize Firebase App and Authentication
        async function initializeFirebase() {
            console.log("[Firebase Init] Starting Firebase initialization...");
            try {
                // Ensure firebaseConfig is an object
                const config = typeof firebaseConfig === 'string' ? JSON.parse(firebaseConfig) : firebaseConfig;
                
                app = initializeApp(config);             
                db = getFirestore(app);             
                auth = getAuth(app);               
                storage = getStorage(app);
                // Expose auth to the window object for debugging
                window.auth = auth;
                console.log("[Firebase Init] Firebase services initialized successfully.");

                // Listen for authentication state changes
                onAuthStateChanged(auth, async (user) => {
                    userId = user ? user.uid : null; 
                    const ADMIN_EMAIL_CORRECTED = 'charles.schwebs@lerma.it'; // Corrected admin email
                    const isAdmin = user && user.email === ADMIN_EMAIL_CORRECTED;
                    console.log(`[Auth State] User ID: ${userId}, Email: ${user ? user.email : 'N/A'}, Is Admin: ${isAdmin}`);

                    // Attempt to sign in anonymously if no user is present and no custom token
                    if (!user && !initialAuthToken) {
                        try {
                            await signInAnonymously(auth);
                            console.log("[Auth State] Signed in anonymously.");
                        } catch (anonError) {
                            console.error("[Auth State] Anonymous sign-in failed:", anonError);
                        }
                    } else if (initialAuthToken && !user) {
                         try {
                            await signInWithCustomToken(auth, initialAuthToken);
                            console.log("[Auth State] Signed in with custom token.");
                        } catch (tokenError) {
                            console.error("[Auth State] Custom token sign-in failed:", tokenError);
                        }
                    }


                    // Update the displayed email for logged-in user or clear it
                    const loggedInUserEmailElement = document.getElementById('loggedInUserEmail');
                    if (loggedInUserEmailElement) { // Add null check
                        loggedInUserEmailElement.textContent = user ? (user.email || 'Anonymous User') : '';
                    }
                    
                    // Update the displayed user ID in the footer
                    const currentUserIdElement = document.getElementById('currentUserId');
                    if (currentUserIdElement) { // Add null check
                        currentUserIdElement.textContent = userId || 'N/A';
                    }

                    updateAuthUI();
                    // Setup listeners ONLY after Firebase is fully initialized and auth state is known
                    setupListeners(); 
                    console.log("[Firebase Init] Firebase initialization complete and listeners setup initiated.");
                });
            } catch (error) {
                console.error("[Firebase Init] Firebase init error:", error);
                showMessageModal("errorMessage", "firebaseInitError", "error");
            }
        }

        // --- UI State Management & View Switching ---
        let currentView = 'aboutUs'; // Default public home page

        const views = {
            aboutUs: document.getElementById('aboutUsView'),
            editorialBoard: document.getElementById('editorialBoardView'),
            currentIssue: document.getElementById('currentIssueView'),
            archivalVolumes: document.getElementById('archivalVolumesView'),
            editorialAndEthics: document.getElementById('editorialAndEthicsView'),
            newsEvents: document.getElementById('newsEventsView'),
            adminLogin: document.getElementById('adminLoginView'),
            adminDashboard: document.getElementById('adminDashboardView')
        };

        function showView(viewId) {
            console.log(`[View Switch] Attempting to show view: ${viewId}`);
            // Hide all main views first
            Object.values(views).forEach(view => {
                if (view) view.classList.add('hidden'); // Ensure view exists
            });

            const targetView = views[viewId];
            if (targetView) {
                targetView.classList.remove('hidden');
                targetView.classList.add('flex'); // Ensure flex is applied if it's a block-level section that should flex
                currentView = viewId;
                console.log(`[View Switch] Successfully switched to view: ${currentView}`);

                // Apply admin-specific background
                document.body.classList.toggle('admin-bg', viewId === 'adminLogin' || viewId === 'adminDashboard');

                // Trigger specific display functions for views that need dynamic content
                // These are now primarily handled by the onSnapshot in setupListeners,
                // but direct calls ensure immediate update if view changes while data is static
                if (viewId === 'adminDashboard') {
                    // Default to publications management when entering dashboard
                    const adminManagePublications = document.getElementById('adminManagePublications');
                    const adminManageNews = document.getElementById('adminManageNews');
                    const adminManageSiteSettings = document.getElementById('adminManageSiteSettings');
                    if(adminManagePublications) adminManagePublications.classList.remove('hidden');
                    if(adminManageNews) adminManageNews.classList.add('hidden');
                    if(adminManageSiteSettings) adminManageSiteSettings.classList.add('hidden');
                    resetAddPublicationForm(); // Clear form when navigating to pubs management
                    listenForAdminPublications(); // Ensure the admin publications list is updated
                }
                
                // Re-display publications and news when switching views to ensure current data/filters
                // These calls ensure that if user navigates away and comes back, the data is refreshed
                // based on the current `allPublications` array (which is kept live by the `onSnapshot`)
                if (viewId === 'aboutUs') {
                    displayPublications(allPublications, 'publicationsList', 'non-archival');
                } else if (viewId === 'archivalVolumes') {
                    displayPublications(allPublications, 'archivalPublicationsList', 'archival');
                } else if (viewId === 'currentIssue') {
                    listenForCurrentIssue();
                } else if (viewId === 'newsEvents') {
                    listenForNews();
                }

            } else {
                console.warn("[View Switch] View not found:", viewId);
                showMessageModal("errorMessage", "viewNotFound", "error");
            }
        }

        // --- Event Listeners for Navigation ---
        document.querySelectorAll('.view-button').forEach(button => {
            button.addEventListener('click', (e) => {
                showView(e.target.dataset.view);
            });
        });

        // Language buttons
        document.querySelectorAll('.lang-button').forEach(button => {
            button.addEventListener('click', (e) => {
                applyTranslations(e.target.dataset.lang);
            });
        });

        // Admin login/logout buttons in footer
        document.getElementById('adminLoginBtnFooter').addEventListener('click', () => showView('adminLogin'));

        document.getElementById('adminLogoutBtn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                showMessageModal("successMessage", "logoutSuccessful", "success");
                showView('aboutUs'); // Redirect to public home on logout
            } catch (error) {
                console.error("[Auth] Error logging out:", error);
                showMessageModal("errorMessage", "logoutFailed" + error.message, "error");
            }
        });

        // Admin Dashboard Sub-navigation (within adminDashboardView)
        document.getElementById('managePublicationsBtn').addEventListener('click', () => {
            document.getElementById('adminManagePublications').classList.remove('hidden');
            document.getElementById('adminManageNews').classList.add('hidden');
            document.getElementById('adminManageSiteSettings').classList.add('hidden');
            resetAddPublicationForm(); // Reset publication form
            listenForAdminPublications(); // Ensure admin pubs list is active
        });
        document.getElementById('manageNewsBtn').addEventListener('click', () => {
            document.getElementById('adminManagePublications').classList.add('hidden');
            document.getElementById('adminManageNews').classList.remove('hidden');
            document.getElementById('adminManageSiteSettings').classList.add('hidden');
            resetAddNewsItemForm(); // Reset news form
            listenForAdminNews(); // Ensure news list updates
        });
        document.getElementById('manageSiteSettingsBtn').addEventListener('click', () => {
            document.getElementById('adminManagePublications').classList.add('hidden');
            document.getElementById('adminManageNews').classList.add('hidden');
            document.getElementById('adminManageSiteSettings').classList.remove('hidden');
            loadSiteLogosForAdmin(); // Load current logos when entering settings
        });

        // Function to update UI based on authentication status (Admin vs Public)
        function updateAuthUI() {
            const user = auth.currentUser;
            const ADMIN_EMAIL_CORRECTED = 'charles.schwebs@lerma.it'; // Corrected admin email
            const isAdmin = user && user.email === ADMIN_EMAIL_CORRECTED; 
            console.log(`[Auth] updateAuthUI called. Is Admin: ${isAdmin}, Current View: ${currentView}`);

            document.getElementById('adminLoginBtnFooter').classList.toggle('hidden', isAdmin);
            document.getElementById('adminLogoutBtn').classList.toggle('hidden', !isAdmin);

            if (isAdmin && currentView !== 'adminDashboard') {
                console.log("[Auth] Admin detected, switching to adminDashboard.");
                showView('adminDashboard');
            } else if (!isAdmin && currentView === 'adminDashboard') {
                console.log("[Auth] Not admin, but currently on adminDashboard. Redirecting to aboutUs.");
                showView('aboutUs'); 
            } else if (!user) { // If no user (anonymous), default to aboutUs
                console.log("[Auth] No user (anonymous). Defaulting to aboutUs.");
                showView('aboutUs');
            }
            // If user is not admin and currentView is already a public view, do nothing.
            console.log(`[Auth] updateAuthUI finished. Effective View: ${currentView}`);
        }

        // --- Admin Login Form Handling ---
        document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoadingSpinner();
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value; 
            const loginErrorMessage = document.getElementById('loginErrorMessage');
            loginErrorMessage.textContent = ''; // Clear previous error
            console.log(`[Auth] Attempting admin login for: ${email}`);

            try {
                await signInWithEmailAndPassword(auth, email, password);
                console.log("[Auth] Admin login successful.");
                // Directly redirect to admin dashboard without showing a modal
                showView('adminDashboard'); 
                document.getElementById('adminEmail').value = '';
                document.getElementById('adminPassword').value = '';
            } catch (error) {
                console.error("[Auth] Admin login error:", error);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    loginErrorMessage.textContent = translations[currentLanguage].invalidCredentials;
                } else if (error.code === 'auth/too-many-requests') {
                    loginErrorMessage.textContent = translations[currentLanguage].tooManyLoginAttempts;
                } else {
                    loginErrorMessage.textContent = translations[currentLanguage].errorMessage + ": " + error.message;
                }
            } finally {
                hideLoadingSpinner();
            }
        });

        // --- Firebase Firestore and Storage Operations ---

        function setupListeners() {
            if (!db) {
                console.error("[Listeners] Firestore not initialized, cannot set up listeners.");
                return;
            }
            console.log("[Listeners] Setting up Firestore listeners.");

            // Central listener for all publications
            onSnapshot(query(collection(db, PUBLIC_PUB_COLLECTION), orderBy("year", "desc")), (snapshot) => {
                allPublications = [];
                snapshot.forEach(doc => allPublications.push({ id: doc.id, ...doc.data() }));
                console.log(`[Firestore Data] allPublications updated. Total: ${allPublications.length}`, allPublications);
                
                // Update all relevant views AFTER allPublications is populated
                displayPublications(allPublications, 'publicationsList', 'non-archival'); // For About Us view
                displayPublications(allPublications, 'archivalPublicationsList', 'archival'); // For Archival Volumes view
                listenForCurrentIssue(); // Update Current Issue view based on latest data
                listenForAdminPublications(); // Update Admin list
            }, (error) => {
                console.error("[Firestore Error] Error listening to all publications:", error);
                showMessageModal("errorMessage", "errorLoadingPublications", "error");
            });

            listenForNews();
            listenForSiteLogos();

            const user = auth.currentUser;
            const ADMIN_EMAIL_CORRECTED = 'charles.schwebs@lerma.it'; // Corrected admin email
            const isAdmin = user && user.email === ADMIN_EMAIL_CORRECTED; 
            if (!isAdmin) { // If not admin, clear admin tables (they will be repopulated if admin logs in later)
                console.log("[Listeners] Not admin, clearing admin tables.");
                const adminPubsList = document.getElementById('adminPublicationsList');
                if (adminPubsList) adminPubsList.innerHTML = `<tr class="admin-table-row"><td colspan="4" class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" data-lang-key="noPublicationsToManage">${translations[currentLanguage].noPublicationsToManage}</td></tr>`;
                const adminNewsList = document.getElementById('adminNewsList');
                if (adminNewsList) adminNewsList.innerHTML = `<tr class="admin-table-row"><td colspan="3" class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" data-lang-key="noNewsToManage">${translations[currentLanguage].noNewsToManage}</td></tr>`;
            }
            console.log("[Listeners] All primary listeners configured.");
        }

        function getOriginalFileNameFromUnique(uniqueFileName) {
            if (!uniqueFileName) return '';
            const parts = uniqueFileName.split('_');
            if (parts.length > 1 && !isNaN(Number(parts[0]))) {
                parts.shift();
                return parts.join('_');
            }
            return uniqueFileName;
        }

        async function uploadFile(file, path) {
            if (!file) return { url: '', fileName: '' };
            console.log(`[File Upload] Attempting to upload: ${file.name} to ${path}`);

            const uniqueFileName = `${Date.now()}_${file.name}`;
            const storageRef = ref(storage, `${path}/${uniqueFileName}`);
            
            try {
                const snapshot = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                console.log(`[File Upload] Successfully uploaded: ${file.name}, URL: ${downloadURL}`);
                return { url: downloadURL, fileName: uniqueFileName };
            } catch (error) {
                console.error("[File Upload] Error uploading file:", file.name, "to path:", path, error);
                throw new Error(translations[currentLanguage].fileUploadFailed + file.name + ". " + translations[currentLanguage].checkStorageRules);
            }
        }

        async function deleteFile(uniqueFileName, path) {
            if (!uniqueFileName) return;
            console.log(`[File Deletion] Attempting to delete: ${uniqueFileName} from ${path}`);
            try {
                const fileRef = ref(storage, `${path}/${uniqueFileName}`);
                await deleteObject(fileRef);
                console.log("[File Deletion] Successfully deleted file:", uniqueFileName);
            } catch (error) {
                if (error.code === 'storage/object-not-found') {
                    console.warn(`[File Deletion] ${translations[currentLanguage].fileNotFoundInStorage}: ${uniqueFileName}`);
                } else {
                    console.error(`[File Deletion] ${translations[currentLanguage].fileDeletionFailed}: ${uniqueFileName}`, error);
                }
            }
        }

        // --- Site Logo Management ---
        function listenForSiteLogos() {
            const docRef = doc(db, PUBLIC_SETTINGS_COLLECTION, SITE_SETTINGS_DOC_ID);
            console.log("[Site Settings] Setting up listener for site logos.");
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log("[Site Settings] Site settings data received:", data);
                    currentHeaderLogo.url = data.headerLogoUrl || DEFAULT_HEADER_LOGO_URL;
                    currentHeaderLogo.fileName = data.headerLogoFileName || '';
                    currentFooterLogo.url = data.footerLogoUrl || DEFAULT_FOOTER_LOGO_URL;
                    currentFooterLogo.fileName = data.footerLogoFileName || '';
                    currentContributor1Logo.url = data.contributor1LogoUrl || DEFAULT_CONTRIB1_LOGO_URL;
                    currentContributor1Logo.fileName = data.contributor1LogoFileName || '';
                    currentContributor2Logo.url = data.contributor2LogoUrl || DEFAULT_CONTRIB2_LOGO_URL;
                    currentContributor2Logo.fileName = data.contributor2LogoFileName || '';
                } else {
                    console.log("[Site Settings] No site settings document found. Using default logos.");
                    // If no settings doc, use default URLs and empty fileNames
                    currentHeaderLogo = { url: DEFAULT_HEADER_LOGO_URL, fileName: '' };
                    currentFooterLogo = { url: DEFAULT_FOOTER_LOGO_URL, fileName: '' };
                    currentContributor1Logo = { url: DEFAULT_CONTRIB1_LOGO_URL, fileName: '' };
                    currentContributor2Logo = { url: DEFAULT_CONTRIB2_LOGO_URL, fileName: '' };
                }
                updateSiteLogosUI();
            }, (error) => {
                console.error("[Site Settings] Error listening for site logos:", error);
                // Fallback to defaults if there's an error fetching
                currentHeaderLogo = { url: DEFAULT_HEADER_LOGO_URL, fileName: '' };
                currentFooterLogo = { url: DEFAULT_FOOTER_LOGO_URL, fileName: '' };
                currentContributor1Logo = { url: DEFAULT_CONTRIB1_LOGO_URL, fileName: '' };
                currentContributor2Logo = { url: DEFAULT_CONTRIB2_LOGO_URL, fileName: '' };
                updateSiteLogosUI();
                showMessageModal("errorMessage", "couldNotLoadLogos", "error");
            });
        }

        function updateSiteLogosUI() {
            console.log("[Site Settings] Updating site logos UI.");
            const headerLogoElement = document.getElementById('headerLogo');
            if (headerLogoElement) headerLogoElement.src = currentHeaderLogo.url;
            
            const footerLogoElement = document.getElementById('footerLogo');
            if (footerLogoElement) footerLogoElement.src = currentFooterLogo.url;
            
            // Handle Contributor Logos dynamically (now updating existing img tags)
            const img1 = document.getElementById('contributor1Logo');
            const img2 = document.getElementById('contributor2Logo');

            if (img1) {
                img1.src = currentContributor1Logo.url;
            }
            if (img2) {
                img2.src = currentContributor2Logo.url;
            }

            // Update admin settings preview if on that page
            const adminPreviews = {
                header: { imgId: 'headerLogoPreview', textId: 'headerLogoFileNameDisplayAdmin', current: currentHeaderLogo, defaultUrl: DEFAULT_HEADER_LOGO_URL, noMsgKey: 'noCustomHeaderLogo' },
                footer: { imgId: 'footerLogoPreview', textId: 'footerLogoFileNameDisplayAdmin', current: currentFooterLogo, defaultUrl: DEFAULT_FOOTER_LOGO_URL, noMsgKey: 'noCustomFooterLogo' },
                contributor1: { imgId: 'contributor1LogoPreview', textId: 'contributor1FileNameDisplayAdmin', current: currentContributor1Logo, defaultUrl: DEFAULT_CONTRIB1_LOGO_URL, noMsgKey: 'noLERMALogo' },
                contributor2: { imgId: 'contributor2LogoPreview', textId: 'contributor2FileNameDisplayAdmin', current: currentContributor2Logo, defaultUrl: DEFAULT_CONTRIB2_LOGO_URL, noMsgKey: 'noMEDALogo' }
            };

            for (const key in adminPreviews) {
                const { imgId, textId, current, defaultUrl, noMsgKey } = adminPreviews[key];
                const imgEl = document.getElementById(imgId);
                const textEl = document.getElementById(textId);
                if (imgEl && textEl) {
                    imgEl.src = current.url;
                    // Display preview image if a custom one is set, or if it's a default, display as 'none' initially
                    imgEl.style.display = (current.url && current.url !== defaultUrl) ? 'block' : 'none';
                    textEl.textContent = current.fileName ? `${translations[currentLanguage].currentLabel}: ${getOriginalFileNameFromUnique(current.fileName)}` : translations[currentLanguage][noMsgKey];
                }
            }
        }

        function loadSiteLogosForAdmin() {
            console.log("[Site Settings] Loading site logos for admin view.");
            updateSiteLogosUI();
        }

        function handleLogoFileInput(inputElement, previewImgElement, fileNameDisplayElement, currentLogoState, defaultUrl, noMsgKey) {
            if (inputElement.files.length > 0) {
                const file = inputElement.files[0];
                fileNameDisplayElement.textContent = `${translations[currentLanguage].selectedLabel}: ${file.name}`;
                if (previewImgElement) {
                    const reader = new FileReader();
                    reader.onload = (event) => { previewImgElement.src = event.target.result; previewImgElement.style.display = 'block'; };
                    reader.readAsDataURL(file);
                }
            } else {
                fileNameDisplayElement.textContent = currentLogoState.fileName ? `${translations[currentLanguage].currentLabel}: ${getOriginalFileNameFromUnique(currentLogoState.fileName)}` : translations[currentLanguage][noMsgKey];
                if (previewImgElement) {
                    // Only show preview if there's a current URL that's not a default placeholder
                    previewImgElement.src = currentLogoState.url;
                    previewImgElement.style.display = (currentLogoState.url && currentLogoState.url !== defaultUrl) ? 'block' : 'none';
                }
            }
        }

        document.getElementById('headerLogoUpload').addEventListener('change', (e) => handleLogoFileInput(e.target, document.getElementById('headerLogoPreview'), document.getElementById('headerLogoFileNameDisplayAdmin'), currentHeaderLogo, DEFAULT_HEADER_LOGO_URL, 'noCustomHeaderLogo'));
        document.getElementById('footerLogoUpload').addEventListener('change', (e) => handleLogoFileInput(e.target, document.getElementById('footerLogoPreview'), document.getElementById('footerLogoFileNameDisplayAdmin'), currentFooterLogo, DEFAULT_FOOTER_LOGO_URL, 'noCustomFooterLogo'));
        document.getElementById('contributor1LogoUpload').addEventListener('change', (e) => handleLogoFileInput(e.target, document.getElementById('contributor1LogoPreview'), document.getElementById('contributor1FileNameDisplayAdmin'), currentContributor1Logo, DEFAULT_CONTRIB1_LOGO_URL, 'noLERMALogo'));
        document.getElementById('contributor2LogoUpload').addEventListener('change', (e) => handleLogoFileInput(e.target, document.getElementById('contributor2LogoPreview'), document.getElementById('contributor2FileNameDisplayAdmin'), currentContributor2Logo, DEFAULT_CONTRIB2_LOGO_URL, 'noMEDALogo'));


        document.getElementById('logoUploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoadingSpinner();
            const user = auth.currentUser;
            const ADMIN_EMAIL_CORRECTED = 'charles.schwebs@lerma.it'; // Corrected admin email
            if (!user || user.email !== ADMIN_EMAIL_CORRECTED) { 
                showMessageModal("permissionDenied", "noPermissionUpdateSiteSettings", "error");
                hideLoadingSpinner();
                return;
            }
            console.log("[Site Settings] Submitting main logo update form.");

            const headerFile = document.getElementById('headerLogoUpload').files[0];
            const footerFile = document.getElementById('footerLogoUpload').files[0];

            let newHeaderLogo = { ...currentHeaderLogo };
            let newFooterLogo = { ...currentFooterLogo };

            try {
                if (headerFile) {
                    if (currentHeaderLogo.fileName && currentHeaderLogo.url !== DEFAULT_HEADER_LOGO_URL) {
                        await deleteFile(currentHeaderLogo.fileName, STORAGE_PATH_LOGOS);
                    }
                    newHeaderLogo = await uploadFile(headerFile, STORAGE_PATH_LOGOS);
                } else if (!headerFile && currentHeaderLogo.fileName) { 
                    newHeaderLogo = { ...currentHeaderLogo }; 
                } else { 
                    newHeaderLogo = { url: DEFAULT_HEADER_LOGO_URL, fileName: '' }; 
                }

                if (footerFile) {
                    if (currentFooterLogo.fileName && currentFooterLogo.url !== DEFAULT_FOOTER_LOGO_URL) {
                        await deleteFile(currentFooterLogo.fileName, STORAGE_PATH_LOGOS);
                    }
                    newFooterLogo = await uploadFile(footerFile, STORAGE_PATH_LOGOS);
                } else if (!footerFile && currentFooterLogo.fileName) { 
                    newFooterLogo = { ...currentFooterLogo }; 
                } else { 
                    newFooterLogo = { url: DEFAULT_FOOTER_LOGO_URL, fileName: '' }; 
                }


                await setDoc(doc(db, PUBLIC_SETTINGS_COLLECTION, SITE_SETTINGS_DOC_ID), {
                    headerLogoUrl: newHeaderLogo.url,
                    headerLogoFileName: newHeaderLogo.fileName,
                    footerLogoUrl: newFooterLogo.url,
                    footerLogoFileName: newFooterLogo.fileName,
                    updatedAt: new Date().toISOString()
                }, { merge: true });

                showMessageModal("successMessage", "siteLogosUpdated", "success");
                currentHeaderLogo = newHeaderLogo;
                currentFooterLogo = newFooterLogo;
                updateSiteLogosUI();
                document.getElementById('headerLogoUpload').value = '';
                document.getElementById('footerLogoUpload').value = '';
                console.log("[Site Settings] Main logos updated in Firestore and UI.");

            } catch (error) {
                console.error("[Site Settings] Error updating site logos:", error);
                showMessageModal("errorMessage", "errorUpdatingLogos" + error.message, "error");
            } finally {
                hideLoadingSpinner();
            }
        });

        document.getElementById('contributorLogoUploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoadingSpinner();
            const user = auth.currentUser;
            const ADMIN_EMAIL_CORRECTED = 'charles.schwebs@lerma.it'; // Corrected admin email
            if (!user || user.email !== ADMIN_EMAIL_CORRECTED) { 
                showMessageModal("permissionDenied", "noPermissionUpdateSiteSettings", "error");
                hideLoadingSpinner();
                return;
            }
            console.log("[Site Settings] Submitting contributor logo update form.");

            const contributor1File = document.getElementById('contributor1LogoUpload').files[0];
            const contributor2File = document.getElementById('contributor2LogoUpload').files[0];

            let newContributor1Logo = { ...currentContributor1Logo };
            let newContributor2Logo = { ...currentContributor2Logo };

            try {
                if (contributor1File) {
                    if (currentContributor1Logo.fileName && currentContributor1Logo.url !== DEFAULT_CONTRIB1_LOGO_URL) {
                        await deleteFile(currentContributor1Logo.fileName, STORAGE_PATH_LOGOS);
                    }
                    newContributor1Logo = await uploadFile(contributor1File, STORAGE_PATH_LOGOS);
                } else if (!contributor1File && currentContributor1Logo.fileName) {
                    newContributor1Logo = { ...currentContributor1Logo };
                } else {
                    newContributor1Logo = { url: '', fileName: '' }; // Set to empty string for db to know it's "unset"
                }

                if (contributor2File) {
                    if (currentContributor2Logo.fileName && currentContributor2Logo.url !== DEFAULT_CONTRIB2_LOGO_URL) {
                        await deleteFile(currentContributor2Logo.fileName, STORAGE_PATH_LOGOS);
                    }
                    newContributor2Logo = await uploadFile(contributor2File, STORAGE_PATH_LOGOS);
                } else if (!contributor2File && currentContributor2Logo.fileName) {
                    newContributor2Logo = { ...currentContributor2Logo };
                } else {
                    newContributor2Logo = { url: '', fileName: '' }; // Set to empty string for db to know it's "unset"
                }

                await setDoc(doc(db, PUBLIC_SETTINGS_COLLECTION, SITE_SETTINGS_DOC_ID), {
                    contributor1LogoUrl: newContributor1Logo.url,
                    contributor1LogoFileName: newContributor1Logo.fileName,
                    contributor2LogoUrl: newContributor2Logo.url,
                    contributor2LogoFileName: newContributor2Logo.fileName,
                    updatedAt: new Date().toISOString()
                }, { merge: true });

                showMessageModal("successMessage", "contributorLogosUpdated", "success");
                currentContributor1Logo = newContributor1Logo;
                currentContributor2Logo = newContributor2Logo;
                updateSiteLogosUI();
                document.getElementById('contributor1LogoUpload').value = '';
                document.getElementById('contributor2LogoUpload').value = '';
                console.log("[Site Settings] Contributor logos updated in Firestore and UI.");

            } catch (error) {
                console.error("[Site Settings] Error updating contributor logos:", error);
                showMessageModal("errorMessage", "errorUpdatingContributorLogos" + error.message, "error");
            } finally {
                hideLoadingSpinner();
            }
        });


        function displayPublications(publications, containerId, filterType) {
            console.log(`[Display Pubs] displayPublications called for container: ${containerId}, filterType: ${filterType}`);
            const container = document.getElementById(containerId);
            if (!container) {
                console.warn(`[Display Pubs] Container not found: ${containerId}`);
                return;
            }

            container.innerHTML = ''; // Clear previous books

            const searchTerm = document.getElementById('publicationSearch').value.toLowerCase();
            const sortBy = document.getElementById('sortPublications').value;

            let filteredPublications = publications.filter(pub => {
                const titleMatch = (pub.title || '').toLowerCase().includes(searchTerm);
                const authorsMatch = (pub.authors || '').toLowerCase().includes(searchTerm);
                const yearMatch = String(pub.year || '').includes(searchTerm);
                const descriptionMatch = (pub.description || '').toLowerCase().includes(searchTerm);
                const isbnMatch = (pub.isbn || '').toLowerCase().includes(searchTerm);
                const issnMatch = (pub.issn || '').toLowerCase().includes(searchTerm);
                const abstractArMatch = (pub.abstracts?.ar?.text || '').toLowerCase().includes(searchTerm);
                const abstractEnMatch = (pub.abstracts?.en?.text || '').toLowerCase().includes(searchTerm);
                const abstractItMatch = (pub.abstracts?.it?.text || '').toLowerCase().includes(searchTerm);

                let meetsFilterType = true;
                if (filterType === 'non-archival') {
                    // Non-archival publications are those NOT marked as archival, AND NOT set as current issue
                    meetsFilterType = !(pub.isArchivalVolume === true) && !(pub.isCurrentIssue === true);
                    console.log(`[Display Pubs] Pub "${pub.title}" - isArchivalVolume: ${pub.isArchivalVolume}, isCurrentIssue: ${pub.isCurrentIssue}, Meets non-archival filter: ${meetsFilterType}`);
                } else if (filterType === 'archival') {
                    meetsFilterType = (pub.isArchivalVolume === true);
                    console.log(`[Display Pubs] Pub "${pub.title}" - isArchivalVolume: ${pub.isArchivalVolume}, Meets archival filter: ${meetsFilterType}`);
                }
                
                return (titleMatch || authorsMatch || yearMatch || descriptionMatch || isbnMatch || issnMatch ||
                       abstractArMatch || abstractEnMatch || abstractItMatch) && meetsFilterType;
            });

            console.log(`[Display Pubs] Filtered publications for ${containerId} (${filterType}):`, filteredPublications);

            if (filteredPublications.length === 0) {
                const noResultsKey = containerId === 'publicationsList' ? 'noPubsFound' : 'noSearchResults'; 
                container.innerHTML = `<p class="col-span-full text-center text-gray-400" data-lang-key="${noResultsKey}">${translations[currentLanguage][noResultsKey]}</p>`;
                console.log(`[Display Pubs] No filtered publications for ${containerId}. Displaying "No results" message.`);
                return;
            }

            // Apply sorting
            filteredPublications.sort((a, b) => {
                switch (sortBy) {
                    case 'year-desc':
                        return (b.year || 0) - (a.year || 0);
                    case 'year-asc':
                        return (a.year || 0) - (b.year || 0);
                    case 'title-asc':
                        return (a.title || '').localeCompare(b.title || '');
                    case 'title-desc':
                        return (b.title || '').localeCompare(a.title || '');
                    case 'author-asc':
                        return (a.authors || '').localeCompare(b.authors || '');
                    case 'author-desc':
                        return (b.authors || '').localeCompare(a.authors || '');
                    default:
                        return 0;
                }
            });

            filteredPublications.forEach(book => {
                const bookCard = document.createElement('div');
                bookCard.className = 'publication-card p-4 flex flex-col items-center text-center';
                bookCard.innerHTML = `
                    <img src="${book.coverImageUrl || 'https://placehold.co/400x600/e0e2e5/3f4245?text=No+Image'}" alt="${(book.title || 'No Title')} Cover" class="cover-image rounded-md mb-4">
                    <h3 class="text-xl font-bold mb-2 text-gray-800">${book.title || translations[currentLanguage].noTitle}</h3>
                    <p class="text-gray-700 mb-1">${book.authors || translations[currentLanguage].noAuthors}</p>
                    <p class="text-gray-600 text-sm font-medium">${book.year || translations[currentLanguage].noYear}</p>
                    <p class="text-gray-700 text-sm mt-2 flex-grow overflow-hidden line-clamp-3">${book.description || translations[currentLanguage].noDescription}</p>
                    <button class="nav-button text-sm mt-4 view-publication-details" data-id="${book.id}" data-lang-key="viewDetailsButton">${translations[currentLanguage].viewDetailsButton}</button>
                `;
                container.appendChild(bookCard);
            });

            container.querySelectorAll('.view-publication-details').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const bookId = e.target.dataset.id;
                    const docRef = doc(db, PUBLIC_PUB_COLLECTION, bookId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        showPublicationDetailsModal(docSnap.data());
                    } else {
                        showMessageModal("errorMessage", "pubDetailsNotFound", "error");
                    }
                });
            });
            console.log(`[Display Pubs] Publications rendered for ${containerId}.`);
        }

        document.getElementById('publicationSearch').addEventListener('input', () => {
            console.log(`[Search] Search term changed to: ${document.getElementById('publicationSearch').value}`);
            // Re-trigger display based on current view to apply search filter
            showView(currentView);
        });
        document.getElementById('sortPublications').addEventListener('change', () => {
            console.log(`[Sort] Sort order changed to: ${document.getElementById('sortPublications').value}`);
            // Re-trigger display based on current view to apply sort
            showView(currentView);
        });

        function listenForCurrentIssue() {
            console.log("[Current Issue] Checking for current issue.");
            // Filter allPublications to find the one marked as current issue
            const currentBook = allPublications.find(pub => pub.isCurrentIssue === true);

            const currentIssueContentDiv = document.getElementById('currentIssueContent');
            const currentIssuePublicationCard = document.getElementById('currentIssuePublicationCard');
            
            // Hide the "No current issue" message and the card initially
            if (currentIssueContentDiv) currentIssueContentDiv.querySelector('p[data-lang-key="noCurrentIssue"]').classList.remove('hidden');
            if (currentIssuePublicationCard) currentIssuePublicationCard.classList.add('hidden');

            if (currentBook) {
                console.log("[Current Issue] Found current issue:", currentBook);
                if (currentIssueContentDiv) currentIssueContentDiv.querySelector('p[data-lang-key="noCurrentIssue"]').classList.add('hidden'); // Hide the "No current issue" message
                if (currentIssuePublicationCard) currentIssuePublicationCard.classList.remove('hidden');
                
                const currentIssueCover = document.getElementById('currentIssueCover');
                if (currentIssueCover) currentIssueCover.src = currentBook.coverImageUrl || 'https://placehold.co/400x600/e0e2e5/3f4245?text=No+Image';
                const currentIssueTitle = document.getElementById('currentIssueTitle');
                if (currentIssueTitle) currentIssueTitle.textContent = currentBook.title || translations[currentLanguage].noTitle;
                const currentIssueAuthors = document.getElementById('currentIssueAuthors');
                if (currentIssueAuthors) currentIssueAuthors.textContent = currentBook.authors || translations[currentLanguage].noAuthors;
                const currentIssueYear = document.getElementById('currentIssueYear');
                if (currentIssueYear) currentIssueYear.textContent = currentBook.year || translations[currentLanguage].noYear;
                const currentIssueDescription = document.getElementById('currentIssueDescription');
                if (currentIssueDescription) currentIssueDescription.textContent = currentBook.description || translations[currentLanguage].noDescription;

                const updateDownloadBtn = (btnId, url, unavailableKey) => {
                    const btn = document.getElementById(btnId);
                    if (btn) { // Ensure button exists before manipulating
                        btn.href = url || '#';
                        btn.classList.toggle('disabled', !url);
                        btn.onclick = url ? null : (e) => { e.preventDefault(); showMessageModal("unavailable", unavailableKey, "alert"); };
                    }
                };
                updateDownloadBtn('currentIssueDownloadPdfBtn', currentBook.pdfUrl, 'fullPdfUnavailable');
                updateDownloadBtn('currentIssueDownloadAbstractArBtn', currentBook.abstracts?.ar?.url, 'arabicAbstractPdfUnavailable');
                updateDownloadBtn('currentIssueDownloadAbstractEnBtn', currentBook.abstracts?.en?.url, 'englishAbstractPdfUnavailable');
                updateDownloadBtn('currentIssueDownloadAbstractItBtn', currentBook.abstracts?.it?.url, 'italianAbstractPdfUnavailable');

            } else {
                console.log("[Current Issue] No current issue found.");
            }
        }

        function listenForNews() {
            console.log("[News] Setting up listener for news items.");
            const q = query(collection(db, PUBLIC_NEWS_COLLECTION), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                const newsFeedDiv = document.getElementById('newsFeed');
                if (!newsFeedDiv) { console.warn("[News] newsFeedDiv not found."); return; }
                newsFeedDiv.innerHTML = '';
                console.log(`[News] News snapshot received. Number of documents: ${snapshot.size}`);

                if (snapshot.empty) {
                    newsFeedDiv.innerHTML = `<p class="col-span-full text-center text-gray-400" data-lang-key="noNewsUpdates">${translations[currentLanguage].noNewsUpdates}</p>`;
                    console.log("[News] No news items found.");
                    return;
                }

                snapshot.forEach(doc => {
                    const news = { id: doc.id, ...doc.data() };
                    const newsItemHtml = `
                        <div class="bg-gray-100 p-6 rounded-lg shadow-md border border-gray-200">
                            ${news.imageUrl ? `<img src="${news.imageUrl}" alt="${news.title}" class="w-full h-48 object-cover rounded-md mb-4 shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/400x200/cccccc/333333?text=No+Image';">` : ''}
                            <h3 class="text-xl font-bold mb-2 text-gray-800">${news.title}</h3>
                            <p class="text-gray-700 text-sm mb-3">${new Date(news.timestamp).toLocaleDateString(currentLanguage === 'it' ? 'it-IT' : 'en-US')}</p>
                            <p class="text-gray-700 text-base">${news.description}</p>
                        </div>
                    `;
                    newsFeedDiv.innerHTML += newsItemHtml;
                });
                console.log("[News] News items rendered.");
            }, (error) => {
                console.error("[News Error] Error listening to news:", error);
                showMessageModal("errorMessage", "errorLoadingNews", "error");
            });
        }


        function listenForAdminPublications() {
            console.log("[Admin Pubs] Updating admin publications list.");
            const adminPublicationsListBody = document.getElementById('adminPublicationsList');
            if (!adminPublicationsListBody) { console.warn("[Admin Pubs] adminPublicationsListBody not found."); return; }
            adminPublicationsListBody.innerHTML = '';

            if (allPublications.length === 0) {
                adminPublicationsListBody.innerHTML = `<tr class="admin-table-row"><td colspan="4" class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" data-lang-key="noPublicationsToManage">${translations[currentLanguage].noPublicationsToManage}</td></tr>`;
                console.log("[Admin Pubs] No publications in allPublications array to display in admin table.");
                return;
            }

            allPublications.forEach(book => {
                const row = adminPublicationsListBody.insertRow();
                row.className = 'admin-table-row';
                const isCurrentIssueIndicator = book.isCurrentIssue ? `<span class="ml-2 px-2 py-1 bg-blue-400 text-white text-xs font-semibold rounded-full" data-lang-key="currentLabelShort">${translations[currentLanguage].currentLabelShort}</span>` : '';
                const isArchivalVolumeIndicator = book.isArchivalVolume ? `<span class="ml-2 px-2 py-1 bg-purple-400 text-white text-xs font-semibold rounded-full" data-lang-key="archivalLabelShort">${translations[currentLanguage].archivalLabelShort || 'Archival'}</span>` : ''; // Added archival indicator

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${book.title || translations[currentLanguage].noTitle}${isCurrentIssueIndicator}${isArchivalVolumeIndicator}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${book.authors || translations[currentLanguage].noAuthors}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${book.year || translations[currentLanguage].noYear}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex space-x-2">
                        <button class="text-blue-600 hover:text-blue-800 edit-publication-button admin-button" data-id="${book.id}" data-lang-key="editButton">${translations[currentLanguage].editButton}</button>
                        <button class="text-red-600 hover:text-red-800 delete-publication-button admin-button" data-id="${book.id}" data-lang-key="deleteButton">${translations[currentLanguage].deleteButton}</button>
                    </td>
                `;
            });
            console.log(`[Admin Pubs] Admin table populated with ${allPublications.length} publications.`);

            document.querySelectorAll('.edit-publication-button').forEach(button => {
                button.addEventListener('click', (e) => editPublication(e.target.dataset.id));
            });
            document.querySelectorAll('.delete-publication-button').forEach(button => {
                button.addEventListener('click', (e) => confirmDeletePublication(e.target.dataset.id));
            });
        }


        // Add/Update Publication Form Elements
        const bookTitleInput = document.getElementById('bookTitle');
        const bookAuthorsInput = document.getElementById('bookAuthors');
        const bookYearInput = document.getElementById('bookYear');
        const bookDescriptionInput = document.getElementById('bookDescription');
        const bookISBNInput = document.getElementById('bookISBN');
        const bookISSNInput = document.getElementById('bookISSN');
        const abstractArTextInput = document.getElementById('abstractArText');
        const abstractEnTextInput = document.getElementById('abstractEnText');
        const abstractItTextInput = document.getElementById('abstractItText');
        const bookIsCurrentIssueCheckbox = document.getElementById('bookIsCurrentIssue');
        const bookIsArchivalVolumeCheckbox = document.getElementById('bookIsArchivalVolume'); // New checkbox
        const bookCoverInput = document.getElementById('bookCover');
        const bookPdfInput = document.getElementById('bookPdf');
        const abstractArPdfInput = document.getElementById('abstractArPdf');
        const abstractEnPdfInput = document.getElementById('abstractEnPdf');
        const abstractItPdfInput = document.getElementById('abstractItPdf');

        const adminFormTitle = document.getElementById('adminFormTitle');
        const submitPublicationBtn = document.getElementById('submitPublicationBtn');
        const cancelEditPublicationBtn = document.getElementById('cancelEditPublicationBtn');

        const uploadedCoverPreviewAdmin = document.getElementById('uploadedCoverPreviewAdmin');
        const coverImageFileNameDisplayAdmin = document.getElementById('coverImageFileNameDisplayAdmin');
        const pdfFileNameDisplayAdmin = document.getElementById('pdfFileNameDisplayAdmin');
        const abstractArPdfFileNameDisplayAdmin = document.getElementById('abstractArPdfFileNameDisplayAdmin');
        const abstractEnPdfFileNameDisplayAdmin = document.getElementById('abstractEnPdfFileNameDisplayAdmin');
        const abstractItPdfFileNameDisplayAdmin = document.getElementById('abstractItPdfFileNameDisplayAdmin');


        document.getElementById('addPublicationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoadingSpinner();
            const user = auth.currentUser;
            const ADMIN_EMAIL_CORRECTED = 'charles.schwebs@lerma.it'; // Corrected admin email
            if (!user || user.email !== ADMIN_EMAIL_CORRECTED) { 
                showMessageModal("permissionDenied", "noPermissionAddEditPublications", "error");
                hideLoadingSpinner();
                return;
            }
            console.log(`[Publication Form] Submitting publication form. Editing ID: ${editingPublicationId}`);

            const title = bookTitleInput.value.trim();
            const authors = bookAuthorsInput.value.trim();
            const year = bookYearInput.value ? parseInt(bookYearInput.value, 10) : null; 
            const description = bookDescriptionInput.value.trim();
            const isbn = bookISBNInput.value.trim();
            const issn = bookISSNInput.value.trim();
            const abstractArText = abstractArTextInput.value.trim();
            const abstractEnText = abstractEnTextInput.value.trim();
            const abstractItText = abstractItTextInput.value.trim();
            const isCurrentIssue = bookIsCurrentIssueCheckbox.checked;
            const isArchivalVolume = bookIsArchivalVolumeCheckbox.checked; 

            try {
                const uploadAndUpdateFile = async (fileInput, currentFileName, storagePath) => {
                    let newFileName = currentFileName;
                    let newUrl = null; 

                    if (fileInput.files[0]) {
                        if (currentFileName) { 
                            await deleteFile(currentFileName, storagePath);
                        }
                        const uploadResult = await uploadFile(fileInput.files[0], storagePath);
                        newFileName = uploadResult.fileName;
                        newUrl = uploadResult.url;
                    } else { 
                         // If no new file selected, retain old URL/filename from currentPubFiles state
                         if (storagePath === STORAGE_PATH_COVERS) newUrl = currentPubFiles.coverUrl;
                         else if (storagePath === STORAGE_PATH_PDFS) newUrl = currentPubFiles.pdfUrl;
                         else if (storagePath === STORAGE_PATH_ABSTRACTS && fileInput === abstractArPdfInput) newUrl = currentPubFiles.abstracts.ar.url;
                         else if (storagePath === STORAGE_PATH_ABSTRACTS && fileInput === abstractEnPdfInput) newUrl = currentPubFiles.abstracts.en.url;
                         else if (storagePath === STORAGE_PATH_ABSTRACTS && fileInput === abstractItPdfInput) newUrl = currentPubFiles.abstracts.it.url;
                         newFileName = currentFileName; 
                    }
                    console.log(`[Publication Form] File processing for ${fileInput.id}: newUrl=${newUrl}, newFileName=${newFileName}`);
                    return { url: newUrl, fileName: newFileName };
                };

                const coverResult = await uploadAndUpdateFile(bookCoverInput, currentPubFiles.coverFileName, STORAGE_PATH_COVERS);
                const pdfResult = await uploadAndUpdateFile(bookPdfInput, currentPubFiles.pdfFileName, STORAGE_PATH_PDFS);
                const abstractArResult = await uploadAndUpdateFile(abstractArPdfInput, currentPubFiles.abstracts.ar.fileName, STORAGE_PATH_ABSTRACTS);
                const abstractEnResult = await uploadAndUpdateFile(abstractEnPdfInput, currentPubFiles.abstracts.en.fileName, STORAGE_PATH_ABSTRACTS);
                const abstractItResult = await uploadAndUpdateFile(abstractItPdfInput, currentPubFiles.abstracts.it.fileName, STORAGE_PATH_ABSTRACTS);

                // Prepare data for Firestore
                const publicationData = {
                    title: title || '', 
                    authors: authors || '',
                    year: year, 
                    description: description || '',
                    isbn: isbn || '',
                    issn: issn || '',
                    abstracts: {
                        ar: { text: abstractArText || '', url: abstractArResult.url || '', fileName: abstractArResult.fileName || '' },
                        en: { text: abstractEnText || '', url: abstractEnResult.url || '', fileName: abstractEnResult.fileName || '' },
                        it: { text: abstractItText || '', url: abstractItResult.url || '', fileName: abstractItResult.fileName || '' }
                    },
                    coverImageUrl: coverResult.url || '', 
                    coverImageFileName: coverResult.fileName || '',
                    pdfUrl: pdfResult.url || '', 
                    pdfFileName: pdfResult.fileName || '',
                    isCurrentIssue,
                    isArchivalVolume, 
                    timestamp: new Date().toISOString()
                };
                console.log("[Publication Form] Prepared publication data:", publicationData);
                
                // If this is set as the current issue, unset previous current issues
                if (isCurrentIssue) {
                    console.log("[Publication Form] Setting as current issue. Unsetting previous current issues.");
                    const currentIssueQuery = query(collection(db, PUBLIC_PUB_COLLECTION), where("isCurrentIssue", "==", true));
                    const currentIssuesSnapshot = await getDocs(currentIssueQuery);
                    for (const docToUnset of currentIssuesSnapshot.docs) {
                        if (docToUnset.id !== editingPublicationId) {
                            await updateDoc(doc(db, PUBLIC_PUB_COLLECTION, docToUnset.id), { isCurrentIssue: false });
                            console.log(`[Publication Form] Unset current issue for document: ${docToUnset.id}`);
                        }
                    }
                }

                if (editingPublicationId) {
                    await updateDoc(doc(db, PUBLIC_PUB_COLLECTION, editingPublicationId), publicationData);
                    showMessageModal("successMessage", "publicationUpdated", "success");
                    console.log(`[Publication Form] Publication updated successfully: ${editingPublicationId}`);
                } else {
                    const newDocRef = await addDoc(collection(db, PUBLIC_PUB_COLLECTION), publicationData);
                    showMessageModal("successMessage", "publicationAdded", "success");
                    console.log(`[Publication Form] Publication added successfully with ID: ${newDocRef.id}`);
                }
                resetAddPublicationForm();
            } catch (error) {
                console.error("[Publication Form] Error saving publication:", error);
                showMessageModal("errorMessage", "errorSavingPublication" + error.message, "error");
            } finally {
                hideLoadingSpinner();
            }
        });

        // Reset form function for Add/Edit Publication
        function resetAddPublicationForm() {
            console.log("[Publication Form] Resetting add/edit publication form.");
            const form = document.getElementById('addPublicationForm');
            if (form) form.reset();
            if (bookTitleInput) bookTitleInput.value = '';
            if (bookAuthorsInput) bookAuthorsInput.value = '';
            if (bookYearInput) bookYearInput.value = '';
            if (bookDescriptionInput) bookDescriptionInput.value = '';
            if (bookISBNInput) bookISBNInput.value = '';
            if (bookISSNInput) bookISSNInput.value = '';
            if (abstractArTextInput) abstractArTextInput.value = '';
            if (abstractEnTextInput) abstractEnTextInput.value = '';
            if (abstractItTextInput) abstractItTextInput.value = '';
            if (bookIsCurrentIssueCheckbox) bookIsCurrentIssueCheckbox.checked = false;
            if (bookIsArchivalVolumeCheckbox) bookIsArchivalVolumeCheckbox.checked = false;

            editingPublicationId = null;
            if (adminFormTitle) adminFormTitle.textContent = translations[currentLanguage].addPublicationTitle;
            if (submitPublicationBtn) submitPublicationBtn.textContent = translations[currentLanguage].addPublicationButton;
            if (cancelEditPublicationBtn) cancelEditPublicationBtn.classList.add('hidden');

            if (uploadedCoverPreviewAdmin) uploadedCoverPreviewAdmin.src = '';
            if (uploadedCoverPreviewAdmin) uploadedCoverPreviewAdmin.style.display = 'none';
            if (coverImageFileNameDisplayAdmin) coverImageFileNameDisplayAdmin.textContent = '';
            if (pdfFileNameDisplayAdmin) pdfFileNameDisplayAdmin.textContent = '';
            if (abstractArPdfFileNameDisplayAdmin) abstractArPdfFileNameDisplayAdmin.textContent = '';
            if (abstractEnPdfFileNameDisplayAdmin) abstractEnPdfFileNameDisplayAdmin.textContent = '';
            if (abstractItPdfFileNameDisplayAdmin) abstractItPdfFileNameDisplayAdmin.textContent = '';

            currentPubFiles = {
                coverUrl: '', coverFileName: '',
                pdfUrl: '', pdfFileName: '',
                abstracts: {
                    ar: { text: '', url: '', fileName: '' },
                    en: { text: '', url: '', fileName: '' },
                    it: { text: '', url: '', fileName: '' }
                }
            };
            // Clear file inputs
            if (bookCoverInput) bookCoverInput.value = '';
            if (bookPdfInput) bookPdfInput.value = '';
            if (abstractArPdfInput) abstractArPdfInput.value = '';
            if (abstractEnPdfInput) abstractEnPdfInput.value = '';
            if (abstractItPdfInput) abstractItPdfInput.value = '';

            console.log("[Publication Form] Form reset complete.");
        }

        cancelEditPublicationBtn.addEventListener('click', resetAddPublicationForm);


        // Edit Publication function
        async function editPublication(publicationId) {
            showLoadingSpinner();
            console.log(`[Edit Pub] Attempting to edit publication with ID: ${publicationId}`);
            try {
                const docRef = doc(db, PUBLIC_PUB_COLLECTION, publicationId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log("[Edit Pub] Found publication data for editing:", data);
                    editingPublicationId = publicationId;

                    // Populate fields, using empty string for null/undefined
                    if (bookTitleInput) bookTitleInput.value = data.title || '';
                    if (bookAuthorsInput) bookAuthorsInput.value = data.authors || '';
                    if (bookYearInput) bookYearInput.value = data.year !== null && data.year !== undefined ? data.year : ''; 
                    if (bookDescriptionInput) bookDescriptionInput.value = data.description || '';
                    if (bookISBNInput) bookISBNInput.value = data.isbn || '';
                    if (bookISSNInput) bookISSNInput.value = data.issn || '';
                    if (abstractArTextInput) abstractArTextInput.value = data.abstracts?.ar?.text || '';
                    if (abstractEnTextInput) abstractEnTextInput.value = data.abstracts?.en?.text || '';
                    if (abstractItTextInput) abstractItTextInput.value = data.abstracts?.it?.text || '';
                    if (bookIsCurrentIssueCheckbox) bookIsCurrentIssueCheckbox.checked = data.isCurrentIssue || false;
                    if (bookIsArchivalVolumeCheckbox) bookIsArchivalVolumeCheckbox.checked = data.isArchivalVolume || false; 

                    currentPubFiles = {
                        coverUrl: data.coverImageUrl || '', coverFileName: data.coverImageFileName || '',
                        pdfUrl: data.pdfUrl || '', pdfFileName: data.pdfFileName || '',
                        abstracts: {
                            ar: data.abstracts?.ar || { text: '', url: '', fileName: '' },
                            en: data.abstracts?.en || { text: '', url: '', fileName: '' },
                            it: data.abstracts?.it || { text: '', url: '', fileName: '' }
                        }
                    };
                    console.log("[Edit Pub] Current publication files state:", currentPubFiles);

                    if (uploadedCoverPreviewAdmin) uploadedCoverPreviewAdmin.src = currentPubFiles.coverUrl;
                    if (uploadedCoverPreviewAdmin) uploadedCoverPreviewAdmin.style.display = currentPubFiles.coverUrl ? 'block' : 'none';
                    if (coverImageFileNameDisplayAdmin) coverImageFileNameDisplayAdmin.textContent = currentPubFiles.coverFileName ? `${translations[currentLanguage].currentLabel}: ${getOriginalFileNameFromUnique(currentPubFiles.coverFileName)}` : '';

                    if (pdfFileNameDisplayAdmin) pdfFileNameDisplayAdmin.textContent = currentPubFiles.pdfFileName ? `${translations[currentLanguage].currentLabel}: ${getOriginalFileNameFromUnique(currentPubFiles.pdfFileName)}` : '';
                    if (abstractArPdfFileNameDisplayAdmin) abstractArPdfFileNameDisplayAdmin.textContent = currentPubFiles.abstracts.ar.fileName ? `${translations[currentLanguage].currentLabel}: ${getOriginalFileNameFromUnique(currentPubFiles.abstracts.ar.fileName)}` : '';
                    if (abstractEnPdfFileNameDisplayAdmin) abstractEnPdfFileNameDisplayAdmin.textContent = currentPubFiles.abstracts.en.fileName ? `${translations[currentLanguage].currentLabel}: ${getOriginalFileNameFromUnique(currentPubFiles.abstracts.en.fileName)}` : '';
                    if (abstractItPdfFileNameDisplayAdmin) abstractItPdfFileNameDisplayAdmin.textContent = currentPubFiles.abstracts.it.fileName ? `${translations[currentLanguage].currentLabel}: ${getOriginalFileNameFromUnique(currentPubFiles.abstracts.it.fileName)}` : '';

                    if (bookCoverInput) bookCoverInput.value = ''; 
                    if (bookPdfInput) bookPdfInput.value = '';
                    if (abstractArPdfInput) abstractArPdfInput.value = '';
                    if (abstractEnPdfInput) abstractEnPdfInput.value = '';
                    if (abstractItPdfInput) abstractItPdfInput.value = '';

                    if (adminFormTitle) adminFormTitle.textContent = translations[currentLanguage].updatePublicationButton;
                    if (submitPublicationBtn) submitPublicationBtn.textContent = translations[currentLanguage].updatePublicationButton;
                    if (cancelEditPublicationBtn) cancelEditPublicationBtn.classList.remove('hidden');

                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    console.log("[Edit Pub] Form populated for editing.");
                } else {
                    console.warn(`[Edit Pub] Publication not found for editing: ${publicationId}`);
                    showMessageModal("errorMessage", "publicationNotFoundForEdit", "error");
                }
            } catch (error) {
                console.error("[Edit Pub] Error editing publication:", error);
                showMessageModal("errorMessage", "errorLoadingPublicationForEdit" + error.message, "error");
            } finally {
                hideLoadingSpinner();
            }
        }

        function confirmDeletePublication(publicationId) {
            console.log(`[Delete Pub] Confirming deletion for publication ID: ${publicationId}`);
            showMessageModal(
                "confirmDelete",
                "confirmDeleteMsg",
                "confirm",
                async (confirmed) => {
                    if (confirmed) {
                        showLoadingSpinner();
                        try {
                            const docRef = doc(db, PUBLIC_PUB_COLLECTION, publicationId);
                            const docSnap = await getDoc(docRef);
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                console.log("[Delete Pub] Deleting associated files for publication:", data.title);
                                // Delete associated files
                                await deleteFile(data.coverImageFileName, STORAGE_PATH_COVERS);
                                await deleteFile(data.pdfFileName, STORAGE_PATH_PDFS);
                                await deleteFile(data.abstracts?.ar?.fileName, STORAGE_PATH_ABSTRACTS);
                                await deleteFile(data.abstracts?.en?.fileName, STORAGE_PATH_ABSTRACTS);
                                await deleteFile(data.abstracts?.it?.fileName, STORAGE_PATH_ABSTRACTS);

                                await deleteDoc(docRef);
                                showMessageModal("successMessage", "publicationDeleted", "success");
                                console.log(`[Delete Pub] Publication successfully deleted: ${publicationId}`);
                            } else {
                                console.warn(`[Delete Pub] Publication not found for deletion: ${publicationId}`);
                                showMessageModal("errorMessage", "publicationNotFoundForDeletion", "error");
                            }
                        } catch (error) {
                            console.error("[Delete Pub] Error deleting publication:", error);
                            showMessageModal("errorMessage", "errorDeletingPublication" + error.message, "error");
                        } finally {
                            hideLoadingSpinner();
                        }
                    }
                }
            );
        }

        // --- News Admin Form Handling ---
        const newsTitleInput = document.getElementById('newsTitle');
        const newsDescriptionInput = document.getElementById('newsDescription');
        const newsImageInput = document.getElementById('newsImage');
        const uploadedNewsImagePreviewAdmin = document.getElementById('uploadedNewsImagePreviewAdmin');
        const newsImageFileNameDisplayAdmin = document.getElementById('newsImageFileNameDisplayAdmin');
        const submitNewsBtn = document.getElementById('submitNewsBtn');
        const cancelEditNewsBtn = document.getElementById('cancelEditNewsBtn');

        function resetAddNewsItemForm() {
            console.log("[News Form] Resetting add/edit news item form.");
            const form = document.getElementById('addNewsItemForm');
            if (form) form.reset();
            if (newsTitleInput) newsTitleInput.value = '';
            if (newsDescriptionInput) newsDescriptionInput.value = '';
            if (newsImageInput) newsImageInput.value = '';
            if (uploadedNewsImagePreviewAdmin) uploadedNewsImagePreviewAdmin.src = '';
            if (uploadedNewsImagePreviewAdmin) uploadedNewsImagePreviewAdmin.style.display = 'none';
            if (newsImageFileNameDisplayAdmin) newsImageFileNameDisplayAdmin.textContent = '';
            currentNewsImage = { url: '', fileName: '' };
            editingNewsItemId = null;
            if (submitNewsBtn) submitNewsBtn.textContent = translations[currentLanguage].addNewsItemButton;
            if (cancelEditNewsBtn) cancelEditNewsBtn.classList.add('hidden');
            console.log("[News Form] Form reset complete.");
        }

        document.getElementById('addNewsItemForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoadingSpinner();
            const user = auth.currentUser;
            const ADMIN_EMAIL_CORRECTED = 'charles.schwebs@lerma.it'; // Corrected admin email
            if (!user || user.email !== ADMIN_EMAIL_CORRECTED) { 
                showMessageModal("permissionDenied", "noPermissionAddNews", "error");
                hideLoadingSpinner();
                return;
            }
            console.log(`[News Form] Submitting news item form. Editing ID: ${editingNewsItemId}`);

            const newsTitle = newsTitleInput.value.trim();
            const newsDescription = newsDescriptionInput.value.trim();
            let imageUrl = currentNewsImage.url;
            let imageFileName = currentNewsImage.fileName;

            try {
                if (newsImageInput.files[0]) {
                    if (currentNewsImage.fileName) { 
                        await deleteFile(currentNewsImage.fileName, STORAGE_PATH_NEWS_IMAGES);
                    }
                    const uploadResult = await uploadFile(newsImageInput.files[0], STORAGE_PATH_NEWS_IMAGES);
                    imageUrl = uploadResult.url;
                    imageFileName = uploadResult.fileName;
                } else if (currentNewsImage.fileName && !newsImageInput.files[0]) {
                    imageUrl = currentNewsImage.url;
                    imageFileName = currentNewsImage.fileName;
                } else {
                    imageUrl = '';
                    imageFileName = '';
                }
                console.log(`[News Form] Image processing: imageUrl=${imageUrl}, imageFileName=${imageFileName}`);


                const newsData = {
                    title: newsTitle,
                    description: newsDescription,
                    imageUrl: imageUrl,
                    imageFileName: imageFileName,
                    timestamp: new Date().toISOString()
                };
                console.log("[News Form] Prepared news data:", newsData);

                if (editingNewsItemId) {
                    await updateDoc(doc(db, PUBLIC_NEWS_COLLECTION, editingNewsItemId), newsData);
                    showMessageModal("successMessage", "newsItemUpdated", "success");
                    console.log(`[News Form] News item updated successfully: ${editingNewsItemId}`);
                } else {
                    const newDocRef = await addDoc(collection(db, PUBLIC_NEWS_COLLECTION), newsData);
                    showMessageModal("successMessage", "newsItemAdded", "success");
                    console.log(`[News Form] News item added successfully with ID: ${newDocRef.id}`);
                }
                resetAddNewsItemForm();
            } catch (error) {
                console.error("[News Form] Error saving news item:", error);
                showMessageModal("errorMessage", "errorSavingNewsItem" + error.message, "error");
            } finally {
                hideLoadingSpinner();
            }
        });

        newsImageInput.addEventListener('change', (e) => {
            const fileNameDisplay = newsImageFileNameDisplayAdmin;
            const previewImage = uploadedNewsImagePreviewAdmin;
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                if (fileNameDisplay) fileNameDisplay.textContent = `${translations[currentLanguage].selectedLabel}: ${file.name}`;
                const reader = new FileReader();
                reader.onload = (event) => { 
                    if (previewImage) {
                        previewImage.src = event.target.result; 
                        previewImage.style.display = 'block'; 
                    }
                };
                reader.readAsDataURL(file);
            } else {
                if (fileNameDisplay) fileNameDisplay.textContent = currentNewsImage.fileName ? `${translations[currentLanguage].currentLabel}: ${getOriginalFileNameFromUnique(currentNewsImage.fileName)}` : '';
                if (previewImage) {
                    previewImage.src = currentNewsImage.url;
                    previewImage.style.display = currentNewsImage.url ? 'block' : 'none';
                }
            }
            console.log("[News Form] News image input changed.");
        });

        cancelEditNewsBtn.addEventListener('click', resetAddNewsItemForm);

        async function editNewsItem(newsItemId) {
            showLoadingSpinner();
            console.log(`[Edit News] Attempting to edit news item with ID: ${newsItemId}`);
            try {
                const docRef = doc(db, PUBLIC_NEWS_COLLECTION, newsItemId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log("[Edit News] Found news item data for editing:", data);
                    editingNewsItemId = newsItemId;

                    if (newsTitleInput) newsTitleInput.value = data.title || '';
                    if (newsDescriptionInput) newsDescriptionInput.value = data.description || '';

                    currentNewsImage.url = data.imageUrl || '';
                    currentNewsImage.fileName = data.imageFileName || '';

                    if (newsImageFileNameDisplayAdmin) newsImageFileNameDisplayAdmin.textContent = currentNewsImage.fileName ? `${translations[currentLanguage].currentLabel}: ${getOriginalFileNameFromUnique(currentNewsImage.fileName)}` : '';
                    if (uploadedNewsImagePreviewAdmin) uploadedNewsImagePreviewAdmin.src = currentNewsImage.url;
                    if (uploadedNewsImagePreviewAdmin) uploadedNewsImagePreviewAdmin.style.display = currentNewsImage.url ? 'block' : 'none';

                    if (newsImageInput) newsImageInput.value = ''; 

                    if (submitNewsBtn) submitNewsBtn.textContent = translations[currentLanguage].updateNewsItemButton;
                    if (cancelEditNewsBtn) cancelEditNewsBtn.classList.remove('hidden');

                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    console.log("[Edit News] Form populated for editing news item.");
                } else {
                    console.warn(`[Edit News] News item not found for editing: ${newsItemId}`);
                    showMessageModal("errorMessage", "newsItemNotFoundForEdit", "error");
                }
            } catch (error) {
                console.error("[Edit News] Error fetching news item for edit:", error);
                showMessageModal("errorMessage", "errorLoadingNewsItemForEdit" + error.message, "error");
            } finally {
                hideLoadingSpinner();
            }
        }

        function confirmDeleteNewsItem(newsItemId) {
            console.log(`[Delete News] Confirming deletion for news item ID: ${newsItemId}`);
            showMessageModal(
                "confirmDelete",
                "confirmDeleteMsg",
                "confirm",
                async (confirmed) => {
                    if (confirmed) {
                        showLoadingSpinner();
                        try {
                            const newsRef = doc(db, PUBLIC_NEWS_COLLECTION, newsItemId);
                            const newsDoc = await getDoc(newsRef);

                            if (newsDoc.exists()) {
                                const data = newsDoc.data();
                                console.log("[Delete News] Deleting associated image for news item:", data.title);
                                await deleteFile(data.imageFileName, STORAGE_PATH_NEWS_IMAGES);
                                await deleteDoc(newsRef);
                                showMessageModal("successMessage", "newsItemDeleted", "success");
                                console.log(`[Delete News] News item successfully deleted: ${newsItemId}`);
                            } else {
                                console.warn(`[Delete News] News item not found for deletion: ${newsItemId}`);
                                showMessageModal("errorMessage", "newsItemNotFoundForDeletion", "error");
                            }
                        } catch (error) {
                            console.error("[Delete News] Error deleting news item:", error);
                            showMessageModal("errorMessage", "errorDeletingNewsItem" + error.message, "error");
                        } finally {
                            hideLoadingSpinner();
                        }
                    }
                }
            );
        }

        function listenForAdminNews() {
            console.log("[Admin News] Setting up listener for admin news items.");
            const q = query(collection(db, PUBLIC_NEWS_COLLECTION), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                const adminNewsListBody = document.getElementById('adminNewsList');
                if (!adminNewsListBody) { console.warn("[Admin News] adminNewsListBody not found."); return; }
                adminNewsListBody.innerHTML = '';
                console.log(`[Admin News] Admin news snapshot received. Number of documents: ${snapshot.size}`);

                if (snapshot.empty) {
                    adminNewsListBody.innerHTML = `<tr class="admin-table-row"><td colspan="3" class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" data-lang-key="noNewsToManage">${translations[currentLanguage].noNewsToManage}</td></tr>`;
                    console.log("[Admin News] No news items to display in admin table.");
                    return;
                }

                snapshot.forEach(doc => {
                    const news = { id: doc.id, ...doc.data() };
                    const row = adminNewsListBody.insertRow();
                    row.className = 'admin-table-row';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${news.title || translations[currentLanguage].noTitle}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${new Date(news.timestamp).toLocaleDateString(currentLanguage === 'it' ? 'it-IT' : 'en-US')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex space-x-2">
                            <button class="text-blue-600 hover:text-blue-800 edit-news-button admin-button" data-id="${news.id}" data-lang-key="editButton">${translations[currentLanguage].editButton}</button>
                            <button class="text-red-600 hover:text-red-800 delete-news-button admin-button" data-id="${news.id}" data-lang-key="deleteButton">${translations[currentLanguage].deleteButton}</button>
                        </td>
                    `;
                });
                console.log(`[Admin News] Admin news table populated with ${snapshot.size} news items.`);

                document.querySelectorAll('.edit-news-button').forEach(button => {
                    button.addEventListener('click', (e) => editNewsItem(e.target.dataset.id));
                });
                document.querySelectorAll('.delete-news-button').forEach(button => {
                    button.addEventListener('click', (e) => confirmDeleteNewsItem(e.target.dataset.id));
                });
            }, (error) => {
                console.error("[Admin News Error] Error listening to admin news:", error);
                showMessageModal("errorMessage", "errorLoadingAdminNews", "error");
            });
        }


        // --- Custom Modal (Alert/Confirm Replacement) ---
        const messageModalElement = document.getElementById('messageModal');
        const messageTextElement = document.getElementById('messageText');
        const modalButtonsElement = document.getElementById('modalButtons');
        const closeMessageModalElement = document.getElementById('closeMessageModal');

        if (closeMessageModalElement) {
            closeMessageModalElement.addEventListener('click', () => {
                if (messageModalElement) messageModalElement.classList.remove('flex');
                if (messageModalElement) messageModalElement.classList.add('hidden');
                if (messageTextElement) messageTextElement.textContent = ''; 
            });
        }
        if (messageModalElement) {
            messageModalElement.addEventListener('click', (event) => {
                if (event.target === messageModalElement) {
                    messageModalElement.classList.remove('flex');
                    messageModalElement.classList.add('hidden');
                    if (messageTextElement) messageTextElement.textContent = ''; 
                }
            });
        }

        function showMessageModal(titleKey, messageKey, type = "alert", callback = null) {
            console.log(`[Modal] Showing message modal: Title=${titleKey}, Message=${messageKey}, Type=${type}`);
            if (messageTextElement) messageTextElement.innerHTML = `<strong>${translations[currentLanguage][titleKey]}</strong><br>${translations[currentLanguage][messageKey]}`;
            if (modalButtonsElement) modalButtonsElement.innerHTML = ''; 

            if (type === "confirm") {
                const yesButton = document.createElement('button');
                yesButton.textContent = translations[currentLanguage].yesButton;
                yesButton.className = 'nav-button bg-red-600 hover:bg-red-700 text-white';
                yesButton.onclick = () => { if (messageModalElement) messageModalElement.classList.remove('flex'); if (messageModalElement) messageModalElement.classList.add('hidden'); if (callback) callback(true); };
                if (modalButtonsElement) modalButtonsElement.appendChild(yesButton);

                const noButton = document.createElement('button');
                noButton.textContent = translations[currentLanguage].noButton;
                noButton.className = 'nav-button bg-gray-500 hover:bg-gray-600 text-white';
                noButton.onclick = () => { if (messageModalElement) messageModalElement.classList.remove('flex'); if (messageModalElement) messageModalElement.classList.add('hidden'); if (callback) callback(false); };
                if (modalButtonsElement) modalButtonsElement.appendChild(noButton);
            } else {
                const okButton = document.createElement('button');
                okButton.textContent = translations[currentLanguage].okButton;
                okButton.className = 'nav-button bg-blue-600 hover:bg-blue-700 text-white';
                okButton.onclick = () => { if (messageModalElement) messageModalElement.classList.remove('flex'); if (messageModalElement) messageModalElement.classList.add('hidden'); if (callback) callback(); };
                if (modalButtonsElement) modalButtonsElement.appendChild(okButton);
            }
            if (messageModalElement) messageModalElement.classList.remove('hidden');
            if (messageModalElement) messageModalElement.classList.add('flex');
        }

        const publicationDetailsModal = document.getElementById('publicationDetailsModal');
        const closePublicationDetailsModal = document.getElementById('closePublicationDetailsModal');

        if (closePublicationDetailsModal) {
            closePublicationDetailsModal.addEventListener('click', () => {
                if (publicationDetailsModal) publicationDetailsModal.classList.remove('flex', 'hidden');
            });
        }
        if (publicationDetailsModal) {
            publicationDetailsModal.addEventListener('click', (event) => {
                if (event.target === publicationDetailsModal) {
                    if (publicationDetailsModal) publicationDetailsModal.classList.remove('flex');
                    if (publicationDetailsModal) publicationDetailsModal.classList.add('hidden');
                }
            });
        }

        function showPublicationDetailsModal(book) {
            console.log("[Details Modal] Showing publication details for:", book.title);
            const detailCoverImage = document.getElementById('detailCoverImage');
            if (detailCoverImage) detailCoverImage.src = book.coverImageUrl || 'https://placehold.co/400x600/cccccc/333333?text=No+Image';
            const detailTitle = document.getElementById('detailTitle');
            if (detailTitle) detailTitle.textContent = book.title || translations[currentLanguage].noTitle;
            const detailAuthors = document.getElementById('detailAuthors');
            if (detailAuthors) detailAuthors.textContent = book.authors || translations[currentLanguage].noAuthors;
            const detailYear = document.getElementById('detailYear');
            if (detailYear) detailYear.textContent = book.year || translations[currentLanguage].noYear;
            const detailDescription = document.getElementById('detailDescription');
            if (detailDescription) detailDescription.textContent = book.description || translations[currentLanguage].noDescription;
            
            const detailISBN = document.getElementById('detailISBN');
            if (detailISBN) detailISBN.textContent = book.isbn || 'N/A';
            const detailISSN = document.getElementById('detailISSN');
            if (detailISSN) detailISSN.textContent = book.issn || 'N/A';

            const detailAbstractArText = document.getElementById('detailAbstractArText');
            if (detailAbstractArText) detailAbstractArText.textContent = book.abstracts?.ar?.text || translations[currentLanguage].noArabicAbstract;
            const detailAbstractEnText = document.getElementById('detailAbstractEnText');
            if (detailAbstractEnText) detailAbstractEnText.textContent = book.abstracts?.en?.text || translations[currentLanguage].noEnglishAbstract;
            const detailAbstractItText = document.getElementById('detailAbstractItText');
            if (detailAbstractItText) detailAbstractItText.textContent = book.abstracts?.it?.text || translations[currentLanguage].noItalianAbstract;

            const updateDownloadBtn = (btnId, url, unavailableKey) => {
                const btn = document.getElementById(btnId);
                if (btn) { 
                    btn.href = url || '#';
                    btn.classList.toggle('disabled', !url);
                    btn.onclick = url ? null : (e) => { e.preventDefault(); showMessageModal("unavailable", unavailableKey, "alert"); };
                }
            };
            updateDownloadBtn('detailDownloadPdfBtn', book.pdfUrl, 'fullPdfUnavailable');
            updateDownloadBtn('detailDownloadAbstractArBtn', book.abstracts?.ar?.url, 'arabicAbstractPdfUnavailable');
            updateDownloadBtn('detailDownloadAbstractEnBtn', book.abstracts?.en?.url, 'englishAbstractPdfUnavailable');
            updateDownloadBtn('detailDownloadAbstractItBtn', book.abstracts?.it?.url, 'italianAbstractPdfUnavailable');

            if (publicationDetailsModal) {
                publicationDetailsModal.classList.remove('hidden');
                publicationDetailsModal.classList.add('flex');
            }
            console.log("[Details Modal] Publication details modal displayed.");
        }

        // --- Loading Spinner Functions ---
        const loadingSpinner = document.getElementById('loadingSpinner');

        function showLoadingSpinner() {
            console.log("[Spinner] Showing loading spinner.");
            if (loadingSpinner) loadingSpinner.classList.remove('hidden');
        }

        function hideLoadingSpinner() {
            console.log("[Spinner] Hiding loading spinner.");
            if (loadingSpinner) loadingSpinner.classList.add('hidden');
        }

        // --- Initial Load Logic ---
        window.onload = function() {
            console.log("[App Init] Window loaded. Starting application initialization.");
            applyTranslations(currentLanguage); 
            initializeFirebase(); 
            const currentYearElement = document.getElementById('currentYear');
            if (currentYearElement) currentYearElement.textContent = new Date().getFullYear();
        };
    </script>
</body>
</html>
