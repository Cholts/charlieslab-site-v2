<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="pageTitle">Quaderni di Archeologia della Libya - Publications</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: EB Garamond for body, Cinzel Decorative for headings (Papyrus/Archaeological Theme) -->
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&family=Cinzel+Decorative:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Leaflet CSS for Interactive Map (New Feature 2) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    <style>
        /* General Body Styling for Public Pages - Papyrus/Archaeological Theme */
        body {
            font-family: 'EB Garamond', serif; /* Body font */
            background-color: #fcf8e8; /* Light papyrus color */
            color: #4a2c1d; /* Dark earthy brown for text */
            line-height: 1.6;
        }

        /* Headings Font */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Cinzel Decorative', serif; /* Heading font */
            color: #6d4c3d; /* Complementary earthy tone for headings */
        }

        /* Container for main content */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Custom Modal Styles (replaces alert/confirm) */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefcf0; /* Lighter papyrus for modal */
            margin: auto;
            padding: 2.5rem;
            border: 2px solid #6d4c3d;
            width: 80%;
            max-width: 500px;
            border-radius: 12px; /* Rounded corners for archaeological feel */
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            animation: fadeInScale 0.3s ease-out; /* Subtle load animation */
        }
        .modal-close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        .modal-close-button:hover,
        .modal-close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        /* Admin specific styles (retain original look) */
        .admin-bg {
            background-color: #f3f4f6; /* neutral-100 */
            color: #374151; /* neutral-700 */
        }
        .admin-header, .admin-footer {
            background-color: #1f2937; /* neutral-800 */
            color: #f9fafb; /* neutral-50 */
        }
        .admin-text-color {
            color: #374151;
        }
        .admin-link {
            color: #6b7280; /* neutral-500 */
        }
        .admin-link:hover {
            color: #d1d5db; /* neutral-300 */
        }

        /* Archaeological Theme Enhancements */
        .header-bg {
            background-color: #5c4033; /* Darker earthy tone for header */
            color: #fefcf0; /* Light text for contrast */
            border-bottom: 3px solid #b8a68b; /* Stone-like border */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .footer-bg {
            background-color: #5c4033; /* Darker earthy tone for footer */
            color: #fefcf0; /* Light text for contrast */
            border-top: 3px solid #b8a68b; /* Stone-like border */
            box-shadow: 0 -4px 6px rgba(0,0,0,0.1);
        }
        .nav-button {
            background-color: #b8a68b; /* Muted gold/stone for buttons */
            color: #4a2c1d; /* Dark earthy text */
            font-family: 'Cinzel Decorative', serif;
            padding: 0.75rem 1.5rem;
            border-radius: 8px; /* Slightly rounded for chiseled look */
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        .nav-button:hover {
            background-color: #d4c0a5; /* Lighter on hover */
            transform: translateY(-2px);
            box-shadow: 4px 4px 8px rgba(0,0,0,0.3);
        }
        .section-paper {
            background-color: #fefcf0; /* Light papyrus for sections */
            border: 1px solid #b8a68b; /* Subtle border */
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            animation: fadeIn 0.8s ease-out; /* Subtle fade-in for sections */
        }
        .publication-card {
            border: 1px solid #b8a68b; /* Aged paper border */
            border-radius: 10px;
            overflow: hidden;
            background-color: #fefcf0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* Museum exhibit shadow */
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            /* transform: rotateZ(-1deg); /* Slight tilt for artifact feel */ */
        }
        .publication-card:hover {
            transform: translateY(-5px); /* Lift effect on hover */
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }
        .cover-image {
            width: 100%;
            height: auto;
            border-bottom: 1px solid #b8a68b;
        }
        .section-heading-motif::before,
        .section-heading-motif::after {
            content: '';
            display: inline-block;
            width: 30px;
            height: 3px;
            background-color: #b8a68b; /* Motif line */
            vertical-align: middle;
            margin: 0 10px;
            border-radius: 2px;
        }
        /* Archaeological Iconography (Example SVG for a scroll) */
        .icon-scroll {
            display: inline-block;
            width: 1.5em;
            height: 1.5em;
            vertical-align: middle;
            margin-right: 0.5em;
            fill: currentColor;
        }
        /* Interactive map specific styling */
        #mapid {
            height: 500px; /* Set a height for the map */
            width: 100%;
            border-radius: 12px;
            border: 2px solid #b8a68b;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[2000] hidden">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-amber-400"></div>
    </div>

    <!-- Modal for messages and confirmations -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button" id="closeMessageModal">&times;</span>
            <p id="messageText" class="text-lg text-neutral-800 mb-4"></p>
            <div id="modalButtons" class="modal-buttons">
                <!-- Buttons will be inserted here by JS -->
            </div>
        </div>
    </div>

    <!-- Header Section (Archaeological Theme) -->
    <header class="header-bg py-6 shadow-md">
        <div class="container flex flex-col md:flex-row items-center justify-between">
            <h1 class="text-4xl font-bold text-center mb-4 md:mb-0">
                <a href="#home" class="text-white hover:text-amber-200 transition duration-300">
                    <svg class="icon-scroll inline-block mr-2" viewBox="0 0 24 24">
                        <path d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM4 20V4h16l-.01 16H4zM9 9h6v2H9V9zm0 4h6v2H9v-2zm-4 4h14v2H5v-2z"/>
                    </svg>
                    Quaderni di Archeologia della Libya
                </a>
            </h1>
            <nav class="space-x-4">
                <button class="nav-button view-button" data-view="publications">Publications</button>
                <button class="nav-button view-button" data-view="archivalVolumes">Archival Volumes</button>
                <button class="nav-button view-button" data-view="codeOfEthics">Code of Ethics</button>
                <button class="nav-button view-button" data-view="editorialGuidelines">Editorial Guidelines</button>
                <button class="nav-button view-button" data-view="editorialBoard">Editorial Board</button>
                <button class="nav-button view-button" data-view="interactiveMap">Interactive Map</button>
                <button class="nav-button view-button" data-view="aboutUs">About Us</button>
                <button class="nav-button view-button" data-view="contactUs">Contact Us</button>
                <button id="adminLoginBtn" class="nav-button">Admin Login</button>
                <button id="adminLogoutBtn" class="nav-button hidden">Logout</button>
            </nav>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow container mt-8">

        <!-- Publications View (Home) -->
        <section id="publicationsView" class="view section-paper">
            <h2 class="text-3xl font-bold text-center mb-6 section-heading-motif">Current Publications</h2>
            <div class="flex flex-col md:flex-row items-center justify-between mb-6 gap-4">
                <div class="relative flex-grow w-full md:w-auto">
                    <input type="text" id="publicationSearch" placeholder="Search publications by title, author, year..."
                        class="w-full px-5 py-3 pr-10 rounded-full border border-stone-300 focus:ring-amber-500 focus:border-amber-500 bg-amber-50 text-neutral-800 placeholder-neutral-500 shadow-sm transition duration-200">
                    <svg class="absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                <select id="sortPublications" class="w-full md:w-auto px-4 py-3 rounded-full border border-stone-300 bg-amber-50 text-neutral-800 shadow-sm transition duration-200">
                    <option value="year-desc">Sort by Year (Newest)</option>
                    <option value="year-asc">Sort by Year (Oldest)</option>
                    <option value="title-asc">Sort by Title (A-Z)</option>
                </select>
            </div>

            <div id="publicationsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Publications will be loaded here -->
                <p class="col-span-full text-center text-neutral-500" data-lang-key="msgNoPublications">No publications found.</p>
            </div>
        </section>

        <!-- Archival Volumes View (New Feature 1) -->
        <section id="archivalVolumesView" class="view hidden section-paper">
            <h2 class="text-3xl font-bold text-center mb-6 section-heading-motif">Archival Volumes</h2>
            <p class="text-center text-neutral-700 mb-8">Explore the rich history of archaeological research in Libya through our past publications. Browse by year or special issue below.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Mock Archival Volumes - Replace with real data from Firestore if desired -->
                <div class="bg-amber-100 p-6 rounded-lg shadow-md border border-amber-200 hover:shadow-lg transition duration-300">
                    <h3 class="text-xl font-semibold mb-2">Volume 1, 1964</h3>
                    <p class="text-neutral-700 mb-4">Pioneering studies on early Roman settlements in Tripolitania.</p>
                    <button class="nav-button text-sm">View Details / PDF</button>
                </div>
                <div class="bg-amber-100 p-6 rounded-lg shadow-md border border-amber-200 hover:shadow-lg transition duration-300">
                    <h3 class="text-xl font-semibold mb-2">Volume 2, 1965</h3>
                    <p class="text-neutral-700 mb-4">Focus on prehistoric rock art in the Tadrart Acacus region.</p>
                    <button class="nav-button text-sm">View Details / PDF</button>
                </div>
                <div class="bg-amber-100 p-6 rounded-lg shadow-md border border-amber-200 hover:shadow-lg transition duration-300">
                    <h3 class="text-xl font-semibold mb-2">Volume 3, 1966 - Special Issue: Garamantian Civilization</h3>
                    <p class="text-neutral-700 mb-4">In-depth research into the ancient Garamantes of the Sahara.</p>
                    <button class="nav-button text-sm">View Details / PDF</button>
                </div>
                <div class="bg-amber-100 p-6 rounded-lg shadow-md border border-amber-200 hover:shadow-lg transition duration-300">
                    <h3 class="text-xl font-semibold mb-2">Volume 4, 1967</h3>
                    <p class="text-neutral-700 mb-4">Studies on Byzantine fortifications along the Libyan coast.</p>
                    <button class="nav-button text-sm">View Details / PDF</button>
                </div>
                <div class="bg-amber-100 p-6 rounded-lg shadow-md border border-amber-200 hover:shadow-lg transition duration-300">
                    <h3 class="text-xl font-semibold mb-2">Volume 5, 1968</h3>
                    <p class="text-neutral-700 mb-4">New findings from the Roman city of Leptis Magna.</p>
                    <button class="nav-button text-sm">View Details / PDF</button>
                </div>
                 <div class="bg-amber-100 p-6 rounded-lg shadow-md border border-amber-200 hover:shadow-lg transition duration-300">
                    <h3 class="text-xl font-semibold mb-2">Volume 6, 1969</h3>
                    <p class="text-neutral-700 mb-4">Excavations at the ancient Greek colony of Cyrene.</p>
                    <button class="nav-button text-sm">View Details / PDF</button>
                </div>
            </div>
            <p class="text-center text-neutral-600 mt-8">More archival volumes coming soon!</p>
        </section>

        <!-- Code of Ethics View -->
        <section id="codeOfEthicsView" class="view hidden section-paper">
            <h2 class="text-3xl font-bold text-center mb-6 section-heading-motif">Code of Ethics</h2>
            <div class="prose max-w-none text-neutral-800">
                <p>The "Quaderni di Archeologia della Libya" journal adheres to the highest standards of ethical conduct in research and publication. Our code of ethics is based on principles of integrity, transparency, and respect for cultural heritage.</p>
                <h3>1. Research Integrity</h3>
                <p>All research published in QAL must be conducted with the utmost integrity. This includes:</p>
                <ul class="list-disc list-inside">
                    <li>Accuracy in reporting results, methods, and data.</li>
                    <li>Avoiding plagiarism, falsification, or fabrication of data.</li>
                    <li>Proper acknowledgment of all sources and contributors.</li>
                </ul>
                <h3>2. Authorship</h3>
                <p>Authorship should be limited to those who have made a significant contribution to the conception, design, execution, or interpretation of the reported study. All authors must approve the final version of the manuscript and agree to its submission for publication.</p>
                <h3>3. Peer Review</h3>
                <p>Peer review is an essential component of the publication process. Reviewers are expected to:</p>
                <ul class="list-disc list-inside">
                    <li>Maintain confidentiality of the manuscript.</li>
                    <li>Provide objective and constructive criticism.</li>
                    <li>Identify any potential conflicts of interest.</li>
                </ul>
                <h3>4. Conflicts of Interest</h3>
                <p>Any financial or personal relationships that could be perceived as influencing the outcome or objectivity of the research must be disclosed by authors, reviewers, and editors.</p>
                <h3>5. Cultural Heritage and Site Preservation</h3>
                <p>We emphasize and uphold the importance of protecting archaeological sites and cultural heritage. All research must comply with national and international laws regarding heritage protection. Any discoveries should be handled with sensitivity and in consultation with local authorities and communities.</p>
                <h3>6. Data Accessibility and Preservation</h3>
                <p>Authors are encouraged to make their raw data accessible to other researchers where appropriate and ethically permissible. Published data should be preserved for a reasonable period to allow for replication or further analysis.</p>
                <p class="mt-6 text-sm text-neutral-600">This Code of Ethics is regularly reviewed and updated to ensure its relevance and effectiveness.</p>
            </div>
        </section>

        <!-- Editorial Guidelines View -->
        <section id="editorialGuidelinesView" class="view hidden section-paper">
            <h2 class="text-3xl font-bold text-center mb-6 section-heading-motif">Editorial Guidelines</h2>
            <div class="prose max-w-none text-neutral-800">
                <p>These guidelines provide detailed instructions for authors preparing manuscripts for submission to "Quaderni di Archeologia della Libya." Adherence to these guidelines ensures a smooth review and publication process.</p>
                <h3>1. Manuscript Submission</h3>
                <p>Manuscripts should be submitted electronically through our online portal (link coming soon). Submissions must include:</p>
                <ul class="list-disc list-inside">
                    <li>Cover letter</li>
                    <li>Full manuscript (including abstract, keywords, main text, references, figures, and tables)</li>
                    <li>Author declarations (e.g., originality, conflict of interest)</li>
                </ul>
                <h3>2. Manuscript Format</h3>
                <p>Submissions should adhere to the following formatting requirements:</p>
                <ul class="list-disc list-inside">
                    <li><strong>Language:</strong> English or Italian.</li>
                    <li><strong>Word Count:</strong> Research articles: 8,000-10,000 words; Reports/Notes: 3,000-5,000 words.</li>
                    <li><strong>Font:</strong> EB Garamond, 12pt, double-spaced.</li>
                    <li><strong>Abstract:</strong> Max 250 words, summarizing the research.</li>
                    <li><strong>Keywords:</strong> 5-7 keywords.</li>
                    <li><strong>Referencing Style:</strong> Chicago Manual of Style (Notes and Bibliography).</li>
                </ul>
                <h3>3. Figures and Tables</h3>
                <p>All figures (photographs, maps, drawings) and tables should be submitted as separate high-resolution files (.TIFF, .JPG, .PNG for images; .XLSX or .DOCX for tables). They must be clearly numbered and referenced in the text.</p>
                <h3>4. Peer Review Process</h3>
                <p>All submitted manuscripts undergo a rigorous double-blind peer-review process. Authors will receive feedback from at least two independent expert reviewers. The editorial board makes the final decision on acceptance based on the reviewers' recommendations.</p>
                <h3>5. Publication Ethics</h3>
                <p>Authors are expected to adhere to the journal's <a href="#codeOfEthics" class="text-amber-700 hover:text-amber-900 transition duration-300 font-semibold">Code of Ethics</a>, ensuring originality, proper attribution, and responsible research practices.</p>
                <p class="mt-6 text-sm text-neutral-600">For any further questions, please refer to the <a href="#contactUs" class="text-amber-700 hover:text-amber-900 transition duration-300 font-semibold">Contact Us</a> section.</p>
            </div>
        </section>

        <!-- Editorial Board View (New Feature 6) -->
        <section id="editorialBoardView" class="view hidden section-paper">
            <h2 class="text-3xl font-bold text-center mb-6 section-heading-motif">Meet the Editorial Board</h2>
            <p class="text-center text-neutral-700 mb-8">Our journal is guided by a distinguished panel of scholars and experts in Libyan archaeology and related fields. Their expertise ensures the high quality and academic rigor of our publications.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Mock Editorial Board Members - Using names from search -->
                <div class="bg-amber-100 p-6 rounded-lg shadow-md border border-amber-200 text-center hover:shadow-lg transition duration-300">
                    <img class="w-32 h-32 rounded-full mx-auto mb-4 object-cover border-2 border-amber-300 shadow-md" src="https://placehold.co/128x128/e9dcc9/4a2c1d?text=EB" alt="Eugenio La Rocca">
                    <h3 class="text-xl font-semibold text-neutral-800">Prof. Eugenio La Rocca</h3>
                    <p class="text-amber-800 text-sm mb-2">Editor-in-Chief</p>
                    <p class="text-neutral-700 text-sm">University of Rome "La Sapienza"</p>
                    <p class="text-neutral-600 text-xs mt-2">Specializes in Roman archaeology and North African provinces.</p>
                </div>
                <div class="bg-amber-100 p-6 rounded-lg shadow-md border border-amber-200 text-center hover:shadow-lg transition duration-300">
                    <img class="w-32 h-32 rounded-full mx-auto mb-4 object-cover border-2 border-amber-300 shadow-md" src="https://placehold.co/128x128/e9dcc9/4a2c1d?text=AH" alt="Ahmed Hussein Y. Abdulkariem">
                    <h3 class="text-xl font-semibold text-neutral-800">Dr. Ahmed Hussein Y. Abdulkariem</h3>
                    <p class="text-amber-800 text-sm mb-2">Associate Editor</p>
                    <p class="text-neutral-700 text-sm">Department of Antiquities, Libya</p>
                    <p class="text-neutral-600 text-xs mt-2">Expert in pre-Islamic Libyan history and conservation.</p>
                </div>
                <div class="bg-amber-100 p-6 rounded-lg shadow-md border border-amber-200 text-center hover:shadow-lg transition duration-300">
                    <img class="w-32 h-32 rounded-full mx-auto mb-4 object-cover border-2 border-amber-300 shadow-md" src="https://placehold.co/128x128/e9dcc9/4a2c1d?text=BB" alt="Barbara Barich">
                    <h3 class="text-xl font-semibold text-neutral-800">Prof. Barbara Barich</h3>
                    <p class="text-amber-800 text-sm mb-2">Editorial Board Member</p>
                    <p class="text-neutral-700 text-sm">University of Rome "La Sapienza"</p>
                    <p class="text-neutral-600 text-xs mt-2">Leading authority on prehistoric Sahara archaeology.</p>
                </div>
                <div class="bg-amber-100 p-6 rounded-lg shadow-md border border-amber-200 text-center hover:shadow-lg transition duration-300">
                    <img class="w-32 h-32 rounded-full mx-auto mb-4 object-cover border-2 border-amber-300 shadow-md" src="https://placehold.co/128x128/e9dcc9/4a2c1d?text=SD" alt="Savino Di Lernia">
                    <h3 class="text-xl font-semibold text-neutral-800">Prof. Savino Di Lernia</h3>
                    <p class="text-amber-800 text-sm mb-2">Editorial Board Member</p>
                    <p class="text-neutral-700 text-sm">University of Rome "La Sapienza"</p>
                    <p class="text-neutral-600 text-xs mt-2">Specializes in pastoral archaeology and rock art.</p>
                </div>
                <div class="bg-amber-100 p-6 rounded-lg shadow-md border border-amber-200 text-center hover:shadow-lg transition duration-300">
                    <img class="w-32 h-32 rounded-full mx-auto mb-4 object-cover border-2 border-amber-300 shadow-md" src="https://placehold.co/128x128/e9dcc9/4a2c1d?text=SK" alt="Susan Kane">
                    <h3 class="text-xl font-semibold text-neutral-800">Dr. Susan Kane</h3>
                    <p class="text-amber-800 text-sm mb-2">Editorial Board Member</p>
                    <p class="text-neutral-700 text-sm">University of Arizona</p>
                    <p class="text-neutral-600 text-xs mt-2">Focuses on Cyrene, ancient sculpture, and urbanism.</p>
                </div>
                <div class="bg-amber-100 p-6 rounded-lg shadow-md border border-amber-200 text-center hover:shadow-lg transition duration-300">
                    <img class="w-32 h-32 rounded-full mx-auto mb-4 object-cover border-2 border-amber-300 shadow-md" src="https://placehold.co/128x128/e9dcc9/4a2c1d?text=AB" alt="Ahmed Buzaian">
                    <h3 class="text-xl font-semibold text-neutral-800">Prof. Ahmed Buzaian</h3>
                    <p class="text-amber-800 text-sm mb-2">Editorial Board Member</p>
                    <p class="text-neutral-700 text-sm">University of Garyounis (Benghazi)</p>
                    <p class="text-neutral-600 text-xs mt-2">Expert in ancient Libyan history and inscriptions.</p>
                </div>
            </div>
            <p class="text-center text-neutral-600 mt-8">Full list of the editorial board and their biographies coming soon.</p>
        </section>

        <!-- Interactive Map View (New Feature 2) -->
        <section id="interactiveMapView" class="view hidden section-paper">
            <h2 class="text-3xl font-bold text-center mb-6 section-heading-motif">Interactive Map of Archaeological Sites</h2>
            <p class="text-center text-neutral-700 mb-8">Explore key archaeological sites across Libya relevant to the journal's research. Click on markers for more information.</p>
            <div id="mapid"></div>
            <p class="text-center text-neutral-600 mt-8">This map provides an overview. Detailed site information will be added in future updates.</p>
        </section>

        <!-- About Us View -->
        <section id="aboutUsView" class="view hidden section-paper">
            <h2 class="text-3xl font-bold text-center mb-6 section-heading-motif">About Us</h2>
            <div class="prose max-w-none text-neutral-800">
                <p>"Quaderni di Archeologia della Libya" (QAL) is a peer-reviewed academic journal dedicated to the archaeology, art history, and cultural heritage of Libya. Established in 1960, QAL publishes original research articles, preliminary reports on excavations, critical reviews, and scholarly discussions covering all periods of Libyan history, from prehistory to the Islamic era.</p>
                <p>Our mission is to foster scholarly excellence, promote new discoveries, and contribute to the understanding and preservation of Libya's rich archaeological landscape. We welcome contributions from international scholars and actively encourage collaboration with Libyan archaeologists and institutions.</p>
                <h3 class="mt-8">Our History</h3>
                <p>Founded by a group of passionate archaeologists and historians, QAL quickly became a leading publication for research on Libyan antiquities. Over the decades, it has documented countless significant discoveries and provided a crucial platform for academic discourse.</p>
                <h3 class="mt-8">Our Vision</h3>
                <p>We aspire to continue being the foremost academic resource for Libyan archaeology, embracing new methodologies, fostering interdisciplinary research, and making scholarly knowledge accessible to a global audience while prioritizing ethical practices and cultural sensitivity.</p>
            </div>
        </section>

        <!-- Contact Us View -->
        <section id="contactUsView" class="view hidden section-paper">
            <h2 class="text-3xl font-bold text-center mb-6 section-heading-motif">Contact Us</h2>
            <div class="prose max-w-none text-neutral-800">
                <p>For general inquiries, submissions, or editorial matters, please use the contact information below. We aim to respond to all inquiries within 5-7 business days.</p>
                <div class="mt-6">
                    <h3 class="text-xl font-semibold">General Inquiries:</h3>
                    <p class="text-neutral-700">Email: <a href="mailto:info@archaeologylibya.org" class="text-amber-700 hover:underline">info@archaeologylibya.org</a></p>
                </div>
                <div class="mt-4">
                    <h3 class="text-xl font-semibold">Editorial Office:</h3>
                    <p class="text-neutral-700">Quaderni di Archeologia della Libya<br>
                    [Journal's Physical Address Placeholder]<br>
                    Rome, Italy</p>
                </div>
                <div class="mt-4">
                    <h3 class="text-xl font-semibold">Submissions:</h3>
                    <p class="text-neutral-700">Please refer to our <a href="#editorialGuidelines" class="text-amber-700 hover:underline">Editorial Guidelines</a> for submission instructions.</p>
                </div>
                <div class="mt-6">
                    <h3 class="text-xl font-semibold">Social Media:</h3>
                    <p class="text-neutral-700">Follow us on [Facebook/Twitter/Academia.edu links - placeholders]</p>
                </div>
            </div>
        </section>

        <!-- Admin Login View -->
        <section id="adminLoginView" class="view hidden admin-bg p-8 rounded-lg shadow-md max-w-md mx-auto">
            <h2 class="text-3xl font-bold text-center mb-6 admin-text-color">Admin Login</h2>
            <form id="adminLoginForm" class="space-y-4">
                <div>
                    <label for="adminEmail" class="block text-sm font-medium admin-text-color">Email:</label>
                    <input type="email" id="adminEmail" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm bg-neutral-50 text-neutral-900">
                </div>
                <div>
                    <label for="adminPassword" class="block text-sm font-medium admin-text-color">Password:</label>
                    <input type="password" id="adminPassword" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm bg-neutral-50 text-neutral-900">
                </div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-amber-600 hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition duration-300">Login</button>
            </form>
        </section>

        <!-- Admin Dashboard View -->
        <section id="adminDashboardView" class="view hidden admin-bg p-8 rounded-lg shadow-md max-w-2xl mx-auto">
            <h2 class="text-3xl font-bold text-center mb-6 admin-text-color">Admin Dashboard</h2>
            <p class="text-center admin-text-color mb-4">Welcome, <span id="loggedInUserEmail" class="font-semibold"></span>!</p>
            <p class="text-center admin-text-color mb-6">User ID: <span id="loggedInUserId" class="font-mono text-xs break-all"></span></p>

            <!-- Add New Publication Form -->
            <div class="bg-neutral-100 p-6 rounded-lg shadow-inner mb-8">
                <h3 class="text-2xl font-semibold mb-4 admin-text-color">Add New Publication</h3>
                <form id="addPublicationForm" class="space-y-4">
                    <div>
                        <label for="bookTitle" class="block text-sm font-medium admin-text-color">Title:</label>
                        <input type="text" id="bookTitle" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-neutral-900" required>
                    </div>
                    <div>
                        <label for="bookAuthors" class="block text-sm font-medium admin-text-color">Authors (comma-separated):</label>
                        <input type="text" id="bookAuthors" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-neutral-900" required>
                    </div>
                     <div>
                        <label for="bookYear" class="block text-sm font-medium admin-text-color">Publication Year:</label>
                        <input type="number" id="bookYear" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-neutral-900" min="1900" max="2100" required>
                    </div>
                    <div>
                        <label for="bookDescription" class="block text-sm font-medium admin-text-color">Description:</label>
                        <textarea id="bookDescription" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-neutral-900" required></textarea>
                    </div>
                    <div>
                        <label for="bookCover" class="block text-sm font-medium admin-text-color">Cover Image (Optional):</label>
                        <input type="file" id="bookCover" accept="image/*" class="mt-1 block w-full text-sm text-neutral-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-neutral-200 file:text-neutral-700 hover:file:bg-neutral-300">
                    </div>
                    <div>
                        <label for="bookPdf" class="block text-sm font-medium admin-text-color">PDF File (Optional):</label>
                        <input type="file" id="bookPdf" accept="application/pdf" class="mt-1 block w-full text-sm text-neutral-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-neutral-200 file:text-neutral-700 hover:file:bg-neutral-300">
                    </div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 transition duration-300">Add Publication</button>
                </form>
            </div>

            <!-- Manage Publications Table -->
            <div class="bg-neutral-100 p-6 rounded-lg shadow-inner">
                <h3 class="text-2xl font-semibold mb-4 admin-text-color">Manage Publications</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-neutral-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Title</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Authors</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Year</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminPublicationsList" class="bg-white divide-y divide-gray-200">
                            <!-- Publications will be loaded here for admin -->
                            <tr><td colspan="4" class="px-6 py-4 whitespace-nowrap text-sm text-neutral-500">No publications to manage.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer Section (Archaeological Theme) -->
    <footer class="footer-bg py-6 mt-8 shadow-inner">
        <div class="container text-center text-sm">
            <p>&copy; <span id="currentYear"></span> Quaderni di Archeologia della Libya. All rights reserved.</p>
            <p class="text-white mt-2">
                <a href="#codeOfEthics" class="text-amber-200 hover:underline transition duration-300">Code of Ethics</a> |
                <a href="#editorialGuidelines" class="text-amber-200 hover:underline transition duration-300">Editorial Guidelines</a> |
                <a href="#contactUs" class="text-amber-200 hover:underline transition duration-300">Contact Us</a>
            </p>
        </div>
    </footer>

    <!-- Leaflet JS for Interactive Map (New Feature 2) -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <!-- Firebase SDK (Version 11.6.1 is commonly compatible) -->
    <script type="module">
        // Firebase CDN Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, onSnapshot, query, orderBy, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Global Firebase Variables (Provided by Canvas Environment)
        // These variables are automatically injected by the Canvas environment.
        // '__app_id': Unique identifier for the application within the Canvas environment.
        // '__firebase_config': JSON string of Firebase project configuration.
        // '__initial_auth_token': Custom Firebase authentication token.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase Service Instances
        let app;
        let db;
        let auth;
        let storage;
        let userId; // Will hold the current user ID, important for Firestore rules

        // Initialize Firebase App and Authentication
        async function initializeFirebase() {
            try {
                // Initialize Firebase app with the provided config
                app = initializeApp(firebaseConfig);
                // Get Firestore, Auth, and Storage service instances
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);

                // Authenticate the user. First, try with a custom token (if provided by Canvas).
                // If no custom token, sign in anonymously. This ensures Firestore access.
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }

                // Set up an authentication state change listener. This runs whenever the user's
                // sign-in state changes (e.g., login, logout, initial load).
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // User is signed in. Get their UID and update the UI.
                        userId = user.uid;
                        console.log("User authenticated:", user.uid, "Email:", user.email || 'N/A');
                        document.getElementById('loggedInUserEmail').textContent = user.email || 'Anonymous User';
                        document.getElementById('loggedInUserId').textContent = user.uid;
                        setupListeners(); // Set up real-time Firestore listeners now that auth is ready.
                    } else {
                        // User is signed out. Clear user info and potentially redirect.
                        userId = null;
                        console.log("No user signed in.");
                        document.getElementById('loggedInUserEmail').textContent = '';
                        document.getElementById('loggedInUserId').textContent = '';
                        // If the user was on an admin-only view, redirect them to a public view.
                        if (currentView === 'adminDashboard') {
                            showView('publications');
                        }
                    }
                    updateAuthUI(); // Always update UI elements related to authentication status.
                });

            } catch (error) {
                // Log and show an error if Firebase initialization fails.
                console.error("Error initializing Firebase:", error);
                showMessageModal("msgFirebaseError", "An error occurred during Firebase initialization. Please try again later.", "error");
            }
        }

        // --- UI State Management & View Switching ---
        let currentView = 'publications'; // Default view displayed on page load

        // Map of view IDs to their corresponding DOM elements
        const views = {
            publications: document.getElementById('publicationsView'),
            archivalVolumes: document.getElementById('archivalVolumesView'),
            codeOfEthics: document.getElementById('codeOfEthicsView'),
            editorialGuidelines: document.getElementById('editorialGuidelinesView'),
            editorialBoard: document.getElementById('editorialBoardView'),
            interactiveMap: document.getElementById('interactiveMapView'),
            aboutUs: document.getElementById('aboutUsView'),
            contactUs: document.getElementById('contactUsView'),
            adminLogin: document.getElementById('adminLoginView'),
            adminDashboard: document.getElementById('adminDashboardView')
        };

        // Function to show a specific view and hide all others
        function showView(viewId) {
            // First, hide all view sections
            Object.values(views).forEach(view => view.classList.add('hidden'));

            // Then, show the requested view
            const targetView = views[viewId];
            if (targetView) {
                targetView.classList.remove('hidden'); // Make the target view visible
                currentView = viewId; // Update the current view state

                // Apply dynamic styling based on whether the view is public or admin
                if (viewId === 'adminLogin' || viewId === 'adminDashboard') {
                    // Apply admin-specific background and header/footer styles
                    document.body.classList.add('admin-bg');
                    document.body.classList.remove('bg-fcf8e8', 'text-4a2c1d'); /* Remove public body styles */
                    document.querySelector('header').classList.remove('header-bg');
                    document.querySelector('header').classList.add('admin-header');
                    document.querySelector('footer').classList.remove('footer-bg');
                    document.querySelector('footer').classList.add('admin-footer');
                } else {
                    // Apply public-facing (archaeological) theme styles
                    document.body.classList.remove('admin-bg');
                    document.body.classList.add('bg-fcf8e8', 'text-4a2c1d'); /* Add public body styles */
                    document.querySelector('header').classList.remove('admin-header');
                    document.querySelector('header').classList.add('header-bg');
                    document.querySelector('footer').classList.remove('admin-footer');
                    document.querySelector('footer').classList.add('footer-bg');
                }

                // Special handling for the interactive map view: ensure it initializes
                // or refreshes its size when made visible.
                if (viewId === 'interactiveMap') {
                    initializeMap();
                }
            } else {
                // If a requested view ID doesn't exist, log a warning and show a modal message.
                console.warn("View not found:", viewId);
                showMessageModal("msgViewNotFound", "The requested page could not be found.", "error");
            }
        }

        // --- Event Listeners for Navigation ---
        // Attach click listeners to all buttons that switch views
        document.querySelectorAll('.view-button').forEach(button => {
            button.addEventListener('click', (e) => {
                showView(e.target.dataset.view); // Get view ID from data-view attribute
            });
        });

        // Specific listeners for Admin Login/Logout buttons
        document.getElementById('adminLoginBtn').addEventListener('click', () => showView('adminLogin'));
        document.getElementById('adminLogoutBtn').addEventListener('click', async () => {
            try {
                await signOut(auth); // Sign out the current user
                showMessageModal("msgLoggedOut", "You have been logged out successfully.", "success");
                showView('publications'); // Redirect to the main publications view after logout
            } catch (error) {
                console.error("Error logging out:", error);
                showMessageModal("msgErrorLoggingOut", "Error logging out: " + error.message, "error");
            }
        });

        // Function to update the visibility of Admin Login/Logout buttons based on auth status
        function updateAuthUI() {
            const user = auth.currentUser;
            // Simple check: if a user is logged in AND their email matches a predefined admin email, consider them admin.
            // For a real app, this would involve Firebase custom claims or roles.
            const isAdmin = user && user.email === 'admin@example.com';

            if (isAdmin) {
                // If admin, hide login button and show logout button
                document.getElementById('adminLoginBtn').classList.add('hidden');
                document.getElementById('adminLogoutBtn').classList.remove('hidden');
                // If currently on the admin login page and now logged in as admin, redirect to dashboard
                if (currentView === 'adminLogin') {
                    showView('adminDashboard');
                }
            } else {
                // If not admin (or logged out), show login button and hide logout button
                document.getElementById('adminLoginBtn').classList.remove('hidden');
                document.getElementById('adminLogoutBtn').classList.add('hidden');
                // If currently on the admin dashboard but not logged in as admin, redirect to publications
                if (currentView === 'adminDashboard') {
                    showView('publications');
                }
            }
        }

        // --- Firebase Firestore and Storage Operations ---

        // Firestore collection references for public and private data
        // Public data is shared across all users (e.g., publications)
        const publicPublicationsCollectionRef = (db) => collection(db, `artifacts/${appId}/public/data/publications`);
        // Private data is user-specific (e.g., for admin to manage their own settings if any)
        const privatePublicationsCollectionRef = (db) => collection(db, `artifacts/${appId}/users/${userId}/publications`);

        // Function to set up real-time Firestore listeners
        function setupListeners() {
            // Ensure userId is available before setting up private listeners
            if (!userId) {
                console.warn("User ID not available for setting up private listeners.");
                // Potentially handle this by only setting public listeners if not authenticated
                listenForPublicPublications();
                return;
            }

            // Listen for public publications (visible to all)
            listenForPublicPublications();

            // Listen for admin-specific publications (only if authenticated as admin)
            const user = auth.currentUser;
            const isAdmin = user && user.email === 'admin@example.com';
            if (isAdmin) {
                listenForAdminPublications();
            } else {
                // Clear admin list if not admin
                document.getElementById('adminPublicationsList').innerHTML = '<tr><td colspan="4" class="px-6 py-4 whitespace-nowrap text-sm text-neutral-500">No publications to manage.</td></tr>';
            }
        }

        // Real-time listener for public publications
        function listenForPublicPublications() {
            // Create a query to order publications by year in descending order for public display.
            // Note: Firebase `orderBy` requires an index if you combine it with `where` clauses on different fields.
            // For simplicity and to avoid index errors without explicit user requests, we sort client-side after fetching,
            // or if we sort server-side, it's a simple orderBy without complex where clauses.
            // For general display, simple `orderBy` by 'year' is common.
            const q = query(publicPublicationsCollectionRef(db), orderBy("year", "desc"));

            onSnapshot(q, (snapshot) => {
                const publications = [];
                snapshot.forEach(doc => {
                    publications.push({ id: doc.id, ...doc.data() });
                });
                console.log("Public publications updated:", publications);
                displayPublications(publications); // Render publications on the public view
            }, (error) => {
                console.error("Error listening to public publications:", error);
                showMessageModal("msgPublicationLoadError", "Error loading publications: " + error.message, "error");
            });
        }

        // Real-time listener for publications in the admin dashboard
        function listenForAdminPublications() {
             // For admin view, we might want to see all, potentially sorted by title or year.
             // Again, `orderBy` should be used carefully with `where` or just rely on client-side sort if complex queries arise.
            const q = query(publicPublicationsCollectionRef(db), orderBy("title"));

            onSnapshot(q, (snapshot) => {
                const adminPublications = [];
                snapshot.forEach(doc => {
                    adminPublications.push({ id: doc.id, ...doc.data() });
                });
                console.log("Admin publications updated:", adminPublications);
                displayAdminPublications(adminPublications); // Render publications on the admin dashboard
            }, (error) => {
                console.error("Error listening to admin publications:", error);
                // No modal here as it would interrupt admin workflow, just console log
            });
        }

        // Function to display publications on the public-facing 'Publications' view
        function displayPublications(publications) {
            const publicationsListDiv = document.getElementById('publicationsList');
            publicationsListDiv.innerHTML = ''; // Clear existing list

            if (publications.length === 0) {
                publicationsListDiv.innerHTML = '<p class="col-span-full text-center text-neutral-500" data-lang-key="msgNoPublications">No publications found.</p>';
                return;
            }

            // Apply search and sort logic here (New Feature 4)
            const searchTerm = document.getElementById('publicationSearch').value.toLowerCase();
            const sortBy = document.getElementById('sortPublications').value;

            let filteredPublications = publications.filter(pub => {
                const titleMatch = pub.title.toLowerCase().includes(searchTerm);
                const authorsMatch = pub.authors.toLowerCase().includes(searchTerm);
                const yearMatch = String(pub.year).includes(searchTerm); // Search by year too
                const descriptionMatch = pub.description.toLowerCase().includes(searchTerm);
                return titleMatch || authorsMatch || yearMatch || descriptionMatch;
            });

            // Sort based on selection
            if (sortBy === 'year-desc') {
                filteredPublications.sort((a, b) => b.year - a.year);
            } else if (sortBy === 'year-asc') {
                filteredPublications.sort((a, b) => a.year - b.year);
            } else if (sortBy === 'title-asc') {
                filteredPublications.sort((a, b) => a.title.localeCompare(b.title));
            }

            if (filteredPublications.length === 0) {
                 publicationsListDiv.innerHTML = '<p class="col-span-full text-center text-neutral-500">No results match your search/filter criteria.</p>';
                 return;
            }

            // Render each filtered and sorted publication
            filteredPublications.forEach(book => {
                const bookCard = document.createElement('div');
                bookCard.className = 'publication-card p-4 flex flex-col items-center text-center';
                bookCard.innerHTML = `
                    ${book.coverImageUrl ? `<img src="${book.coverImageUrl}" alt="${book.title} Cover" class="cover-image rounded-lg mb-4 shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/400x600/e9dcc9/4a2c1d?text=No+Image';">` : `<img src="https://placehold.co/400x600/e9dcc9/4a2c1d?text=No+Image" alt="Placeholder Cover" class="cover-image rounded-lg mb-4 shadow-sm">`}
                    <h3 class="text-xl font-semibold mb-2 text-neutral-800">${book.title}</h3>
                    <p class="text-neutral-700 mb-1">${book.authors}</p>
                    <p class="text-amber-800 text-sm font-medium">${book.year}</p>
                    <p class="text-neutral-600 text-sm mt-2 flex-grow">${book.description}</p>
                    <div class="mt-4 flex flex-wrap justify-center gap-2">
                        <button class="nav-button text-sm view-details-button" data-id="${book.id}">View Details</button>
                        ${book.pdfUrl ? `<a href="${book.pdfUrl}" target="_blank" class="nav-button text-sm">Download PDF</a>` : ''}
                    </div>
                `;
                publicationsListDiv.appendChild(bookCard);
            });

            // Attach event listeners to "View Details" buttons
            publicationsListDiv.querySelectorAll('.view-details-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const bookId = e.target.dataset.id;
                    const book = publications.find(p => p.id === bookId);
                    if (book) {
                        showPublicationDetailsModal(book);
                    }
                });
            });
        }

        // Event listeners for search and sort (New Feature 4 - part of displayPublications)
        document.getElementById('publicationSearch').addEventListener('input', () => {
            // Trigger a re-render of publications to apply filter
            // Since listenForPublicPublications sets up a snapshot, we could also re-filter the current list
            // For simplicity, directly re-calling displayPublications with the current data state (which is reactive)
            // Or, if data is not immediately reactive, fetch again. For now, we assume displayPublications will use latest snapshot data.
            if (db) { // Ensure Firebase is initialized
                const q = query(publicPublicationsCollectionRef(db), orderBy("year", "desc")); // Fetch all or ordered data
                getDocs(q).then(snapshot => {
                    const publications = [];
                    snapshot.forEach(doc => publications.push({ id: doc.id, ...doc.data() }));
                    displayPublications(publications);
                }).catch(error => {
                    console.error("Error re-fetching publications for search/sort:", error);
                });
            }
        });

        document.getElementById('sortPublications').addEventListener('change', () => {
            // Trigger a re-render of publications to apply sort
            if (db) {
                const q = query(publicPublicationsCollectionRef(db), orderBy("year", "desc")); // Fetch all or ordered data
                getDocs(q).then(snapshot => {
                    const publications = [];
                    snapshot.forEach(doc => publications.push({ id: doc.id, ...doc.data() }));
                    displayPublications(publications);
                }).catch(error => {
                    console.error("Error re-fetching publications for search/sort:", error);
                });
            }
        });


        // Function to display publications in the Admin Dashboard table
        function displayAdminPublications(publications) {
            const adminPublicationsListBody = document.getElementById('adminPublicationsList');
            adminPublicationsListBody.innerHTML = ''; // Clear existing table rows

            if (publications.length === 0) {
                adminPublicationsListBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 whitespace-nowrap text-sm text-neutral-500">No publications to manage.</td></tr>';
                return;
            }

            publications.forEach(book => {
                const row = adminPublicationsListBody.insertRow();
                row.className = 'hover:bg-neutral-50 transition duration-150';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-neutral-900">${book.title}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral-800">${book.authors}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral-600">${book.year}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-indigo-600 hover:text-indigo-900 mr-4 edit-publication-button" data-id="${book.id}">Edit</button>
                        <button class="text-red-600 hover:text-red-900 delete-publication-button" data-id="${book.id}">Delete</button>
                    </td>
                `;
            });

            // Attach event listeners for edit and delete buttons in the admin table
            adminPublicationsListBody.querySelectorAll('.edit-publication-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const bookId = e.target.dataset.id;
                    // Logic to populate edit form with book data
                    editPublication(bookId);
                });
            });

            adminPublicationsListBody.querySelectorAll('.delete-publication-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const bookId = e.target.dataset.id;
                    confirmDeletePublication(bookId);
                });
            });
        }

        // --- Add New Publication Form Handling ---
        document.getElementById('addPublicationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoadingSpinner(); // Show loading spinner

            // Get form values
            const title = document.getElementById('bookTitle').value;
            const authors = document.getElementById('bookAuthors').value;
            const year = parseInt(document.getElementById('bookYear').value, 10);
            const description = document.getElementById('bookDescription').value;
            const coverFile = document.getElementById('bookCover').files[0];
            const pdfFile = document.getElementById('bookPdf').files[0];

            if (!db || !auth.currentUser) {
                showMessageModal("msgAuthRequired", "Authentication required to add publications.", "error");
                hideLoadingSpinner();
                return;
            }

            try {
                let coverImageUrl = '';
                let pdfUrl = '';
                let coverImageFileName = ''; // To store the file name for deletion
                let pdfFileName = ''; // To store the file name for deletion

                // Upload cover image to Firebase Storage if provided
                if (coverFile) {
                    coverImageFileName = `${Date.now()}_${coverFile.name}`;
                    const coverStorageRef = ref(storage, `artifacts/${appId}/public/files/covers/${coverImageFileName}`);
                    await uploadBytes(coverStorageRef, coverFile);
                    coverImageUrl = await getDownloadURL(coverStorageRef);
                    console.log("Cover uploaded:", coverImageUrl);
                }

                // Upload PDF file to Firebase Storage if provided
                if (pdfFile) {
                    pdfFileName = `${Date.now()}_${pdfFile.name}`;
                    const pdfStorageRef = ref(storage, `artifacts/${appId}/public/files/pdfs/${pdfFileName}`);
                    await uploadBytes(pdfStorageRef, pdfFile);
                    pdfUrl = await getDownloadURL(pdfStorageRef);
                    console.log("PDF uploaded:", pdfUrl);
                }

                // Add publication data to Firestore
                await addDoc(publicPublicationsCollectionRef(db), {
                    title,
                    authors,
                    year,
                    description,
                    coverImageUrl,
                    coverImageFileName, // Save filename for future deletion
                    pdfUrl,
                    pdfFileName, // Save filename for future deletion
                    createdAt: new Date()
                });

                showMessageModal("msgPublicationAdded", "Publication added successfully!", "success");
                e.target.reset(); // Clear form
            } catch (error) {
                console.error("Error adding publication:", error);
                showMessageModal("msgErrorAddingPublication", "Error adding publication: " + error.message, "error");
            } finally {
                hideLoadingSpinner(); // Hide loading spinner
            }
        });

        // --- Edit Publication Handling (Placeholder - Requires form for editing) ---
        async function editPublication(bookId) {
            // In a full implementation, this would involve:
            // 1. Fetching the document data by bookId.
            // 2. Populating a dedicated "edit publication" form with the fetched data.
            // 3. Handling file updates (delete old, upload new if changed).
            // 4. Updating the document in Firestore using `updateDoc`.
            showMessageModal("msgFeatureComingSoon", `Edit functionality for ID: ${bookId} is coming soon!`);
            console.log("Attempting to edit publication with ID:", bookId);
        }

        // --- Delete Publication Handling ---
        function confirmDeletePublication(bookId) {
            showMessageModal(
                "msgConfirmDelete",
                "Are you sure you want to delete this publication? This action cannot be undone.",
                "confirm",
                async (confirmed) => {
                    if (confirmed) {
                        showLoadingSpinner();
                        try {
                            const bookRef = doc(publicPublicationsCollectionRef(db), bookId);
                            const bookDoc = await getDoc(bookRef); // Get document to retrieve file names

                            if (bookDoc.exists()) {
                                const bookData = bookDoc.data();

                                // Delete cover image from Storage if it exists
                                if (bookData.coverImageFileName) {
                                    try {
                                        const coverStorageRef = ref(storage, `artifacts/${appId}/public/files/covers/${bookData.coverImageFileName}`);
                                        await deleteObject(coverStorageRef);
                                        console.log("Cover image deleted from Storage:", bookData.coverImageFileName);
                                    } catch (storageError) {
                                        console.warn("Could not delete cover image from Storage (might not exist or permission issue):", bookData.coverImageFileName, storageError);
                                    }
                                }

                                // Delete PDF file from Storage if it exists
                                if (bookData.pdfFileName) {
                                    try {
                                        const pdfStorageRef = ref(storage, `artifacts/${appId}/public/files/pdfs/${bookData.pdfFileName}`);
                                        await deleteObject(pdfStorageRef);
                                        console.log("PDF file deleted from Storage:", bookData.pdfFileName);
                                    } catch (storageError) {
                                        console.warn("Could not delete PDF file from Storage (might not exist or permission issue):", bookData.pdfFileName, storageError);
                                    }
                                }

                                // Finally, delete the document from Firestore
                                await deleteDoc(bookRef);
                                showMessageModal("msgPublicationDeleted", "Publication deleted successfully!", "success");
                            } else {
                                showMessageModal("msgPublicationNotFound", "Publication not found for deletion.", "error");
                            }
                        } catch (error) {
                            console.error("Error removing document:", error);
                            showMessageModal("msgErrorDeletingPublication", "Error deleting publication: " + error.message, "error");
                        } finally {
                            hideLoadingSpinner();
                        }
                    }
                }
            );
        }

        // --- Custom Modal (Alert/Confirm Replacement) ---
        const messageModal = document.getElementById('messageModal');
        const messageText = document.getElementById('messageText');
        const modalButtons = document.getElementById('modalButtons');
        const closeMessageModal = document.getElementById('closeMessageModal');

        // Close modal when 'x' is clicked
        closeMessageModal.addEventListener('click', () => messageModal.style.display = 'none');
        // Close modal when clicking outside of it
        window.addEventListener('click', (event) => {
            if (event.target === messageModal) {
                messageModal.style.display = 'none';
            }
        });

        // Function to show a custom modal for messages or confirmations
        function showMessageModal(key, message, type = "alert", callback = null) {
            messageText.textContent = message;
            modalButtons.innerHTML = ''; // Clear previous buttons

            if (type === "confirm") {
                // For confirmation, add Yes/No buttons
                const yesButton = document.createElement('button');
                yesButton.textContent = 'Yes';
                yesButton.className = 'nav-button bg-red-600 hover:bg-red-700 text-white';
                yesButton.onclick = () => {
                    messageModal.style.display = 'none';
                    if (callback) callback(true);
                };
                modalButtons.appendChild(yesButton);

                const noButton = document.createElement('button');
                noButton.textContent = 'No';
                noButton.className = 'nav-button bg-gray-500 hover:bg-gray-600 text-white';
                noButton.onclick = () => {
                    messageModal.style.display = 'none';
                    if (callback) callback(false);
                };
                modalButtons.appendChild(noButton);
            } else {
                // For alerts or simple messages, add an OK button
                const okButton = document.createElement('button');
                okButton.textContent = 'OK';
                okButton.className = 'nav-button bg-amber-600 hover:bg-amber-700 text-white';
                okButton.onclick = () => {
                    messageModal.style.display = 'none';
                    if (callback) callback();
                };
                modalButtons.appendChild(okButton);
            }
            messageModal.style.display = 'flex'; // Show the modal
        }

        // --- Loading Spinner Functions ---
        const loadingSpinner = document.getElementById('loadingSpinner');

        function showLoadingSpinner() {
            loadingSpinner.classList.remove('hidden');
        }

        function hideLoadingSpinner() {
            loadingSpinner.classList.add('hidden');
        }

        // --- Interactive Map Initialization (New Feature 2) ---
        let map; // Declare map variable globally or in a scope accessible to initializeMap

        function initializeMap() {
            // Only initialize map if it hasn't been initialized yet
            if (map) {
                map.invalidateSize(); // Invalidate size if the map container changes visibility/size
                return;
            }

            // Check if the map container element exists
            const mapContainer = document.getElementById('mapid');
            if (!mapContainer) {
                console.error("Map container #mapid not found.");
                return;
            }

            // Initialize Leaflet map
            // Center map on Libya: [latitude, longitude]
            // Zoom level can be adjusted: 5-7 is good for a country-wide view
            map = L.map('mapid').setView([26.3351, 17.2283], 6);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            // Add mock markers for archaeological sites in Libya
            const sites = [
                { lat: 32.65, lon: 14.30, name: "Leptis Magna", info: "Major Roman city on the coast." },
                { lat: 32.78, lon: 21.85, name: "Cyrene", info: "Ancient Greek and Roman city, UNESCO World Heritage site." },
                { lat: 32.53, lon: 21.09, name: "Apollonia", info: "Ancient Greek port of Cyrene." },
                { lat: 26.50, lon: 10.00, name: "Tadrart Acacus", info: "Mountain range with prehistoric rock art, UNESCO World Heritage site." },
                { lat: 30.90, lon: 13.00, name: "Sabratha", info: "Ancient Roman city, part of UNESCO World Heritage site of Tripolitania." },
                { lat: 24.30, lon: 14.00, name: "Ghadames", info: "Ancient oasis town and UNESCO World Heritage site." }
            ];

            sites.forEach(site => {
                L.marker([site.lat, site.lon])
                    .addTo(map)
                    .bindPopup(`<b>${site.name}</b><br>${site.info}<br><a href="#" onclick="showMessageModal('siteInfo', '${site.name} details coming soon!')">More Info</a>`);
            });

            console.log("Leaflet map initialized.");
        }

        // --- Initial Load Logic ---
        window.onload = function() {
            initializeFirebase(); // Start Firebase initialization and auth process
            document.getElementById('currentYear').textContent = new Date().getFullYear(); // Set current year in footer
            showView('publications'); // Display the default publications view
        };
    </script>
</body>
</html>
