<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="pageTitle">Quaderni di Archeologia della Libya - Publications</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Global Font and Base Colors - Refined Cooler Greys */
        body { font-family: 'EB Garamond', serif; background-color: #e8e9eb; color: #3f4245; line-height: 1.6; }
        h1, h2, h3, h4, h5, h6 { font-family: 'EB Garamond', serif; color: #2c2f33; font-weight: 700; }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .header-bg { background-color: #d8dbdf; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-bottom: 1px solid #c0c4c9; }
        .header-logo { max-height: 120px; width: auto; filter: none; }
        .nav-button { background-color: #5f6b7a; color: #ffffff; font-family: 'EB Garamond', serif; padding: 0.75rem 1.25rem; border-radius: 6px; transition: all 0.2s ease-in-out; text-decoration: none; display: inline-block; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1); white-space: nowrap; border: 1px solid #505c68; }
        .nav-button:hover { background-color: #72808f; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .lang-button { background-color: #8c98a7; color: #ffffff; font-family: 'EB Garamond', serif; padding: 0.5rem 0.8rem; border-radius: 4px; transition: all 0.2s ease-in-out; font-weight: 600; border: 1px solid #7a8694; }
        .lang-button:hover { background-color: #a0aab8; transform: translateY(-1px); }
        .lang-button.active { background-color: #3b76a7; border-color: #2e5a80; box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); }
        .header-search-container { background-color: #e0e2e5; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: inset 0 1px 4px rgba(0,0,0,0.03); border: 1px solid #c0c4c9; }
        .search-input, .search-select { border: 1px solid #a0a8b3; border-radius: 4px; padding: 0.6rem 1rem; font-family: 'EB Garamond', serif; color: #3f4245; background-color: #f0f2f5; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); }
        .search-input::placeholder, .search-select option { color: #7f8a94; }
        .search-input:focus, .search-select:focus { border-color: #5f6b7a; outline: none; box-shadow: 0 0 0 2px rgba(95, 107, 122, 0.2); }
        .search-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292%22%20height%3D%22292%22%20viewBox%3D%220%200%20292%20292%22%3E%3Cpath%20fill%3D%22%237f8a94%22%20d%3D%22M287%2069.4L146.7%20209.6%206.4%2069.4c-4.2-4.1-11-4.1-15.2%200-4.2%204.1-4.2%2010.8%200%2014.9l145%20146.5c4%204%2010.4%204%2014.4%200l145-146.5c4.2-4.1%204.2-10.8%200-14.9-4.2-4.1-11-4.1-15.2%200z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 0.8em; padding-right: 2.5rem; }
        .section-content { background-color: #f0f2f5; border-radius: 12px; padding: 2.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 2.5rem; animation: fadeIn 0.8s ease-out; border: 1px solid #d0d5dc; }
        .publication-card { background-color: #f8f9fa; border: 1px solid #e0e5ea; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.2s ease, box-shadow 0.2s ease; cursor: pointer; }
        .publication-card:hover { transform: translateY(-5px); box-shadow: 0 6px 15px rgba(0,0,0,0.15); }
        .cover-image { width: 100%; height: 250px; object-fit: cover; border-bottom: 1px solid #e0e5ea; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; padding: 1rem; }
        .modal.flex { display: flex; }
        .modal-content { background-color: #e8e9eb; margin: auto; padding: 2.5rem; border-radius: 10px; box-shadow: 0 8px 20px rgba(0,0,0,0.4); width: 90%; max-width: 700px; text-align: center; position: relative; border: 1px solid #a0a8b3; }
        .modal-close-button { position: absolute; top: 15px; right: 25px; color: #7f8a94; font-size: 32px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .modal-close-button:hover { color: #2c2f33; }
        .modal-buttons button { background-color: #5f6b7a; color: white; padding: 0.8rem 1.5rem; border-radius: 6px; transition: background-color 0.2s ease; font-family: 'EB Garamond', serif; font-weight: 600; }
        .modal-buttons button:hover { background-color: #72808f; }
        .admin-bg { background-color: #c0c4c9; color: #2c2f33; }
        .admin-section { background-color: #d8dbdf; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 2rem; color: #3f4245; }
        .admin-section h3 { color: #2c2f33; }
        .admin-input { border: 1px solid #a0a8b3; border-radius: 4px; padding: 0.5rem 1rem; font-family: 'EB Garamond', serif; color: #3f4245; background-color: #f0f2f5; }
        .admin-input::placeholder { color: #7f8a94; }
        .admin-input:focus { border-color: #5f6b7a; box-shadow: 0 0 0 2px rgba(95, 107, 122, 0.2); }
        .admin-button { background-color: #5f6b7a; color: #ffffff; padding: 0.75rem 1.5rem; border-radius: 6px; transition: background-color 0.2s ease; font-family: 'EB Garamond', serif; font-weight: 600; }
        .admin-button:hover { background-color: #72808f; }
        .admin-button.bg-red-600 { background-color: #dc2626; border-color: #b91c1c;} .admin-button.bg-red-600:hover { background-color: #b91c1c; }
        .admin-button.bg-green-600 { background-color: #16a34a; border-color: #15803d; } .admin-button.bg-green-600:hover { background-color: #15803d; }
        .admin-button.bg-blue-600 { background-color: #2563eb; border-color: #1d4ed8; } .admin-button.bg-blue-600:hover { background-color: #1d4ed8; }
        .footer-bg { background-color: #a0a8b3; color: #2c2f33; padding: 2rem; box-shadow: 0 -2px 8px rgba(0,0,0,0.1); border-top: 1px solid #b0b8c3; }
        .footer-logo { max-height: 80px; width: auto; filter: none; }
        .footer-link { color: #3b76a7; } .footer-link:hover { color: #2e5a80; text-decoration: underline; }
        .modal-download-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.75rem; margin-top: 1.5rem; }
        .modal-download-group a, .modal-download-group button { background-color: #3b76a7; color: white; padding: 0.6rem 1.2rem; border-radius: 5px; font-size: 0.9rem; transition: background-color 0.2s ease; font-family: 'EB Garamond', serif; font-weight: 600; text-decoration: none; box-shadow: 0 1px 3px rgba(0,0,0,0.2); border: 1px solid #2e5a80; }
        .modal-download-group a:hover, .modal-download-group button:hover { background-color: #2e5a80; }
        .modal-download-group a.disabled, .modal-download-group button.disabled { background-color: #c0c4c9; color: #5f6b7a; cursor: not-allowed; box-shadow: none; opacity: 0.7; border-color: #b0b8c3; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .section-separator { border-top: 1px solid #c0c4c9; margin: 3rem 0; }
        .admin-table-header { background-color: #c0c4c9; } .admin-table-row { background-color: #e0e2e5; color: #3f4245; }
        .admin-table-row:nth-child(even) { background-color: #f0f2f5; }
        .admin-table-row td { border-bottom: 1px solid #d0d5dc; padding: 0.75rem 1.5rem; }
        .admin-table-row:hover { background-color: #d0d5dc; }
        .file-upload-preview { display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem; }
        .file-upload-preview img { max-width: 80px; height: auto; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .file-upload-preview p { font-size: 0.875rem; color: #7f8a94; }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div id="loadingSpinner" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[2000] hidden">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-white"></div>
    </div>

    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button" id="closeMessageModal">&times;</span>
            <p id="messageText" class="text-lg text-gray-800 mb-4"></p>
            <div id="modalButtons" class="modal-buttons flex justify-center gap-4"></div>
        </div>
    </div>

    <div id="publicationDetailsModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button" id="closePublicationDetailsModal">&times;</span>
            <img id="detailCoverImage" src="https://placehold.co/400x600/cccccc/333333?text=No+Image" alt="Publication Cover" class="w-full max-w-[200px] h-auto object-cover mx-auto mb-4 rounded-md shadow-md">
            <h3 id="detailTitle" class="text-2xl font-bold text-gray-800 mb-2"></h3>
            <p id="detailAuthors" class="text-gray-600 text-lg mb-1"></p>
            <p id="detailYear" class="text-gray-500 text-md font-medium mb-3"></p>
            <p id="detailDescription" class="text-gray-700 text-base leading-relaxed text-left mb-6"></p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left text-gray-700 mb-6">
                <div><strong data-lang-key="isbnLabel">ISBN:</strong> <span id="detailISBN">N/A</span></div>
                <div><strong data-lang-key="issnLabel">ISSN:</strong> <span id="detailISSN">N/A</span></div>
            </div>
            <div class="modal-download-group">
                <a id="detailDownloadPdfBtn" href="#" target="_blank" class="admin-button" data-lang-key="downloadFullPdfBtn"></a>
                <a id="detailDownloadAbstractArBtn" href="#" target="_blank" class="admin-button" data-lang-key="downloadArabicAbstractPdfBtn"></a>
                <a id="detailDownloadAbstractEnBtn" href="#" target="_blank" class="admin-button" data-lang-key="downloadEnglishAbstractPdfBtn"></a>
                <a id="detailDownloadAbstractItBtn" href="#" target="_blank" class="admin-button" data-lang-key="downloadItalianAbstractPdfBtn"></a>
            </div>
            <div class="text-gray-700 text-base leading-relaxed text-left mt-6 space-y-3">
                <p><strong class="font-semibold" data-lang-key="arabicAbstractTextLabel"></strong> <span id="detailAbstractArText"></span></p>
                <p><strong class="font-semibold" data-lang-key="englishAbstractTextLabel"></strong> <span id="detailAbstractEnText"></span></p>
                <p><strong class="font-semibold" data-lang-key="italianAbstractTextLabel"></strong> <span id="detailAbstractItText"></span></p>
            </div>
        </div>
    </div>

    <header class="header-bg py-4 px-6 shadow-sm">
        <div class="container flex flex-col gap-4">
            <div class="flex flex-col md:flex-row items-center justify-between w-full gap-4">
                <div class="flex-shrink-0"><img id="mainHeaderLogo" src="https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/header_logos%2FLogo%20QAL%20arabo%20300%20dpi.jpeg?alt=media&token=c2d438d9-9ba2-49ec-a32a-517ed18775ee" alt="Quaderni di Archeologia della Libya Logo" class="header-logo"></div>
                <div class="header-search-container flex flex-col sm:flex-row items-center gap-4 flex-grow md:max-w-xl lg:max-w-2xl">
                    <input type="text" id="publicationSearch" data-lang-key="searchPlaceholder" class="search-input flex-grow w-full sm:w-auto">
                    <select id="sortPublications" class="search-select w-full sm:w-auto">
                        <option value="year-desc" data-lang-key="sortYearNewest"></option><option value="year-asc" data-lang-key="sortYearOldest"></option>
                        <option value="title-asc" data-lang-key="sortTitleAZ"></option><option value="title-desc" data-lang-key="sortTitleZA"></option>
                        <option value="author-asc" data-lang-key="sortAuthorAZ"></option><option value="author-desc" data-lang-key="sortAuthorZA"></option>
                    </select>
                </div>
                <div class="flex space-x-2 mt-4 md:mt-0"><button class="lang-button" data-lang="en">ENG</button><button class="lang-button" data-lang="it">ITA</button></div>
            </div>
            <nav class="flex flex-wrap justify-center items-center space-x-2 md:space-x-4 w-full pt-4 md:pt-0">
                <button class="nav-button view-button" data-view="aboutUs" data-lang-key="navAboutUs"></button>
                <button class="nav-button view-button" data-view="editorialBoard" data-lang-key="navEditorialBoard"></button>
                <button class="nav-button view-button" data-view="currentIssue" data-lang-key="navCurrentIssue"></button>
                <button class="nav-button view-button" data-view="archivalVolumes" data-lang-key="navArchivalVolumes"></button>
                <button class="nav-button view-button" data-view="editorialAndEthics" data-lang-key="navEditorialEthics"></button>
                <button class="nav-button view-button" data-view="newsEvents" data-lang-key="navNewsEvents"></button>
            </nav>
        </div>
    </header>

    <main class="flex-grow container mt-8">
        <section id="aboutUsView" class="view section-content">
            <h2 class="text-3xl text-center mb-6" data-lang-key="aboutUsHeading"></h2>
            <div class="prose max-w-none text-gray-700 leading-relaxed space-y-4">
                <p data-lang-key="aboutUsPara1"></p><p data-lang-key="aboutUsPara2"></p>
                <p data-lang-key="aboutUsPara3"></p><p data-lang-key="aboutUsPara4"></p>
            </div>
            <div class="section-separator"></div>
            <h2 class="text-3xl text-center mb-6" data-lang-key="currentPublicationsHeading"></h2>
            <div id="publicationsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <p class="col-span-full text-center text-gray-400" data-lang-key="loadingPublications"></p>
            </div>
        </section>

        <section id="editorialBoardView" class="view hidden section-content">
            <h2 class="text-3xl text-center mb-6" data-lang-key="editorialBoardHeading"></h2>
            <p class="text-center text-gray-700 mb-8" data-lang-key="editorialBoardIntro"></p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="bg-gray-100 p-6 rounded-lg shadow-md border text-center"><img class="w-32 h-32 rounded-full mx-auto mb-4 object-cover border-2" src="https://placehold.co/128x128/e0e2e5/3f4245?text=EB" alt="Eugenio La Rocca"><h3 class="text-xl font-semibold">Prof. Eugenio La Rocca</h3><p class="text-sm mb-2" data-lang-key="editorInChief"></p><p class="text-sm">University of Rome "La Sapienza"</p></div>
                <div class="bg-gray-100 p-6 rounded-lg shadow-md border text-center"><img class="w-32 h-32 rounded-full mx-auto mb-4 object-cover border-2" src="https://placehold.co/128x128/e0e2e5/3f4245?text=AH" alt="Ahmed Hussein Y. Abdulkariem"><h3 class="text-xl font-semibold">Dr. Ahmed Hussein Y. Abdulkariem</h3><p class="text-sm mb-2" data-lang-key="associateEditor"></p><p class="text-sm">Department of Antiquities, Libya</p></div>
                <div class="bg-gray-100 p-6 rounded-lg shadow-md border text-center"><img class="w-32 h-32 rounded-full mx-auto mb-4 object-cover border-2" src="https://placehold.co/128x128/e0e2e5/3f4245?text=BB" alt="Barbara Barich"><h3 class="text-xl font-semibold">Prof. Barbara Barich</h3><p class="text-sm mb-2" data-lang-key="editorialBoardMember"></p><p class="text-sm">University of Rome "La Sapienza"</p></div>
            </div>
            <p class="text-center text-gray-600 mt-8" data-lang-key="editorialBoardComingSoon"></p>
        </section>

        <section id="currentIssueView" class="view hidden section-content flex flex-col items-center">
            <h2 class="text-3xl text-center mb-6" data-lang-key="currentIssueHeading"></h2>
            <div class="text-center w-full max-w-3xl" id="currentIssueContent">
                <p class="text-gray-700 text-lg mb-4" data-lang-key="noCurrentIssue"></p>
                <div id="currentIssuePublicationCard" class="publication-card p-6 flex flex-col items-center text-center shadow-lg hidden">
                    <img id="currentIssueCover" src="" alt="Current Issue Cover" class="cover-image rounded-lg mb-6 shadow-xl" onerror="this.onerror=null;this.src='https://placehold.co/400x600/cccccc/333333?text=No+Image';">
                    <h3 id="currentIssueTitle" class="text-3xl font-bold mb-3"></h3><p id="currentIssueAuthors" class="text-xl mb-2"></p>
                    <p id="currentIssueYear" class="text-lg font-medium mb-4"></p><p id="currentIssueDescription" class="text-md leading-relaxed mb-6"></p>
                    <div class="modal-download-group">
                        <a id="currentIssueDownloadPdfBtn" href="#" target="_blank" class="admin-button" data-lang-key="downloadFullPdfBtn"></a>
                        <a id="currentIssueDownloadAbstractArBtn" href="#" target="_blank" class="admin-button" data-lang-key="downloadArabicAbstractPdfBtn"></a>
                        <a id="currentIssueDownloadAbstractEnBtn" href="#" target="_blank" class="admin-button" data-lang-key="downloadEnglishAbstractPdfBtn"></a>
                        <a id="currentIssueDownloadAbstractItBtn" href="#" target="_blank" class="admin-button" data-lang-key="downloadItalianAbstractPdfBtn"></a>
                    </div>
                </div>
            </div>
        </section>

        <section id="archivalVolumesView" class="view hidden section-content">
            <h2 class="text-3xl text-center mb-6" data-lang-key="archivalVolumesHeading"></h2>
            <p class="text-center text-gray-700 mb-8" data-lang-key="archivalVolumesIntro"></p>
            <div id="archivalPublicationsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"><p class="col-span-full text-center text-gray-400" data-lang-key="loadingArchivalVolumes"></p></div>
        </section>

        <section id="editorialAndEthicsView" class="view hidden section-content">
            <h2 class="text-3xl text-center mb-6" data-lang-key="editorialEthicsHeading"></h2>
            <div class="prose max-w-none text-gray-700 leading-relaxed space-y-4">
                <h3 class="text-2xl font-bold mt-6 mb-3" data-lang-key="editorialGuidelinesTitle"></h3><p class="text-lg font-semibold" data-lang-key="articlesSubmittedTo"></p>
                <ul class="list-disc ml-6 space-y-1"><li><a href="mailto:redazione@quadalibya.it" class="text-blue-600 hover:underline">redazione@quadalibya.it</a></li><li><a href="mailto:laura.buccino@quadalibya.it" class="text-blue-600 hover:underline">laura.buccino@quadalibya.it</a></li></ul>
                <h4 class="text-xl font-bold mt-4 mb-2" data-lang-key="submissionProcedureTitle"></h4><ul class="list-disc ml-6 space-y-2"><li data-lang-key="submissionProcedure1"></li><li data-lang-key="submissionProcedure2"></li><li data-lang-key="submissionProcedure3"></li><li data-lang-key="submissionProcedure4"></li><li data-lang-key="submissionProcedure5"></li></ul>
                <h4 class="text-xl font-bold mt-4 mb-2" data-lang-key="articleRequirementsTitle"></h4><ul class="list-disc ml-6 space-y-2"><li data-lang-key="articleRequirements1"></li><li data-lang-key="articleRequirements2"></li><li data-lang-key="articleRequirements3"></li><li data-lang-key="articleRequirements4"></li><li data-lang-key="articleRequirements5"></li><li data-lang-key="articleRequirements6"></li></ul>
                <h4 class="text-xl font-bold mt-4 mb-2" data-lang-key="formattingGuidelinesTitle"></h4><ul class="list-disc ml-6 space-y-2"><li data-lang-key="formattingGuidelines1"></li><li data-lang-key="formattingGuidelines2"></li><li data-lang-key="formattingGuidelines3"></li><li data-lang-key="formattingGuidelines4"></li><li data-lang-key="formattingGuidelines5"></li></ul>
                <h4 class="text-xl font-bold mt-4 mb-2" data-lang-key="commonAbbreviationsTitle"></h4><ul class="list-disc ml-6 space-y-1"><li data-lang-key="abbrCat"></li><li data-lang-key="abbrCf"></li><li data-lang-key="abbrCm"></li><li data-lang-key="abbrCol"></li><li data-lang-key="abbrEAD"></li><li data-lang-key="abbrEtc"></li><li data-lang-key="abbrF"></li><li data-lang-key="abbrFig"></li><li data-lang-key="abbrFol"></li><li data-lang-key="abbrID"></li><li data-lang-key="abbrIID"></li><li data-lang-key="abbrL"></li><li data-lang-key="abbrNoInv"></li><li data-lang-key="abbrM"></li><li data-lang-key="abbrMs"></li><li data-lang-key="abbrNo"></li><li data-lang-key="abbrNd"></li><li data-lang-key="abbrNp"></li><li data-lang-key="abbrNote"></li><li data-lang-key="abbrP"></li><li data-lang-key="abbrSee"></li><li data-lang-key="abbrSv"></li><li data-lang-key="abbrPl"></li><li data-lang-key="abbrVol"></li></ul>
                <p class="text-sm text-gray-600 mt-8" data-lang-key="fullGuidelinesNote"></p><div class="section-separator"></div>
                <h3 class="text-2xl font-bold mt-12 mb-3" data-lang-key="ethicsStatementTitle"></h3><p data-lang-key="ethicsStatementPara1"></p>
                <h4 class="text-xl font-bold mt-4 mb-2" data-lang-key="researchEthicsTitle"></h4><p data-lang-key="researchEthicsPara1"></p><p data-lang-key="researchEthicsPara2"></p>
                <p class="text-sm text-gray-600 mt-8" data-lang-key="lastUpdatedDate"></p>
            </div>
        </section>

        <section id="newsEventsView" class="view hidden section-content">
            <h2 class="text-3xl text-center mb-6" data-lang-key="newsEventsHeading"></h2>
            <p class="text-center text-gray-700 mb-8" data-lang-key="newsEventsIntro"></p>
            <div id="newsFeed" class="grid grid-cols-1 md:grid-cols-2 gap-8"><p class="col-span-full text-center text-gray-400" data-lang-key="noNewsUpdates"></p></div>
        </section>

        <section id="adminLoginView" class="view hidden section-content max-w-md mx-auto">
            <h2 class="text-3xl text-center mb-6" data-lang-key="adminLoginHeading"></h2>
            <form id="adminLoginForm" class="space-y-4">
                <div><label for="adminEmail" class="block text-sm font-semibold" data-lang-key="emailLabel"></label><input type="email" id="adminEmail" class="admin-input w-full" required></div>
                <div><label for="adminPassword" class="block text-sm font-semibold" data-lang-key="passwordLabel"></label><input type="password" id="adminPassword" class="admin-input w-full" required></div>
                <button type="submit" class="admin-button w-full bg-green-600" data-lang-key="loginButton"></button>
                <p class="text-red-500 text-sm mt-2 text-center" id="loginErrorMessage"></p>
            </form>
        </section>

        <section id="adminDashboardView" class="view hidden admin-bg p-8 rounded-lg shadow-md max-w-4xl mx-auto">
            <h2 class="text-3xl text-center mb-6" data-lang-key="adminDashboardHeading"></h2>
            <p class="text-center text-gray-700 mb-4"><span data-lang-key="welcomeAdmin"></span><span id="loggedInUserEmail" class="font-semibold"></span>!</p>
            <nav class="flex justify-center space-x-4 mb-8">
                <button class="admin-button" id="managePublicationsBtn" data-lang-key="managePublicationsBtn"></button><button class="admin-button" id="manageNewsBtn" data-lang-key="manageNewsBtn"></button>
                <button class="admin-button" id="manageSiteSettingsBtn" data-lang-key="manageSiteSettingsBtn"></button><button class="admin-button bg-red-600" id="adminLogoutBtn" data-lang-key="logoutButton"></button>
            </nav>
            <div id="adminManagePublications" class="admin-section">
                <h3 id="adminFormTitle" class="text-2xl font-bold mb-4" data-lang-key="addPublicationTitle"></h3>
                <form id="addPublicationForm" class="space-y-4">
                    <div><label for="bookTitle" class="block text-sm font-semibold" data-lang-key="titleLabel"></label><input type="text" id="bookTitle" class="admin-input w-full"></div>
                    <div><label for="bookAuthors" class="block text-sm font-semibold" data-lang-key="authorsLabel"></label><input type="text" id="bookAuthors" class="admin-input w-full"></div>
                    <div><label for="bookYear" class="block text-sm font-semibold" data-lang-key="publicationYearLabel"></label><input type="number" id="bookYear" class="admin-input w-full" min="1900" max="2100"></div>
                    <div><label for="bookDescription" class="block text-sm font-semibold" data-lang-key="descriptionLabel"></label><textarea id="bookDescription" rows="3" class="admin-input w-full"></textarea></div>
                    <div><label for="bookISBN" class="block text-sm font-semibold" data-lang-key="isbnLabel"></label><input type="text" id="bookISBN" class="admin-input w-full"></div>
                    <div><label for="bookISSN" class="block text-sm font-semibold" data-lang-key="issnLabel"></label><input type="text" id="bookISSN" class="admin-input w-full"></div>
                    <div><label for="bookCoverImage" class="block text-sm font-semibold" data-lang-key="coverImageLabel"></label><input type="file" id="bookCoverImage" class="admin-input w-full"></div>
                    <div id="bookCoverImagePreview" class="file-upload-preview hidden"><img src="" alt="Cover Image Preview"><p></p></div>
                    <div><label for="bookFullPdf" class="block text-sm font-semibold" data-lang-key="fullPdfLabel"></label><input type="file" id="bookFullPdf" class="admin-input w-full"></div>
                    <div id="bookFullPdfPreview" class="file-upload-preview hidden"><p></p></div>
                    <div><label for="bookAbstractAr" class="block text-sm font-semibold" data-lang-key="arabicAbstractPdfLabel"></label><input type="file" id="bookAbstractAr" class="admin-input w-full"></div>
                    <div id="bookAbstractArPreview" class="file-upload-preview hidden"><p></p></div>
                    <div><label for="bookAbstractEn" class="block text-sm font-semibold" data-lang-key="englishAbstractPdfLabel"></label><input type="file" id="bookAbstractEn" class="admin-input w-full"></div>
                    <div id="bookAbstractEnPreview" class="file-upload-preview hidden"><p></p></div>
                    <div><label for="bookAbstractIt" class="block text-sm font-semibold" data-lang-key="italianAbstractPdfLabel"></label><input type="file" id="bookAbstractIt" class="admin-input w-full"></div>
                    <div id="bookAbstractItPreview" class="file-upload-preview hidden"><p></p></div>
                    <div><label for="bookAbstractArText" class="block text-sm font-semibold" data-lang-key="arabicAbstractTextLabel"></label><textarea id="bookAbstractArText" rows="3" class="admin-input w-full"></textarea></div>
                    <div><label for="bookAbstractEnText" class="block text-sm font-semibold" data-lang-key="englishAbstractTextLabel"></label><textarea id="bookAbstractEnText" rows="3" class="admin-input w-full"></textarea></div>
                    <div><label for="bookAbstractItText" class="block text-sm font-semibold" data-lang-key="italianAbstractTextLabel"></label><textarea id="bookAbstractItText" rows="3" class="admin-input w-full"></textarea></div>
                    <div class="flex gap-4">
                        <button type="submit" class="admin-button bg-blue-600" data-lang-key="addPublicationButton"></button>
                        <button type="button" id="clearPublicationForm" class="admin-button" data-lang-key="clearFormButton"></button>
                    </div>
                </form>
                <div class="section-separator"></div>
                <h3 class="text-2xl font-bold mb-4" data-lang-key="manageExistingPublicationsTitle"></h3>
                <input type="text" id="filterPublications" data-lang-key="filterPublicationsPlaceholder" class="admin-input w-full mb-4">
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-300 rounded-lg">
                        <thead><tr class="admin-table-header"><th class="py-2 px-4 text-left" data-lang-key="titleLabel"></th><th class="py-2 px-4 text-left" data-lang-key="authorsLabel"></th><th class="py-2 px-4 text-left" data-lang-key="publicationYearLabel"></th><th class="py-2 px-4 text-left" data-lang-key="actionsLabel"></th></tr></thead>
                        <tbody id="adminPublicationsTableBody">
                            <tr><td colspan="4" class="text-center py-4 text-gray-500" data-lang-key="noPublicationsToManage"></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="adminManageNews" class="admin-section hidden">
                <h3 id="adminNewsFormTitle" class="text-2xl font-bold mb-4" data-lang-key="addNewsTitle"></h3>
                <form id="addNewsForm" class="space-y-4">
                    <div><label for="newsTitle" class="block text-sm font-semibold" data-lang-key="newsTitleLabel"></label><input type="text" id="newsTitle" class="admin-input w-full"></div>
                    <div><label for="newsDate" class="block text-sm font-semibold" data-lang-key="newsDateLabel"></label><input type="date" id="newsDate" class="admin-input w-full"></div>
                    <div><label for="newsContent" class="block text-sm font-semibold" data-lang-key="newsContentLabel"></label><textarea id="newsContent" rows="5" class="admin-input w-full"></textarea></div>
                    <div class="flex gap-4">
                        <button type="submit" class="admin-button bg-blue-600" data-lang-key="addNewsButton"></button>
                        <button type="button" id="clearNewsForm" class="admin-button" data-lang-key="clearFormButton"></button>
                    </div>
                </form>
                <div class="section-separator"></div>
                <h3 class="text-2xl font-bold mb-4" data-lang-key="manageExistingNewsTitle"></h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-300 rounded-lg">
                        <thead><tr class="admin-table-header"><th class="py-2 px-4 text-left" data-lang-key="newsTitleLabel"></th><th class="py-2 px-4 text-left" data-lang-key="newsDateLabel"></th><th class="py-2 px-4 text-left" data-lang-key="actionsLabel"></th></tr></thead>
                        <tbody id="adminNewsTableBody">
                            <tr><td colspan="3" class="text-center py-4 text-gray-500" data-lang-key="noNewsToManage"></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="adminManageSiteSettings" class="admin-section hidden">
                <h3 class="text-2xl font-bold mb-4" data-lang-key="siteSettingsTitle"></h3>
                <form id="siteSettingsForm" class="space-y-4">
                    <div><label for="siteHeaderLogo" class="block text-sm font-semibold" data-lang-key="headerLogoLabel"></label><input type="file" id="siteHeaderLogo" class="admin-input w-full"></div>
                    <div id="siteHeaderLogoPreview" class="file-upload-preview hidden"><img src="" alt="Header Logo Preview"><p></p></div>
                    <div><label for="siteFooterLogo" class="block text-sm font-semibold" data-lang-key="footerLogoLabel"></label><input type="file" id="siteFooterLogo" class="admin-input w-full"></div>
                    <div id="siteFooterLogoPreview" class="file-upload-preview hidden"><img src="" alt="Footer Logo Preview"><p></p></div>
                    <div><label for="siteContributor1Logo" class="block text-sm font-semibold" data-lang-key="contributor1LogoLabel"></label><input type="file" id="siteContributor1Logo" class="admin-input w-full"></div>
                    <div id="siteContributor1LogoPreview" class="file-upload-preview hidden"><img src="" alt="Contributor 1 Logo Preview"><p></p></div>
                    <div><label for="siteContributor2Logo" class="block text-sm font-semibold" data-lang-key="contributor2LogoLabel"></label><input type="file" id="siteContributor2Logo" class="admin-input w-full"></div>
                    <div id="siteContributor2LogoPreview" class="file-upload-preview hidden"><img src="" alt="Contributor 2 Logo Preview"><p></p></div>
                    <button type="submit" class="admin-button bg-blue-600" data-lang-key="saveSettingsButton"></button>
                </form>
            </div>
        </section>
    </main>

    <footer class="footer-bg mt-8 py-8 px-6 text-center">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="flex-shrink-0">
                <img id="mainFooterLogo" src="https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/footer_logos%2Ffooter-logo.png?alt=media&token=YOUR_TOKEN" alt="Quaderni di Archeologia della Libya Footer Logo" class="footer-logo mb-3 mx-auto">
                <div class="flex justify-center space-x-4">
                    <img id="contributor1Logo" src="https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/contributor_logos%2Fcontributor1.png?alt=media&token=YOUR_TOKEN" alt="Contributor 1 Logo" class="footer-logo">
                    <img id="contributor2Logo" src="https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/contributor_logos%2Fcontributor2.png?alt=media&token=YOUR_TOKEN" alt="Contributor 2 Logo" class="footer-logo">
                </div>
            </div>
            <div class="text-sm space-y-2 md:text-left">
                <p data-lang-key="contactEmail">Email: <a href="mailto:redazione@quadalibya.it" class="footer-link">redazione@quadalibya.it</a></p>
                <p>&copy; <span id="currentYear"></span> <span data-lang-key="journalNameShort"></span>. <span data-lang-key="allRightsReserved"></span></p>
                <p data-lang-key="designedBy">Designed by [Your Name/Org]</p>
            </div>
            <div class="text-sm space-y-2 md:text-right">
                <p data-lang-key="legalNotes">Legal Notes</p>
                <p data-lang-key="privacyPolicy">Privacy Policy</p>
                <p data-lang-key="cookiePolicy">Cookie Policy</p>
            </div>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, orderBy, onSnapshot, addDoc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js';

        // Translations object (ensure this is populated correctly from your source)
        // This should be loaded from a separate file or generated by your build process
        // For demonstration, a minimal structure:
        const translations = {
            en: {
                pageTitle: "Quaderni di Archeologia della Libya - Publications",
                navAboutUs: "About Us",
                navEditorialBoard: "Editorial Board",
                navCurrentIssue: "Current Issue",
                navArchivalVolumes: "Archival Volumes",
                navEditorialEthics: "Editorial & Ethics",
                navNewsEvents: "News & Events",
                searchPlaceholder: "Search publications...",
                sortYearNewest: "Sort by Year (Newest)",
                sortYearOldest: "Sort by Year (Oldest)",
                sortTitleAZ: "Sort by Title (A-Z)",
                sortTitleZA: "Sort by Title (Z-A)",
                sortAuthorAZ: "Sort by Author (A-Z)",
                sortAuthorZA: "Sort by Author (Z-A)",
                loadingPublications: "Loading publications...",
                noPublicationsFound: "No publications found.",
                downloadFullPdfBtn: "Download Full PDF",
                downloadArabicAbstractPdfBtn: "Download Arabic Abstract PDF",
                downloadEnglishAbstractPdfBtn: "Download English Abstract PDF",
                downloadItalianAbstractPdfBtn: "Download Italian Abstract PDF",
                isbnLabel: "ISBN:",
                issnLabel: "ISSN:",
                arabicAbstractTextLabel: "Arabic Abstract:",
                englishAbstractTextLabel: "English Abstract:",
                italianAbstractTextLabel: "Italian Abstract:",
                aboutUsHeading: "About Quaderni di Archeologia della Libya",
                aboutUsPara1: "Quaderni di Archeologia della Libya (QAL) is a peer-reviewed academic journal dedicated to the archaeology, history, and cultural heritage of Libya. It publishes original research articles, reviews, and reports on excavations, surveys, and conservation projects.",
                aboutUsPara2: "QAL aims to provide a platform for scholars and researchers to disseminate their findings and contribute to the understanding and preservation of Libya's rich archaeological legacy.",
                aboutUsPara3: "The journal emphasizes interdisciplinary approaches and encourages submissions from various fields, including classical archaeology, prehistory, Islamic archaeology, epigraphy, numismatics, and heritage management.",
                aboutUsPara4: "Published annually, QAL welcomes contributions in English, Italian, and Arabic.",
                currentPublicationsHeading: "Latest Publications",
                editorialBoardHeading: "Editorial Board",
                editorialBoardIntro: "The Editorial Board is composed of distinguished scholars from various international institutions.",
                editorInChief: "Editor-in-Chief",
                associateEditor: "Associate Editor",
                editorialBoardMember: "Editorial Board Member",
                editorialBoardComingSoon: "More members will be listed soon.",
                currentIssueHeading: "Current Issue",
                noCurrentIssue: "No current issue available at this time. Please check back later or browse our archival volumes.",
                archivalVolumesHeading: "Archival Volumes",
                archivalVolumesIntro: "Explore our collection of past issues and publications.",
                loadingArchivalVolumes: "Loading archival volumes...",
                editorialEthicsHeading: "Editorial & Ethical Guidelines",
                editorialGuidelinesTitle: "Editorial Guidelines",
                articlesSubmittedTo: "Articles should be submitted to:",
                submissionProcedureTitle: "Submission Procedure",
                submissionProcedure1: "Manuscripts must be original and not previously published or under consideration elsewhere.",
                submissionProcedure2: "Submissions should be prepared according to the formatting guidelines below.",
                submissionProcedure3: "All articles undergo a double-blind peer-review process.",
                submissionProcedure4: "Authors will be notified of the editorial decision, which may include acceptance, acceptance with revisions, or rejection.",
                submissionProcedure5: "Accepted articles will proceed to editing and publication.",
                articleRequirementsTitle: "Article Requirements",
                articleRequirements1: "Language: English, Italian, or Arabic.",
                articleRequirements2: "Length: Typically between 5,000-10,000 words (including footnotes and bibliography).",
                articleRequirements3: "Abstract: A concise abstract (150-250 words) in English, Italian, and Arabic.",
                articleRequirements4: "Keywords: 5-7 keywords.",
                articleRequirements5: "Illustrations: High-resolution images (300 dpi minimum for print).",
                articleRequirements6: "Bibliography: Follow a consistent citation style (e.g., Chicago Manual of Style or a common archaeological standard).",
                formattingGuidelinesTitle: "Formatting Guidelines",
                formattingGuidelines1: "Font: Times New Roman, 12pt for main text, 10pt for footnotes.",
                formattingGuidelines2: "Line Spacing: 1.5 for main text, single for footnotes.",
                formattingGuidelines3: "Margins: 1 inch (2.54 cm) on all sides.",
                formattingGuidelines4: "Headings: Use clear, hierarchical headings.",
                formattingGuidelines5: "Citations: In-text citations or footnotes as appropriate.",
                commonAbbreviationsTitle: "Common Abbreviations (Examples)",
                abbrCat: "Cat. = Catalogue", abbrCf: "Cf. = Confer (compare)", abbrCm: "cm = centimeter", abbrCol: "Col. = Column", abbrEAD: "e.a.d. = et alii dicuntur", abbrEtc: "etc. = et cetera", abbrF: "f./ff. = following page(s)", abbrFig: "Fig./Figs. = Figure/Figures", abbrFol: "fol./foll. = folio/folios", abbrID: "id. = idem (the same author)", abbrIID: "i.i.d. = ibidem (in the same place)", abbrL: "l./ll. = line/lines", abbrNoInv: "n. inv. = inventory number", abbrM: "m = meter", abbrMs: "Ms./Mss. = Manuscript/Manuscripts", abbrNo: "No. = Number", abbrNd: "n.d. = no date", abbrNp: "n.p. = no place/no publisher", abbrNote: "n. = note", abbrP: "p./pp. = page/pages", abbrSee: "s. = see", abbrSv: "s.v. = sub verbo", abbrPl: "Pl./Pls. = Plate/Plates", abbrVol: "Vol./Vols. = Volume/Volumes",
                fullGuidelinesNote: "A complete set of guidelines is available upon request.",
                ethicsStatementTitle: "Ethical Statement",
                ethicsStatementPara1: "Quaderni di Archeologia della Libya (QAL) is committed to upholding the highest standards of publication ethics. We adhere to the principles of transparency and best practice in scholarly publishing.",
                researchEthicsTitle: "Research Ethics",
                researchEthicsPara1: "Authors must ensure their research is conducted ethically and responsibly, respecting cultural heritage, archaeological sites, and local communities.",
                researchEthicsPara2: "Plagiarism, fabrication, and falsification of data are strictly prohibited.",
                lastUpdatedDate: "Last Updated: June 15, 2025",
                newsEventsHeading: "News & Events",
                newsEventsIntro: "Stay updated with the latest news and upcoming events related to Libyan archaeology.",
                noNewsUpdates: "No news updates at this time.",
                adminLoginHeading: "Administrator Login",
                emailLabel: "Email:",
                passwordLabel: "Password:",
                loginButton: "Login",
                adminDashboardHeading: "Admin Dashboard",
                welcomeAdmin: "Welcome, ",
                managePublicationsBtn: "Manage Publications",
                manageNewsBtn: "Manage News",
                manageSiteSettingsBtn: "Manage Site Settings",
                logoutButton: "Logout",
                addPublicationTitle: "Add/Edit Publication",
                titleLabel: "Title:",
                authorsLabel: "Authors:",
                publicationYearLabel: "Publication Year:",
                descriptionLabel: "Description:",
                coverImageLabel: "Cover Image (PDF):",
                fullPdfLabel: "Full Publication PDF:",
                arabicAbstractPdfLabel: "Arabic Abstract PDF:",
                englishAbstractPdfLabel: "English Abstract PDF:",
                italianAbstractPdfLabel: "Italian Abstract PDF:",
                addPublicationButton: "Add Publication",
                clearFormButton: "Clear Form",
                filterPublicationsPlaceholder: "Filter publications...",
                manageExistingPublicationsTitle: "Manage Existing Publications",
                actionsLabel: "Actions",
                noPublicationsToManage: "No publications to manage.",
                addNewsTitle: "Add/Edit News Item",
                newsTitleLabel: "News Title:",
                newsDateLabel: "Date:",
                newsContentLabel: "Content:",
                addNewsButton: "Add News",
                manageExistingNewsTitle: "Manage Existing News",
                noNewsToManage: "No news to manage.",
                siteSettingsTitle: "Site Settings",
                headerLogoLabel: "Header Logo:",
                footerLogoLabel: "Footer Logo:",
                contributor1LogoLabel: "Contributor 1 Logo:",
                contributor2LogoLabel: "Contributor 2 Logo:",
                saveSettingsButton: "Save Settings",
                journalNameShort: "QAL",
                allRightsReserved: "All Rights Reserved",
                designedBy: "Designed by AI",
                messageSuccess: "Success!",
                messageError: "Error!",
                messageConfirmDelete: "Are you sure you want to delete this item?",
                messageYes: "Yes",
                messageNo: "No",
                uploadingFile: "Uploading file...",
                deletingFile: "Deleting file...",
                deleteSuccess: "File deleted successfully.",
                deleteError: "Error deleting file.",
                publicationAdded: "Publication added/updated successfully.",
                publicationDeleted: "Publication deleted successfully.",
                newsAdded: "News item added/updated successfully.",
                newsDeleted: "News item deleted successfully.",
                settingsSaved: "Site settings saved successfully."
            },
            it: {
                pageTitle: "Quaderni di Archeologia della Libya - Pubblicazioni",
                navAboutUs: "Chi Siamo",
                navEditorialBoard: "Comitato Editoriale",
                navCurrentIssue: "Numero Corrente",
                navArchivalVolumes: "Volumi d'Archivio",
                navEditorialEthics: "Editoriale ed Etica",
                navNewsEvents: "Notizie ed Eventi",
                searchPlaceholder: "Cerca pubblicazioni...",
                sortYearNewest: "Ordina per Anno (Più recente)",
                sortYearOldest: "Ordina per Anno (Meno recente)",
                sortTitleAZ: "Ordina per Titolo (A-Z)",
                sortTitleZA: "Ordina per Titolo (Z-A)",
                sortAuthorAZ: "Ordina per Autore (A-Z)",
                sortAuthorZA: "Ordina per Autore (Z-A)",
                loadingPublications: "Caricamento pubblicazioni...",
                noPublicationsFound: "Nessuna pubblicazione trovata.",
                downloadFullPdfBtn: "Scarica PDF Completo",
                downloadArabicAbstractPdfBtn: "Scarica Abstract PDF Arabo",
                downloadEnglishAbstractPdfBtn: "Scarica Abstract PDF Inglese",
                downloadItalianAbstractPdfBtn: "Scarica Abstract PDF Italiano",
                isbnLabel: "ISBN:",
                issnLabel: "ISSN:",
                arabicAbstractTextLabel: "Abstract Arabo:",
                englishAbstractTextLabel: "Abstract Inglese:",
                italianAbstractTextLabel: "Abstract Italiano:",
                aboutUsHeading: "Riguardo Quaderni di Archeologia della Libya",
                aboutUsPara1: "Quaderni di Archeologia della Libya (QAL) è una rivista accademica peer-reviewed dedicata all'archeologia, alla storia e al patrimonio culturale della Libia. Pubblica articoli di ricerca originali, recensioni e rapporti su scavi, indagini e progetti di conservazione.",
                aboutUsPara2: "QAL mira a fornire una piattaforma per studiosi e ricercatori per diffondere le loro scoperte e contribuire alla comprensione e alla conservazione del ricco patrimonio archeologico della Libia.",
                aboutUsPara3: "La rivista enfatizza gli approcci interdisciplinari e incoraggia le proposte da vari campi, inclusi l'archeologia classica, la preistoria, l'archeologia islamica, l'epigrafia, la numismatica e la gestione del patrimonio.",
                aboutUsPara4: "Pubblicata annualmente, QAL accoglie contributi in inglese, italiano e arabo.",
                currentPublicationsHeading: "Ultime Pubblicazioni",
                editorialBoardHeading: "Comitato Editoriale",
                editorialBoardIntro: "Il Comitato Editoriale è composto da illustri studiosi provenienti da varie istituzioni internazionali.",
                editorInChief: "Redattore Capo",
                associateEditor: "Redattore Associato",
                editorialBoardMember: "Membro del Comitato Editoriale",
                editorialBoardComingSoon: "Altri membri saranno presto elencati.",
                currentIssueHeading: "Numero Corrente",
                noCurrentIssue: "Nessun numero corrente disponibile al momento. Si prega di ricontrollare più tardi o di sfogliare i nostri volumi d'archivio.",
                archivalVolumesHeading: "Volumi d'Archivio",
                archivalVolumesIntro: "Esplora la nostra collezione di numeri passati e pubblicazioni.",
                loadingArchivalVolumes: "Caricamento volumi d'archivio...",
                editorialEthicsHeading: "Linee Guida Editoriali ed Etiche",
                editorialGuidelinesTitle: "Linee Guida Editoriali",
                articlesSubmittedTo: "Gli articoli dovrebbero essere inviati a:",
                submissionProcedureTitle: "Procedura di Sottomissione",
                submissionProcedure1: "I manoscritti devono essere originali e non precedentemente pubblicati o in considerazione altrove.",
                submissionProcedure2: "Le sottomissioni devono essere preparate secondo le linee guida di formattazione seguenti.",
                submissionProcedure3: "Tutti gli articoli sono sottoposti a un processo di revisione paritaria in doppio cieco.",
                submissionProcedure4: "Gli autori saranno informati della decisione editoriale, che può includere accettazione, accettazione con revisioni o rifiuto.",
                submissionProcedure5: "Gli articoli accettati procederanno all'editing e alla pubblicazione.",
                articleRequirementsTitle: "Requisiti dell'Articolo",
                articleRequirements1: "Lingua: Inglese, Italiano o Arabo.",
                articleRequirements2: "Lunghezza: Tipicamente tra 5.000-10.000 parole (incluse note a piè di pagina e bibliografia).",
                articleRequirements3: "Abstract: Un abstract conciso (150-250 parole) in inglese, italiano e arabo.",
                articleRequirements4: "Parole chiave: 5-7 parole chiave.",
                articleRequirements5: "Illustrazioni: Immagini ad alta risoluzione (minimo 300 dpi per la stampa).",
                articleRequirements6: "Bibliografia: Seguire uno stile di citazione coerente (es. Chicago Manual of Style o uno standard archeologico comune).",
                formattingGuidelinesTitle: "Linee Guida di Formattazione",
                formattingGuidelines1: "Carattere: Times New Roman, 12pt per il testo principale, 10pt per le note a piè di pagina.",
                formattingGuidelines2: "Interlinea: 1.5 per il testo principale, singola per le note a piè di pagina.",
                formattingGuidelines3: "Margini: 1 pollice (2.54 cm) su tutti i lati.",
                formattingGuidelines4: "Intestazioni: Usare intestazioni chiare e gerarchiche.",
                formattingGuidelines5: "Citazioni: Citazioni nel testo o note a piè di pagina come appropriato.",
                commonAbbreviationsTitle: "Abbreviazioni Comuni (Esempi)",
                abbrCat: "Cat. = Catalogo", abbrCf: "Cfr. = Confronta", abbrCm: "cm = centimetro", abbrCol: "Col. = Colonna", abbrEAD: "e.a.d. = et alii dicuntur", abbrEtc: "ecc. = eccetera", abbrF: "f./ff. = pagina/e seguente/i", abbrFig: "Fig./Figg. = Figura/Figure", abbrFol: "fol./foll. = foglio/fogli", abbrID: "id. = idem (lo stesso autore)", abbrIID: "ib. = ibidem (nello stesso luogo)", abbrL: "l./ll. = riga/righe",
                abbrNoInv: "n. inv. = numero inventario", abbrM: "m = metro", abbrMs: "Ms./Mss. = Manoscritto/Manoscritti", abbrNo: "N. = Numero", abbrNd: "s.d. = senza data", abbrNp: "s.l./s.e. = senza luogo/senza editore", abbrNote: "n. = nota", abbrP: "p./pp. = pagina/pagine", abbrSee: "v. = vedi", abbrSv: "s.v. = sub voce", abbrPl: "Tav./Tavv. = Tavola/Tavole", abbrVol: "Vol./Voll. = Volume/Volumi",
                fullGuidelinesNote: "Un set completo di linee guida è disponibile su richiesta.",
                ethicsStatementTitle: "Dichiarazione Etica",
                ethicsStatementPara1: "Quaderni di Archeologia della Libya (QAL) si impegna a sostenere i più alti standard di etica delle pubblicazioni. Aderiamo ai principi di trasparenza e buone pratiche nell'editoria accademica.",
                researchEthicsTitle: "Etica della Ricerca",
                researchEthicsPara1: "Gli autori devono assicurarsi che la loro ricerca sia condotta eticamente e responsabilmente, rispettando il patrimonio culturale, i siti archeologici e le comunità locali.",
                researchEthicsPara2: "Il plagio, la fabbricazione e la falsificazione dei dati sono severamente proibiti.",
                lastUpdatedDate: "Ultimo Aggiornamento: 15 Giugno 2025",
                newsEventsHeading: "Notizie ed Eventi",
                newsEventsIntro: "Rimani aggiornato con le ultime notizie e gli eventi imminenti relativi all'archeologia libica.",
                noNewsUpdates: "Nessun aggiornamento di notizie al momento.",
                adminLoginHeading: "Accesso Amministratore",
                emailLabel: "Email:",
                passwordLabel: "Password:",
                loginButton: "Accedi",
                adminDashboardHeading: "Pannello di Amministrazione",
                welcomeAdmin: "Benvenuto, ",
                managePublicationsBtn: "Gestisci Pubblicazioni",
                manageNewsBtn: "Gestisci Notizie",
                manageSiteSettingsBtn: "Gestisci Impostazioni Sito",
                logoutButton: "Esci",
                addPublicationTitle: "Aggiungi/Modifica Pubblicazione",
                titleLabel: "Titolo:",
                authorsLabel: "Autori:",
                publicationYearLabel: "Anno di Pubblicazione:",
                descriptionLabel: "Descrizione:",
                coverImageLabel: "Immagine di Copertina (PDF):",
                fullPdfLabel: "PDF Completo della Pubblicazione:",
                arabicAbstractPdfLabel: "PDF Abstract Arabo:",
                englishAbstractPdfLabel: "PDF Abstract Inglese:",
                italianAbstractPdfLabel: "PDF Abstract Italiano:",
                addPublicationButton: "Aggiungi Pubblicazione",
                clearFormButton: "Cancella Modulo",
                filterPublicationsPlaceholder: "Filtra pubblicazioni...",
                manageExistingPublicationsTitle: "Gestisci Pubblicazioni Esistenti",
                actionsLabel: "Azioni",
                noPublicationsToManage: "Nessuna pubblicazione da gestire.",
                addNewsTitle: "Aggiungi/Modifica Notizia",
                newsTitleLabel: "Titolo Notizia:",
                newsDateLabel: "Data:",
                newsContentLabel: "Contenuto:",
                addNewsButton: "Aggiungi Notizia",
                manageExistingNewsTitle: "Gestisci Notizie Esistenti",
                noNewsToManage: "Nessuna notizia da gestire.",
                siteSettingsTitle: "Impostazioni Sito",
                headerLogoLabel: "Logo Intestazione:",
                footerLogoLabel: "Logo Piè di Pagina:",
                contributor1LogoLabel: "Logo Collaboratore 1:",
                contributor2LogoLabel: "Logo Collaboratore 2:",
                saveSettingsButton: "Salva Impostazioni",
                journalNameShort: "QAL",
                allRightsReserved: "Tutti i Diritti Riservati",
                designedBy: "Progettato da AI",
                messageSuccess: "Successo!",
                messageError: "Errore!",
                messageConfirmDelete: "Sei sicuro di voler eliminare questo elemento?",
                messageYes: "Sì",
                messageNo: "No",
                uploadingFile: "Caricamento file...",
                deletingFile: "Eliminazione file...",
                deleteSuccess: "File eliminato con successo.",
                deleteError: "Errore durante l'eliminazione del file.",
                publicationAdded: "Pubblicazione aggiunta/aggiornata con successo.",
                publicationDeleted: "Pubblicazione eliminata con successo.",
                newsAdded: "Notizia aggiunta/aggiornata con successo.",
                newsDeleted: "Notizia eliminata con successo.",
                settingsSaved: "Impostazioni del sito salvate con successo."
            }
        };

        // Firebase Configuration (replace with your actual config)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Global Constants
        const currentLanguage = localStorage.getItem('language') || 'en';
        const PUBLIC_DATA_BASE_PATH = `artifacts/${firebaseConfig.appId}/public/data`;
        const ADMIN_USERS_DOC_PATH = `${PUBLIC_DATA_BASE_PATH}/adminManagement/adminUsers`; // Correct path
        const SITE_CONFIGURATION_DOC_ID = 'siteConfiguration';
        const PUBLIC_PUB_COLLECTION_NAME = 'publications';
        const PUBLIC_NEWS_COLLECTION_NAME = 'news';
        const PUBLIC_CURRENT_ISSUE_DOC_ID = 'currentIssue';

        // View Management
        const views = {}; // This will be populated in window.onload
        function showView(viewId) {
            Object.values(views).forEach(view => {
                if (view) view.classList.add('hidden');
            });
            if (views[viewId]) {
                views[viewId].classList.remove('hidden');
                // Scroll to top of the new view
                views[viewId].scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            // Update active navigation button style
            document.querySelectorAll('.nav-button').forEach(button => {
                if (button.dataset.view === viewId) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }

        // Translation Functionality
        function applyTranslations(lang) {
            document.querySelectorAll('[data-lang-key]').forEach(element => {
                const key = element.dataset.langKey;
                if (translations[lang] && translations[lang][key]) {
                    if (element.tagName === 'INPUT' && element.type === 'text' && element.placeholder) {
                        element.placeholder = translations[lang][key];
                    } else if (element.tagName === 'OPTION') {
                        element.textContent = translations[lang][key];
                    } else {
                        element.textContent = translations[lang][key];
                    }
                }
            });
            // Handle specific cases like title which is not just textContent
            const pageTitleElement = document.querySelector('title[data-lang-key="pageTitle"]');
            if (pageTitleElement && translations[lang] && translations[lang].pageTitle) {
                pageTitleElement.textContent = translations[lang].pageTitle;
            }

            // Update active language button style
            document.querySelectorAll('.lang-button').forEach(button => {
                if (button.dataset.lang === lang) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
            localStorage.setItem('language', lang);
        }

        // Modals
        function showMessageModal(message, type = 'info', onConfirm = null) {
            const messageModal = document.getElementById('messageModal');
            const messageText = document.getElementById('messageText');
            const modalButtons = document.getElementById('modalButtons');
            messageText.textContent = message;
            modalButtons.innerHTML = ''; // Clear previous buttons

            if (type === 'confirm' && onConfirm) {
                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = translations[currentLanguage].messageYes || 'Yes';
                confirmBtn.className = 'admin-button bg-green-600';
                confirmBtn.onclick = () => {
                    onConfirm();
                    hideMessageModal();
                };
                modalButtons.appendChild(confirmBtn);

                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = translations[currentLanguage].messageNo || 'No';
                cancelBtn.className = 'admin-button bg-red-600';
                cancelBtn.onclick = hideMessageModal;
                modalButtons.appendChild(cancelBtn);
            } else {
                const okBtn = document.createElement('button');
                okBtn.textContent = 'OK'; // Always OK, regardless of type
                okBtn.className = 'admin-button bg-blue-600';
                okBtn.onclick = hideMessageModal;
                modalButtons.appendChild(okBtn);
            }
            messageModal.classList.add('flex');
        }

        function hideMessageModal() {
            document.getElementById('messageModal').classList.remove('flex');
        }

        function showLoadingSpinner() {
            document.getElementById('loadingSpinner').classList.remove('hidden');
        }

        function hideLoadingSpinner() {
            document.getElementById('loadingSpinner').classList.add('hidden');
        }

        function showPublicationDetailsModal(publication) {
            document.getElementById('detailCoverImage').src = publication.coverImageUrl || 'https://placehold.co/400x600/cccccc/333333?text=No+Image';
            document.getElementById('detailTitle').textContent = publication.title;
            document.getElementById('detailAuthors').textContent = publication.authors;
            document.getElementById('detailYear').textContent = publication.year;
            document.getElementById('detailDescription').textContent = publication.description;
            document.getElementById('detailISBN').textContent = publication.isbn || 'N/A';
            document.getElementById('detailISSN').textContent = publication.issn || 'N/A';
            document.getElementById('detailAbstractArText').textContent = publication.abstractAr || 'N/A';
            document.getElementById('detailAbstractEnText').textContent = publication.abstractEn || 'N/A';
            document.getElementById('detailAbstractItText').textContent = publication.abstractIt || 'N/A';

            const downloadPdfBtn = document.getElementById('detailDownloadPdfBtn');
            downloadPdfBtn.href = publication.fullPdfUrl || '#';
            downloadPdfBtn.classList.toggle('disabled', !publication.fullPdfUrl);
            downloadPdfBtn.target = publication.fullPdfUrl ? '_blank' : '_self';

            const downloadAbstractArBtn = document.getElementById('detailDownloadAbstractArBtn');
            downloadAbstractArBtn.href = publication.abstractArUrl || '#';
            downloadAbstractArBtn.classList.toggle('disabled', !publication.abstractArUrl);
            downloadAbstractArBtn.target = publication.abstractArUrl ? '_blank' : '_self';

            const downloadAbstractEnBtn = document.getElementById('detailDownloadAbstractEnBtn');
            downloadAbstractEnBtn.href = publication.abstractEnUrl || '#';
            downloadAbstractEnBtn.classList.toggle('disabled', !publication.abstractEnUrl);
            downloadAbstractEnBtn.target = publication.abstractEnUrl ? '_blank' : '_self';

            const downloadAbstractItBtn = document.getElementById('detailDownloadAbstractItBtn');
            downloadAbstractItBtn.href = publication.abstractItUrl || '#';
            downloadAbstractItBtn.classList.toggle('disabled', !publication.abstractItUrl);
            downloadAbstractItBtn.target = publication.abstractItUrl ? '_blank' : '_self';

            document.getElementById('publicationDetailsModal').classList.add('flex');
        }

        function hidePublicationDetailsModal() {
            document.getElementById('publicationDetailsModal').classList.remove('flex');
        }

        // Firebase Auth and UI Updates
        let currentAppId = null;
        let isAdmin = false;

        async function updateAuthUI(user) {
            const adminLoginView = views.adminLogin;
            const adminDashboardView = views.adminDashboard;
            const loggedInUserEmailSpan = document.getElementById('loggedInUserEmail');

            if (user) {
                console.log("Auth state changed: User logged in.");
                loggedInUserEmailSpan.textContent = user.email;

                try {
                    const adminDocRef = doc(db, PUBLIC_DATA_BASE_PATH, 'adminManagement', 'adminUsers');
                    console.log("Checking admin document at:", adminDocRef.path);
                    const adminDocSnap = await getDoc(adminDocRef);

                    console.log("updateAuthUI: User is NOT client-side admin. Doc exists:", adminDocSnap.exists());
                    if (adminDocSnap.exists() && adminDocSnap.data().uids && adminDocSnap.data().uids[user.uid]) {
                        isAdmin = true;
                        adminLoginView.classList.add('hidden');
                        adminDashboardView.classList.remove('hidden');
                        showView('adminDashboard'); // Ensure dashboard is shown if admin
                        console.log("User is admin. Showing admin dashboard.");
                    } else {
                        isAdmin = false;
                        adminLoginView.classList.remove('hidden');
                        adminDashboardView.classList.add('hidden');
                        showView('aboutUs'); // Default view for non-admins
                        console.log("User is not admin. Showing aboutUs view.");
                    }
                } catch (error) {
                    console.error("Error checking admin status:", error);
                    isAdmin = false;
                    adminLoginView.classList.remove('hidden');
                    adminDashboardView.classList.add('hidden');
                    showView('aboutUs');
                }
            } else {
                console.log("Auth state changed: User logged out.");
                isAdmin = false;
                adminLoginView.classList.remove('hidden');
                adminDashboardView.classList.add('hidden');
                showView('aboutUs'); // Default view for logged out users
            }
            setupListeners(); // Setup listeners regardless of auth state to fetch public data
        }

        function initializeFirebase() {
            onAuthStateChanged(auth, async (user) => {
                currentAppId = firebaseConfig.appId;
                await updateAuthUI(user);
            });
        }

        // Event Listeners for Admin Dashboard Navigation
        function setupAdminNavListeners() {
            document.getElementById('managePublicationsBtn').addEventListener('click', () => {
                document.getElementById('adminManagePublications').classList.remove('hidden');
                document.getElementById('adminManageNews').classList.add('hidden');
                document.getElementById('adminManageSiteSettings').classList.add('hidden');
                document.getElementById('adminFormTitle').textContent = translations[currentLanguage].addPublicationTitle;
                document.getElementById('addPublicationForm').reset();
                resetFileUploadPreviews('book');
                listenForAdminPublications(); // Re-listen for admin publications
            });
            document.getElementById('manageNewsBtn').addEventListener('click', () => {
                document.getElementById('adminManagePublications').classList.add('hidden');
                document.getElementById('adminManageNews').classList.remove('hidden');
                document.getElementById('adminManageSiteSettings').classList.add('hidden');
                document.getElementById('adminNewsFormTitle').textContent = translations[currentLanguage].addNewsTitle;
                document.getElementById('addNewsForm').reset();
                listenForAdminNews(); // Re-listen for admin news
            });
            document.getElementById('manageSiteSettingsBtn').addEventListener('click', () => {
                document.getElementById('adminManagePublications').classList.add('hidden');
                document.getElementById('adminManageNews').classList.add('hidden');
                document.getElementById('adminManageSiteSettings').classList.remove('hidden');
                listenForSiteLogos(); // Listen for site settings
            });
            document.getElementById('adminLogoutBtn').addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    showMessageModal(translations[currentLanguage].logoutSuccess || "Logged out successfully!");
                } catch (error) {
                    console.error("Logout error:", error);
                    showMessageModal(translations[currentLanguage].logoutError || "Error logging out.");
                }
            });
        }

        // File Upload Utility
        async function uploadFile(file, path) {
            showLoadingSpinner();
            const storageRef = ref(storage, path);
            try {
                const snapshot = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                hideLoadingSpinner();
                return downloadURL;
            } catch (error) {
                hideLoadingSpinner();
                console.error("Error uploading file:", error);
                showMessageModal(translations[currentLanguage].uploadingFileError || "Error uploading file.", 'error');
                throw error;
            }
        }

        async function deleteFile(url) {
            if (!url || url.includes('placehold.co')) return; // Don't delete placeholder images
            showLoadingSpinner();
            try {
                const fileRef = ref(storage, url);
                await deleteObject(fileRef);
                hideLoadingSpinner();
                return true;
            } catch (error) {
                hideLoadingSpinner();
                console.error("Error deleting file:", error);
                showMessageModal(translations[currentLanguage].deleteError || "Error deleting file.", 'error');
                throw error;
            }
        }

        function setupFileUploadPreview(inputId, previewId, isImage = true) {
            const input = document.getElementById(inputId);
            const previewContainer = document.getElementById(previewId);
            const previewImg = previewContainer.querySelector('img');
            const previewText = previewContainer.querySelector('p');

            input.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    previewContainer.classList.remove('hidden');
                    if (isImage) {
                        previewImg.src = URL.createObjectURL(file);
                        previewImg.classList.remove('hidden');
                        if (previewText) previewText.classList.add('hidden');
                    } else {
                        if (previewImg) previewImg.classList.add('hidden');
                        previewText.textContent = file.name;
                        previewText.classList.remove('hidden');
                    }
                } else {
                    previewContainer.classList.add('hidden');
                    if (previewImg) previewImg.src = '';
                    if (previewText) previewText.textContent = '';
                }
            });
        }

        function resetFileUploadPreviews(prefix) {
            const inputs = [`${prefix}CoverImage`, `${prefix}FullPdf`, `${prefix}AbstractAr`, `${prefix}AbstractEn`, `${prefix}AbstractIt`,
                            'siteHeaderLogo', 'siteFooterLogo', 'siteContributor1Logo', 'siteContributor2Logo'];
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.value = '';
                    const previewContainer = document.getElementById(`${inputId}Preview`);
                    if (previewContainer) {
                        previewContainer.classList.add('hidden');
                        const previewImg = previewContainer.querySelector('img');
                        const previewText = previewContainer.querySelector('p');
                        if (previewImg) previewImg.src = '';
                        if (previewText) previewText.textContent = '';
                    }
                }
            });
        }

        // Public Data Listeners
        let unsubscribePublications = null;
        let unsubscribeCurrentIssue = null;
        let unsubscribeNews = null;
        let unsubscribeSiteConfig = null;

        function setupListeners() {
            if (unsubscribePublications) unsubscribePublications();
            if (unsubscribeCurrentIssue) unsubscribeCurrentIssue();
            if (unsubscribeNews) unsubscribeNews();
            if (unsubscribeSiteConfig) unsubscribeSiteConfig(); // Unsubscribe existing listener

            listenForPublicPublications();
            listenForCurrentIssue();
            listenForNews();
            listenForSiteLogos(); // Re-attach site logo listener
        }

        async function listenForSiteLogos() {
            try {
                // Corrected: Ensure this path is correct and targets a document
                const docRef = doc(db, PUBLIC_DATA_BASE_PATH, SITE_CONFIGURATION_DOC_ID); // Path to the DOCUMENT
                console.log("Listening for site configuration at:", docRef.path);

                unsubscribeSiteConfig = onSnapshot(docRef, (docSnap) => {
                    console.log("Site config snapshot received. Exists:", docSnap.exists());
                    if (docSnap.exists()) {
                        const config = docSnap.data();
                        console.log("Site config data:", config);

                        const headerLogo = document.getElementById('mainHeaderLogo');
                        const footerLogo = document.getElementById('mainFooterLogo');
                        const contributor1Logo = document.getElementById('contributor1Logo');
                        const contributor2Logo = document.getElementById('contributor2Logo');

                        if (config.headerLogoUrl) {
                            headerLogo.src = config.headerLogoUrl;
                        } else {
                            // Re-apply hardcoded default if no custom URL
                            headerLogo.src = "https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/header_logos%2FLogo%20QAL%20arabo%20300%20dpi.jpeg?alt=media&token=c2d438d9-9ba2-49ec-a32a-517ed18775ee";
                        }
                        if (config.footerLogoUrl) {
                            footerLogo.src = config.footerLogoUrl;
                        } else {
                             footerLogo.src = "https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/footer_logos%2Ffooter-logo.png?alt=media&token=YOUR_TOKEN";
                        }
                        if (config.contributor1LogoUrl) {
                            contributor1Logo.src = config.contributor1LogoUrl;
                        } else {
                             contributor1Logo.src = "https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/contributor_logos%2Fcontributor1.png?alt=media&token=YOUR_TOKEN";
                        }
                        if (config.contributor2LogoUrl) {
                            contributor2Logo.src = config.contributor2LogoUrl;
                        } else {
                             contributor2Logo.src = "https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/contributor_logos%2Fcontributor2.png?alt=media&token=YOUR_TOKEN";
                        }

                        // Update admin site settings form previews
                        if (isAdmin) {
                            document.getElementById('siteHeaderLogoPreview').classList.toggle('hidden', !config.headerLogoUrl);
                            if (config.headerLogoUrl) document.getElementById('siteHeaderLogoPreview').querySelector('img').src = config.headerLogoUrl;

                            document.getElementById('siteFooterLogoPreview').classList.toggle('hidden', !config.footerLogoUrl);
                            if (config.footerLogoUrl) document.getElementById('siteFooterLogoPreview').querySelector('img').src = config.footerLogoUrl;

                            document.getElementById('siteContributor1LogoPreview').classList.toggle('hidden', !config.contributor1LogoUrl);
                            if (config.contributor1LogoUrl) document.getElementById('siteContributor1LogoPreview').querySelector('img').src = config.contributor1LogoUrl;

                            document.getElementById('siteContributor2LogoPreview').classList.toggle('hidden', !config.contributor2LogoUrl);
                            if (config.contributor2LogoUrl) document.getElementById('siteContributor2LogoPreview').querySelector('img').src = config.contributor2LogoUrl;
                        }

                    } else {
                        console.log("Site configuration document does not exist. Using hardcoded defaults.");
                        // Ensure hardcoded defaults are applied if document doesn't exist
                        document.getElementById('mainHeaderLogo').src = "https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/header_logos%2FLogo%20QAL%20arabo%20300%20dpi.jpeg?alt=media&token=c2d438d9-9ba2-49ec-a32a-517ed18775ee";
                        document.getElementById('mainFooterLogo').src = "https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/footer_logos%2Ffooter-logo.png?alt=media&token=YOUR_TOKEN";
                        document.getElementById('contributor1Logo').src = "https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/contributor_logos%2Fcontributor1.png?alt=media&token=YOUR_TOKEN";
                        document.getElementById('contributor2Logo').src = "https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/contributor_logos%2Fcontributor2.png?alt=media&token=YOUR_TOKEN";
                        // Hide admin previews if no config
                        if (isAdmin) {
                            document.getElementById('siteHeaderLogoPreview').classList.add('hidden');
                            document.getElementById('siteFooterLogoPreview').classList.add('hidden');
                            document.getElementById('siteContributor1LogoPreview').classList.add('hidden');
                            document.getElementById('siteContributor2LogoPreview').classList.add('hidden');
                        }
                    }
                }, (error) => {
                    console.error("Error listening for site configuration:", error);
                    // Fallback to hardcoded defaults on error
                    document.getElementById('mainHeaderLogo').src = "https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/header_logos%2FLogo%20QAL%20arabo%20300%20dpi.jpeg?alt=media&token=c2d438d9-9ba2-49ec-a32a-517ed18775ee";
                    document.getElementById('mainFooterLogo').src = "https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/footer_logos%2Ffooter-logo.png?alt=media&token=YOUR_TOKEN";
                    document.getElementById('contributor1Logo').src = "https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/contributor_logos%2Fcontributor1.png?alt=media&token=YOUR_TOKEN";
                    document.getElementById('contributor2Logo').src = "https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/contributor_logos%2Fcontributor2.png?alt=media&token=YOUR_TOKEN";
                });
            } catch (error) {
                console.error("Failed to set up listener for site configuration:", error);
                // Fallback to hardcoded defaults if listener setup fails
                document.getElementById('mainHeaderLogo').src = "https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/header_logos%2FLogo%20QAL%20arabo%20300%20dpi.jpeg?alt=media&token=c2d438d9-9ba2-49ec-a32a-517ed18775ee";
                document.getElementById('mainFooterLogo').src = "https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/footer_logos%2Ffooter-logo.png?alt=media&token=YOUR_TOKEN";
                document.getElementById('contributor1Logo').src = "https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/contributor_logos%2Fcontributor1.png?alt=media&token=YOUR_TOKEN";
                document.getElementById('contributor2Logo').src = "https://firebasestorage.googleapis.com/v0/b/quadernilibyawebsite.firebasestorage.app/o/contributor_logos%2Fcontributor2.png?alt=media&token=YOUR_TOKEN";
            }
        }


        async function listenForPublicPublications() {
            const publicationsList = document.getElementById('publicationsList');
            if (!publicationsList) return;

            const q = query(collection(db, PUBLIC_DATA_BASE_PATH, PUBLIC_PUB_COLLECTION_NAME), orderBy('year', 'desc'));
            console.log("Listening for public publications at:", q._query.path.segments.join('/')); // Log the path

            unsubscribePublications = onSnapshot(q, (snapshot) => {
                console.log("Public publications snapshot received. Docs count:", snapshot.docs.length);
                const publications = [];
                snapshot.forEach(doc => {
                    publications.push({ id: doc.id, ...doc.data() });
                });
                displayPublications(publications, 'publicationsList');
            }, (error) => {
                console.error("Error listening for public publications:", error);
                publicationsList.innerHTML = `<p class="col-span-full text-center text-red-500">${translations[currentLanguage].errorLoadingPublications || 'Error loading publications.'}</p>`;
            });
        }

        async function listenForCurrentIssue() {
            const currentIssueContent = document.getElementById('currentIssueContent');
            const currentIssuePublicationCard = document.getElementById('currentIssuePublicationCard');
            const noCurrentIssueText = document.querySelector('#currentIssueContent > p');

            const docRef = doc(db, PUBLIC_DATA_BASE_PATH, PUBLIC_CURRENT_ISSUE_DOC_ID);
            console.log("Listening for current issue at:", docRef.path);

            unsubscribeCurrentIssue = onSnapshot(docRef, (docSnap) => {
                console.log("Current issue snapshot received. Exists:", docSnap.exists());
                if (docSnap.exists()) {
                    const issue = docSnap.data();
                    document.getElementById('currentIssueCover').src = issue.coverImageUrl || 'https://placehold.co/400x600/cccccc/333333?text=No+Image';
                    document.getElementById('currentIssueTitle').textContent = issue.title;
                    document.getElementById('currentIssueAuthors').textContent = issue.authors;
                    document.getElementById('currentIssueYear').textContent = issue.year;
                    document.getElementById('currentIssueDescription').textContent = issue.description;

                    const downloadPdfBtn = document.getElementById('currentIssueDownloadPdfBtn');
                    downloadPdfBtn.href = issue.fullPdfUrl || '#';
                    downloadPdfBtn.classList.toggle('disabled', !issue.fullPdfUrl);
                    downloadPdfBtn.target = issue.fullPdfUrl ? '_blank' : '_self';

                    const downloadAbstractArBtn = document.getElementById('currentIssueDownloadAbstractArBtn');
                    downloadAbstractArBtn.href = issue.abstractArUrl || '#';
                    downloadAbstractArBtn.classList.toggle('disabled', !issue.abstractArUrl);
                    downloadAbstractArBtn.target = issue.abstractArUrl ? '_blank' : '_self';

                    const downloadAbstractEnBtn = document.getElementById('currentIssueDownloadAbstractEnBtn');
                    downloadAbstractEnBtn.href = issue.abstractEnUrl || '#';
                    downloadAbstractEnBtn.classList.toggle('disabled', !issue.abstractEnUrl);
                    downloadAbstractEnBtn.target = issue.abstractEnUrl ? '_blank' : '_self';

                    const downloadAbstractItBtn = document.getElementById('currentIssueDownloadAbstractItBtn');
                    downloadAbstractItBtn.href = issue.abstractItUrl || '#';
                    downloadAbstractItBtn.classList.toggle('disabled', !issue.abstractItUrl);
                    downloadAbstractItBtn.target = issue.abstractItUrl ? '_blank' : '_self';

                    noCurrentIssueText.classList.add('hidden');
                    currentIssuePublicationCard.classList.remove('hidden');
                } else {
                    noCurrentIssueText.classList.remove('hidden');
                    currentIssuePublicationCard.classList.add('hidden');
                }
            }, (error) => {
                console.error("Error listening for current issue:", error);
                noCurrentIssueText.textContent = translations[currentLanguage].errorLoadingCurrentIssue || 'Error loading current issue.';
                noCurrentIssueText.classList.remove('hidden');
                currentIssuePublicationCard.classList.add('hidden');
            });
        }

        async function listenForNews() {
            const newsFeed = document.getElementById('newsFeed');
            if (!newsFeed) return;

            const q = query(collection(db, PUBLIC_DATA_BASE_PATH, PUBLIC_NEWS_COLLECTION_NAME), orderBy('date', 'desc'));
            console.log("Listening for news at:", q._query.path.segments.join('/'));

            unsubscribeNews = onSnapshot(q, (snapshot) => {
                console.log("News snapshot received. Docs count:", snapshot.docs.length);
                newsFeed.innerHTML = ''; // Clear previous news
                if (snapshot.empty) {
                    newsFeed.innerHTML = `<p class="col-span-full text-center text-gray-400" data-lang-key="noNewsUpdates">${translations[currentLanguage].noNewsUpdates}</p>`;
                    return;
                }
                snapshot.forEach(doc => {
                    const newsItem = doc.data();
                    const newsCard = document.createElement('div');
                    newsCard.className = 'bg-gray-100 p-6 rounded-lg shadow-md border';
                    const date = newsItem.date ? new Date(newsItem.date.toDate()).toLocaleDateString(currentLanguage) : 'N/A';
                    newsCard.innerHTML = `
                        <h3 class="text-xl font-bold mb-2">${newsItem.title}</h3>
                        <p class="text-gray-600 text-sm mb-3">${date}</p>
                        <p class="text-gray-700 text-base">${newsItem.content}</p>
                    `;
                    newsFeed.appendChild(newsCard);
                });
            }, (error) => {
                console.error("Error listening for news:", error);
                newsFeed.innerHTML = `<p class="col-span-full text-center text-red-500">${translations[currentLanguage].errorLoadingNews || 'Error loading news.'}</p>`;
            });
        }

        // Admin Data Listeners
        let unsubscribeAdminPublications = null;
        let unsubscribeAdminNews = null;

        function listenForAdminPublications() {
            if (!isAdmin) return;
            if (unsubscribeAdminPublications) unsubscribeAdminPublications(); // Unsubscribe previous listener

            const adminPublicationsTableBody = document.getElementById('adminPublicationsTableBody');
            const q = query(collection(db, PUBLIC_DATA_BASE_PATH, PUBLIC_PUB_COLLECTION_NAME), orderBy('year', 'desc'));

            unsubscribeAdminPublications = onSnapshot(q, (snapshot) => {
                adminPublicationsTableBody.innerHTML = ''; // Clear existing rows
                if (snapshot.empty) {
                    adminPublicationsTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500" data-lang-key="noPublicationsToManage">${translations[currentLanguage].noPublicationsToManage}</td></tr>`;
                    return;
                }
                snapshot.forEach(docSnap => {
                    const publication = { id: docSnap.id, ...docSnap.data() };
                    const row = adminPublicationsTableBody.insertRow();
                    row.className = 'admin-table-row';
                    row.innerHTML = `
                        <td>${publication.title}</td>
                        <td>${publication.authors}</td>
                        <td>${publication.year}</td>
                        <td class="flex space-x-2">
                            <button class="admin-button bg-blue-600 edit-publication-btn" data-id="${publication.id}" data-lang-key="editButton">${translations[currentLanguage].editButton || 'Edit'}</button>
                            <button class="admin-button bg-red-600 delete-publication-btn" data-id="${publication.id}" data-lang-key="deleteButton">${translations[currentLanguage].deleteButton || 'Delete'}</button>
                        </td>
                    `;
                });
                attachAdminPublicationActionListeners();
            }, (error) => {
                console.error("Error listening for admin publications:", error);
                adminPublicationsTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">${translations[currentLanguage].errorLoadingPublications || 'Error loading publications.'}</td></tr>`;
            });
        }

        function listenForAdminNews() {
            if (!isAdmin) return;
            if (unsubscribeAdminNews) unsubscribeAdminNews(); // Unsubscribe previous listener

            const adminNewsTableBody = document.getElementById('adminNewsTableBody');
            const q = query(collection(db, PUBLIC_DATA_BASE_PATH, PUBLIC_NEWS_COLLECTION_NAME), orderBy('date', 'desc'));

            unsubscribeAdminNews = onSnapshot(q, (snapshot) => {
                adminNewsTableBody.innerHTML = ''; // Clear existing rows
                if (snapshot.empty) {
                    adminNewsTableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-gray-500" data-lang-key="noNewsToManage">${translations[currentLanguage].noNewsToManage}</td></tr>`;
                    return;
                }
                snapshot.forEach(docSnap => {
                    const newsItem = { id: docSnap.id, ...docSnap.data() };
                    const row = adminNewsTableBody.insertRow();
                    row.className = 'admin-table-row';
                    const date = newsItem.date ? new Date(newsItem.date.toDate()).toISOString().split('T')[0] : '';
                    row.innerHTML = `
                        <td>${newsItem.title}</td>
                        <td>${date}</td>
                        <td class="flex space-x-2">
                            <button class="admin-button bg-blue-600 edit-news-btn" data-id="${newsItem.id}" data-lang-key="editButton">${translations[currentLanguage].editButton || 'Edit'}</button>
                            <button class="admin-button bg-red-600 delete-news-btn" data-id="${newsItem.id}" data-lang-key="deleteButton">${translations[currentLanguage].deleteButton || 'Delete'}</button>
                        </td>
                    `;
                });
                attachAdminNewsActionListeners();
            }, (error) => {
                console.error("Error listening for admin news:", error);
                adminNewsTableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-500">${translations[currentLanguage].errorLoadingNews || 'Error loading news.'}</p></tr>`;
            });
        }


        // Display Functions
        function displayPublications(publications, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // Clear previous content

            if (publications.length === 0) {
                container.innerHTML = `<p class="col-span-full text-center text-gray-400" data-lang-key="noPublicationsFound">${translations[currentLanguage].noPublicationsFound}</p>`;
                return;
            }

            publications.forEach(pub => {
                const card = document.createElement('div');
                card.className = 'publication-card';
                card.dataset.id = pub.id;
                card.innerHTML = `
                    <img src="${pub.coverImageUrl || 'https://placehold.co/400x600/cccccc/333333?text=No+Image'}" alt="${pub.title} Cover" class="cover-image">
                    <div class="p-4">
                        <h3 class="text-xl font-semibold mb-1">${pub.title}</h3>
                        <p class="text-gray-600 text-sm">${pub.authors}</p>
                        <p class="text-gray-500 text-xs mt-1">${pub.year}</p>
                    </div>
                `;
                card.addEventListener('click', () => showPublicationDetailsModal(pub));
                container.appendChild(card);
            });
        }

        // Admin Forms and Actions
        async function handleAddEditPublication(event) {
            event.preventDefault();
            showLoadingSpinner();

            const form = event.target;
            const publicationId = form.dataset.editingId;

            const title = document.getElementById('bookTitle').value;
            const authors = document.getElementById('bookAuthors').value;
            const year = document.getElementById('bookYear').value;
            const description = document.getElementById('bookDescription').value;
            const isbn = document.getElementById('bookISBN').value;
            const issn = document.getElementById('bookISSN').value;
            const abstractArText = document.getElementById('bookAbstractArText').value;
            const abstractEnText = document.getElementById('bookAbstractEnText').value;
            const abstractItText = document.getElementById('bookAbstractItText').value;

            const coverImageFile = document.getElementById('bookCoverImage').files[0];
            const fullPdfFile = document.getElementById('bookFullPdf').files[0];
            const abstractArFile = document.getElementById('bookAbstractAr').files[0];
            const abstractEnFile = document.getElementById('bookAbstractEn').files[0];
            const abstractItFile = document.getElementById('bookAbstractIt').files[0];

            let coverImageUrl = form.dataset.currentCoverImageUrl || '';
            let fullPdfUrl = form.dataset.currentFullPdfUrl || '';
            let abstractArUrl = form.dataset.currentAbstractArUrl || '';
            let abstractEnUrl = form.dataset.currentAbstractEnUrl || '';
            let abstractItUrl = form.dataset.currentAbstractItUrl || '';

            try {
                if (coverImageFile) {
                    if (coverImageUrl) await deleteFile(coverImageUrl); // Delete old file if updating
                    coverImageUrl = await uploadFile(coverImageFile, `artifacts/${currentAppId}/public/files/publications/covers/${publicationId || 'temp'}_${coverImageFile.name}`);
                }
                if (fullPdfFile) {
                    if (fullPdfUrl) await deleteFile(fullPdfUrl);
                    fullPdfUrl = await uploadFile(fullPdfFile, `artifacts/${currentAppId}/public/files/publications/pdfs/${publicationId || 'temp'}_${fullPdfFile.name}`);
                }
                if (abstractArFile) {
                    if (abstractArUrl) await deleteFile(abstractArUrl);
                    abstractArUrl = await uploadFile(abstractArFile, `artifacts/${currentAppId}/public/files/publications/abstracts_ar/${publicationId || 'temp'}_${abstractArFile.name}`);
                }
                if (abstractEnFile) {
                    if (abstractEnUrl) await deleteFile(abstractEnUrl);
                    abstractEnUrl = await uploadFile(abstractEnFile, `artifacts/${currentAppId}/public/files/publications/abstracts_en/${publicationId || 'temp'}_${abstractEnFile.name}`);
                }
                if (abstractItFile) {
                    if (abstractItUrl) await deleteFile(abstractItUrl);
                    abstractItUrl = await uploadFile(abstractItFile, `artifacts/${currentAppId}/public/files/publications/abstracts_it/${publicationId || 'temp'}_${abstractItFile.name}`);
                }

                const publicationData = {
                    title, authors, year: parseInt(year), description, isbn, issn,
                    coverImageUrl, fullPdfUrl, abstractArUrl, abstractEnUrl, abstractItUrl,
                    abstractAr: abstractArText, abstractEn: abstractEnText, abstractIt: abstractItText
                };

                if (publicationId) {
                    // Update existing publication
                    await updateDoc(doc(db, PUBLIC_DATA_BASE_PATH, PUBLIC_PUB_COLLECTION_NAME, publicationId), publicationData);
                } else {
                    // Add new publication
                    const newDocRef = await addDoc(collection(db, PUBLIC_DATA_BASE_PATH, PUBLIC_PUB_COLLECTION_NAME), publicationData);
                    // If files were uploaded with 'temp' in path, rename them to use actual ID
                    // This is a simplified approach; a more robust solution might involve cloud functions
                    console.log("New publication added with ID:", newDocRef.id);
                    // For temp files, if any, you'd re-upload or rename. For now, assume fixed URLs post-creation.
                    // This part needs a robust solution if temporary IDs are used in file paths.
                    // For now, if publicationId was 'temp', we are good, as we are creating a new doc here.
                    // If it was meant to update paths with the newDocRef.id, this logic is missing.
                }

                hideLoadingSpinner();
                showMessageModal(translations[currentLanguage].publicationAdded || "Publication added/updated successfully!");
                form.reset();
                form.removeAttribute('data-editing-id');
                form.removeAttribute('data-current-cover-image-url');
                form.removeAttribute('data-current-full-pdf-url');
                form.removeAttribute('data-current-abstract-ar-url');
                form.removeAttribute('data-current-abstract-en-url');
                form.removeAttribute('data-current-abstract-it-url');
                document.getElementById('adminFormTitle').textContent = translations[currentLanguage].addPublicationTitle;
                resetFileUploadPreviews('book');
            } catch (error) {
                hideLoadingSpinner();
                console.error("Error adding/updating publication:", error);
                showMessageModal(translations[currentLanguage].messageError || "Error saving publication.", 'error');
            }
        }

        async function handleDeletePublication(id, coverImageUrl, fullPdfUrl, abstractArUrl, abstractEnUrl, abstractItUrl) {
            showMessageModal(translations[currentLanguage].messageConfirmDelete || "Are you sure you want to delete this item?", 'confirm', async () => {
                showLoadingSpinner();
                try {
                    await deleteDoc(doc(db, PUBLIC_DATA_BASE_PATH, PUBLIC_PUB_COLLECTION_NAME, id));
                    if (coverImageUrl) await deleteFile(coverImageUrl);
                    if (fullPdfUrl) await deleteFile(fullPdfUrl);
                    if (abstractArUrl) await deleteFile(abstractArUrl);
                    if (abstractEnUrl) await deleteFile(abstractEnUrl);
                    if (abstractItUrl) await deleteFile(abstractItUrl);
                    hideLoadingSpinner();
                    showMessageModal(translations[currentLanguage].publicationDeleted || "Publication deleted successfully!");
                } catch (error) {
                    hideLoadingSpinner();
                    console.error("Error deleting publication:", error);
                    showMessageModal(translations[currentLanguage].messageError || "Error deleting publication.", 'error');
                }
            });
        }

        async function handleEditPublicationClick(id) {
            showLoadingSpinner();
            try {
                const docSnap = await getDoc(doc(db, PUBLIC_DATA_BASE_PATH, PUBLIC_PUB_COLLECTION_NAME, id));
                if (docSnap.exists()) {
                    const pub = docSnap.data();
                    document.getElementById('bookTitle').value = pub.title || '';
                    document.getElementById('bookAuthors').value = pub.authors || '';
                    document.getElementById('bookYear').value = pub.year || '';
                    document.getElementById('bookDescription').value = pub.description || '';
                    document.getElementById('bookISBN').value = pub.isbn || '';
                    document.getElementById('bookISSN').value = pub.issn || '';
                    document.getElementById('bookAbstractArText').value = pub.abstractAr || '';
                    document.getElementById('bookAbstractEnText').value = pub.abstractEn || '';
                    document.getElementById('bookAbstractItText').value = pub.abstractIt || '';

                    const form = document.getElementById('addPublicationForm');
                    form.dataset.editingId = id;
                    form.dataset.currentCoverImageUrl = pub.coverImageUrl || '';
                    form.dataset.currentFullPdfUrl = pub.fullPdfUrl || '';
                    form.dataset.currentAbstractArUrl = pub.abstractArUrl || '';
                    form.dataset.currentAbstractEnUrl = pub.abstractEnUrl || '';
                    form.dataset.currentAbstractItUrl = pub.abstractItUrl || '';

                    document.getElementById('adminFormTitle').textContent = translations[currentLanguage].editPublicationTitle || "Edit Publication";
                    // Update file upload previews for existing files
                    updateFileUploadPreviewDisplay('bookCoverImagePreview', pub.coverImageUrl, true);
                    updateFileUploadPreviewDisplay('bookFullPdfPreview', pub.fullPdfUrl, false);
                    updateFileUploadPreviewDisplay('bookAbstractArPreview', pub.abstractArUrl, false);
                    updateFileUploadPreviewDisplay('bookAbstractEnPreview', pub.abstractEnUrl, false);
                    updateFileUploadPreviewDisplay('bookAbstractItPreview', pub.abstractItUrl, false);

                    hideLoadingSpinner();
                    // Scroll to form
                    document.getElementById('adminManagePublications').scrollIntoView({ behavior: 'smooth' });
                } else {
                    hideLoadingSpinner();
                    showMessageModal(translations[currentLanguage].messageError || "Publication not found.", 'error');
                }
            } catch (error) {
                hideLoadingSpinner();
                console.error("Error editing publication:", error);
                showMessageModal(translations[currentLanguage].messageError || "Error loading publication for edit.", 'error');
            }
        }

        function updateFileUploadPreviewDisplay(previewId, url, isImage) {
            const previewContainer = document.getElementById(previewId);
            const previewImg = previewContainer.querySelector('img');
            const previewText = previewContainer.querySelector('p');

            if (url && !url.includes('placehold.co')) {
                previewContainer.classList.remove('hidden');
                if (isImage) {
                    if (previewImg) {
                        previewImg.src = url;
                        previewImg.classList.remove('hidden');
                    }
                    if (previewText) previewText.classList.add('hidden');
                } else {
                    if (previewImg) previewImg.classList.add('hidden');
                    if (previewText) {
                        const fileName = url.substring(url.lastIndexOf('/') + 1).split('?')[0]; // Extract filename from URL
                        previewText.textContent = decodeURIComponent(fileName);
                        previewText.classList.remove('hidden');
                    }
                }
            } else {
                previewContainer.classList.add('hidden');
                if (previewImg) previewImg.src = '';
                if (previewText) previewText.textContent = '';
            }
        }

        function attachAdminPublicationActionListeners() {
            document.querySelectorAll('.edit-publication-btn').forEach(button => {
                button.onclick = async (e) => {
                    const id = e.target.dataset.id;
                    await handleEditPublicationClick(id);
                };
            });
            document.querySelectorAll('.delete-publication-btn').forEach(button => {
                button.onclick = async (e) => {
                    const id = e.target.dataset.id;
                    // Fetch publication details to get file URLs for deletion
                    const docSnap = await getDoc(doc(db, PUBLIC_DATA_BASE_PATH, PUBLIC_PUB_COLLECTION_NAME, id));
                    if (docSnap.exists()) {
                        const pub = docSnap.data();
                        handleDeletePublication(id, pub.coverImageUrl, pub.fullPdfUrl, pub.abstractArUrl, pub.abstractEnUrl, pub.abstractItUrl);
                    } else {
                        showMessageModal(translations[currentLanguage].messageError || "Publication not found for deletion.", 'error');
                    }
                };
            });
        }

        async function handleAddEditNews(event) {
            event.preventDefault();
            showLoadingSpinner();

            const form = event.target;
            const newsId = form.dataset.editingId;

            const title = document.getElementById('newsTitle').value;
            const date = document.getElementById('newsDate').value; // YYYY-MM-DD
            const content = document.getElementById('newsContent').value;

            try {
                const newsData = {
                    title,
                    date: new Date(date), // Convert string to Firestore Timestamp
                    content
                };

                if (newsId) {
                    await updateDoc(doc(db, PUBLIC_DATA_BASE_PATH, PUBLIC_NEWS_COLLECTION_NAME, newsId), newsData);
                } else {
                    await addDoc(collection(db, PUBLIC_DATA_BASE_PATH, PUBLIC_NEWS_COLLECTION_NAME), newsData);
                }

                hideLoadingSpinner();
                showMessageModal(translations[currentLanguage].newsAdded || "News item added/updated successfully!");
                form.reset();
                form.removeAttribute('data-editing-id');
                document.getElementById('adminNewsFormTitle').textContent = translations[currentLanguage].addNewsTitle;
            } catch (error) {
                hideLoadingSpinner();
                console.error("Error adding/updating news:", error);
                showMessageModal(translations[currentLanguage].messageError || "Error saving news item.", 'error');
            }
        }

        async function handleDeleteNews(id) {
            showMessageModal(translations[currentLanguage].messageConfirmDelete || "Are you sure you want to delete this item?", 'confirm', async () => {
                showLoadingSpinner();
                try {
                    await deleteDoc(doc(db, PUBLIC_DATA_BASE_PATH, PUBLIC_NEWS_COLLECTION_NAME, id));
                    hideLoadingSpinner();
                    showMessageModal(translations[currentLanguage].newsDeleted || "News item deleted successfully!");
                } catch (error) {
                    hideLoadingSpinner();
                    console.error("Error deleting news:", error);
                    showMessageModal(translations[currentLanguage].messageError || "Error deleting news item.", 'error');
                }
            });
        }

        async function handleEditNewsClick(id) {
            showLoadingSpinner();
            try {
                const docSnap = await getDoc(doc(db, PUBLIC_DATA_BASE_PATH, PUBLIC_NEWS_COLLECTION_NAME, id));
                if (docSnap.exists()) {
                    const news = docSnap.data();
                    document.getElementById('newsTitle').value = news.title || '';
                    document.getElementById('newsContent').value = news.content || '';
                    // Convert Firestore Timestamp to YYYY-MM-DD string for input type="date"
                    document.getElementById('newsDate').value = news.date ? news.date.toDate().toISOString().split('T')[0] : '';

                    const form = document.getElementById('addNewsForm');
                    form.dataset.editingId = id;
                    document.getElementById('adminNewsFormTitle').textContent = translations[currentLanguage].editNewsTitle || "Edit News Item";
                    hideLoadingSpinner();
                    // Scroll to form
                    document.getElementById('adminManageNews').scrollIntoView({ behavior: 'smooth' });
                } else {
                    hideLoadingSpinner();
                    showMessageModal(translations[currentLanguage].messageError || "News item not found.", 'error');
                }
            } catch (error) {
                hideLoadingSpinner();
                console.error("Error editing news:", error);
                showMessageModal(translations[currentLanguage].messageError || "Error loading news item for edit.", 'error');
            }
        }

        function attachAdminNewsActionListeners() {
            document.querySelectorAll('.edit-news-btn').forEach(button => {
                button.onclick = async (e) => {
                    const id = e.target.dataset.id;
                    await handleEditNewsClick(id);
                };
            });
            document.querySelectorAll('.delete-news-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.target.dataset.id;
                    handleDeleteNews(id);
                };
            });
        }

        async function handleSiteSettingsSave(event) {
            event.preventDefault();
            showLoadingSpinner();

            const headerLogoFile = document.getElementById('siteHeaderLogo').files[0];
            const footerLogoFile = document.getElementById('siteFooterLogo').files[0];
            const contributor1LogoFile = document.getElementById('siteContributor1Logo').files[0];
            const contributor2LogoFile = document.getElementById('siteContributor2Logo').files[0];

            let siteConfig = {};
            try {
                // Fetch current config to get existing URLs for deletion
                const docSnap = await getDoc(doc(db, PUBLIC_DATA_BASE_PATH, SITE_CONFIGURATION_DOC_ID));
                if (docSnap.exists()) {
                    siteConfig = docSnap.data();
                }

                if (headerLogoFile) {
                    if (siteConfig.headerLogoUrl) await deleteFile(siteConfig.headerLogoUrl);
                    siteConfig.headerLogoUrl = await uploadFile(headerLogoFile, `artifacts/${currentAppId}/public/files/siteSettings/header_logo_${headerLogoFile.name}`);
                }
                if (footerLogoFile) {
                    if (siteConfig.footerLogoUrl) await deleteFile(siteConfig.footerLogoUrl);
                    siteConfig.footerLogoUrl = await uploadFile(footerLogoFile, `artifacts/${currentAppId}/public/files/siteSettings/footer_logo_${footerLogoFile.name}`);
                }
                if (contributor1LogoFile) {
                    if (siteConfig.contributor1LogoUrl) await deleteFile(siteConfig.contributor1LogoUrl);
                    siteConfig.contributor1LogoUrl = await uploadFile(contributor1LogoFile, `artifacts/${currentAppId}/public/files/siteSettings/contributor1_logo_${contributor1LogoFile.name}`);
                }
                if (contributor2LogoFile) {
                    if (siteConfig.contributor2LogoUrl) await deleteFile(siteConfig.contributor2LogoUrl);
                    siteConfig.contributor2LogoUrl = await uploadFile(contributor2LogoFile, `artifacts/${currentAppId}/public/files/siteSettings/contributor2_logo_${contributor2LogoFile.name}`);
                }

                // Corrected: Ensure setDoc uses the correct path
                await setDoc(doc(db, PUBLIC_DATA_BASE_PATH, SITE_CONFIGURATION_DOC_ID), siteConfig, { merge: true });

                hideLoadingSpinner();
                showMessageModal(translations[currentLanguage].settingsSaved || "Site settings saved successfully!");
                document.getElementById('siteSettingsForm').reset();
                resetFileUploadPreviews('site'); // Reset site logo previews
            } catch (error) {
                hideLoadingSpinner();
                console.error("Error saving site settings:", error);
                showMessageModal(translations[currentLanguage].messageError || "Error saving site settings.", 'error');
            }
        }


        // Event Listeners for Page Load and Interactions
        window.onload = function() {
            // Populate views object
            views.aboutUs = document.getElementById('aboutUsView');
            views.editorialBoard = document.getElementById('editorialBoardView');
            views.currentIssue = document.getElementById('currentIssueView');
            views.archivalVolumes = document.getElementById('archivalVolumesView');
            views.editorialAndEthics = document.getElementById('editorialAndEthicsView');
            views.newsEvents = document.getElementById('newsEventsView');
            views.adminLogin = document.getElementById('adminLoginView');
            views.adminDashboard = document.getElementById('adminDashboardView');
            
            if (typeof translations === 'undefined' || !translations.en || !translations.it) {
                console.error("CRITICAL: Full translations object not found or incomplete. Text will not display correctly. Ensure it's pasted above.");
                // Provide minimal fallback if translations are missing, to prevent some errors during init
                window.translations = { en: { noPublicationsToManage: "No publications", noNewsToManage: "No news"}, it: { noPublicationsToManage: "Nessuna pubblicazione", noNewsToManage: "Nessuna notizia" } };
            }

            applyTranslations(currentLanguage); // Apply initial language
            initializeFirebase(); // Initialize Firebase and set up auth listener
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            showView('aboutUs'); // Explicitly show the default view
        };

        // Attach ALL event listeners
        document.querySelectorAll('.lang-button').forEach(button => {
            button.addEventListener('click', (e) => {
                applyTranslations(e.target.dataset.lang);
                // Re-apply translations for dynamically loaded content, or re-render
                // For simplicity, re-calling relevant display functions here.
                listenForPublicPublications(); // Re-fetch/display to apply language
                listenForCurrentIssue();
                listenForNews();
                listenForSiteLogos(); // To update image alt texts if they were translation keys
                if (isAdmin) {
                    listenForAdminPublications();
                    listenForAdminNews();
                }
            });
        });

        document.querySelectorAll('.view-button').forEach(button => {
            button.addEventListener('click', (e) => showView(e.target.dataset.view));
        });

        document.getElementById('closeMessageModal').addEventListener('click', hideMessageModal);
        document.getElementById('closePublicationDetailsModal').addEventListener('click', hidePublicationDetailsModal);

        // Admin login form
        document.getElementById('adminLoginForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            showLoadingSpinner();
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const loginErrorMessage = document.getElementById('loginErrorMessage');

            loginErrorMessage.textContent = ''; // Clear previous error

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Auth state change will be handled by onAuthStateChanged listener
                hideLoadingSpinner();
            } catch (error) {
                hideLoadingSpinner();
                console.error("Login error:", error);
                let errorMessage = translations[currentLanguage].loginErrorGeneric || "Login failed. Please check your credentials.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = translations[currentLanguage].loginErrorInvalidCredentials || "Invalid email or password.";
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = translations[currentLanguage].loginErrorTooManyRequests || "Too many failed login attempts. Please try again later.";
                }
                loginErrorMessage.textContent = errorMessage;
            }
        });

        // Search and Sort
        let allPublications = []; // Store all fetched publications for client-side filtering/sorting

        // This function will be called by listenForPublicPublications
        const originalDisplayPublications = displayPublications; // Keep a reference to the original
        displayPublications = (pubs, containerId) => {
            allPublications = pubs; // Store the full list
            filterAndSortPublications(containerId); // Call the combined filter/sort function
        };

        function filterAndSortPublications(containerId) {
            let filteredPublications = [...allPublications]; // Start with all
            const searchTerm = document.getElementById('publicationSearch').value.toLowerCase();
            const sortBy = document.getElementById('sortPublications').value;

            if (searchTerm) {
                filteredPublications = filteredPublications.filter(pub =>
                    pub.title.toLowerCase().includes(searchTerm) ||
                    pub.authors.toLowerCase().includes(searchTerm) ||
                    pub.description.toLowerCase().includes(searchTerm) ||
                    pub.year.toString().includes(searchTerm)
                );
            }

            filteredPublications.sort((a, b) => {
                switch (sortBy) {
                    case 'year-desc': return b.year - a.year;
                    case 'year-asc': return a.year - b.year;
                    case 'title-asc': return a.title.localeCompare(b.title);
                    case 'title-desc': return b.title.localeCompare(a.title);
                    case 'author-asc': return a.authors.localeCompare(b.authors);
                    case 'author-desc': return b.authors.localeCompare(a.authors);
                    default: return 0;
                }
            });
            originalDisplayPublications(filteredPublications, containerId); // Use the original display function
        }

        document.getElementById('publicationSearch').addEventListener('input', () => filterAndSortPublications('publicationsList'));
        document.getElementById('sortPublications').addEventListener('change', () => filterAndSortPublications('publicationsList'));
        document.getElementById('filterPublications').addEventListener('input', (e) => {
            const filterText = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#adminPublicationsTableBody .admin-table-row');
            rows.forEach(row => {
                const title = row.children[0].textContent.toLowerCase();
                const authors = row.children[1].textContent.toLowerCase();
                const year = row.children[2].textContent.toLowerCase();
                if (title.includes(filterText) || authors.includes(filterText) || year.includes(filterText)) {
                    row.classList.remove('hidden');
                } else {
                    row.classList.add('hidden');
                }
            });
        });

        // Admin Forms setup
        document.getElementById('addPublicationForm').addEventListener('submit', handleAddEditPublication);
        document.getElementById('clearPublicationForm').addEventListener('click', () => {
            document.getElementById('addPublicationForm').reset();
            document.getElementById('addPublicationForm').removeAttribute('data-editing-id');
            document.getElementById('addPublicationForm').removeAttribute('data-current-cover-image-url');
            document.getElementById('addPublicationForm').removeAttribute('data-current-full-pdf-url');
            document.getElementById('addPublicationForm').removeAttribute('data-current-abstract-ar-url');
            document.getElementById('addPublicationForm').removeAttribute('data-current-abstract-en-url');
            document.getElementById('addPublicationForm').removeAttribute('data-current-abstract-it-url');
            document.getElementById('adminFormTitle').textContent = translations[currentLanguage].addPublicationTitle;
            resetFileUploadPreviews('book');
        });

        document.getElementById('addNewsForm').addEventListener('submit', handleAddEditNews);
        document.getElementById('clearNewsForm').addEventListener('click', () => {
            document.getElementById('addNewsForm').reset();
            document.getElementById('addNewsForm').removeAttribute('data-editing-id');
            document.getElementById('adminNewsFormTitle').textContent = translations[currentLanguage].addNewsTitle;
        });

        document.getElementById('siteSettingsForm').addEventListener('submit', handleSiteSettingsSave);

        // Setup file upload previews
        setupFileUploadPreview('bookCoverImage', 'bookCoverImagePreview', true);
        setupFileUploadPreview('bookFullPdf', 'bookFullPdfPreview', false);
        setupFileUploadPreview('bookAbstractAr', 'bookAbstractArPreview', false);
        setupFileUploadPreview('bookAbstractEn', 'bookAbstractEnPreview', false);
        setupFileUploadPreview('bookAbstractIt', 'bookAbstractItPreview', false);

        setupFileUploadPreview('siteHeaderLogo', 'siteHeaderLogoPreview', true);
        setupFileUploadPreview('siteFooterLogo', 'siteFooterLogoPreview', true);
        setupFileUploadPreview('siteContributor1Logo', 'siteContributor1LogoPreview', true);
        setupFileUploadPreview('siteContributor2Logo', 'siteContributor2LogoPreview', true);

        // Initial setup for admin navigation listeners (these should be setup once)
        setupAdminNavListeners();

    </script>
</body>
</html>
