<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="pageTitle">Quaderni di Archeologia della Libya - Publications</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: EB Garamond for global text and headings -->
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Global Font and Base Colors - Refined Cooler Greys */
        body {
            font-family: 'EB Garamond', serif; /* Apply Garamond globally */
            background-color: #e8e9eb; /* Very light cool grey */
            color: #3f4245; /* Dark charcoal-blue for body text */
            line-height: 1.6;
        }

        /* Headings Font - Consistent Garamond */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'EB Garamond', serif;
            color: #2c2f33; /* Even darker blue-grey for headings */
            font-weight: 700;
        }

        /* Container for main content */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header Specific Styles */
        .header-bg {
            background-color: #d8dbdf; /* Lighter cool grey for header */
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); /* Subtle shadow */
            border-bottom: 1px solid #c0c4c9; /* A finer line */
        }
        .header-logo {
            max-height: 90px;
            width: auto;
            filter: none; /* No filter needed for lighter background */
        }
        .nav-button {
            background-color: #5f6b7a; /* Muted blue-grey for buttons */
            color: #ffffff; /* White text */
            font-family: 'EB Garamond', serif;
            padding: 0.75rem 1.25rem;
            border-radius: 6px;
            transition: all 0.2s ease-in-out;
            text-decoration: none;
            display: inline-block;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            white-space: nowrap;
            border: 1px solid #505c68; /* Distinct border */
        }
        .nav-button:hover {
            background-color: #72808f; /* Slightly lighter on hover */
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        /* Translation Buttons */
        .lang-button {
            background-color: #8c98a7; /* Even lighter blue-grey for lang buttons */
            color: #ffffff;
            font-family: 'EB Garamond', serif;
            padding: 0.5rem 0.8rem;
            border-radius: 4px;
            transition: all 0.2s ease-in-out;
            font-weight: 600;
            border: 1px solid #7a8694;
        }
        .lang-button:hover {
            background-color: #a0aab8;
            transform: translateY(-1px);
        }
        .lang-button.active {
            background-color: #3b76a7; /* Active blue */
            border-color: #2e5a80;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }

        /* Search Bar Styling */
        .header-search-container {
            background-color: #e0e2e5; /* Lighter cool grey for search area */
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.03);
            border: 1px solid #c0c4c9;
        }
        .search-input, .search-select {
            border: 1px solid #a0a8b3; /* Medium cool grey border */
            border-radius: 4px;
            padding: 0.6rem 1rem;
            font-family: 'EB Garamond', serif;
            color: #3f4245; /* Dark text */
            background-color: #f0f2f5; /* Off-white for inputs */
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }
        .search-input::placeholder, .search-select option {
            color: #7f8a94; /* Placeholder text color */
        }
        .search-input:focus, .search-select:focus {
            border-color: #5f6b7a; /* Muted blue-grey on focus */
            outline: none;
            box-shadow: 0 0 0 2px rgba(95, 107, 122, 0.2); /* Light blue-grey focus ring */
        }
        .search-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292%22%20height%3D%22292%22%20viewBox%3D%220%200%20292%20292%22%3E%3Cpath%20fill%3D%22%237f8a94%22%20d%3D%22M287%2069.4L146.7%20209.6%206.4%2069.4c-4.2-4.1-11-4.1-15.2%200-4.2%204.1-4.2%2010.8%200%2014.9l145%20146.5c4%204%2010.4%204%2014.4%200l145-146.5c4.2-4.1%204.2-10.8%200-14.9-4.2-4.1-11-4.1-15.2%200z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 0.8em;
            padding-right: 2.5rem;
        }

        /* General Section Styling */
        .section-content {
            background-color: #f0f2f5; /* Off-white, slightly darker light grey for main content sections */
            border-radius: 12px;
            padding: 2.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 2.5rem;
            animation: fadeIn 0.8s ease-out;
            border: 1px solid #d0d5dc; /* Subtle cool grey border */
        }

        /* Publication Cards */
        .publication-card {
            background-color: #f8f9fa; /* Even lighter for cards */
            border: 1px solid #e0e5ea; /* Very light cool grey border */
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }
        .publication-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }
        .cover-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-bottom: 1px solid #e0e5ea;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6); /* Standard overlay */
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .modal.flex {
            display: flex;
        }
        .modal-content {
            background-color: #e8e9eb; /* Modal content matches body background for harmony */
            margin: auto;
            padding: 2.5rem;
            border-radius: 10px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            width: 90%;
            max-width: 700px;
            text-align: center;
            position: relative;
            border: 1px solid #a0a8b3;
        }
        .modal-close-button {
            position: absolute;
            top: 15px;
            right: 25px;
            color: #7f8a94;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .modal-close-button:hover {
            color: #2c2f33;
        }
        .modal-buttons button {
            background-color: #5f6b7a;
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 6px;
            transition: background-color 0.2s ease;
            font-family: 'EB Garamond', serif;
            font-weight: 600;
        }
        .modal-buttons button:hover {
            background-color: #72808f;
        }

        /* Admin Specific Styles */
        .admin-bg {
            background-color: #c0c4c9; /* Slightly darker cool grey for admin area */
            color: #2c2f33; /* Dark text for admin */
        }
        .admin-section {
            background-color: #d8dbdf; /* Lighter cool grey for admin sections */
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            color: #3f4245; /* Dark text inside admin sections */
        }
        .admin-section h3 {
            color: #2c2f33; /* Ensure headings are dark */
        }
        .admin-input {
            border: 1px solid #a0a8b3;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            font-family: 'EB Garamond', serif;
            color: #3f4245;
            background-color: #f0f2f5;
        }
        .admin-input::placeholder {
            color: #7f8a94;
        }
        .admin-input:focus {
            border-color: #5f6b7a;
            box-shadow: 0 0 0 2px rgba(95, 107, 122, 0.2);
        }
        .admin-button {
            background-color: #5f6b7a;
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            transition: background-color 0.2s ease;
            font-family: 'EB Garamond', serif;
            font-weight: 600;
        }
        .admin-button:hover {
            background-color: #72808f;
        }
        .admin-button.bg-red-600 { background-color: #dc2626; border-color: #b91c1c;} /* Tailwind red */
        .admin-button.bg-red-600:hover { background-color: #b91c1c; }
        .admin-button.bg-green-600 { background-color: #16a34a; border-color: #15803d; } /* Tailwind green */
        .admin-button.bg-green-600:hover { background-color: #15803d; }
        .admin-button.bg-blue-600 { background-color: #2563eb; border-color: #1d4ed8; } /* Tailwind blue */
        .admin-button.bg-blue-600:hover { background-color: #1d4ed8; }

        /* Footer Styles */
        .footer-bg {
            background-color: #a0a8b3; /* Medium cool grey for footer */
            color: #2c2f33; /* Dark text */
            padding: 2rem;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            border-top: 1px solid #b0b8c3;
        }
        .footer-logo {
            max-height: 60px;
            width: auto;
            filter: none; /* No filter needed for lighter background */
        }
        .footer-link {
            color: #3b76a7; /* Professional blue for links */
        }
        .footer-link:hover {
            color: #2e5a80; /* Darker blue on hover */
            text-decoration: underline;
        }

        /* Specific style for abstract/pdf download buttons in modal */
        .modal-download-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }
        .modal-download-group a, .modal-download-group button {
            background-color: #3b76a7; /* A professional blue for downloads */
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 5px;
            font-size: 0.9rem;
            transition: background-color 0.2s ease;
            font-family: 'EB Garamond', serif;
            font-weight: 600;
            text-decoration: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .modal-download-group a:hover, .modal-download-group button:hover {
            background-color: #2e5a80;
        }
        /* Loading Spinner Styles */
        #loadingSpinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent black */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Ensure it's above everything else */
            backdrop-filter: blur(5px); /* Optional: blur background */
        }

        .spinner {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body class="bg-amber-50 min-h-screen flex flex-col">

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="hidden">
        <div class="spinner"></div>
    </div>

    <!-- Header -->
    <header class="header-bg shadow-md py-4 px-6 md:px-8">
        <div class="container flex justify-between items-center">
            <a href="#home" class="flex items-center">
                <img id="headerLogo" src="https://placehold.co/150x50/cccccc/333333?text=Logo" alt="Site Logo" class="header-logo rounded-md mr-3">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800" data-lang-key="headerTitle">Quaderni di Archeologia della Libya</h1>
            </a>
            <nav class="flex items-center space-x-4">
                <button id="homeViewBtn" class="nav-button" data-lang-key="homeBtn">Publications</button>
                <button id="aboutViewBtn" class="nav-button" data-lang-key="aboutBtn">About Us</button>
                <button id="contactViewBtn" class="nav-button" data-lang-key="contactBtn">Contact Us</button>
                <!-- Admin login button made less pronounced -->
                <button id="adminLoginBtn" class="nav-button text-sm" data-lang-key="adminLoginBtn">Admin Login</button>
                <button id="adminLogoutBtn" class="nav-button hidden bg-red-600 hover:bg-red-700" data-lang-key="logoutButton">Logout</button>
                <div class="flex space-x-2">
                    <button id="langEnBtn" class="lang-button active">EN</button>
                    <button id="langItBtn" class="lang-button">IT</button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow container mt-8">

        <!-- Message/Alert Modal -->
        <div id="messageModal" class="modal hidden">
            <div class="modal-content">
                <span class="modal-close-button" onclick="closeMessageModal()">&times;</span>
                <p id="modalMessage" class="text-lg text-gray-800"></p>
                <div class="modal-buttons">
                    <button onclick="closeMessageModal()" class="admin-button" data-lang-key="modalOkBtn">OK</button>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmModal" class="modal hidden">
            <div class="modal-content">
                <span class="modal-close-button" onclick="closeConfirmModal()">&times;</span>
                <p id="confirmMessage" class="text-lg text-gray-800 mb-6"></p>
                <div class="modal-buttons">
                    <button id="confirmYesBtn" class="admin-button bg-red-600 hover:bg-red-700" data-lang-key="confirmYesBtn">Yes</button>
                    <button id="confirmNoBtn" class="admin-button bg-gray-400 hover:bg-gray-500" data-lang-key="confirmNoBtn">No</button>
                </div>
            </div>
        </div>

        <!-- Book Details Modal -->
        <div id="bookDetailsModal" class="modal hidden">
            <div class="modal-content">
                <span class="modal-close-button" onclick="closeBookDetailsModal()">&times;</span>
                <img id="modalBookCover" src="" alt="Book Cover" class="w-48 h-64 object-cover rounded-md mx-auto mb-4 shadow-lg">
                <h3 id="modalBookTitle" class="text-2xl font-bold mb-2 text-gray-800"></h3>
                <p id="modalBookAuthor" class="text-gray-600 text-base mb-3"></p>
                <div class="text-gray-700 text-sm text-left leading-relaxed mb-6 space-y-2">
                    <p id="modalBookPages" class="font-medium"></p>
                    <p id="modalBookFormat" class="font-medium"></p>
                    <p id="modalBookDoi"><span class="font-medium" data-lang-key="doiLabel">DOI:</span> <a href="#" target="_blank" class="text-blue-600 hover:underline"></a></p>
                    <p id="modalBookIsbn"><span class="font-medium" data-lang-key="isbnLabel">ISBN:</span> </p>
                    <p id="modalBookIssn"><span class="font-medium" data-lang-key="issnLabel">ISSN:</span> </p>
                    <p id="modalBookNovelty" class="text-green-600 font-semibold hidden" data-lang-key="isNoveltyLabel">NEW!</p>
                    <p id="modalBookDescription"></p>
                </div>
                <div class="modal-download-group">
                    <a id="modalDownloadPdfBtn" href="#" target="_blank" class="admin-button bg-blue-500 hover:bg-blue-600" data-lang-key="downloadPdfButton">Download PDF</a>
                </div>
            </div>
        </div>

        <!-- Home View Section (Publications) -->
        <section id="homeView" class="section-content">
            <h2 class="text-3xl font-bold mb-6 text-center text-gray-800" data-lang-key="ourPublicationsTitle">Our Publications</h2>
            <div class="mb-6 max-w-lg mx-auto">
                <label for="publicSearchInput" class="sr-only" data-lang-key="searchPublicationsLabel">Search Publications</label>
                <input type="text" id="publicSearchInput" placeholder="Search by title or author..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" data-lang-key="searchPlaceholder">
            </div>
            <div id="booksContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Books will be loaded here by JavaScript -->
                <p class="text-center text-gray-500 col-span-full" id="noBooksMessage" data-lang-key="noPublicationsMessage">No publications yet. Check back soon!</p>
            </div>
        </section>

        <!-- About Us Section -->
        <section id="aboutView" class="hidden section-content">
            <h2 class="text-3xl font-bold mb-6 text-center text-gray-800" data-lang-key="aboutTitle">About Quaderni di Archeologia della Libya</h2>
            <div class="prose max-w-none text-gray-700 leading-relaxed space-y-4">
                <p data-lang-key="aboutPara1">Welcome to the official website for <strong>Quaderni di Archeologia della Libya</strong>, a prestigious academic journal dedicated to archaeological research in Libya. Initiated in 1950, this esteemed series documents the significant contributions of Italian archaeological missions in the region, fostering a deeper understanding of its rich ancient history.</p>
                <p data-lang-key="aboutPara2">After a brief hiatus, the journal proudly resumed publication in 2018 with a new series, re-establishing itself as a leading scientific platform. We provide an essential venue for scholars interested in the archaeology and history of Libya and the broader Maghreb, ensuring high-quality, peer-reviewed content.</p>
                <p data-lang-key="aboutPara3">Our volumes embrace a multidisciplinary approach, featuring articles on epigraphy, ancient and colonial history, the history of archaeology, and territorial studies. Contributions are published in major European languages, complemented by comprehensive English and Arabic abstracts, to promote international academic exchange and collaboration.</p>
                <p data-lang-key="aboutPara4">This website serves as a dedicated resource for the series, maintained by L'Erma di Bretschneider, a renowned academic publishing house in Rome. We are committed to upholding the highest standards of scholarly excellence and ensuring the continued global dissemination of groundbreaking research presented in the "Quaderni di Archeologia della Libya."</p>
            </div>
        </section>

        <!-- Contact Us Section -->
        <section id="contactView" class="hidden section-content">
            <h2 class="text-3xl font-bold mb-6 text-center text-gray-800" data-lang-key="contactTitle">Contact Us</h2>
            <div class="text-gray-700 space-y-4">
                <p><strong class="font-semibold" data-lang-key="contactEmailLabel">Email:</strong> <a href="mailto:lerma@lerma.it" class="text-blue-600 hover:underline">lerma@lerma.it</a></p>
                <p><strong class="font-semibold" data-lang-key="contactPhoneLabel">Phone:</strong> +39 06 6874127</p>
                <p><strong class="font-semibold" data-lang-key="contactAddressLabel">Address:</strong></p>
                <address class="not-italic">
                    L'Erma di Bretschneider<br>
                    Via Marianna Dionigi, 57<br>
                    00193 Roma RM, Italy
                </address>
                <p data-lang-key="contactMessage">For inquiries regarding publications of "Quaderni di Archeologia della Libya" or other scholarly initiatives, please feel free to reach out to L'Erma di Bretschneider through the contact information provided above.</p>
            </div>
        </section>

        <!-- Admin Login Section -->
        <section id="adminLoginView" class="hidden admin-bg p-8 rounded-xl shadow-lg max-w-md mx-auto">
            <h2 class="text-3xl font-bold mb-8 text-center text-gray-800" data-lang-key="adminLoginTitle">Admin Login</h2>
            <form id="adminLoginForm" class="space-y-6">
                <div>
                    <label for="username" class="block text-gray-700 text-sm font-semibold mb-2" data-lang-key="usernameLabel">Username (Email):</label>
                    <input type="email" id="username" name="username" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="password" class="block text-gray-700 text-sm font-semibold mb-2" data-lang-key="passwordLabel">Password:</label>
                    <input type="password" id="password" name="password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg shadow-md transition duration-300" data-lang-key="loginButton">Login</button>
            </form>
            <p class="text-center text-sm text-gray-500 mt-4" data-lang-key="firebaseAuthHint">Use your Firebase Auth admin email and password.</p>
            <p class="text-sm text-red-500 mt-2 text-center" id="loginErrorMessage"></p>
        </section>

        <!-- Admin Dashboard Section -->
        <section id="adminDashboardView" class="hidden admin-bg p-8 rounded-xl shadow-lg">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-3xl font-bold text-gray-800" data-lang-key="adminDashboardTitle">Admin Dashboard</h2>
                <div class="flex space-x-2">
                    <button id="managePublicationsBtn" class="admin-button bg-blue-600 hover:bg-blue-700" data-lang-key="managePublicationsBtn">Manage Publications</button>
                    <button id="siteSettingsBtn" class="admin-button bg-purple-600 hover:bg-purple-700" data-lang-key="siteSettingsBtn">Site Settings</button>
                    <!-- Logout button moved here as well for consistency, it's also in the header -->
                    <button id="adminDashboardLogoutBtn" class="admin-button bg-red-600 hover:bg-red-700" data-lang-key="logoutButton">Logout</button>
                </div>
            </div>

            <!-- Manage Publications Subsection -->
            <div id="managePublicationsSection" class="admin-section">
                <!-- Upload/Edit New Book Form -->
                <div class="mb-8 p-6 border border-gray-200 rounded-xl shadow-sm">
                    <h3 id="formTitle" class="text-2xl font-bold mb-4 text-gray-800" data-lang-key="uploadNewPublicationTitle">Upload New Publication</h3>
                    <form id="uploadBookForm" class="space-y-4">
                        <div>
                            <label for="bookTitle" class="block text-gray-700 text-sm font-semibold mb-2" data-lang-key="bookTitleLabel">Title:</label>
                            <input type="text" id="bookTitle" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="bookAuthor" class="block text-gray-700 text-sm font-semibold mb-2" data-lang-key="bookAuthorLabel">Author:</label>
                            <input type="text" id="bookAuthor" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="bookDescription" class="block text-gray-700 text-sm font-semibold mb-2" data-lang-key="bookDescriptionLabel">Description:</label>
                            <textarea id="bookDescription" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        <div>
                            <label for="bookPages" class="block text-gray-700 text-sm font-semibold mb-2" data-lang-key="bookPagesLabel">Pages:</label>
                            <input type="text" id="bookPages" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 258 pp.">
                        </div>
                        <div>
                            <label for="bookFormat" class="block text-gray-700 text-sm font-semibold mb-2" data-lang-key="bookFormatLabel">Format:</label>
                            <input type="text" id="bookFormat" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Brossura, 21,5 x 28 cm">
                        </div>
                        <div>
                            <label for="bookDoi" class="block text-gray-700 text-sm font-semibold mb-2" data-lang-key="bookDoiLabel">DOI:</label>
                            <input type="text" id="bookDoi" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 10.48255/...">
                        </div>
                        <div>
                            <label for="bookIsbn" class="block text-gray-700 text-sm font-semibold mb-2" data-lang-key="bookIsbnLabel">ISBN:</label>
                            <input type="text" id="bookIsbn" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 9788891332295">
                        </div>
                        <div>
                            <label for="bookIssn" class="block text-gray-700 text-sm font-semibold mb-2" data-lang-key="bookIssnLabel">ISSN:</label>
                            <input type="text" id="bookIssn" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 0079-8258">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="bookIsNew" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="bookIsNew" class="ml-2 block text-gray-700 text-sm font-semibold" data-lang-key="bookIsNewLabel">Novelty (New Publication)</label>
                        </div>
                        <div>
                            <label for="coverImageFile" class="block text-gray-700 text-sm font-semibold mb-2" data-lang-key="uploadCoverImageLabel">Upload Cover Image:</label>
                            <input type="file" id="coverImageFile" accept="image/png, image/jpeg, image/gif" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p id="coverImageFileNameDisplay" class="text-sm text-gray-600 mt-1"></p>
                            <img id="uploadedCoverPreview" src="" alt="Uploaded Cover Preview" class="mt-4 max-w-xs h-auto rounded-lg shadow-md" style="display:none;">
                        </div>
                        <div>
                            <label for="pdfFile" class="block text-gray-700 text-sm font-semibold mb-2" data-lang-key="uploadPdfFileLabel">Upload PDF File:</label>
                            <input type="file" id="pdfFile" accept=".pdf" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p id="pdfFileNameDisplay" class="text-sm text-gray-600 mt-1"></p>
                        </div>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                            <button type="submit" id="submitBookBtn" class="w-full sm:w-1/2 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg shadow-md transition duration-300" data-lang-key="addPublicationButton">Add Publication</button>
                            <button type="button" id="cancelEditBtn" class="w-full sm:w-1/2 bg-gray-400 hover:bg-gray-500 text-white font-semibold py-3 rounded-lg shadow-md transition duration-300 hidden" data-lang-key="cancelEditButton">Cancel Edit</button>
                        </div>
                    </form>
                </div>

                <!-- Existing Publications List -->
                <div class="p-6 border border-gray-200 rounded-xl shadow-sm">
                    <h3 class="text-2xl font-bold mb-4 text-gray-800" data-lang-key="existingPublicationsTitle">Existing Publications</h3>
                    <div id="adminBooksList" class="space-y-4">
                        <!-- Books will be loaded here for admin by JavaScript -->
                        <p class="text-center text-gray-500" id="noAdminBooksMessage" data-lang-key="noPublicationsUploadedYet">No publications uploaded yet.</p>
                    </div>
                </div>
            </div>

            <!-- Site Settings Subsection -->
            <div id="siteSettingsSection" class="admin-section hidden">
                <h3 class="text-2xl font-bold mb-4 text-gray-800" data-lang-key="siteSettingsTitle">Site Settings</h3>
                <form id="uploadSiteLogoForm" class="space-y-4">
                    <div>
                        <label for="siteLogoFile" class="block text-gray-700 text-sm font-semibold mb-2" data-lang-key="uploadSiteLogoLabel">Upload Site Logo (Header & Footer):</label>
                        <input type="file" id="siteLogoFile" accept="image/png, image/jpeg, image/gif" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p id="siteLogoFileNameDisplay" class="text-sm text-gray-600 mt-1"></p>
                        <img id="uploadedSiteLogoPreview" src="" alt="Site Logo Preview" class="mt-4 max-w-xs h-auto rounded-lg shadow-md" style="display:none;">
                    </div>
                    <button type="submit" id="saveSiteLogoBtn" class="admin-button bg-green-600 hover:bg-green-700" data-lang-key="saveSiteLogoButton">Save Site Logo</button>
                </form>
            </div>

        </section>

    </main>

    <!-- Footer -->
    <footer class="footer-bg text-amber-50 py-4 mt-8 px-6 md:px-8">
        <div class="container text-center text-sm">
            <p>&copy; <span id="currentYear"></span> <span data-lang-key="footerCopyright">L'Erma di Bretschneider. All rights reserved.</span></p>
            <p class="text-amber-100" data-lang-key="footerDataStorage">Website data is stored securely using Firebase services.</p>
            <p class="text-amber-100" data-lang-key="footerUserId">Logged in User ID: <span id="currentUserId" class="font-mono"></span></p>
            <img id="footerLogo" src="https://placehold.co/100x30/cccccc/333333?text=Logo" alt="Site Logo" class="footer-logo mt-3 mx-auto">
        </div>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Firebase Configuration ---
        // Use environment variables if available (provided by Canvas), otherwise fall back to a default.
        // This ensures the app adapts to the Canvas environment's specific Firebase project.
        const providedFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

        // Fallback configuration if not running in Canvas or __firebase_config is not provided.
        // You would replace these with your actual Firebase project details if deploying independently.
        const defaultFirebaseConfig = {
            apiKey: "YOUR_API_KEY", // Placeholder - Canvas will inject this if empty
            authDomain: "your-project-id.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project-id.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID",
            measurementId: "G-XXXXXXXXXX"
        };
        const finalFirebaseConfig = providedFirebaseConfig || defaultFirebaseConfig;

        // Determine the current app ID for constructing Firebase paths.
        // It prioritizes __app_id from the Canvas environment, falling back to the projectId from the config.
        const currentAppId = typeof __app_id !== 'undefined' ? __app_id : finalFirebaseConfig.projectId;

        // --- Firebase Service Instances ---
        let app;
        let db;
        let auth;
        let storage;
        
        // --- Authentication & User State ---
        let userId = null; // The UID of the currently authenticated user (anonymous, email/pass, or custom token)
        let isLoggedIn = false; // True if *any* user is authenticated (including anonymous)
        let isAuthReady = false; // True once the initial Firebase Auth state has been determined
        // This variable will hold the UID of the specific "admin" user, which is assumed to be
        // the user authenticated via the __initial_auth_token in the Canvas environment.
        let ADMIN_UID_FROM_CANVAS = null;

        // --- Firebase Collection and Storage Paths ---
        // These paths are constructed using the currentAppId for proper isolation within the Canvas environment.
        const BOOKS_COLLECTION_PATH = `artifacts/${currentAppId}/public/data/books`;
        const SITE_SETTINGS_DOC_PATH = `artifacts/${currentAppId}/public/data/settings/site_branding`;
        const COVERS_STORAGE_PATH = `artifacts/${currentAppId}/public/files/covers`;
        const PDFS_STORAGE_PATH = `artifacts/${currentAppId}/public/files/pdfs`;
        const SITE_ASSETS_STORAGE_PATH = `artifacts/${currentAppId}/public/files/site_assets`;


        // --- Translation Logic ---
        const translations = {
            en: {
                pageTitle: "Quaderni di Archeologia della Libya - Publications",
                headerTitle: "Quaderni di Archeologia della Libya",
                homeBtn: "Publications",
                aboutBtn: "About Us",
                contactBtn: "Contact Us",
                adminLoginBtn: "Admin Login",
                logoutButton: "Logout",
                ourPublicationsTitle: "Our Publications",
                searchPublicationsLabel: "Search Publications",
                searchPlaceholder: "Search by title or author...",
                noPublicationsMessage: "No publications yet. Check back soon!",
                aboutTitle: "About Quaderni di Archeologia della Libya",
                aboutPara1: "Welcome to the official website for <strong>Quaderni di Archeologia della Libya</strong>, a prestigious academic journal dedicated to archaeological research in Libya. Initiated in 1950, this esteemed series documents the significant contributions of Italian archaeological missions in the region, fostering a deeper understanding of its rich ancient history.",
                aboutPara2: "After a brief hiatus, the journal proudly resumed publication in 2018 with a new series, re-establishing itself as a leading scientific platform. We provide an essential venue for scholars interested in the archaeology and history of Libya and the broader Maghreb, ensuring high-quality, peer-reviewed content.",
                aboutPara3: "Our volumes embrace a multidisciplinary approach, featuring articles on epigraphy, ancient and colonial history, the history of archaeology, and territorial studies. Contributions are published in major European languages, complemented by comprehensive English and Arabic abstracts, to promote international academic exchange and collaboration.",
                aboutPara4: "This website serves as a dedicated resource for the series, maintained by L'Erma di Bretschneider, a renowned academic publishing house in Rome. We are committed to upholding the highest standards of scholarly excellence and ensuring the continued global dissemination of groundbreaking research presented in the \"Quaderni di Archeologia della Libya.\"",
                contactTitle: "Contact Us",
                contactEmailLabel: "Email:",
                contactPhoneLabel: "Phone:",
                contactAddressLabel: "Address:",
                contactMessage: "For inquiries regarding publications of \"Quaderni di Archeologia della Libya\" or other scholarly initiatives, please feel free to reach out to L'Erma di Bretschneider through the contact information provided above.",
                adminLoginTitle: "Admin Login",
                usernameLabel: "Username (Email):",
                passwordLabel: "Password:",
                loginButton: "Login",
                firebaseAuthHint: "Use your Firebase Auth admin email and password.",
                adminDashboardTitle: "Admin Dashboard",
                uploadNewPublicationTitle: "Upload New Publication",
                bookTitleLabel: "Title:",
                bookAuthorLabel: "Author:",
                bookDescriptionLabel: "Description:",
                bookPagesLabel: "Pages:",
                bookFormatLabel: "Format:",
                bookDoiLabel: "DOI:",
                bookIsbnLabel: "ISBN:",
                bookIssnLabel: "ISSN:",
                bookIsNewLabel: "Novelty (New Publication)",
                uploadCoverImageLabel: "Upload Cover Image:",
                uploadPdfFileLabel: "Upload PDF File:",
                addPublicationButton: "Add Publication",
                cancelEditButton: "Cancel Edit",
                existingPublicationsTitle: "Existing Publications",
                noPublicationsUploadedYet: "No publications uploaded yet.",
                footerCopyright: "L'Erma di Bretschneider. All rights reserved.",
                footerDataStorage: "Website data is stored securely using Firebase services.",
                footerUserId: "Logged in User ID:",
                viewDetailsButton: "View Details",
                doiLabel: "DOI:",
                isbnLabel: "ISBN:",
                issnLabel: "ISSN:",
                isNoveltyLabel: "NEW!",
                // Modals
                modalOkBtn: "OK",
                confirmYesBtn: "Yes",
                confirmNoBtn: "No",
                msgFillTitleAuthor: "Please fill in at least the title and author.",
                msgCoverUploaded: "Cover image uploaded to Storage successfully!",
                msgPdfUploaded: "PDF uploaded to Storage successfully!",
                msgPublicationUpdated: "Publication updated successfully!",
                msgPublicationAdded: "Publication added successfully!",
                msgFirebaseStorageRules: "Ensure Firebase Storage rules allow writing.",
                msgBookNotFound: "Publication not found for editing.",
                msgErrorLoadingBook: "Error loading publication for editing. Please try again.",
                msgConfirmDelete: "Are you sure you want to delete this publication? This action cannot be undone.",
                msgPublicationDeleted: "Publication deleted successfully!",
                msgErrorDeletingPublication: "Error deleting publication. Ensure Firebase Storage rules allow deletion.",
                msgPdfNotAvailable: "PDF not available for this book.",
                msgCurrentCover: "Current:",
                msgNoCurrentCover: "No current cover.",
                msgCurrentPdf: "Current:",
                msgNoCurrentPdf: "No current PDF.",
                msgUpdating: "Updating...",
                msgAdding: "Adding...",
                msgAuthWarning: "No user is authenticated. Public view features requiring authentication may not work.",
                msgNoBooksFoundSearch: "No publications found matching your search. Try a different term.",
                msgErrorLoadingPublications: "Error loading publications. Please try again later.",
                msgErrorLoadingAdminPublications: "Error loading publications for admin. Please try again.",
                msgLoginInvalid: "Invalid email or password.",
                msgLoginTooManyAttempts: "Too many login attempts. Please try again later.",
                msgLoginFailedGeneric: "Login failed: ",
                msgLoggedOut: "Logged out successfully.",
                msgErrorLoggingOut: "Error logging out. Please try again.",
                msgFirebaseConfigInvalid: "Firebase configuration is missing or invalid. Please ensure the app is running in a Firebase-enabled environment with correct config.",
                msgFirebaseInitFailed: "Failed to initialize Firebase. Check console for details.",
                msgPublicContentAuthRequired: "Please log in or enable anonymous access in Firebase for public content.",
                msgSelected: "Selected",
                downloadPdfButton: "Download PDF",
                editButton: "Edit",
                deleteButton: "Delete",
                byAuthor: "by",
                msgNotAvailable: "Not available",
                msgUploading: "Uploading",
                msgUploaded: "Uploaded",
                msgFailedUploadCover: "Failed to upload cover image",
                msgFailedUploadPdf: "Failed to upload PDF",
                msgCheckStorageRulesOrNetwork: "Check storage rules or network.",
                msgUploadFailed: "Upload failed.",
                msgLoginRequiredForUpload: "Please log in as admin before uploading files.",
                msgLoginRequiredToAddEdit: "You must be logged in as an admin to add/edit publications.",
                msgFirebaseNotReady: "Firebase not ready. Please wait a moment.",
                msgSelectPdfWaitUpload: "Please select a PDF file and wait for it to finish uploading.",
                msgSelectCoverWaitUpload: "Please upload a cover image and wait for it to finish uploading.",
                msgPdfMissing: "PDF missing. Please upload a PDF or ensure existing one is valid.",
                msgCoverMissing: "Cover image missing. Please upload a cover image or ensure existing one is valid.",
                msgErrorSavingPublication: "Error saving publication",
                msgCheckFirestoreRules: "Check Firestore rules.",
                editPublicationTitle: "Edit Publication",
                updatePublicationButton: "Update Publication",
                msgNoCoverSelected: "No cover image selected.",
                msgNoPdfSelected: "No PDF file selected.",
                msgEditCancelled: "Edit cancelled.",
                msgLoginRequiredToDelete: "You must be logged in as an admin to delete publications.",
                msgNoDescriptionProvided: "No description provided.",
                msgLoginRequiredToEdit: "You must be logged in as an admin to edit publications.",
                managePublicationsBtn: "Manage Publications",
                siteSettingsBtn: "Site Settings",
                siteSettingsTitle: "Site Settings",
                uploadSiteLogoLabel: "Upload Site Logo (Header & Footer):",
                saveSiteLogoButton: "Save Site Logo",
                msgSiteLogoUploaded: "Site logo uploaded and saved successfully!",
                msgFailedUploadSiteLogo: "Failed to upload site logo",
                msgErrorSavingSiteLogo: "Error saving site logo settings",
                msgNoSiteLogoSelected: "No site logo selected.",
                msgCurrentSiteLogo: "Current site logo:",
                msgLoadingSiteSettings: "Loading site settings...",
                msgErrorLoadingSiteSettings: "Error loading site settings.",
                msgFirebaseError: "Firebase Error",
                msgViewNotFound: "View Not Found",
            },
            it: {
                pageTitle: "Quaderni di Archeologia della Libya - Pubblicazioni",
                headerTitle: "Quaderni di Archeologia della Libya",
                homeBtn: "Pubblicazioni",
                aboutBtn: "Chi Siamo",
                contactBtn: "Contatti",
                adminLoginBtn: "Accesso Amministratore",
                logoutButton: "Esci",
                ourPublicationsTitle: "Le Nostre Pubblicazioni",
                searchPublicationsLabel: "Cerca Pubblicazioni",
                searchPlaceholder: "Cerca per titolo o autore...",
                noPublicationsMessage: "Nessuna pubblicazione ancora. Torna presto!",
                aboutTitle: "Chi Siamo Quaderni di Archeologia della Libya",
                aboutPara1: "Benvenuti nel sito ufficiale di <strong>Quaderni di Archeologia della Libya</strong>, una prestigiosa rivista accademica dedicata alla ricerca archeologica in Libia. Iniziata nel 1950, questa stimata serie documenta i significativi contributi delle missioni archeologiche italiane nella regione, favorendo una più profonda comprensione della sua ricca storia antica.",
                aboutPara2: "Dopo una breve pausa, la rivista ha ripreso con orgoglio la pubblicazione nel 2018 con una nuova serie, ristabilendosi come una piattaforma scientifica di spicco. Forniamo un luogo essenziale per gli studiosi interessati all'archeologia e alla storia della Libia e del Maghreb più ampio, garantendo contenuti di alta qualità e sottoposti a revisione paritaria.",
                aboutPara3: "I nostri volumi adottano un approccio multidisciplinare, presentando articoli su epigrafia, antica e coloniale, storia dell'archeologia e studi territoriali. I contributi sono pubblicati nelle principali lingue europee, accompagnati da riassunti completi in inglese e arabo, per promuovere lo scambio accademico internazionale e la collaborazione.",
                aboutPara4: "Questo sito funge da risorsa dedicata alla serie, mantenuta da L'Erma di Bretschneider, una rinomata casa editrice accademica di Roma. Ci impegniamo a sostenere i più alti standard di eccellenza accademica e a garantire la continua diffusione globale delle ricerche innovative presentate nei \"Quaderni di Archeologia della Libya.\"",
                contactTitle: "Contattaci",
                contactEmailLabel: "Email:",
                contactPhoneLabel: "Telefono:",
                contactAddressLabel: "Indirizzo:",
                contactMessage: "Per domande relative alle pubblicazioni di \"Quaderni di Archeologia della Libya\" o altre iniziative accademiche, non esitate a contattare L'Erma di Bretschneider tramite le informazioni di contatto fornite sopra.",
                adminLoginTitle: "Accesso Amministratore",
                usernameLabel: "Nome utente (Email):",
                passwordLabel: "Password:",
                loginButton: "Accedi",
                firebaseAuthHint: "Usa l'email e la password dell'amministratore di Firebase Auth.",
                adminDashboardTitle: "Pannello di Amministrazione",
                uploadNewPublicationTitle: "Carica Nuova Pubblicazione",
                bookTitleLabel: "Titolo:",
                bookAuthorLabel: "Autore:",
                bookDescriptionLabel: "Descrizione:",
                bookPagesLabel: "Pagine:",
                bookFormatLabel: "Formato:",
                bookDoiLabel: "DOI:",
                bookIsbnLabel: "ISBN:",
                bookIssnLabel: "ISSN:",
                bookIsNewLabel: "Novità (Nuova Pubblicazione)",
                uploadCoverImageLabel: "Carica Immagine di Copertina:",
                uploadPdfFileLabel: "Carica File PDF:",
                addPublicationButton: "Aggiungi Pubblicazione",
                cancelEditButton: "Annulla Modifica",
                existingPublicationsTitle: "Pubblicazioni Esistenti",
                noPublicationsUploadedYet: "Nessuna pubblicazione caricata ancora.",
                footerCopyright: "L'Erma di Bretschneider. Tutti i diritti riservati.",
                footerDataStorage: "I dati del sito web sono archiviati in modo sicuro utilizzando i servizi Firebase.",
                footerUserId: "ID utente collegato:",
                viewDetailsButton: "Vedi Dettagli",
                doiLabel: "DOI:",
                isbnLabel: "ISBN:",
                issnLabel: "ISSN:",
                isNoveltyLabel: "NUOVO!",
                // Modals
                modalOkBtn: "OK",
                confirmYesBtn: "Sì",
                confirmNoBtn: "No",
                msgFillTitleAuthor: "Si prega di compilare almeno il titolo e l'autore.",
                msgCoverUploaded: "Immagine di copertina caricata su Storage con successo!",
                msgPdfUploaded: "PDF caricato su Storage con successo!",
                msgPublicationUpdated: "Pubblicazione aggiornata con successo!",
                msgPublicationAdded: "Pubblicazione aggiunta con successo!",
                msgFirebaseStorageRules: "Assicurati che le regole di Firebase Storage consentano la scrittura.",
                msgBookNotFound: "Pubblicazione non trovata per la modifica.",
                msgErrorLoadingBook: "Errore durante il caricamento della pubblicazione per la modifica. Riprova.",
                msgConfirmDelete: "Sei sicuro di voler eliminare questa pubblicazione? Questa azione non può essere annullata.",
                msgPublicationDeleted: "Pubblicazione eliminata con successo!",
                msgErrorDeletingPublication: "Errore durante l'eliminazione della pubblicazione. Assicurati che le regole di Firebase Storage consentano l'eliminazione.",
                msgPdfNotAvailable: "PDF non disponibile per questo libro.",
                msgCurrentCover: "Attuale:",
                msgNoCurrentCover: "Nessuna copertina attuale.",
                msgCurrentPdf: "Attuale:",
                msgNoCurrentPdf: "Nessun PDF attuale.",
                msgUpdating: "Aggiornamento...",
                msgAdding: "Aggiunta...",
                msgAuthWarning: "Nessun utente autenticato. Le funzionalità della vista pubblica che richiedono autenticazione potrebbero non funzionare.",
                msgNoBooksFoundSearch: "Nessuna pubblicazione trovata corrispondente alla tua ricerca. Prova un altro termine.",
                msgErrorLoadingPublications: "Errore durante il caricamento delle pubblicazioni. Riprova più tardi.",
                msgErrorLoadingAdminPublications: "Errore durante il caricamento delle pubblicazioni per l'amministratore. Riprova.",
                msgLoginInvalid: "Email o password non validi.",
                msgLoginTooManyAttempts: "Troppi tentativi di accesso. Riprova più tardi.",
                msgLoginFailedGeneric: "Accesso fallito: ",
                msgLoggedOut: "Disconnessione effettuata con successo.",
                msgErrorLoggingOut: "Errore durante la disconnessione. Riprova.",
                msgFirebaseConfigInvalid: "La configurazione di Firebase è mancante o non valida. Assicurati che l'app sia in esecuzione in un ambiente abilitato a Firebase con una configurazione corretta.",
                msgFirebaseInitFailed: "Impossibile inizializzare Firebase. Controlla la console per i dettagli.",
                msgPublicContentAuthRequired: "Accedi o abilita l'accesso anonimo in Firebase per i contenuti pubblici.",
                msgSelected: "Selezionato",
                downloadPdfButton: "Scarica PDF",
                editButton: "Modifica",
                deleteButton: "Elimina",
                byAuthor: "di",
                msgNotAvailable: "Non disponibile",
                msgUploading: "Caricamento",
                msgUploaded: "Caricato",
                msgFailedUploadCover: "Caricamento immagine di copertina fallito",
                msgFailedUploadPdf: "Caricamento PDF fallito",
                msgCheckStorageRulesOrNetwork: "Controlla le regole di storage o la rete.",
                msgUploadFailed: "Caricamento fallito.",
                msgLoginRequiredForUpload: "Accedi come amministratore prima di caricare i file.",
                msgLoginRequiredToAddEdit: "Devi essere loggato come amministratore per aggiungere/modificare pubblicazioni.",
                msgFirebaseNotReady: "Firebase non pronto. Attendi un momento.",
                msgSelectPdfWaitUpload: "Seleziona un file PDF e attendi il caricamento.",
                msgSelectCoverWaitUpload: "Carica un'immagine di copertina e attendi il caricamento.",
                msgPdfMissing: "PDF mancante. Carica un PDF o assicurati che quello esistente sia valido.",
                msgCoverMissing: "Immagine di copertina mancante. Carica un'immagine di copertina o assicurati che quella esistente sia valida.",
                msgErrorSavingPublication: "Errore durante il salvataggio della pubblicazione",
                msgCheckFirestoreRules: "Controlla le regole di Firestore.",
                editPublicationTitle: "Modifica Pubblicazione",
                updatePublicationButton: "Aggiorna Pubblicazione",
                msgNoCoverSelected: "Nessuna immagine di copertina selezionata.",
                msgNoPdfSelected: "Nessun file PDF selezionato.",
                msgEditCancelled: "Modifica annullata.",
                msgLoginRequiredToDelete: "Devi essere loggato come amministratore per eliminare le pubblicazioni.",
                msgNoDescriptionProvided: "Nessuna descrizione fornita.",
                msgLoginRequiredToEdit: "Devi essere loggato come amministratore per modificare le pubblicazioni.",
                managePublicationsBtn: "Gestisci Pubblicazioni",
                siteSettingsBtn: "Impostazioni Sito",
                siteSettingsTitle: "Impostazioni Sito",
                uploadSiteLogoLabel: "Carica Logo del Sito (Intestazione e Piè di pagina):",
                saveSiteLogoButton: "Salva Logo del Sito",
                msgSiteLogoUploaded: "Logo del sito caricato e salvato con successo!",
                msgFailedUploadSiteLogo: "Caricamento logo del sito fallito",
                msgErrorSavingSiteLogo: "Errore durante il salvataggio delle impostazioni del logo del sito",
                msgNoSiteLogoSelected: "Nessun logo del sito selezionato.",
                msgCurrentSiteLogo: "Logo attuale del sito:",
                msgLoadingSiteSettings: "Caricamento impostazioni sito...",
                msgErrorLoadingSiteSettings: "Errore durante il caricamento delle impostazioni del sito.",
                msgFirebaseError: "Errore Firebase",
                msgViewNotFound: "Vista non trovata",
            }
        };

        let currentLang = localStorage.getItem('lang') || 'en'; // Default to English or saved preference

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang);
            document.documentElement.lang = lang; // Set HTML lang attribute
            
            // Update all elements with data-lang-key
            document.querySelectorAll('[data-lang-key]').forEach(element => {
                const key = element.getAttribute('data-lang-key');
                if (translations[lang] && translations[lang][key]) {
                    // Handle innerHTML for bold tags in paragraphs
                    if (element.tagName === 'P' && (key.includes('Para') || key.includes('Subtitle'))) {
                        element.innerHTML = translations[lang][key];
                    } else {
                        element.textContent = translations[lang][key];
                    }
                }
            });

            // Update specific placeholders manually as textContent doesn't work for them
            const publicSearchInput = document.getElementById('publicSearchInput');
            if (publicSearchInput) {
                publicSearchInput.placeholder = translations[lang]['searchPlaceholder'];
            }
            
            // Update button texts that change based on context (Add/Update)
            // Ensure submitBookBtn is defined before accessing it
            const submitBookBtnLocal = document.getElementById('submitBookBtn');
            if (submitBookBtnLocal) {
                if (editingBookId) {
                    submitBookBtnLocal.textContent = translations[lang]['updatePublicationButton']; // Use update button text
                } else {
                    submitBookBtnLocal.textContent = translations[lang]['addPublicationButton'];
                }
            }

            // Update modal buttons if they are visible
            const modalOkBtn = document.querySelector('#messageModal .modal-buttons button');
            if (modalOkBtn) modalOkBtn.textContent = translations[lang]['modalOkBtn'];

            const confirmYesBtn = document.getElementById('confirmYesBtn');
            if (confirmYesBtn) confirmYesBtn.textContent = translations[lang]['confirmYesBtn'];
            const confirmNoBtn = document.getElementById('confirmNoBtn');
            if (confirmNoBtn) confirmNoBtn.textContent = translations[lang]['confirmNoBtn'];

            // Update dynamically generated text in file input displays
            const coverImageFileNameDisplayLocal = document.getElementById('coverImageFileNameDisplay');
            const pdfFileNameDisplayLocal = document.getElementById('pdfFileNameDisplay');
            const siteLogoFileNameDisplayLocal = document.getElementById('siteLogoFileNameDisplay');

            if (currentCoverImageFile) {
                if (coverImageFileNameDisplayLocal) coverImageFileNameDisplayLocal.textContent = `${translations[currentLang]['msgSelected']}: ${getOriginalFileNameFromUnique(currentCoverImageFile.name)}`;
            } else if (editingBookId && currentCoverImageFileName) {
                if (coverImageFileNameDisplayLocal) coverImageFileNameDisplayLocal.textContent = `${translations[currentLang]['msgCurrentCover']}: ${getOriginalFileNameFromUnique(currentCoverImageFileName)}`;
            } else {
                if (coverImageFileNameDisplayLocal) coverImageFileNameDisplayLocal.textContent = '';
            }

            if (currentPdfFile) {
                if (pdfFileNameDisplayLocal) pdfFileNameDisplayLocal.textContent = `${translations[currentLang]['msgSelected']}: ${getOriginalFileNameFromUnique(currentPdfFile.name)}`;
            } else if (editingBookId && currentPdfFileName) {
                if (pdfFileNameDisplayLocal) pdfFileNameDisplayLocal.textContent = `${translations[currentLang]['msgCurrentPdf']}: ${getOriginalFileNameFromUnique(currentPdfFileName)}`;
            } else {
                if (pdfFileNameDisplayLocal) pdfFileNameDisplayLocal.textContent = '';
            }

            if (currentSiteLogoFile) { // For the new site logo input
                if (siteLogoFileNameDisplayLocal) siteLogoFileNameDisplayLocal.textContent = `${translations[currentLang]['msgSelected']}: ${getOriginalFileNameFromUnique(currentSiteLogoFile.name)}`;
            } else if (siteLogoUrlFromFirestore && siteLogoFileNameFromFirestore) { // If a logo exists in Firestore
                 if (siteLogoFileNameDisplayLocal) siteLogoFileNameDisplayLocal.textContent = `${translations[currentLang]['msgCurrentSiteLogo']} ${getOriginalFileNameFromUnique(siteLogoFileNameFromFirestore)}`;
            } else {
                if (siteLogoFileNameDisplayLocal) siteLogoFileNameDisplayLocal.textContent = '';
            }

            // Update potentially dynamic content like "by Author"
            document.querySelectorAll('.publication-card p.text-gray-600').forEach(el => {
                const authorText = el.textContent; // Get current text
                const authorName = authorText.replace(`${translations[currentLang === 'en' ? 'it' : 'en']['byAuthor']} `, ''); // Extract just the name, handling previous language
                el.textContent = `${translations[currentLang]['byAuthor']} ${authorName}`;
            });
            // Update the no data messages if they are currently visible
            const homeViewLocal = document.getElementById('homeView');
            const noBooksMessageElement = document.getElementById('noBooksMessage');
            if (homeViewLocal && (!homeViewLocal.classList.contains('hidden'))) {
                if (noBooksMessageElement && !noBooksMessageElement.classList.contains('hidden')) {
                    noBooksMessageElement.textContent = translations[currentLang]['noPublicationsMessage'];
                }
            }
            const adminBooksList = document.getElementById('adminBooksList');
            const noAdminBooksMessage = document.getElementById('noAdminBooksMessage');
            if (adminBooksList && (!adminBooksList.classList.contains('hidden'))) {
                if (noAdminBooksMessage && !noAdminBooksMessage.classList.contains('hidden')) {
                    noAdminBooksMessage.textContent = translations[currentLang]['noPublicationsUploadedYet'];
                }
            }
        }

        // Event listeners for language buttons
        document.getElementById('langEnBtn').addEventListener('click', () => setLanguage('en'));
        document.getElementById('langItBtn').addEventListener('click', () => setLanguage('it'));

        // --- UI Feedback: Loading Spinner ---
        function showLoadingSpinner() {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) spinner.classList.remove('hidden');
        }

        function hideLoadingSpinner() {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) spinner.classList.add('hidden');
        }

        // --- Message Modal Functions ---
        // Unified modal for alerts and confirmations
        function showMessageModal(messageKey, type = "alert", callback = null) {
            const message = translations[currentLang][messageKey] || messageKey; // Get translated message
            const modalMessageElement = document.getElementById('modalMessage');
            const messageModal = document.getElementById('messageModal');
            const modalButtonsContainer = document.querySelector('#messageModal .modal-buttons');

            if (modalMessageElement) modalMessageElement.textContent = message;
            
            // Clear previous buttons
            if(modalButtonsContainer) modalButtonsContainer.innerHTML = '';

            if (type === "confirm") {
                const yesButton = document.createElement('button');
                yesButton.textContent = translations[currentLang]['confirmYesBtn'];
                yesButton.className = 'admin-button bg-red-600 hover:bg-red-700 mx-2'; // Added mx-2 for spacing
                yesButton.onclick = () => {
                    closeMessageModal();
                    if (callback) callback(true);
                };
                if(modalButtonsContainer) modalButtonsContainer.appendChild(yesButton);

                const noButton = document.createElement('button');
                noButton.textContent = translations[currentLang]['confirmNoBtn'];
                noButton.className = 'admin-button bg-gray-400 hover:bg-gray-500 mx-2'; // Added mx-2 for spacing
                noButton.onclick = () => {
                    closeMessageModal();
                    if (callback) callback(false);
                };
                if(modalButtonsContainer) modalButtonsContainer.appendChild(noButton);
            } else {
                const okButton = document.createElement('button');
                okButton.textContent = translations[currentLang]['modalOkBtn'];
                okButton.className = 'admin-button';
                okButton.onclick = () => {
                    closeMessageModal();
                    if (callback) callback();
                };
                if(modalButtonsContainer) modalButtonsContainer.appendChild(okButton);
            }

            if (messageModal) {
                messageModal.classList.remove('hidden');
                messageModal.classList.add('flex'); // Show modal by applying flex
            }
        }

        function closeMessageModal() {
            const messageModal = document.getElementById('messageModal');
            const modalMessageElement = document.getElementById('modalMessage');

            if (modalMessageElement) modalMessageElement.textContent = ''; // Clear message
            if (messageModal) {
                messageModal.classList.remove('flex'); // Hide modal by removing flex
                messageModal.classList.add('hidden');
            }
        }

        // Confirmation Modal Functions (for backward compatibility, though showMessageModal can handle it)
        function showConfirmModal(messageKey, callback) {
             // Redirect to the new showMessageModal for consistency
            showMessageModal(messageKey, "confirm", callback);
        }

        function closeConfirmModal() {
            // This now closes the main messageModal if it was used as a confirm
            closeMessageModal();
        }

        // --- Book Details Modal Functions ---
        function showBookDetailsModal(book) {
            const modalBookCover = document.getElementById('modalBookCover');
            const modalBookTitle = document.getElementById('modalBookTitle');
            const modalBookAuthor = document.getElementById('modalBookAuthor');
            const modalBookDescription = document.getElementById('modalBookDescription');
            const modalDownloadPdfBtn = document.getElementById('modalDownloadPdfBtn');
            const bookDetailsModal = document.getElementById('bookDetailsModal');

            // New metadata elements
            const modalBookPages = document.getElementById('modalBookPages');
            const modalBookFormat = document.getElementById('modalBookFormat');
            const modalBookDoi = document.getElementById('modalBookDoi');
            const modalBookIsbn = document.getElementById('modalBookIsbn');
            const modalBookIssn = document.getElementById('modalBookIssn');
            const modalBookNovelty = document.getElementById('modalBookNovelty');


            if (modalBookCover) modalBookCover.src = book.coverImageUrl || 'https://placehold.co/150x200/cccccc/333333?text=No+Cover';
            if (modalBookTitle) modalBookTitle.textContent = book.title;
            if (modalBookAuthor) modalBookAuthor.textContent = `${translations[currentLang]['byAuthor']} ${book.author}`;
            if (modalBookDescription) modalBookDescription.textContent = book.description || translations[currentLang]['msgNoDescriptionProvided'];
            
            // Populate new metadata fields
            if (modalBookPages) modalBookPages.textContent = book.pages ? `${translations[currentLang]['bookPagesLabel']} ${book.pages}` : '';
            if (modalBookFormat) modalBookFormat.textContent = book.format ? `${translations[currentLang]['bookFormatLabel']} ${book.format}` : '';
            
            if (modalBookDoi) {
                const doiLink = modalBookDoi.querySelector('a');
                if (book.doi) {
                    doiLink.href = `https://doi.org/${book.doi}`;
                    doiLink.textContent = book.doi;
                    modalBookDoi.classList.remove('hidden');
                } else {
                    modalBookDoi.classList.add('hidden');
                    doiLink.textContent = '';
                    doiLink.href = '#';
                }
            }
            if (modalBookIsbn) modalBookIsbn.textContent = book.isbn ? `${translations[currentLang]['isbnLabel']} ${book.isbn}` : '';
            if (modalBookIssn) modalBookIssn.textContent = book.issn ? `${translations[currentLang]['issnLabel']} ${book.issn}` : '';
            if (modalBookNovelty) {
                if (book.isNew) {
                    modalBookNovelty.classList.remove('hidden');
                } else {
                    modalBookNovelty.classList.add('hidden');
                }
            }

            if (modalDownloadPdfBtn) {
                if (book.pdfUrl) {
                    modalDownloadPdfBtn.href = book.pdfUrl;
                    modalDownloadPdfBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    modalDownloadPdfBtn.onclick = null; // Remove previous onclick
                } else {
                    modalDownloadPdfBtn.href = '#';
                    modalDownloadPdfBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    modalDownloadPdfBtn.onclick = (e) => {
                        e.preventDefault();
                        showMessageModal('msgPdfNotAvailable');
                    };
                }
            }

            if (bookDetailsModal) {
                bookDetailsModal.classList.remove('hidden');
                bookDetailsModal.classList.add('flex');
            }
            // Add event listener to close button inside the modal
            const closeBtn = bookDetailsModal.querySelector('.modal-close-button');
            if (closeBtn) {
                closeBtn.onclick = closeBookDetailsModal;
            }
        }

        function closeBookDetailsModal() {
            const bookDetailsModal = document.getElementById('bookDetailsModal');
            if (bookDetailsModal) {
                bookDetailsModal.classList.remove('flex');
                bookDetailsModal.classList.add('hidden');
            }
        }


        // --- Firebase Initialization and Authentication state management ---
        async function initializeFirebase() {
            showLoadingSpinner();
            try {
                // Initialize Firebase app if it hasn't been already
                app = getApps().length ? getApp() : initializeApp(finalFirebaseConfig);
                
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app); // Initialize Firebase Storage

                // Attempt to sign in with custom token first, if available (for Canvas admin auto-login)
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Attempted sign-in with custom token for Canvas admin.");
                    } catch (tokenError) {
                        console.error("Error signing in with custom token:", tokenError);
                        // Fallback to anonymous sign-in if custom token fails
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously due to custom token failure.");
                    }
                } else {
                    // If no custom token is provided (e.g., local development, or user logs out of admin), sign in anonymously
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously (no custom token provided).");
                }


                // Set up the auth state listener. This will fire immediately after the above sign-in,
                // and every time the authentication state changes (login, logout).
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isLoggedIn = true;
                        // If an initial custom token was provided AND the current user's UID matches the UID
                        // we expect from the custom token login (the very first user logged in via token),
                        // then this user is considered the "admin" for client-side checks.
                        // IMPORTANT: The actual security is enforced by Firebase Rules using this UID.
                        if (initialAuthToken && user.uid === userId) {
                            ADMIN_UID_FROM_CANVAS = user.uid;
                        } else {
                            ADMIN_UID_FROM_CANVAS = null; // Not the Canvas admin (e.g., anonymous, or regular email/pass user)
                        }
                    } else {
                        // User is logged out, or initial anonymous sign-in failed (should be rare)
                        userId = null;
                        isLoggedIn = false;
                        ADMIN_UID_FROM_CANVAS = null; // Clear admin UID when no user is logged in
                    }
                    isAuthReady = true; // Auth state has been checked

                    // Now that auth state is determined, set up event listeners and initial view.
                    setupEventListeners(); // Call setupEventListeners here
                    
                    // Display the current user ID in the footer
                    const currentUserIdElement = document.getElementById('currentUserId');
                    if (currentUserIdElement) {
                        currentUserIdElement.textContent = userId || translations[currentLang]['footerUserId'] + ' ' + translations[currentLang]['msgNotAvailable'];
                    }

                    // Load site settings (like logo) and update UI based on admin status
                    loadSiteSettings();
                    updateAdminUI(); // Update UI based on current admin status
                    hideLoadingSpinner(); // Hide spinner once initial auth and UI updates are done
                });

            } catch (error) {
                console.error("Error during Firebase initialization/initial sign-in:", error);
                showMessageModal("msgFirebaseInitFailed");
                hideLoadingSpinner();
            }
        }

        // New function to check if the current user is the designated admin
        function isCurrentUserAdmin() {
            return isLoggedIn && userId === ADMIN_UID_FROM_CANVAS;
        }

        // --- View Management ---
        // Variables for views and buttons - these will be assigned inside setupEventListeners
        // Declared as `null` initially to ensure they are assigned later.
        let homeView = null, aboutView = null, contactView = null, adminLoginView = null, adminDashboardView = null, managePublicationsSection = null, siteSettingsSection = null;
        let homeViewBtn = null, aboutViewBtn = null, contactViewBtn = null, adminLoginBtn = null, adminLogoutBtn = null, adminDashboardLogoutBtn = null, managePublicationsBtn = null, siteSettingsBtn = null;
        let publicSearchInput = null;
        let adminLoginForm = null, usernameInput = null, passwordInput = null, loginErrorMessage = null;
        let uploadBookForm = null, bookTitleInput = null, bookAuthorInput = null, bookDescriptionInput = null, bookPagesInput = null, bookFormatInput = null, bookDoiInput = null, bookIsbnInput = null, bookIssnInput = null, bookIsNewCheckbox = null, coverImageFileInput = null, coverImageFileNameDisplay = null, uploadedCoverPreview = null, pdfFileInput = null, pdfFileNameDisplay = null, submitBookBtn = null, cancelEditBtn = null, formTitle = null;
        let adminBooksList = null, noAdminBooksMessage = null, noBooksMessage = null, booksContainer = null;
        // Site Logo elements
        let uploadSiteLogoForm = null, siteLogoFile = null, siteLogoFileNameDisplay = null, uploadedSiteLogoPreview = null, saveSiteLogoBtn = null;
        let headerLogo = null, footerLogo = null;
        let currentSiteLogoFile = null; // Stores the actual File object for site logo upload
        let siteLogoUrlFromFirestore = ''; // Stores the URL of the site logo from Firestore
        let siteLogoFileNameFromFirestore = ''; // Stores the file name of the site logo from Firestore


        function showView(viewId) {
            // All these variables should be assigned in setupEventListeners, which runs once auth is ready.
            const allViews = [homeView, aboutView, contactView, adminLoginView, adminDashboardView];
            allViews.forEach(view => {
                if (view) {
                    view.classList.remove('flex');
                    view.classList.add('hidden');
                }
            });
            // Also hide admin subsections by default
            if (managePublicationsSection) managePublicationsSection.classList.add('hidden');
            if (siteSettingsSection) siteSettingsSection.classList.add('hidden');


            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.remove('hidden');
                targetView.classList.add('flex');
            } else {
                console.error(`Attempted to show unknown view: ${viewId}`);
                showMessageModal('msgViewNotFound');
                return; // Prevent further execution if view not found
            }

            // Default to manage publications if entering admin dashboard and user is admin
            if (viewId === 'adminDashboardView' && isCurrentUserAdmin()) {
                if (managePublicationsSection) managePublicationsSection.classList.remove('hidden');
            } else if (viewId === 'adminDashboardView' && !isCurrentUserAdmin()) {
                // If trying to access admin dashboard but not admin, redirect to login
                showView('adminLoginView');
                showMessageModal(translations[currentLang]['msgLoginRequiredToAddEdit']);
                return;
            }


            // Load data relevant to the view
            if (viewId === 'homeView') {
                if (isAuthReady) { // Ensure auth is ready before attempting to load books
                    loadBooks();
                } else {
                    // This state should be brief if initializeFirebase works as expected
                    if (booksContainer && noBooksMessage) {
                        booksContainer.innerHTML = '';
                        noBooksMessage.textContent = translations[currentLang]['msgFirebaseNotReady'];
                        noBooksMessage.classList.remove('hidden');
                    }
                }
            } else if (viewId === 'adminDashboardView' && isCurrentUserAdmin()) {
                loadBooksForAdmin(); // Load books for admin view specifically
            }
            setLanguage(currentLang); // Reapply translations after view change
            updateAdminUI(); // Re-evaluate UI visibility after view change
        }

        // Function to set up all event listeners and initial view after DOM is ready AND Firebase Auth is ready
        function setupEventListeners() {
            // Assign ALL DOM elements to variables here
            homeView = document.getElementById('homeView');
            aboutView = document.getElementById('aboutView');
            contactView = document.getElementById('contactView');
            adminLoginView = document.getElementById('adminLoginView');
            adminDashboardView = document.getElementById('adminDashboardView');
            managePublicationsSection = document.getElementById('managePublicationsSection');
            siteSettingsSection = document.getElementById('siteSettingsSection');

            homeViewBtn = document.getElementById('homeViewBtn');
            aboutViewBtn = document.getElementById('aboutViewBtn');
            contactViewBtn = document.getElementById('contactViewBtn');
            adminLoginBtn = document.getElementById('adminLoginBtn');
            adminLogoutBtn = document.getElementById('adminLogoutBtn'); // Header logout
            adminDashboardLogoutBtn = document.getElementById('adminDashboardLogoutBtn'); // Dashboard logout
            managePublicationsBtn = document.getElementById('managePublicationsBtn');
            siteSettingsBtn = document.getElementById('siteSettingsBtn');
            
            publicSearchInput = document.getElementById('publicSearchInput');

            adminLoginForm = document.getElementById('adminLoginForm');
            usernameInput = document.getElementById('username');
            passwordInput = document.getElementById('password');
            loginErrorMessage = document.getElementById('loginErrorMessage');

            uploadBookForm = document.getElementById('uploadBookForm');
            bookTitleInput = document.getElementById('bookTitle');
            bookAuthorInput = document.getElementById('bookAuthor');
            bookDescriptionInput = document.getElementById('bookDescription');
            bookPagesInput = document.getElementById('bookPages');
            bookFormatInput = document.getElementById('bookFormat');
            bookDoiInput = document.getElementById('bookDoi');
            bookIsbnInput = document.getElementById('bookIsbn');
            bookIssnInput = document.getElementById('bookIssn');
            bookIsNewCheckbox = document.getElementById('bookIsNew');
            coverImageFileInput = document.getElementById('coverImageFile');
            coverImageFileNameDisplay = document.getElementById('coverImageFileNameDisplay');
            uploadedCoverPreview = document.getElementById('uploadedCoverPreview');
            pdfFileInput = document.getElementById('pdfFile');
            pdfFileNameDisplay = document.getElementById('pdfFileNameDisplay');
            submitBookBtn = document.getElementById('submitBookBtn');
            cancelEditBtn = document.getElementById('cancelEditBtn');
            formTitle = document.getElementById('formTitle');
            adminBooksList = document.getElementById('adminBooksList');
            noAdminBooksMessage = document.getElementById('noAdminBooksMessage');
            booksContainer = document.getElementById('booksContainer');
            noBooksMessage = document.getElementById('noBooksMessage');

            // Site Logo elements
            uploadSiteLogoForm = document.getElementById('uploadSiteLogoForm');
            siteLogoFile = document.getElementById('siteLogoFile');
            siteLogoFileNameDisplay = document.getElementById('siteLogoFileNameDisplay');
            uploadedSiteLogoPreview = document.getElementById('uploadedSiteLogoPreview');
            saveSiteLogoBtn = document.getElementById('saveSiteLogoBtn');
            headerLogo = document.getElementById('headerLogo');
            footerLogo = document.getElementById('footerLogo');


            // Set initial language and display home view
            setLanguage(currentLang); // Apply initial translations
            showView('homeView'); // Show the first view, which will trigger loadBooks

            // Attach Event Listeners for Navigation
            if (homeViewBtn) homeViewBtn.addEventListener('click', () => showView('homeView'));
            if (aboutViewBtn) aboutViewBtn.addEventListener('click', () => showView('aboutView'));
            if (contactViewBtn) contactViewBtn.addEventListener('click', () => showView('contactView'));
            if (adminLoginBtn) adminLoginBtn.addEventListener('click', () => showView('adminLoginView'));
            
            // Admin Dashboard Sub-navigation
            if (managePublicationsBtn) {
                managePublicationsBtn.addEventListener('click', () => {
                    if (managePublicationsSection) managePublicationsSection.classList.remove('hidden');
                    if (siteSettingsSection) siteSettingsSection.classList.add('hidden');
                    loadBooksForAdmin(); // Ensure publications are loaded/reloaded
                });
            }
            if (siteSettingsBtn) {
                siteSettingsBtn.addEventListener('click', () => {
                    if (siteSettingsSection) siteSettingsSection.classList.remove('hidden');
                    if (managePublicationsSection) managePublicationsSection.classList.add('hidden');
                    loadSiteSettings(); // Ensure site settings are loaded/reloaded
                });
            }


            // Unified Logout Logic for both header and dashboard logout buttons
            const handleLogout = async () => {
                try {
                    await signOut(auth);
                    // onAuthStateChanged will handle isLoggedIn, userId, ADMIN_UID_FROM_CANVAS updates
                    showView('homeView');
                    showMessageModal("msgLoggedOut");
                } catch (error) {
                    console.error("Error signing out:", error);
                    showMessageModal("msgErrorLoggingOut");
                }
            };

            if (adminLogoutBtn) adminLogoutBtn.addEventListener('click', handleLogout);
            if (adminDashboardLogoutBtn) adminDashboardLogoutBtn.addEventListener('click', handleLogout);

            // Admin Login Form Listener
            if (adminLoginForm) {
                adminLoginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    showLoadingSpinner();
                    const email = usernameInput.value;
                    const password = passwordInput.value;

                    try {
                        const userCredential = await signInWithEmailAndPassword(auth, email, password);
                        // The onAuthStateChanged listener will now trigger and update global state
                        // and call updateAdminUI()
                        if (loginErrorMessage) loginErrorMessage.textContent = '';
                        if (usernameInput) usernameInput.value = '';
                        if (passwordInput) passwordInput.value = '';
                        showView('adminDashboardView'); // Redirect to dashboard
                    } catch (error) {
                        console.error("Firebase Login Error:", error.code, error.message);
                        if (loginErrorMessage) {
                            if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                                loginErrorMessage.textContent = translations[currentLang]['msgLoginInvalid'];
                            } else if (error.code === 'auth/too-many-requests') {
                                loginErrorMessage.textContent = translations[currentLang]['msgLoginTooManyAttempts'];
                            } else {
                                loginErrorMessage.textContent = translations[currentLang]['msgLoginFailedGeneric'] + error.message;
                            }
                        }
                    } finally {
                        hideLoadingSpinner();
                    }
                });
            }

            // File input change listeners for Publications
            if (coverImageFileInput) {
                coverImageFileInput.addEventListener('change', async (e) => {
                    if (!isCurrentUserAdmin()) { // Check for admin permissions
                        showMessageModal("msgLoginRequiredForUpload");
                        e.target.value = ''; // Clear selection
                        return;
                    }
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        const uniqueFileName = `${Date.now()}_${file.name}`;
                        currentCoverImageFile = file;
                        currentCoverImageFileName = uniqueFileName;

                        if(uploadedCoverPreview) {
                            uploadedCoverPreview.src = '';
                            uploadedCoverPreview.style.display = 'none';
                        }
                        if(coverImageFileNameDisplay) coverImageFileNameDisplay.textContent = `${translations[currentLang]['msgUploading']} ${file.name}...`;

                        showLoadingSpinner();
                        const imageStorageRef = ref(storage, `${COVERS_STORAGE_PATH}/${uniqueFileName}`);
                        try {
                            const snapshot = await uploadBytes(imageStorageRef, file);
                            currentCoverImageURL = await getDownloadURL(snapshot.ref);
                            if(uploadedCoverPreview) {
                                uploadedCoverPreview.src = currentCoverImageURL;
                                uploadedCoverPreview.style.display = 'block';
                            }
                            if(coverImageFileNameDisplay) coverImageFileNameDisplay.textContent = `${translations[currentLang]['msgUploaded']}: ${getOriginalFileNameFromUnique(file.name)}`;
                            showMessageModal("msgCoverUploaded");
                        } catch (error) {
                            console.error("Error uploading cover image to Firebase Storage:", error);
                            showMessageModal(`${translations[currentLang]['msgFailedUploadCover']}: ${error.message}. ${translations[currentLang]['msgCheckStorageRulesOrNetwork']}`);
                            currentCoverImageFile = null;
                            currentCoverImageFileName = '';
                            if(coverImageFileNameDisplay) coverImageFileNameDisplay.textContent = translations[currentLang]['msgUploadFailed'];
                            if(uploadedCoverPreview) {
                                uploadedCoverPreview.style.display = 'none';
                                uploadedCoverPreview.src = '';
                            }
                        } finally {
                            hideLoadingSpinner();
                        }
                    } else {
                        currentCoverImageFile = null;
                        currentCoverImageFileName = '';
                        if(coverImageFileNameDisplay) coverImageFileNameDisplay.textContent = '';
                        currentCoverImageURL = '';
                        if(uploadedCoverPreview) {
                            uploadedCoverPreview.src = '';
                            uploadedCoverPreview.style.display = 'none';
                        }
                    }
                });
            }

            if (pdfFileInput) {
                pdfFileInput.addEventListener('change', async (e) => {
                    if (!isCurrentUserAdmin()) { // Check for admin permissions
                        showMessageModal("msgLoginRequiredForUpload");
                        e.target.value = '';
                        return;
                    }
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        const uniqueFileName = `${Date.now()}_${file.name}`;
                        currentPdfFile = file;
                        currentPdfFileName = uniqueFileName;

                        if(pdfFileNameDisplay) pdfFileNameDisplay.textContent = `${translations[currentLang]['msgUploading']} ${file.name}...`;

                        showLoadingSpinner();
                        const pdfStorageRef = ref(storage, `${PDFS_STORAGE_PATH}/${uniqueFileName}`);
                        try {
                            const snapshot = await uploadBytes(pdfStorageRef, file);
                            currentPdfURL = await getDownloadURL(snapshot.ref);
                            if(pdfFileNameDisplay) pdfFileNameDisplay.textContent = `${translations[currentLang]['msgUploaded']}: ${getOriginalFileNameFromUnique(file.name)}`;
                            showMessageModal("msgPdfUploaded");
                        } catch (error) {
                            console.error("Error uploading PDF to Firebase Storage:", error);
                            showMessageModal(`${translations[currentLang]['msgFailedUploadPdf']}: ${error.message}. ${translations[currentLang]['msgCheckStorageRulesOrNetwork']}`);
                            currentPdfFile = null;
                            currentPdfFileName = '';
                            if(pdfFileNameDisplay) pdfFileNameDisplay.textContent = translations[currentLang]['msgUploadFailed'];
                            currentPdfURL = '';
                        } finally {
                            hideLoadingSpinner();
                        }
                    } else {
                        currentPdfFile = null;
                        currentPdfFileName = '';
                        if(pdfFileNameDisplay) pdfFileNameDisplay.textContent = '';
                        currentPdfURL = '';
                    }
                });
            }

            // Upload/Edit Form Listener for Publications
            if (uploadBookForm) {
                uploadBookForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!isCurrentUserAdmin()) { // Check for admin permissions
                        showMessageModal("msgLoginRequiredToAddEdit");
                        return;
                    }
                    if (!isAuthReady) {
                        showMessageModal("msgFirebaseNotReady");
                        return;
                    }

                    const title = bookTitleInput.value.trim();
                    const author = bookAuthorInput.value.trim();
                    const description = bookDescriptionInput.value.trim();
                    const pages = bookPagesInput.value.trim();
                    const format = bookFormatInput.value.trim();
                    const doi = bookDoiInput.value.trim();
                    const isbn = bookIsbnInput.value.trim();
                    const issn = bookIssnInput.value.trim();
                    const isNew = bookIsNewCheckbox.checked;

                    let pdfUrlToSave = currentPdfURL;
                    let coverImageUrlToSave = currentCoverImageURL;
                    let pdfFileNameToSave = currentPdfFileName;
                    let coverImageFileNameToSave = currentCoverImageFileName;

                    if (!title || !author) {
                        showMessageModal("msgFillTitleAuthor");
                        return;
                    }

                    showLoadingSpinner(); // Show spinner for the main save operation

                    try {
                        if (editingBookId) {
                            const bookSnap = await getDoc(doc(db, BOOKS_COLLECTION_PATH, editingBookId));
                            const existingBook = bookSnap.exists() ? bookSnap.data() : null;

                            // If no new PDF was selected, use existing URL and unique filename from Firestore
                            if (!currentPdfFile) {
                                pdfUrlToSave = existingBook?.pdfUrl || '';
                                pdfFileNameToSave = existingBook?.pdfFileName || '';
                            }
                            // If no new cover was selected, use existing URL and unique filename from Firestore
                            if (!currentCoverImageFile) {
                                coverImageUrlToSave = existingBook?.coverImageUrl || '';
                                coverImageFileNameToSave = existingBook?.coverImageFileName || '';
                            }
                        } else { // For new books, ensure files are selected AND uploaded
                            if (!currentPdfFile || !currentPdfURL) {
                                showMessageModal("msgSelectPdfWaitUpload");
                                return;
                            }
                            if (!currentCoverImageFile || !currentCoverImageURL) {
                                showMessageModal("msgSelectCoverWaitUpload");
                                return;
                            }
                        }

                        // Final check that URLs are available after all logic
                        if (!pdfUrlToSave) {
                            showMessageModal("msgPdfMissing");
                            return;
                        }
                        if (!coverImageUrlToSave) {
                            showMessageModal("msgCoverMissing");
                            return;
                        }

                        if (submitBookBtn) {
                            submitBookBtn.textContent = editingBookId ? translations[currentLang]['msgUpdating'] : translations[currentLang]['msgAdding'];
                            submitBookBtn.disabled = true;
                        }
                        
                        const bookData = {
                            title: title,
                            author: author,
                            description: description,
                            pages: pages,
                            format: format,
                            doi: doi,
                            isbn: isbn,
                            issn: issn,
                            isNew: isNew,
                            coverImageUrl: coverImageUrlToSave,
                            coverImageFileName: coverImageFileNameToSave,
                            pdfUrl: pdfUrlToSave,
                            pdfFileName: pdfFileNameToSave,
                            timestamp: new Date().toISOString()
                        };

                        if (editingBookId) {
                            await updateDoc(doc(db, BOOKS_COLLECTION_PATH, editingBookId), bookData);
                            showMessageModal("msgPublicationUpdated");
                        } else {
                            await addDoc(collection(db, BOOKS_COLLECTION_PATH), bookData);
                            showMessageModal("msgPublicationAdded");
                        }

                        resetBookForm();
                    } catch (error) {
                        console.error("Error saving document: ", error);
                        showMessageModal(`${translations[currentLang]['msgErrorSavingPublication']}: ${error.message}. ${translations[currentLang]['msgCheckFirestoreRules']}`);
                    } finally {
                        if (submitBookBtn) {
                            submitBookBtn.textContent = editingBookId ? translations[currentLang]['updatePublicationButton'] : translations[currentLang]['addPublicationButton'];
                            submitBookBtn.disabled = false;
                            setLanguage(currentLang);
                        }
                        hideLoadingSpinner(); // Hide spinner after main save operation
                    }
                });
            }

            // Cancel Edit Listener for Publications
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', () => {
                    resetBookForm();
                    showMessageModal("msgEditCancelled");
                });
            }

            // Public Search Input Listener
            if (publicSearchInput) {
                publicSearchInput.addEventListener('input', (e) => {
                    loadBooks(e.target.value);
                });
            }

            // --- Site Logo Upload Form Listener ---
            if (siteLogoFile) {
                siteLogoFile.addEventListener('change', async (e) => {
                    if (!isCurrentUserAdmin()) { // Check for admin permissions
                        showMessageModal("msgLoginRequiredForUpload");
                        e.target.value = '';
                        return;
                    }
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        currentSiteLogoFile = file; // Store the actual File object
                        
                        // Display a loading message
                        if (uploadedSiteLogoPreview) {
                            uploadedSiteLogoPreview.src = '';
                            uploadedSiteLogoPreview.style.display = 'none';
                        }
                        if (siteLogoFileNameDisplay) siteLogoFileNameDisplay.textContent = `${translations[currentLang]['msgUploading']} ${file.name}...`;

                        // Optional: Show a preview immediately after selection (before Firebase upload)
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            if (uploadedSiteLogoPreview) {
                                uploadedSiteLogoPreview.src = e.target.result;
                                uploadedSiteLogoPreview.style.display = 'block';
                            }
                        };
                        reader.readAsDataURL(file);

                    } else {
                        currentSiteLogoFile = null;
                        if (siteLogoFileNameDisplay) siteLogoFileNameDisplay.textContent = '';
                        if (uploadedSiteLogoPreview) {
                            uploadedSiteLogoPreview.src = '';
                            uploadedSiteLogoPreview.style.display = 'none';
                        }
                    }
                });
            }

            if (uploadSiteLogoForm) {
                uploadSiteLogoForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!isCurrentUserAdmin()) { // Check for admin permissions
                        showMessageModal("msgLoginRequiredToAddEdit");
                        return;
                    }
                    if (!isAuthReady) {
                        showMessageModal("msgFirebaseNotReady");
                        return;
                    }
                    if (!currentSiteLogoFile) {
                        showMessageModal("msgNoSiteLogoSelected");
                        return;
                    }

                    showLoadingSpinner();
                    try {
                        const file = currentSiteLogoFile;
                        const uniqueFileName = `site_logo_${Date.now()}_${file.name}`; // Consistent naming

                        const logoStorageRef = ref(storage, `${SITE_ASSETS_STORAGE_PATH}/${uniqueFileName}`);
                        const snapshot = await uploadBytes(logoStorageRef, file);
                        const logoUrl = await getDownloadURL(snapshot.ref);

                        // Save the logo URL and filename to Firestore
                        const siteSettingsDocRef = doc(db, SITE_SETTINGS_DOC_PATH);
                        await setDoc(siteSettingsDocRef, {
                            siteLogoUrl: logoUrl,
                            siteLogoFileName: uniqueFileName, // Save unique filename for deletion if needed
                            lastUpdated: new Date().toISOString()
                        }, { merge: true }); // Use merge to avoid overwriting other settings if they exist

                        showMessageModal("msgSiteLogoUploaded");
                        // Update UI immediately
                        if(headerLogo) headerLogo.src = logoUrl;
                        if(footerLogo) footerLogo.src = logoUrl;
                        currentSiteLogoFile = null; // Clear file input state
                        siteLogoFile.value = ''; // Clear actual file input
                        if(siteLogoFileNameDisplay) siteLogoFileNameDisplay.textContent = ''; // Clear display text
                        if(uploadedSiteLogoPreview) {
                            uploadedSiteLogoPreview.src = '';
                            uploadedSiteLogoPreview.style.display = 'none';
                        }
                        siteLogoUrlFromFirestore = logoUrl; // Update global state
                        siteLogoFileNameFromFirestore = uniqueFileName;

                    } catch (error) {
                        console.error("Error uploading or saving site logo:", error);
                        showMessageModal(`${translations[currentLang]['msgFailedUploadSiteLogo']}: ${error.message}. ${translations[currentLang]['msgCheckStorageRulesOrNetwork']}`);
                    } finally {
                        hideLoadingSpinner();
                    }
                });
            }


            // Modals backdrop click
            const messageModal = document.getElementById('messageModal');
            if (messageModal) {
                messageModal.addEventListener('click', function(event) {
                    if (event.target === messageModal) {
                        closeMessageModal();
                    }
                });
            }
            
            const confirmModal = document.getElementById('confirmModal');
            if (confirmModal) {
                confirmModal.addEventListener('click', function(event) {
                    if (event.target === confirmModal) {
                        closeConfirmModal();
                    }
                });
            }

            const bookDetailsModal = document.getElementById('bookDetailsModal');
            if (bookDetailsModal) {
                bookDetailsModal.addEventListener('click', function(event) {
                    if (event.target === bookDetailsModal) {
                        closeBookDetailsModal();
                    }
                });
            }
        } // End of setupEventListeners

        // --- Update Admin UI Visibility ---
        // This function dynamically shows/hides UI elements based on current admin status
        function updateAdminUI() {
            // Header buttons
            if (adminLoginBtn) {
                if (isCurrentUserAdmin()) {
                    adminLoginBtn.classList.add('hidden');
                } else {
                    adminLoginBtn.classList.remove('hidden');
                }
            }
            if (adminLogoutBtn) {
                if (isLoggedIn) { // Show logout if any user is logged in
                    adminLogoutBtn.classList.remove('hidden');
                } else {
                    adminLogoutBtn.classList.add('hidden');
                }
            }
            // Dashboard-specific logout button
            if (adminDashboardLogoutBtn) {
                if (isLoggedIn) {
                    adminDashboardLogoutBtn.classList.remove('hidden');
                } else {
                    adminDashboardLogoutBtn.classList.add('hidden');
                }
            }


            // Admin Dashboard and its contents
            if (adminDashboardView) {
                if (isCurrentUserAdmin()) {
                    // showView will handle displaying adminDashboardView when called.
                    // Here, we ensure its internal elements are enabled/disabled correctly.
                    if (uploadBookForm) {
                        uploadBookForm.querySelectorAll('input, textarea, button[type="submit"], input[type="file"]').forEach(el => el.disabled = false);
                    }
                    if (uploadSiteLogoForm) {
                        uploadSiteLogoForm.querySelectorAll('input, textarea, button[type="submit"], input[type="file"]').forEach(el => el.disabled = false);
                    }
                    if (managePublicationsBtn) managePublicationsBtn.disabled = false;
                    if (siteSettingsBtn) siteSettingsBtn.disabled = false;
                } else {
                    // If not admin, disable all admin controls within the dashboard view
                    // (The view itself will be hidden by showView unless actively logged in as admin)
                    if (uploadBookForm) {
                        uploadBookForm.querySelectorAll('input, textarea, button[type="submit"], input[type="file"]').forEach(el => el.disabled = true);
                    }
                    if (uploadSiteLogoForm) {
                        uploadSiteLogoForm.querySelectorAll('input, textarea, button[type="submit"], input[type="file"]').forEach(el => el.disabled = true);
                    }
                    if (managePublicationsBtn) managePublicationsBtn.disabled = true;
                    if (siteSettingsBtn) siteSettingsBtn.disabled = true;
                }
            }
        }


        // --- Book Management (Firestore) ---
        // Function to load and display books in the public view
        async function loadBooks(searchTerm = '') {
            // Ensure authentication is ready. Anonymous users will be able to read if rules permit.
            if (!isAuthReady || !userId) {
                if (noBooksMessage) {
                    noBooksMessage.innerHTML = translations[currentLang]['msgPublicContentAuthRequired'];
                    noBooksMessage.classList.remove('hidden');
                }
                if (booksContainer) {
                    booksContainer.innerHTML = '';
                }
                return;
            }

            if (!booksContainer) { console.error("booksContainer not found in loadBooks."); return; }
            if (!noBooksMessage) { console.error("noBooksMessage not found in loadBooks."); return; }

            noBooksMessage.classList.add('hidden');
            booksContainer.innerHTML = '';
            showLoadingSpinner(); // Show spinner for loading books

            try {
                // Set up a real-time listener for the public books collection
                const q = query(collection(db, BOOKS_COLLECTION_PATH));
                onSnapshot(q, (querySnapshot) => {
                    let books = [];
                    querySnapshot.forEach((doc) => {
                        books.push({ id: doc.id, ...doc.data() });
                    });

                    // Sort books by timestamp in descending order (newest first)
                    books.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());


                    const lowerCaseSearchTerm = searchTerm.toLowerCase();
                    const filteredBooks = books.filter(book =>
                        book.title.toLowerCase().includes(lowerCaseSearchTerm) ||
                        book.author.toLowerCase().includes(lowerCaseSearchTerm) ||
                        (book.description && book.description.toLowerCase().includes(lowerCaseSearchTerm)) ||
                        (book.pages && book.pages.toLowerCase().includes(lowerCaseSearchTerm)) ||
                        (book.format && book.format.toLowerCase().includes(lowerCaseSearchTerm)) ||
                        (book.doi && book.doi.toLowerCase().includes(lowerCaseSearchTerm)) ||
                        (book.isbn && book.isbn.toLowerCase().includes(lowerCaseSearchTerm)) ||
                        (book.issn && book.issn.toLowerCase().includes(lowerCaseSearchTerm))
                    );

                    booksContainer.innerHTML = '';
                    if (filteredBooks.length === 0) {
                        noBooksMessage.textContent = translations[currentLang]['msgNoBooksFoundSearch'];
                        noBooksMessage.classList.remove('hidden');
                        hideLoadingSpinner(); // Hide spinner if no books found
                        return;
                    }

                    noBooksMessage.classList.add('hidden');

                    filteredBooks.forEach((book) => {
                        // Truncate description for card view
                        const truncatedDescription = book.description && book.description.length > 150 
                            ? book.description.substring(0, 147) + '...' 
                            : (book.description || translations[currentLang]['msgNoDescriptionProvided']);

                        const bookCard = `
                            <div class="bg-yellow-100 p-4 rounded-lg shadow-md flex flex-col items-center text-center transition duration-300 hover:shadow-lg book-card" data-book-id="${book.id}">
                                <img src="${book.coverImageUrl || 'https://placehold.co/150x200/cccccc/333333?text=No+Cover'}" alt="${book.title}" class="w-36 h-48 object-cover rounded-md mb-4 shadow-sm">
                                <h3 class="text-xl font-semibold mb-2 text-gray-800">${book.title}</h3>
                                <p class="text-gray-600 text-sm mb-3">${translations[currentLang]['byAuthor']} ${book.author}</p>
                                <p class="text-gray-700 text-sm h-20 overflow-hidden">${truncatedDescription}</p>
                                <button class="mt-auto bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300" onclick="showBookDetailsModalWithId('${book.id}')" data-lang-key="viewDetailsButton">View Details</button>
                            </div>
                        `;
                        booksContainer.innerHTML += bookCard;
                    });
                    hideLoadingSpinner(); // Hide spinner after books are loaded
                });
            } catch (error) {
                console.error("Error setting up Firestore listener for books:", error);
                showMessageModal("msgErrorLoadingPublications");
                if (noBooksMessage) {
                    noBooksMessage.textContent = translations[currentLang]['msgErrorLoadingPublications'];
                }
                hideLoadingSpinner(); // Hide spinner on error
            }
        }

        // Function to load and display books in the admin dashboard
        async function loadBooksForAdmin() {
            if (!isAuthReady || !isCurrentUserAdmin()) { // Check for admin permissions
                console.warn("Not authorized to load admin books. Please log in as admin.");
                if (adminBooksList) adminBooksList.innerHTML = '';
                if (noAdminBooksMessage) {
                    noAdminBooksMessage.classList.remove('hidden');
                    noAdminBooksMessage.textContent = translations[currentLang]['msgLoginRequiredToAddEdit'];
                }
                return;
            }
            if (!adminBooksList) { console.error("adminBooksList not found in loadBooksForAdmin."); return; }
            if (!noAdminBooksMessage) { console.error("noAdminBooksMessage not found in loadBooksForAdmin."); return; }

            adminBooksList.innerHTML = '';
            noAdminBooksMessage.classList.add('hidden');
            showLoadingSpinner(); // Show spinner for loading admin books

            try {
                // Set up a real-time listener for the public books collection
                const q = query(collection(db, BOOKS_COLLECTION_PATH));
                onSnapshot(q, (querySnapshot) => {
                    let books = [];
                    querySnapshot.forEach((docRef) => {
                        books.push({ id: docRef.id, ...docRef.data() });
                    });

                    // Sort books by timestamp in descending order (newest first)
                    books.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());


                    adminBooksList.innerHTML = '';
                    if (books.length === 0) {
                        if (noAdminBooksMessage) {
                            noAdminBooksMessage.classList.remove('hidden');
                            noAdminBooksMessage.textContent = translations[currentLang]['noPublicationsUploadedYet'];
                        }
                        hideLoadingSpinner(); // Hide spinner if no books found
                        return;
                    }

                    noAdminBooksMessage.classList.add('hidden');

                    books.forEach((book) => {
                        const bookId = book.id;
                        // Display original filename for better readability in Admin UI
                        const pdfDisplayFileName = getOriginalFileNameFromUnique(book.pdfFileName) || translations[currentLang]['msgNotAvailable'];
                        const coverDisplayFileName = getOriginalFileNameFromUnique(book.coverImageFileName) || translations[currentLang]['msgNotAvailable'];

                        const bookItem = `
                            <div class="bg-yellow-100 p-4 rounded-lg shadow-sm flex items-center justify-between">
                                <div class="flex items-center">
                                    <img src="${book.coverImageUrl || 'https://placehold.co/50x60/cccccc/333333?text=Cover'}" alt="${book.title}" class="w-12 h-16 object-cover rounded-md mr-4 shadow-sm">
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-800">${book.title}</h4>
                                        <p class="text-gray-600 text-sm">by ${book.author}</p>
                                        <p class="text-gray-500 text-xs">${translations[currentLang]['uploadPdfFileLabel']}: ${pdfDisplayFileName}</p>
                                        <p class="text-gray-500 text-xs">${translations[currentLang]['uploadCoverImageLabel']}: ${coverDisplayFileName}</p>
                                        <p class="text-gray-500 text-xs">${translations[currentLang]['bookPagesLabel']}: ${book.pages || translations[currentLang]['msgNotAvailable']}</p>
                                        <p class="text-gray-500 text-xs">${translations[currentLang]['bookFormatLabel']}: ${book.format || translations[currentLang]['msgNotAvailable']}</p>
                                        <p class="text-gray-500 text-xs">${translations[currentLang]['bookDoiLabel']}: ${book.doi || translations[currentLang]['msgNotAvailable']}</p>
                                        <p class="text-gray-500 text-xs">${translations[currentLang]['bookIsbnLabel']}: ${book.isbn || translations[currentLang]['msgNotAvailable']}</p>
                                        <p class="text-gray-500 text-xs">${translations[currentLang]['bookIssnLabel']}: ${book.issn || translations[currentLang]['msgNotAvailable']}</p>
                                        <p class="text-xs ${book.isNew ? 'text-green-600 font-semibold' : 'text-gray-400'}" >${book.isNew ? translations[currentLang]['isNoveltyLabel'] : ''}</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button data-id="${bookId}" class="edit-book-btn admin-button bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-3 rounded-lg text-sm" data-lang-key="editButton">Edit</button>
                                    <button data-id="${bookId}" class="delete-book-btn admin-button bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded-lg text-sm" data-lang-key="deleteButton">Delete</button>
                                </div>
                            </div>
                        `;
                        if (adminBooksList) adminBooksList.innerHTML += bookItem;
                    });

                    document.querySelectorAll('.edit-book-btn').forEach(button => {
                        button.addEventListener('click', (e) => editBook(e.target.dataset.id));
                    });
                    document.querySelectorAll('.delete-book-btn').forEach(button => {
                        button.addEventListener('click', (e) => deleteBook(e.target.dataset.id));
                    });
                    setLanguage(currentLang); // Re-apply translations for dynamically added buttons
                    hideLoadingSpinner(); // Hide spinner after books are loaded
                });
            } catch (error) {
                console.error("Error setting up Firestore listener for admin books:", error);
                showMessageModal("msgErrorLoadingAdminPublications");
                if (noAdminBooksMessage) {
                    noAdminBooksMessage.textContent = translations[currentLang]['msgErrorLoadingAdminPublications'];
                }
                hideLoadingSpinner(); // Hide spinner on error
            }
        }


        // --- Add/Edit Book Logic ---
        let editingBookId = null; // Stores the ID of the book being edited
        let currentCoverImageFile = null; // Stores the actual File object for upload
        let currentPdfFile = null; // Stores the actual File object for upload
        let currentCoverImageURL = ''; // Stores the Firebase Storage URL of the selected/existing cover image
        let currentCoverImageFileName = ''; // Stores the name of the selected/existing image file (includes timestamp)
        let currentPdfFileName = ''; // Stores the name of the selected/existing PDF file (includes timestamp)
        let currentPdfURL = ''; // Stores the Firebase Storage URL of the selected/existing PDF file


        // Helper to extract original file name from unique timestamped name (for display)
        function getOriginalFileNameFromUnique(uniqueFileName) {
            if (!uniqueFileName) return '';
            const parts = uniqueFileName.split('_');
            if (parts.length > 1 && !isNaN(Number(parts[0]))) { // Check if first part is a number (timestamp)
                parts.shift(); // Remove the timestamp
                return parts.join('_'); // Rejoin the rest
            }
            return uniqueFileName; // Return as is if no timestamp prefix
        }


        // --- Form Reset ---
        function resetBookForm() {
            if (uploadBookForm) uploadBookForm.reset();
            if (bookTitleInput) bookTitleInput.value = '';
            if (bookAuthorInput) bookAuthorInput.value = '';
            if (bookDescriptionInput) bookDescriptionInput.value = '';
            if (bookPagesInput) bookPagesInput.value = '';
            if (bookFormatInput) bookFormatInput.value = '';
            if (bookDoiInput) bookDoiInput.value = '';
            if (bookIsbnInput) bookIsbnInput.value = '';
            if (bookIssnInput) bookIssnInput.value = '';
            if (bookIsNewCheckbox) bookIsNewCheckbox.checked = false;
            if (coverImageFileInput) coverImageFileInput.value = '';
            if (pdfFileInput) pdfFileInput.value = '';
            if (coverImageFileNameDisplay) coverImageFileNameDisplay.textContent = '';
            if (pdfFileNameDisplay) pdfFileNameDisplay.textContent = '';
            if (uploadedCoverPreview) {
                uploadedCoverPreview.src = '';
                uploadedCoverPreview.style.display = 'none';
            }
            if (formTitle) formTitle.textContent = translations[currentLang]['uploadNewPublicationTitle'];
            if (submitBookBtn) submitBookBtn.textContent = translations[currentLang]['addPublicationButton'];
            if (cancelEditBtn) cancelEditBtn.classList.add('hidden');
            editingBookId = null;
            currentCoverImageFile = null;
            currentPdfFile = null;
            currentCoverImageURL = '';
            currentCoverImageFileName = ''; // Reset unique filename
            currentPdfFileName = ''; // Reset unique filename
            currentPdfURL = '';
            setLanguage(currentLang); // Re-apply translations for button text after reset
        }

        // Function to show book details in a modal given book ID
        window.showBookDetailsModalWithId = async function(bookId) {
            if (!isAuthReady) {
                showMessageModal("msgFirebaseNotReady");
                return;
            }
            showLoadingSpinner(); // Show spinner for fetching details
            try {
                const bookRef = doc(db, BOOKS_COLLECTION_PATH, bookId);
                const bookSnap = await getDoc(bookRef);

                if (bookSnap.exists()) {
                    showBookDetailsModal(bookSnap.data());
                } else {
                    showMessageModal("msgBookNotFound");
                }
            } catch (error) {
                console.error("Error fetching book for details:", error);
                showMessageModal("msgErrorLoadingBook");
            } finally {
                hideLoadingSpinner(); // Hide spinner after details are fetched or on error
            }
        };

        // --- Edit Book Logic ---
        async function editBook(bookId) {
            if (!isCurrentUserAdmin()) { // Check for admin permissions
                showMessageModal("msgLoginRequiredToEdit");
                return;
            }

            showLoadingSpinner(); // Show spinner for fetching book data for edit
            try {
                const bookRef = doc(db, BOOKS_COLLECTION_PATH, bookId);
                const bookSnap = await getDoc(bookRef);

                if (bookSnap.exists()) {
                    const bookData = bookSnap.data();
                    editingBookId = bookId;

                    // Populate the form with existing data
                    bookTitleInput.value = bookData.title;
                    bookAuthorInput.value = bookData.author;
                    bookDescriptionInput.value = bookData.description;
                    bookPagesInput.value = bookData.pages || '';
                    bookFormatInput.value = bookData.format || '';
                    bookDoiInput.value = bookData.doi || '';
                    bookIsbnInput.value = bookData.isbn || '';
                    bookIssnInput.value = bookData.issn || '';
                    bookIsNewCheckbox.checked = bookData.isNew || false;

                    // Set cover image preview and currentCoverImageURL
                    uploadedCoverPreview.src = bookData.coverImageUrl || '';
                    uploadedCoverPreview.style.display = bookData.coverImageUrl ? 'block' : 'none';
                    coverImageFileInput.value = ''; // Important: Clear native file input value
                    currentCoverImageURL = bookData.coverImageUrl || ''; // Store the existing URL
                    currentCoverImageFileName = bookData.coverImageFileName || ''; // Store the unique filename from Firestore
                    coverImageFileNameDisplay.textContent = currentCoverImageFileName ? `${translations[currentLang]['msgCurrentCover']}: ${getOriginalFileNameFromUnique(currentCoverImageFileName)}` : translations[currentLang]['msgNoCoverSelected'];

                    // Set PDF display and currentPdfURL
                    pdfFileInput.value = ''; // Important: Clear native file input value
                    currentPdfURL = bookData.pdfUrl || ''; // Store the existing URL
                    currentPdfFileName = bookData.pdfFileName || ''; // Store the unique filename from Firestore
                    pdfFileNameDisplay.textContent = currentPdfFileName ? `${translations[currentLang]['msgCurrentPdf']}: ${getOriginalFileNameFromUnique(currentPdfFileName)}` : translations[currentLang]['msgNoPdfSelected'];


                    // Change form title and button text
                    formTitle.textContent = translations[currentLang]['editPublicationTitle'];
                    submitBookBtn.textContent = translations[currentLang]['updatePublicationButton'];
                    cancelEditBtn.classList.remove('hidden'); // Show cancel button

                    // Scroll to the form
                    window.scrollTo({ top: uploadBookForm.offsetTop, behavior: 'smooth' });
                } else {
                    showMessageModal("msgBookNotFound");
                }
            } catch (error) {
                console.error("Error fetching book for edit:", error);
                showMessageModal("msgErrorLoadingBook");
            } finally {
                hideLoadingSpinner(); // Hide spinner after edit data is loaded or on error
            }
        }


        // --- Delete Book Logic ---
        async function deleteBook(bookId) {
            if (!isCurrentUserAdmin()) { // Check for admin permissions
                showMessageModal("msgLoginRequiredToDelete");
                return;
            }
            if (!isAuthReady) {
                 showMessageModal("msgFirebaseNotReady");
                 return;
            }

            showConfirmModal("msgConfirmDelete", async (confirmed) => {
                if (confirmed) {
                    showLoadingSpinner(); // Show spinner during deletion
                    try {
                        const bookRef = doc(db, BOOKS_COLLECTION_PATH, bookId);
                        const bookSnap = await getDoc(bookRef);
                        const bookData = bookSnap.exists() ? bookSnap.data() : null;

                        // Attempt to delete files from Firebase Storage first
                        // Use the stored unique filenames to construct storage references
                        if (bookData.pdfFileName) {
                            try {
                                const pdfStorageRef = ref(storage, `${PDFS_STORAGE_PATH}/${bookData.pdfFileName}`);
                                await deleteObject(pdfStorageRef);
                                console.log("PDF deleted from Storage:", bookData.pdfFileName);
                            } catch (storageError) {
                                console.warn("Could not delete PDF from Storage (might not exist or permission issue):", bookData.pdfFileName, storageError);
                            }
                        }
                        if (bookData.coverImageFileName) {
                            try {
                                const coverStorageRef = ref(storage, `${COVERS_STORAGE_PATH}/${bookData.coverImageFileName}`);
                                await deleteObject(coverStorageRef);
                                console.log("Cover image deleted from Storage:", bookData.coverImageFileName);
                            } catch (storageError) {
                                console.warn("Could not delete cover image from Storage (might not exist or permission issue):", bookData.coverImageFileName, storageError);
                            }
                        }

                        // Finally, delete the document from Firestore
                        await deleteDoc(bookRef);
                        showMessageModal("msgPublicationDeleted");
                        // onSnapshot listeners will automatically update loadBooksForAdmin and loadBooks
                    } catch (error) {
                        console.error("Error removing document: ", error);
                        showMessageModal("msgErrorDeletingPublication");
                    } finally {
                        hideLoadingSpinner(); // Hide spinner after deletion
                    }
                }
            });
        }

        // --- Site Settings Logic ---
        // Load existing site settings (e.g., logo URL) from Firestore
        async function loadSiteSettings() {
            // No admin check here, as public users also need to load the logo.
            // Write operations are protected by isCurrentUserAdmin() and Firebase Rules.
            if (!isAuthReady) { // Ensure Firebase is ready to perform read operations
                console.warn("Firebase not ready to load site settings.");
                return;
            }

            // showLoadingSpinner(); // This spinner is often for more intense ops, might be too much for just logo fetch
            try {
                const siteSettingsDocRef = doc(db, SITE_SETTINGS_DOC_PATH);
                const docSnap = await getDoc(siteSettingsDocRef);

                if (docSnap.exists()) {
                    const settings = docSnap.data();
                    siteLogoUrlFromFirestore = settings.siteLogoUrl || '';
                    siteLogoFileNameFromFirestore = settings.siteLogoFileName || '';

                    // Update the preview and display text
                    if (uploadedSiteLogoPreview) {
                        uploadedSiteLogoPreview.src = siteLogoUrlFromFirestore;
                        uploadedSiteLogoPreview.style.display = siteLogoUrlFromFirestore ? 'block' : 'none';
                    }
                    if (siteLogoFileNameDisplay) {
                        siteLogoFileNameDisplay.textContent = siteLogoFileNameFromFirestore ? `${translations[currentLang]['msgCurrentSiteLogo']} ${getOriginalFileNameFromUnique(siteLogoFileNameFromFirestore)}` : translations[currentLang]['msgNoSiteLogoSelected'];
                    }
                    // Update header and footer logos immediately
                    if(headerLogo) headerLogo.src = siteLogoUrlFromFirestore || 'https://placehold.co/150x50/cccccc/333333?text=Logo';
                    if(footerLogo) footerLogo.src = siteLogoUrlFromFirestore || 'https://placehold.co/100x30/cccccc/333333?text=Logo';

                } else {
                    console.log("No site settings found in Firestore.");
                    // Reset if no settings found
                    siteLogoUrlFromFirestore = '';
                    siteLogoFileNameFromFirestore = '';
                    if (uploadedSiteLogoPreview) {
                        uploadedSiteLogoPreview.src = '';
                        uploadedSiteLogoPreview.style.display = 'none';
                    }
                    if (siteLogoFileNameDisplay) siteLogoFileNameDisplay.textContent = translations[currentLang]['msgNoSiteLogoSelected'];
                    // Use placeholders if no logo is set
                    if(headerLogo) headerLogo.src = 'https://placehold.co/150x50/cccccc/333333?text=Logo';
                    if(footerLogo) footerLogo.src = 'https://placehold.co/100x30/cccccc/333333?text=Logo';
                }
            } catch (error) {
                console.error("Error loading site settings:", error);
                showMessageModal("msgErrorLoadingSiteSettings");
            } finally {
                // hideLoadingSpinner(); // If spinner was shown, hide it.
            }
        }

        // --- Initial Load Logic ---
        window.onload = function() {
            document.getElementById('currentYear').textContent = new Date().getFullYear(); // Set current year in footer
            initializeFirebase(); // Start Firebase initialization and auth process
            // The initial view (homeView) will be shown by setupEventListeners after auth is ready.
        };
    </script>
</body>
</html>
